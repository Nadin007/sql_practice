<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/monokai-sublime.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <title>Document</title>
</head>
<body>
    <a href="https://stepik.org/">Созданно на основе сайта stepik.org</a>
    <h2> Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/178481801" rel="noopener noreferrer nofollow">Dmitry Kravtsov</a></p>

<p>Магазин счёл, что классика уже не пользуется популярностью, поэтому необходимо в выборке:</p>

<p>1. Сменить всех авторов на "Донцова Дарья".</p>

<p>2. К названию каждой книги в начале дописать "Евлампия Романова и " ( <em>пробел в конце</em>).</p>

<p>3. Цену поднять на 42% (округлить её до двух знаков после запятой).</p>

<p>4. Отсортировать по убыванию цены.</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+---------------+-------------------------------------------+---------+
| author        | title                                     | price   |
+---------------+-------------------------------------------+---------+
| Донцова Дарья | Евлампия Романова и Братья Карамазовы     | 1134.59 |
| Донцова Дарья | Евлампия Романова и Мастер и Маргарита    | 952.81  |
| Донцова Дарья | Евлампия Романова и Стихотворения и поэмы | 923.00  |
| Донцова Дарья | Евлампия Романова и Белая гвардия         | 767.51  |
| Донцова Дарья | Евлампия Романова и Игрок                 | 682.31  |
| Донцова Дарья | Евлампия Романова и Идиот                 | 653.20  |
+---------------+-------------------------------------------+---------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Магазин счёл, что классика уже не пользуется популярностью, поэтому необходимо в выборке:</p>

<p>1. Сменить всех авторов на "Донцова Дарья".</p>

<p>2. К названию каждой книги в начале дописать "Евлампия Романова и " ( <em>пробел в конце</em>).</p>

<p>3. Цену поднять на 42% (округлить её до двух знаков после запятой).</p>

<p>4. Отсортировать по убыванию цены.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/147868417" rel="noopener noreferrer nofollow">Москвин Павел</a></p>

<p>Вывести авторов и названия книг и их цену в двух столбцах - рубли и копейки.  Информацию отсортировать по убыванию копеек. </p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------------------+-------+---------+
| author           | title                 | Рубли | Копейки |
+------------------+-----------------------+-------+---------+
| Булгаков М.А.    | Мастер и Маргарита    | 670   | 99      |
| Есенин С.А.      | Черный человек        | 670   | 99      |
| Булгаков М.А.    | Белая гвардия         | 540   | 50      |
| Достоевский Ф.М. | Игрок                 | 480   | 50      |
| Достоевский Ф.М. | Братья Карамазовы     | 799   | 1       |
| Достоевский Ф.М. | Идиот                 | 460   | 0       |
| Есенин С.А.      | Стихотворения и поэмы | 650   | 0       |
+------------------+-----------------------+-------+---------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :  </p>

<blockquote>
<p>Вывести авторов и названия книг и их цену в двух столбцах - рубли и копейки.  Информацию отсортировать по убыванию копеек. </p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p>Автор - <a href="https://stepik.org/users/76913457" rel="noopener noreferrer nofollow">Лариса Фернандес</a></p>

<p>Найти вопрос, с самой большой успешностью выполнения - "самый легкий" и вопрос, с самой маленькой успешностью выполнения - "самый сложный".  (Подробно про успешность на этом <a href="https://stepik.org/lesson/310421/step/10?unit=292727" rel="noopener noreferrer nofollow">шаге</a>). Вывести предмет, эти два вопроса и указание - самый сложный или самый легкий это вопрос. Сначала вывести самый легкий запроса, потом самый сложный.</p>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/ffc21f73-3166-47ab-bc72-54e897969450/"></p>

<p><em><code>Результат:</code></em></p>

<pre><code class="language-sql">+--------------+-------------------------------------------------------------------------+---------------+
| name_subject | name_question                                                           | Сложность     |
+--------------+-------------------------------------------------------------------------+---------------+
| Основы SQL   | Условие, по которому отбираются записи, задается после ключевого слова: | самый легкий  |
| Основы SQL   | Для внутреннего соединения таблиц используется оператор:                | самый сложный |
+--------------+-------------------------------------------------------------------------+---------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :  </p>

<blockquote>
<p>Найти вопрос, на который было дано максимальное количество правильных ответов - "самый легкий" и вопрос, на который было дано минимальное количество правильных ответов - "самый сложный". Вывести предмет, эти два вопроса и указание - самый сложный или самый легкий это вопрос. Сначала вывести самый легкий запроса, потом самый сложный.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Выбор уникальных элементов столбца</h2>

<p>Чтобы отобрать уникальные элементы некоторого столбца используется ключевое слово <code>DISTINCT</code>, которое размещается сразу после <code>SELECT</code>.</p>

<p><strong>Пример</strong></p>

<p>Выбрать различных авторов, книги которых хранятся в таблице<code><strong> book</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT DISTINCT author
FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+
| author           |
+------------------+
| Булгаков М.А.    |
| Достоевский Ф.М. |
| Есенин С.А.      |
+------------------+</code></pre>

<p>Другой способ – использование оператора <code>GROUP BY</code>, который группирует данные при выборке, имеющие одинаковые значения в некотором столбце. Столбец, по которому осуществляется группировка, указывается после <code>GROUP BY</code> .</p>

<p>С помощью <code>GROUP BY</code> можно выбрать уникальные элементы столбца, по которому осуществляется группировка. Результат будет точно такой же как при использовании <code>DISTINCT</code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT  author
FROM book
GROUP BY author;</code></pre>

<h2>Задание</h2>

<p>Отобрать различные (уникальные) элементы столбца <code><strong>amount</strong></code> таблицы<code><strong> book</strong></code>.</p>

<details><summary><strong>Результат </strong>(<strong><span style="color: #66cc66;">попробуйте решать задания без известного результата, если не получится - раскройте его</span></strong><em>)</em></summary>

<pre><code class="language-sql">Query result:
+--------+
| amount |
+--------+
| 3      |
| 5      |
| 10     |
| 15     |
+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT DISTINCT amount
FROM book




</code></pre><h2>Вложенный запрос, возвращающий одно значение</h2>

<p>Вложенный запрос, возвращающий одно значение, может использоваться в условии отбора записей <code>WHERE</code> как обычное значение совместно с операциями =, &lt;&gt;, &gt;=, &lt;=, &gt;, &lt;.</p>

<p><strong>Пример</strong></p>

<p>Вывести информацию о самых дешевых книгах, хранящихся на складе.</p>

<p>Для реализации этого запроса нам необходимо получить минимальную цену из столбца <code><strong>price</strong></code> таблицы <code><strong>book</strong></code>, а затем вывести информацию о тех книгах, цена которых  равна минимальной. Первая часть  – поиск  минимума – реализуется вложенным запросом.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, price, amount
FROM book
WHERE price = (
         SELECT MIN(price) 
         FROM book
      );</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-------+------------------+--------+--------+
| title | author           | price  | amount |
+-------+------------------+--------+--------+
| Идиот | Достоевский Ф.М. | 460.00 | 10     |
+-------+------------------+--------+--------+</code></pre>

<p>Вложенный запрос определяет минимальную цену книг во всей таблице (это 460.00), а затем в основном запросе для каждой записи проверяется, равна ли цена минимальному значению, если равна, информация о книге включается в результирующую таблицу запроса.</p>

<p><strong>Рекомендация. </strong>При использовании вложенного запроса рекомендуется сначала проверить, правильно ли он работает (занести текст запроса в окно кода и нажать черную кнопку <strong>Запустить</strong>), если выдается верный результат – использовать код в качестве вложенного запроса.</p>

<h2>Задание</h2>

<p>Вывести информацию (автора, название и цену) о  книгах, цены которых меньше или равны средней цене книг на складе. Информацию вывести в отсортированном по убыванию цены виде. Среднее вычислить как среднее по цене книги.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------------+---------------+--------+
| author           | title         | price  |
+------------------+---------------+--------+
| Булгаков М.А.    | Белая гвардия | 540.50 |
| Достоевский Ф.М. | Игрок         | 480.50 |
| Достоевский Ф.М. | Идиот         | 460.00 |
+------------------+---------------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, title, price
FROM book
WHERE price <= (SELECT AVG(price) FROM book)
ORDER BY price DESC;



</code></pre><h2>Создание пустой таблицы</h2>

<p>Создание таблицы осуществляется с помощью запроса <code>CREATE</code>, подробно рассмотренного в <a href="https://stepik.org/lesson/297508/step/7?unit=279268" rel="noopener noreferrer nofollow">первом уроке модуля</a>.</p>

<h2>Задание</h2>

<p>Создать таблицу поставка (<code><strong>supply</strong></code>), которая имеет ту же структуру, что и таблиц <code><strong>book</strong></code>.</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #e6f8e0; background: #e6f8e0; text-align: center;">
			<td style="text-align: center;"><strong>Поле</strong></td>
			<td style="text-align: center;"><strong>Тип, описание</strong></td>
		</tr>
		<tr>
			<td><strong>supply_id</strong></td>
			<td>INT PRIMARY KEY AUTO_INCREMENT</td>
		</tr>
		<tr>
			<td><strong>title</strong></td>
			<td>VARCHAR(50)</td>
		</tr>
		<tr>
			<td><strong>author</strong></td>
			<td>VARCHAR(30)</td>
		</tr>
		<tr>
			<td><strong>price</strong></td>
			<td>DECIMAL(8, 2)</td>
		</tr>
		<tr>
			<td><strong>amount</strong></td>
			<td>INT</td>
		</tr>
	</tbody>
</table> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE supply (
supply_id INT PRIMARY KEY AUTO_INCREMENT,
title VARCHAR(50),
author VARCHAR(30),
price DECIMAL(8, 2),
amount INT);</code></pre><h2>Задание</h2>

<p>Вывести из таблицы <code><strong>trip</strong></code> информацию о командировках тех сотрудников, фамилия которых заканчивается на букву «а», в отсортированном по убыванию даты последнего дня командировки виде. В результат включить столбцы <code><strong>name, city, per_diem, date_first, date_last.</strong></code></p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------+-----------------+----------+------------+------------+
| name          | city            | per_diem | date_first | date_last  |
+---------------+-----------------+----------+------------+------------+
| Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| Федорова А.Ю. | Томск           | 450.00   | 2020-06-20 | 2020-06-26 |
| Абрамова К.А. | Санкт-Петербург | 700.00   | 2020-05-28 | 2020-06-04 |
| Федорова А.Ю. | Новосибирск     | 450.00   | 2020-05-25 | 2020-06-04 |
| Абрамова К.А. | Москва          | 700.00   | 2020-04-06 | 2020-04-14 |
| Абрамова К.А. | Москва          | 700.00   | 2020-02-23 | 2020-03-01 |
| Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
+---------------+-----------------+----------+------------+------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>trip</strong></code></strong></summary>

<pre><code>+---------+---------------+-----------------+----------+------------+------------+
| trip_id | name          | city            | per_diem | date_first | date_last  |
+---------+---------------+-----------------+----------+------------+------------+
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |
+---------+---------------+-----------------+----------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name, city, per_diem, date_first, date_last
FROM trip
WHERE name LIKE '%а %'
ORDER BY date_last DESC;
</code></pre><h2>Задание</h2>

<p>Создать таблицу <code><strong>fine</strong></code> следующей структуры:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #e6f8e0; background: #e6f8e0; text-align: center;">
			<td style="text-align: center;"><strong>Поле</strong></td>
			<td style="text-align: center;"><strong>Описание</strong></td>
		</tr>
		<tr>
			<td><strong>fine_id</strong></td>
			<td>ключевой столбец целого типа с автоматическим увеличением значения ключа на 1</td>
		</tr>
		<tr>
			<td><strong>name</strong></td>
			<td>строка длиной 30</td>
		</tr>
		<tr>
			<td><strong>number_plate</strong></td>
			<td>строка длиной 6</td>
		</tr>
		<tr>
			<td><strong>violation</strong></td>
			<td>строка длиной 50</td>
		</tr>
		<tr>
			<td><strong>sum_fine</strong></td>
			<td>вещественное число, максимальная длина 8, количество знаков после запятой 2</td>
		</tr>
		<tr>
			<td><strong>date_violation</strong></td>
			<td>дата</td>
		</tr>
		<tr>
			<td><strong>date_payment</strong></td>
			<td>дата</td>
		</tr>
	</tbody>
</table>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 0</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297508/step/7?unit=279268" rel="noopener noreferrer nofollow">типы столбцов</a>;</li>
	<li>создание таблицы (<a href="https://stepik.org/lesson/297508/step/8?unit=279268" rel="noopener noreferrer nofollow">шаг</a>, <a href="https://stepik.org/lesson/305012/step/2?unit=287020" rel="noopener noreferrer nofollow">шаг</a>).</li>
</ul>
</details> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE fine (
fine_id INT PRIMARY KEY AUTO_INCREMENT,
name VARCHAR(30),
number_plate VARCHAR(6),
violation VARCHAR(50),
sum_fine DECIMAL(8, 2),
date_violation DATE,
date_payment DATE)
   </code></pre><h2>Соединение INNER JOIN</h2>

<p>Оператор внутреннего соединения <code>INNER JOIN</code> соединяет две таблицы. Порядок таблиц для оператора неважен, поскольку оператор является симметричным.</p>

<pre><code class="language-sql">SELECT
 ...
FROM
    таблица_1 INNER JOIN  таблица_2
    ON условие
...</code></pre>

<p>Результат запроса формируется так:</p>

<ul>
	<li>каждая строка одной таблицы сопоставляется с каждой строкой второй таблицы;</li>
	<li>для полученной «соединённой» строки проверяется условие соединения;</li>
	<li>если условие истинно, в таблицу результата добавляется соответствующая «соединённая» строка;</li>
</ul>

<p><strong>Пример</strong></p>

<p>Вывести название книг и их авторов.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, name_author
FROM 
    author INNER JOIN book
    ON author.author_id = book.author_id;</code></pre>

<p>Поскольку поля <code><strong>author_id</strong></code> в таблицах <code><strong>book</strong></code> и <strong><code>author</code></strong> называются одинаково, необходимо в запросах указывать полную ссылку на них (<code><strong>book.author_id</strong></code> и <code><strong>author.author_id</strong></code>).</p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+
| title                 | name_author      |
+-----------------------+------------------+
| Мастер и Маргарита    | Булгаков М.А.    |
| Белая гвардия         | Булгаков М.А.    |
| Идиот                 | Достоевский Ф.М. |
| Братья Карамазовы     | Достоевский Ф.М. |
| Игрок                 | Достоевский Ф.М. |
| Стихотворения и поэмы | Есенин С.А.      |
| Черный человек        | Есенин С.А.      |
| Лирика                | Пастернак Б.Л.   |
+-----------------------+------------------+</code></pre>

<p>В данном запросе осуществляется соединение главной таблицы <strong><code>author</code></strong> и зависимой таблицы <code><strong>book</strong></code> по ключевому столбцу<code><strong> author.author_id</strong></code> и внешнему ключу <code><strong>book.author_id</strong></code>. При этом в результирующую таблицу запроса включаются все строки, в которых значения этих столбцов совпадают. Другими словами строки зависимой таблицы <code><strong>book</strong></code> дополняются фамилией и инициалами авторов из таблицы <code><strong>author</strong></code>.</p>

<h2>Задание</h2>

<p>Вывести название, жанр и цену тех книг, количество которых больше 8, в отсортированном по убыванию цены виде.</p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/"></p>

<p><em><strong>Текст задания </strong>(чтобы не прокручивать страницу):</em></p>

<blockquote>
<p>Вывести название, жанр и цену тех книг, количество которых больше 8, в отсортированном по убыванию цены виде.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------------+------------+--------+
| title                 | name_genre | price  |
+-----------------------+------------+--------+
| Стихотворения и поэмы | Поэзия     | 650.00 |
| Игрок                 | Роман      | 480.50 |
| Идиот                 | Роман      | 460.00 |
+-----------------------+------------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code class="language-sql">Таблица genre:
+----------+-------------+
| genre_id | name_genre  |
+----------+-------------+
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |
+----------+-------------+

Таблица author:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
+-----------+------------------+

Таблица book:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, name_genre, price
FROM genre INNER JOIN book ON genre.genre_id = book.genre_id
WHERE book.amount > 8
ORDER BY book.price DESC;

</code></pre><h2>Запросы на обновление, связанные таблицы</h2>

<p>В запросах на обновление можно использовать связанные таблицы:</p>

<pre><code class="language-sql">UPDATE таблица_1
     ... JOIN таблица_2
     ON выражение
     ...
SET ...   
WHERE ...;</code></pre>

<p>При этом исправлять данные можно во всех используемых в запросе таблицах.</p>

<p><strong>Пример</strong></p>

<p>Для книг, которые уже есть на складе (в таблице<strong><code> book</code></strong>) по той же цене, что и в поставке (<code><strong>supply</strong></code>), увеличить количество на значение, указанное в поставке, а также обнулить количество этих книг в поставке.</p>

<p>Этот запрос должен отобрать строки из таблиц <strong><code>book</code></strong>и <code><strong>supply</strong></code> такие, что у них совпадают и автор, и название книги. Но в таблице <code><strong>supply</strong></code> фамилия автора записана не числом (<code><strong>id</strong></code>), а текстом. Следовательно, чтобы выполнить сравнение по фамилии автора нужно "подтянуть" таблицу <strong><code>author</code></strong>,  которая связана с <strong><code>book</code></strong>по столбцу <code><strong>author_id</strong></code>.  И в логическом выражении, описывающем соединение таблиц, можно будет использовать столбцы из таблиц <strong><code>book, author</code></strong>и <code><strong>supply</strong></code>. </p>

<p>Если таблицы логически связаны по двум и более столбцам (на рисунке связи обозначены линиями), возможно через другие таблицы, условие соединение будет включать связи по нужным столбцам через логический оператор <code><strong>AND</strong></code>. Например, для следующих таблиц логическую связь по названию и автору:</p>

<p><img alt="" src="https://ucarecdn.com/3c953b71-fad4-40c0-8ae2-6e43a3e201d0/"></p>

<p>условие соединения можно записать в виде:</p>

<pre><code class="language-sql">book INNER JOIN author ON author.author_id = book.author_id
     INNER JOIN supply ON book.title = supply.title 
                          and supply.author = author.name_author</code></pre>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">UPDATE book 
     INNER JOIN author ON author.author_id = book.author_id
     INNER JOIN supply ON book.title = supply.title 
                         and supply.author = author.name_author
SET book.amount = book.amount + supply.amount,
    supply.amount = 0   
WHERE book.price = supply.price;

SELECT * FROM book;

SELECT * FROM supply;
</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 4

Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+
Affected rows: 8

Query result:
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 0      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 0      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
Affected rows: 6</code></pre>

<p>Под нужное нам условие подходят две книги «Белая гвардия» Булгакова и «Черный человек» Есенина. В таблице <code><strong>book</strong></code> их количество увеличилось, а в таблице <code><strong>supply</strong></code> - обнулилось.</p>

<h2>Задание</h2>

<p>Для книг, которые уже есть на складе (в таблице<strong><code> book</code></strong>), но по другой цене, чем в поставке (<code><strong>supply</strong></code>),  необходимо в таблице <strong><code>book </code></strong>увеличить количество на значение, указанное в поставке,  и пересчитать цену. А в таблице  <code><strong>supply </strong></code>обнулить количество этих книг. Формула для пересчета цены:</p>

<p><span class="math-tex">\[price={(p_1*k_1+p_2*k_2)\over k_1+k_2}\]</span>где  <em>p<sub>1</sub>, p<sub>2</sub></em> - цена книги в таблицах <strong><code>book </code></strong>и <code><strong>supply</strong></code>;</p>

<p>       <em>k<sub>1</sub>, k<sub>2</sub> </em>- количество книг в таблицах <strong><code>book </code></strong>и <code><strong>supply</strong></code>.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>Пересчитываться должна цена только одной книги Достоевского «Идиот», для этой же книги увеличится количество в таблице <code><strong>book</strong></code> и обнулится количество в таблице <code><strong>supply</strong></code>.</p>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2

Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+
Affected rows: 8
Query result:
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 0      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
Affected rows: 6</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code>Таблица book
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+
Таблица supply
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
Таблица author                          Таблица genre
+-----------+------------------+	+----------+-------------+			
| author_id | name_author      |	| genre_id | name_genre  |			
+-----------+------------------+	+----------+-------------+			
| 1         | Булгаков М.А.    |	| 1        | Роман       |			
| 2         | Достоевский Ф.М. |	| 2        | Поэзия      |			
| 3         | Есенин С.А.      |	| 3        | Приключения |			
| 4         | Пастернак Б.Л.   |	+----------+-------------+			
| 5         | Лермонтов М.Ю.   |							
+-----------+------------------+							</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE book INNER JOIN author ON book.author_id = author.author_id INNER JOIN supply ON book.title = supply.title AND author.name_author = supply.author
SET book.price = IF(book.price <> supply.price, ((book.price * book.amount + supply.price * supply.amount) / (book.amount + supply.amount)), book.price), book.amount = book.amount + supply.amount, supply.amount = 0
WHERE book.price <> supply.price;
</code></pre><h2>Задание</h2>

<p>Включить нового человека в таблицу с клиентами. Его имя <strong>Попов Илья</strong>, его email <strong>popov@test</strong>, проживает он в <strong>Москве</strong>.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/2d95c7c4-3164-4d35-b195-6dea9308e5ae/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>1. В запросах на добавление можно одновременно заносить и константы, и данные из других таблиц. Для этого в той части запроса <code>INSERT</code> , где задается запрос на выборку, в качестве полей для вставки указываются не только поля других таблиц, но и  константы:</p>

<pre><code class="language-sql">INSERT INTO ... 
SELECT 'Попов Илья', city_id, 'popov@test'
FROM city
WHERE ...;</code></pre>

<p>2. Для просмотра той таблицы, в которую внесены изменения, используйте запрос вида:</p>

<pre><code class="language-sql">SELECT * FROM таблица;</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/4?unit=287020" rel="noopener noreferrer nofollow">добавление записей</a></u>;</li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>).</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p> Включить нового человека в таблицу с клиентами. Его имя <strong>Попов Илья</strong>, его email <strong>popov@test</strong>, проживает он в <strong>Москве</strong>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1

Query result (выборка из таблицы client):
+-----------+-----------------+---------+----------------+
| client_id | name_client     | city_id | email          |
+-----------+-----------------+---------+----------------+
| 1         | Баранов Павел   | 3       | baranov@test   |
| 2         | Абрамова Катя   | 1       | abramova@test  |
| 3         | Семенонов Иван  | 2       | semenov@test   |
| 4         | Яковлева Галина | 1       | yakovleva@test |
| 5         | Попов Илья      | 1       | popov@test     |
+-----------+-----------------+---------+----------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц (перед выполнением шага)</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO client (name_client, city_id, email)
SELECT 'Попов Илья', city_id, 'popov@test'
FROM city
WHERE name_city = 'Москва';

</code></pre><h2>Задание</h2>

<p>Вывести абитуриентов, которые хотят поступать на образовательную программу «Мехатроника и робототехника» в отсортированном по фамилиям виде.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/5bafc977-00f6-4709-80b1-1ff175681d19/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Вывести абитуриентов, которые хотят поступать на образовательную программу «Мехатроника и робототехника» в отсортированном по фамилиям виде.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------+
| name_enrollee   |
+-----------------+
| Баранов Павел   |
| Попов Илья      |
| Семенов Иван    |
| Степанова Дарья |
+-----------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>program</code>, <code>enrollee</code>, <code>program_enrollee</code></strong></summary>

<pre><code class="language-sql">таблица program
+------------+-------------------------------------+---------------+------+
| program_id | name_program                        | department_id | plan |
+------------+-------------------------------------+---------------+------+
| 1          | Прикладная математика и информатика | 2             | 1    |
| 2          | Математика и компьютерные науки     | 2             | 2    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |
+------------+-------------------------------------+---------------+------+
таблица enrollee
+-------------+-----------------+
| enrollee_id | name_enrollee   |
+-------------+-----------------+
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |
+-------------+-----------------+
таблица program_enrollee
+---------------------+------------+-------------+
| program_enrollee_id | program_id | enrollee_id |
+---------------------+------------+-------------+
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |
+---------------------+------------+-------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_enrollee
FROM enrollee INNER JOIN program_enrollee USING(enrollee_id) INNER JOIN program USING(program_id)
WHERE name_program = 'Мехатроника и робототехника'
ORDER BY name_enrollee ASC;


</code></pre><h2>Задание</h2>

<p>Создать вспомогательную таблицу <code><strong>applicant</strong></code>,  куда включить <code><strong>id</strong></code> образовательной программы, <code><strong>id</strong></code> абитуриента, сумму баллов абитуриентов (столбец <code><strong>itog</strong></code>) в отсортированном сначала по <code><strong>id</strong></code> образовательной программы, а потом по убыванию суммы баллов виде (использовать <a href="https://stepik.org/lesson/310418/step/10?unit=292724" rel="noopener noreferrer nofollow">запрос</a> из предыдущего урока).</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/f80c65d2-82b4-4ae7-8036-3181302256ee/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для просмотра результата выполнения запроса корректировки на этом шаге и на всех остальных,  используется запрос на выборку, который отображает все записи корректируемой таблицы:</p>

<pre><code class="language-sql">SELECT * FROM таблица;</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/10?unit=287020" rel="noopener noreferrer nofollow">создание таблицы</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p> Создать вспомогательную таблицу <code><strong>applicant</strong></code>,  куда включить <code><strong>id</strong></code> образовательной программы,  <code><strong>id</strong></code> абитуриента, сумму баллов абитуриентов (столбец <code><strong>itog</strong></code>) в отсортированном сначала по <code><strong>id</strong></code> образовательной программы, а потом по убыванию суммы баллов виде (использовать <a href="https://stepik.org/lesson/310418/step/10?unit=292724" rel="noopener noreferrer nofollow">запрос</a> из предыдущего урока).</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 14

Query result:
+------------+-------------+------+
| program_id | enrollee_id | itog |
+------------+-------------+------+
| 1          | 3           | 230  |
| 1          | 2           | 226  |
| 1          | 1           | 213  |
| 2          | 6           | 276  |
| 2          | 3           | 230  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 238  |
| 3          | 5           | 192  |
| 3          | 1           | 179  |
| 4          | 6           | 270  |
| 4          | 3           | 242  |
| 4          | 5           | 192  |
| 4          | 1           | 179  |
+------------+-------------+------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE applicant AS
SELECT program.program_id, enrollee.enrollee_id, SUM(result) AS itog
FROM program INNER JOIN program_subject USING(program_id)
INNER JOIN subject USING(subject_id)
INNER JOIN program_enrollee ON program.program_id = program_enrollee.program_id
INNER JOIN enrollee ON program_enrollee.enrollee_id = enrollee.enrollee_id
INNER JOIN enrollee_subject ON enrollee.enrollee_id = enrollee_subject.enrollee_id AND enrollee_subject.subject_id = subject.subject_id
GROUP BY program.program_id, enrollee.enrollee_id
ORDER BY program_id ASC, itog DESC;
</code></pre><h2>Задание</h2>

<p>Вывести студентов, которые сдавали дисциплину «Основы баз данных», указать дату попытки и результат. Информацию вывести по убыванию результатов тестирования.</p>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/d46b4a8e-ef49-4335-815b-f3d685f63a13/">​</p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу)</p>

<blockquote>
<p> Вывести студентов, которые сдавали дисциплину «Основы баз данных», указать дату попытки и результат. Информацию вывести по убыванию результатов тестирования.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------+--------------+--------+
| name_student    | date_attempt | result |
+-----------------+--------------+--------+
| Яковлева Галина | 2020-04-21   | 100    |
| Баранов Павел   | 2020-03-23   | 67     |
| Яковлева Галина | 2020-03-26   | 0      |
+-----------------+--------------+--------+
</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>attempt</code>, <code>student</code>, <code>subject</code></strong></summary>

<pre><code class="language-sql">таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
таблица student                   таблица subject
+------------+-----------------+  +------------+-------------------+
| student_id | name_student    |  | subject_id | name_subject      |
+------------+-----------------+  +------------+-------------------+
| 1          | Баранов Павел   |  | 1          | Основы SQL        |
| 2          | Абрамова Катя   |  | 2          | Основы баз данных |
| 3          | Семенов Иван    |  | 3          | Физика            |
| 4          | Яковлева Галина |  +------------+-------------------+
+------------+-----------------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_student, date_attempt, result
FROM student INNER JOIN attempt USING(student_id) INNER JOIN subject USING(subject_id)
WHERE name_subject = 'Основы баз данных'
ORDER BY result DESC;

</code></pre><h2>Задание</h2>

<p>В таблицу <strong><code>attempt</code> </strong>включить новую попытку для студента Баранова Павла по дисциплине «Основы баз данных». Установить текущую дату в качестве даты выполнения попытки.</p>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/39672b19-b8ef-4e77-b7a8-236f2ac73fa0/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для того, чтобы вставить текущую дату используйте функцию<strong> </strong><code><strong>NOW()</strong></code>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/4?unit=287020" rel="noopener noreferrer nofollow">добавление записей</a>;</u></li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/4?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297514/step/6?unit=279274" rel="noopener noreferrer nofollow">вложенный запрос после SELECT</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>В таблицу <code><strong>attempt</strong></code><strong> </strong>включить новую попытку для студента Баранова Павла по дисциплине «Основы баз данных». Установить текущую дату в качестве даты выполнения попытки.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<p>Примечание: дата попытки при запуске запроса будет отличаться от образца.</p>

<pre><code class="language-sql">Affected rows: 1

Query result:
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | NULL   |
+------------+------------+------------+--------------+--------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>subject</code>, <code>student</code>, <code>attempt</code> (перед выполнением шага)</strong></summary>

<pre><code class="language-sql">таблица student                   таблица subject
+------------+-----------------+  +------------+-------------------+
| student_id | name_student    |  | subject_id | name_subject      |
+------------+-----------------+  +------------+-------------------+
| 1          | Баранов Павел   |  | 1          | Основы SQL        |
| 2          | Абрамова Катя   |  | 2          | Основы баз данных |
| 3          | Семенов Иван    |  | 3          | Физика            |
| 4          | Яковлева Галина |  +------------+-------------------+
+------------+-----------------+
таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO attempt (student_id, subject_id, date_attempt, result)
SELECT student_id, subject_id, now(), Null
FROM student INNER JOIN attempt USING(student_id) INNER JOIN subject USING(subject_id)
WHERE (student_id = (
    SELECT student_id From student WHERE name_student = 'Баранов Павел')
    AND subject_id = (
        SELECT subject_id FROM subject WHERE name_subject = 'Основы баз данных'));

SELECT *
FROM attempt</code></pre><h2>Задание</h2>

<p><em><strong>автор -</strong> Даниил Карасев</em></p>

<p>Провести аналитику по трем ценовым категориям (до 600 руб, от 600 руб до 700 руб, свыше 700 руб) и вывести среднюю цену  книги, общую стоимость остатков книг  в этой ценовой позиции и количество позиций. Среднюю цену и стоимость округлить до двух знаков после запятой. Информацию отсортировать по возрастанию нижней границы ценовой категории.</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p>Для реализации этого запроса создадим вспомогательную таблицу <strong><code>stat</code></strong>, в которой будут храниться ценовые категории (первая ценовая категория - цены  больше или равны 0 и меньше 600, вторая - больше или равны 600 и меньше 700 и т.д.):</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>beg_range</strong></td>
			<td><strong>end_range</strong></td>
		</tr>
		<tr style="background-color: #dcdcdc; background: #dcdcdc; text-align: center;">
			<td>int</td>
			<td><sup><strong>INT</strong></sup></td>
		</tr>
		<tr>
			<td>0</td>
			<td>600</td>
		</tr>
		<tr>
			<td>600</td>
			<td>700</td>
		</tr>
		<tr>
			<td>700</td>
			<td>10000</td>
		</tr>
	</tbody>
</table>

<p>Использование такой таблицы позволит анализировать разные ценовые категории, не изменяя запрос. В таблице можно указать любое количество категорий и любые границы.</p>

<p><em>Результат (таблица stat уже создана):</em></p>

<pre><code class="language-sql">+-----------+-----------+--------------+-----------+------------+
| beg_range | end_range | Средняя_цена | Стоимость | Количество |
+-----------+-----------+--------------+-----------+------------+
| 0         | 600       | 493.67       | 12107.50  | 3          |
| 600       | 700       | 660.50       | 11762.97  | 2          |
| 700       | 10000     | 799.01       | 2397.03   | 1          |
+-----------+-----------+--------------+-----------+------------+</code></pre>

<p><strong>Пояснение</strong> (один из вариантов решения).</p>

<p>Можно сначала реализовать вложенный запрос, в котором для каждой книги вывести ценовой интервал, к которому она относится, результат:</p>

<pre><code class="language-sql">+-----------+-----------+--------+--------+
| beg_range | end_range | price  | amount |
+-----------+-----------+--------+--------+
| 600       | 700       | 670.99 | 3      |
| 0         | 600       | 540.50 | 5      |
| 0         | 600       | 460.00 | 10     |
| 700       | 10000     | 799.01 | 3      |
| 0         | 600       | 480.50 | 10     |
| 600       | 700       | 650.00 | 15     |
+-----------+-----------+--------+--------+</code></pre>

<p> В основном запросе выполнить вычисления с помощью групповых функций.</p>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Провести аналитику по трем ценовым категориям (до 600 руб, от 600 руб до 700 руб, свыше 700 руб) и вывести среднюю цену  книги, общую стоимость остатков книг  в этой ценовой позиции и количество позиций. Среднюю цену и стоимость округлить до двух знаков после запятой. Информацию отсортировать по возрастанию нижней границы ценовой категории.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em>Анатолий Алексеев</p>

<p>Вывести жанр(ы), в котором было заказано <strong>меньше всего</strong> экземпляров книг, указать это количество. Учитывать только жанры, в которых была заказана хотя бы одна книга.<br>
При реализации в основном запросе не используйте LIMIT, поскольку жанров с минимальным количеством заказанных книг может быть несколько.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/a34b56be-6b50-42af-a99f-a4fea0ab97ec/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------+------------+
| name_genre | Количество |
+------------+------------+
| Поэзия     | 4          |
+------------+------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Вывести жанр(ы), в котором было заказано <strong>меньше всего</strong> экземпляров книг, указать это количество. Учитывать только жанры, в которых была заказана хотя бы одна книга.<br>
При реализации в основном запросе не используйте LIMIT, поскольку жанров с минимальным количеством заказанных книг может быть несколько.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/114229543" rel="noopener noreferrer nofollow">Надежда Новикова</a></p>

<p>В связи с повышенным спросом на классическую литературу школьниками в формате "А есть то же самое, но покороче, чтобы читать поменьше?" была выпущена серия "Графоман и. Краткое содержание".<br>
<strong>В выборке:</strong><br>
- к имени автора добавить "Графоман и ";<br>
- к названию книги дописать ". Краткое содержание.";<br>
- цену на новый опус установить 40% от цены оригинала, но не более 250. (Если 40% больше 250, то цена должна быть 250);<br>
- в зависимости от остатка на складе вывести "Спрос": до 3 (включительно) - высокий, до 10 (включительно) - средний, иначе низкий;<br>
- добавить колонку "Наличие" в зависимости от количества: 1-2 шт - очень мало, 3-14 - в наличии, 15 и больше - много;<br>
- отсортировать по цене по возрастанию, затем по Спросу от высокого к низкому, а затем по названию книги в алфавитном порядке.</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------------+--------------------------------------------+---------+---------+------------+
| Автор                       | Название                                   | Цена    | Спрос   | Наличие    |
+-----------------------------+--------------------------------------------+---------+---------+------------+
| Графоман и Достоевский Ф.М. | Идиот. Краткое содержание.                 | 184.000 | средний | в наличии  |
| Графоман и Достоевский Ф.М. | Игрок. Краткое содержание.                 | 192.200 | средний | в наличии  |
| Графоман и Булгаков М.А.    | Белая гвардия. Краткое содержание.         | 216.200 | средний | в наличии  |
| Графоман и Достоевский Ф.М. | Братья Карамазовы. Краткое содержание.     | 250     | высокий | очень мало |
| Графоман и Булгаков М.А.    | Мастер и Маргарита. Краткое содержание.    | 250     | высокий | в наличии  |
| Графоман и Есенин С.А.      | Черный человек. Краткое содержание.        | 250     | средний | в наличии  |
| Графоман и Есенин С.А.      | Стихотворения и поэмы. Краткое содержание. | 250     | низкий  | много      |
+-----------------------------+--------------------------------------------+---------+---------+------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :  </p>

<blockquote>
<p>В связи с повышенным спросом на классическую литературу школьниками в формате "А есть то же самое, но покороче, чтобы читать поменьше?" была выпущена серия "Графоман и. Краткое содержание".<br>
<strong>В выборке:</strong><br>
- к имени автора добавить "Графоман и ";<br>
- к названию книги дописать ". Краткое содержание.";<br>
- цену на новый опус установить 40% от цены оригинала, но не более 250. (Если 40% больше 250, то цена должна быть 250);<br>
- в зависимости от остатка на складе вывести "Спрос": до 3 (включительно) - высокий, до 10 (включительно) - средний, иначе низкий;<br>
- добавить колонку "Наличие" в зависимости от количества: 1-2 шт - очень мало, 3-14 - в наличии, 15 и больше - много;<br>
- отсортировать по цене по возрастанию, затем по Спросу от высокого к низкому, а затем по названию книги в алфавитном порядке.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p>Автор - <a href="https://stepik.org/users/76913457" rel="noopener noreferrer nofollow">Лариса Фернандес</a></p>

<p>Для повышения успеваемости, предоставить возможность студентам снова пройти тестирование.</p>

<p>Для студентов, у которых количество попыток меньше 3 и максимальный балл &lt; 70, в таблицу <code><strong>attempt</strong></code> добавить новые попытки по соответствующим предметам с текущей датой.</p>

<p><strong>Корректируемая таблица:</strong></p>

<p><img alt="" src="https://ucarecdn.com/d1382132-e039-43a2-8cba-30c5f195e4b6/"></p>

<p><em><code>Результат (даты новых попыток будут отличаться от образца):</code></em></p>

<pre><code class="language-sql">Affected rows: 2

Query result:
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 1          | 2020-05-18   | None   |
| 9          | 1          | 2          | 2020-05-18   | None   |
+------------+------------+------------+--------------+--------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :  </p>

<blockquote>
<p> Для повышения успеваемости, предоставить возможность студентам снова пройти тестирование.</p>

<p>Для студентов, у которых количество попыток меньше 3 и максимальный балл &lt; 70, в таблицу <code><strong>attempt</strong></code> добавить новые попытки по соответствующим предметам с текущей датой.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><p>Платформа Stepik представляет довольно скудную навигацию по шагам модуля. Очень трудно вспомнить, на каком шаге изучался тот или иной материал. База данных этого урока позволяет с помощью запросов реализовать удобный поиск нужных шагов.</p>

<h2>Задание</h2>

<p>Отобрать все шаги, в которых рассматриваются вложенные запросы (то есть в названии шага упоминаются вложенные запросы). Указать к какому уроку и модулю они относятся. Для этого вывести 3 поля:</p>

<ul>
	<li>в поле <code><strong>Модуль</strong></code> указать номер модуля и его название через пробел;</li>
	<li>в поле <code><strong>Урок</strong></code> указать номер модуля, порядковый номер урока (<code><strong>lesson_position</strong></code>) через точку и название урока через пробел;</li>
	<li>в поле <code><strong>Шаг</strong></code> указать номер модуля, порядковый номер урока (<code><strong>lesson_position</strong></code>) через точку, порядковый номер шага (<code><strong>step_position</strong></code>) через точку и название шага через пробел.</li>
</ul>

<p>Длину полей <code><strong>Модуль</strong></code> и <code><strong>Урок </strong></code>ограничить 19 символами, при этом слишком длинные надписи обозначить многоточием в конце (16 символов - это номер модуля или урока, пробел и  название <code><strong>Урока</strong></code> или <code><strong>Модуля</strong></code> к ним присоединить <code><strong>"..."</strong></code>). Информацию отсортировать по возрастанию номеров модулей, порядковых номеров уроков и порядковых номеров шагов.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/da5f161d-0dd9-497c-a9fd-3c3a94ee45b8/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/310421/step/10?auth=login&amp;unit=292727" rel="noopener noreferrer nofollow">функции LEFT() и CONCAT()</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><em><strong>Текст запроса (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p> Отобрать все шаги, в которых рассматриваются вложенные запросы (то есть в названии шага упоминаются вложенные запросы). Указать к какому уроку и модулю они относятся. Для этого вывести 3 поля:</p>

<ul>
	<li>в поле <code><strong>Модуль</strong></code> указать номер модуля и его название через пробел;</li>
	<li>в поле <code><strong>Урок </strong></code>указать номер модуля, порядковый номер урока (<code><strong>lesson_position</strong></code>) через точку и название урока через пробел;</li>
	<li>в поле <code><strong>Шаг</strong></code> указать номер модуля, порядковый номер урока (<code><strong>lesson_position</strong></code>) через точку, порядковый номер шага (<code><strong>step_position</strong></code>) через точку и название шага через пробел.</li>
</ul>

<p>Длину полей <code><strong>Модуль</strong></code> и <code><strong>Урок </strong></code>ограничить 19 символами, при этом слишком длинные надписи обозначить многоточием в конце (16 символов - это номер модуля или урока, пробел и  название <code><strong>Урока</strong></code> или <code><strong>Модуля,</strong></code>к ним присоединить <code><strong>"..."</strong></code>). Информацию отсортировать по возрастанию номеров модулей, порядковых номеров уроков и порядковых номеров шагов.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------------+---------------------+-------------------------------------------------------------+
| Модуль              | Урок                | Шаг                                                         |
+---------------------+---------------------+-------------------------------------------------------------+
| 1 Основы реляцио... | 1.4 Вложенные за... | 1.4.2 Вложенный запрос, возвращающий одно значение          |
| 1 Основы реляцио... | 1.4 Вложенные за... | 1.4.3 Использование вложенного запроса в выражении          |
| 1 Основы реляцио... | 1.4 Вложенные за... | 1.4.4 Вложенный запрос, оператор IN                         |
| 1 Основы реляцио... | 1.4 Вложенные за... | 1.4.5 Вложенный запрос, операторы ANY и ALL                 |
| 1 Основы реляцио... | 1.4 Вложенные за... | 1.4.6 Вложенный запрос после SELECT                         |
| 1 Основы реляцио... | 1.5 Запросы корр... | 1.5.5 Добавление записей, вложенные запросы                 |
| 2 Запросы SQL к ... | 2.2 Запросы на в... | 2.2.7 Запросы для нескольких таблиц со вложенными запросами |
| 2 Запросы SQL к ... | 2.2 Запросы на в... | 2.2.8 Вложенные запросы в операторах соединения             |
| 2 Запросы SQL к ... | 2.3 Запросы корр... | 2.3.5 Запрос на обновление, вложенные запросы               |
+---------------------+---------------------+-------------------------------------------------------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT CONCAT(a.module_id, ' ', LEFT(a.module_name, 14), '...') AS Модуль, CONCAT(a.module_id, '.', l.lesson_position, ' ', LEFT(lesson_name, 12), '...') AS Урок, CONCAT(a.module_id, '.', l.lesson_position, '.', s.step_position, ' ', step_name) AS Шаг
FROM module as a INNER JOIN lesson as l USING(module_id) INNER JOIN step as s USING(lesson_id)
HAVING Шаг LIKE '%вложенн%запрос%'
ORDER BY module_id, lesson_position, step_position


</code></pre><h2>Поиск по ключевым словам</h2>

<p>На данном шаге можно найти шаги курса, в которых встречаются ключевые слова SQL, которые рассматриваются в курсе.</p>

<p>Для этого скопируйте один из запросов в окно решений, укажите нужные ключевые слова и запустите запрос. В окне решений будут выведены ссылки на соответствующие шаги.</p>

<p>Это <strong>НЕ ЗАДАНИЕ</strong>, а просто запросы, с помощью которых можно найти шаги, в которых встречаются те или иные ключевые слова. Выполнять не обязательно (это задание оценивается в 0 баллов). Это ПРОСТО ПОМОЩЬ для навигации по курсу.</p>

<p><strong>Запрос 1. </strong>Поиск шагов, в которых встречается заданное ключевое слово, в примере <strong>MAX</strong>:</p>

<pre><code class="language-sql">SELECT 
   CONCAT(module_id,'.',lesson_position,".",step_position," ", CONCAT(LEFT(step_name, 50), '...')) AS Шаг,
   note AS Примечание
FROM step
        INNER JOIN lesson USING(lesson_id)
        INNER JOIN module USING(module_id)
        INNER JOIN step_keyword USING(step_id)
        INNER JOIN keyword USING(keyword_id)
WHERE keyword_name = 'MAX'
ORDER BY 1;</code></pre>

<p><strong>Запрос 2. </strong>Поиск шагов, в которых встречаются два заданных ключевых слова одновременно, в примере <strong>MAX</strong> и <strong>AVG</strong>:</p>

<pre><code class="language-sql">SELECT 
   CONCAT(module_id,'.',lesson_position,".",step_position," ", CONCAT(LEFT(step_name, 30), '...')) AS Шаг, 
   link AS Ссылка_на_шаг
FROM step
        INNER JOIN lesson USING(lesson_id)
        INNER JOIN module USING(module_id)
        INNER JOIN step_keyword USING(step_id)
        INNER JOIN keyword USING(keyword_id)
WHERE keyword_name IN ('MAX', 'AVG')
GROUP BY ШАГ, Ссылка_на_шаг
HAVING count(*) = 2
ORDER BY 1;</code></pre>

<p><strong> Запрос 3. </strong>Поиск шагов, в которых встречаются три заданных ключевых слова одновременно, в примере <strong>MAX</strong>, <strong>MIN</strong> и <strong>AVG</strong>:</p>

<pre><code class="language-sql">SELECT 
   CONCAT(module_id,'.',lesson_position,".",step_position," ",step_name) AS Шаг
FROM step
        INNER JOIN lesson USING(lesson_id)
        INNER JOIN module USING(module_id)
        INNER JOIN step_keyword USING(step_id)
        INNER JOIN keyword USING(keyword_id)
WHERE keyword_name IN ('MAX', 'AVG', 'MIN')
GROUP BY ШАГ
HAVING COUNT(*) = 3
ORDER BY 1;</code></pre> <br><hr><br> <pre><code class="hljs language-sql">SELECT 
   CONCAT(module_id,'.',lesson_position,".",step_position," ", CONCAT(LEFT(step_name, 50), '...')) AS Шаг,
   note AS Примечание
FROM step
        INNER JOIN lesson USING(lesson_id)
        INNER JOIN module USING(module_id)
        INNER JOIN step_keyword USING(step_id)
        INNER JOIN keyword USING(keyword_id)
WHERE keyword_name = 'MAX'
ORDER BY 1;



</code></pre><h2>Выборка всех данных из таблицы</h2>

<p>Для того чтобы отобрать все данные из таблицы используется SQL запрос следующей структуры: </p>

<ul>
	<li>ключевое слово <code><strong>SELECT</strong></code>; </li>
	<li>символ « <code><strong>*</strong></code>» ; </li>
	<li>ключевое слово <code><strong>FROM</strong></code>; </li>
	<li>имя таблицы.</li>
</ul>

<p>Результатом является таблица, в которую включены все строки и столбцы указанной в запросе таблицы.</p>

<p><strong>Пример</strong></p>

<p>Выбрать все записи таблицы book .</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT * FROM book;</code></pre>

<h2>Задание</h2>

<p>Вывести информацию о всех книгах, хранящихся на складе.</p>

<p>Для этого: </p>

<ul>
	<li>Напишите SQL запрос в окне кода; </li>
	<li>Отправьте на проверку (кнопка  <strong>Отправить</strong>); </li>
	<li>Если запрос работает неверно, исправьте его и снова отправьте на проверку.</li>
</ul>

<p><strong>Важно! </strong>В окне кода можно использовать комментарии для сохранения разных вариантов запросов или пояснений. Комментарии заключаются в <strong>/* </strong>и <strong>*/</strong></p>

<p><strong>Результат:</strong></p>

<pre><code class="language-sql">+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+
Affected rows: 5</code></pre> <br><hr><br> <pre><code class="hljs language-sql">SELECT * FROM book;




</code></pre><h2>Задание</h2>

<p>Вывести в алфавитном порядке фамилии и инициалы тех сотрудников, которые были в командировке в Москве.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------+
| name          |
+---------------+
| Абрамова К.А. |
| Баранов П.Е.  |
| Колесов С.П.  |
| Лебедев Т.К.  |
| Семенов И.В.  |
+---------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</li>
	<li><a href="https://stepik.org/lesson/297515/step/2?unit=279275" rel="noopener noreferrer nofollow">уникальные записи</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>trip</strong></code></strong></summary>

<pre><code>+---------+---------------+-----------------+----------+------------+------------+
| trip_id | name          | city            | per_diem | date_first | date_last  |
+---------+---------------+-----------------+----------+------------+------------+
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |
+---------+---------------+-----------------+----------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT DISTINCT name
FROM trip
WHERE city = 'Москва'
ORDER BY name ASC;



</code></pre><h2>Выборка данных, групповые функции SUM и COUNT</h2>

<p>При группировке над элементами столбца, входящими в группу можно выполнить различные действия, например, просуммировать их или найти количество элементов в группе.</p>

<p>Подробно рассмотрим, как осуществляется группировка данных по некоторому столбцу и вычисления над группой на следующем примере:</p>

<pre><code>SELECT author, sum(amount), count(amount)
FROM book
GROUP BY author;</code></pre>

<p>1. В таблице <code><strong>book</strong></code> определяются строки, в которых в столбце <code><strong>author</strong></code> одинаковые значения:</p>

<p><img alt="" height="243" src="https://ucarecdn.com/2c9cc54f-b3b0-4388-8443-bcf590176622/" width="600"></p>

<p>Получили 3 различные группы:</p>

<ul>
	<li><strong>группа I</strong> объединяет две записи, у которых в столбце <code><strong>author</strong></code> значение Булгаков М.А.;</li>
	<li><strong>группа II</strong> объединяет три записи, у которых в столбце <code><strong>author</strong></code> значение Достоевский Ф.М.;</li>
	<li><strong>группа III</strong> объединяет одну запись, у которой в столбце <code><strong>author</strong></code> значение Есенин С.А.</li>
</ul>

<p>2. Вместо каждой группы в результирующий запрос включается  одна запись. Запись как минимум включает значение столбца, по которому осуществляется группировка (в нашем случае это <code><strong>author</strong></code>):</p>

<p><img alt="" height="220" src="https://ucarecdn.com/8265a790-2164-44ee-882a-d2ef67fa75d4/" width="600"></p>

<p>3. Дальше можно выполнить вычисления над элементами КАЖДОЙ группы в отдельности, например, посчитать общее количество экземпляров книг каждого автора. Для этого используется групповая функция <code>SUM()</code>, а в скобках указывается столбец, по которому нужно выполнить суммирование ( в нашем случае <code><strong>amount</strong></code>):</p>

<p><img alt="" height="217" src="https://ucarecdn.com/8ef972d9-842b-438c-a4c5-e13a0a17d9fb/" width="750"></p>

<p>4. Также можно посчитать, сколько записей относится к группе. Для этого используется функция <code>COUNT()</code>, в скобках можно указать ЛЮБОЙ столбец из группы, если группа не содержит пустых значений (ниже приведен пример, в котором показано, как работает <code><strong>COUNT()</strong></code>, если в группе есть пустые значения):</p>

<p><img alt="" height="217" src="https://ucarecdn.com/708aa6d7-f879-41b4-8030-103e4b43754e/" width="750"></p>

<p><strong>Пример</strong></p>

<p>Посчитать, сколько экземпляров книг каждого автора хранится на складе.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT author, SUM(amount)
FROM book
GROUP BY author;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-------------+
| author           | SUM(amount) |
+------------------+-------------+
| Булгаков М.А.    | 8           |
| Достоевский Ф.М. | 23          |
| Есенин С.А.      | 15          |
+------------------+-------------+</code></pre>

<details><summary><strong>Примечание</strong></summary>

<p>Обратите внимание, что в качестве названия вычисляемого столбца в результирующей таблице используется выражение. Рекомендуется всем  вычисляемым столбцам давать имя.</p>
</details>

<p><strong>Пример</strong></p>

<p>Посчитать, сколько различных книг каждого автора хранится на складе.</p>

<p>Только для этого примера в таблицу<code><strong> book</strong></code> добавлена запись с пустыми значениями в столбцах <code><strong>amount</strong></code> и <code><strong>price</strong></code>:</p>

<pre><code class="language-sql">+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 7       | Черный человек        | Есенин С.А.      | Null   | Null   |
+---------+-----------------------+------------------+--------+--------+</code></pre>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">/* чтобы проверить запрос, добавьте в таблицу строку */
INSERT INTO book (title, author, price, amount) VALUES ('Черный человек','Есенин С.А.', Null, Null);

SELECT author, COUNT(author), COUNT(amount), COUNT(*)
FROM book
GROUP BY author;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+---------------+---------------+----------+
| author           | COUNT(author) | COUNT(amount) | COUNT(*) |
+------------------+---------------+---------------+----------+
| Булгаков М.А.    | 2             | 2             | 2        |
| Достоевский Ф.М. | 3             | 3             | 3        |
| Есенин С.А.      | 2             | 1             | 2        |
+------------------+---------------+---------------+----------+</code></pre>

<p>Из таблицы с результатами запроса видно, что функцию <code><strong>COUNT()</strong></code> можно применять к любому столбцу, в том числе можно использовать и <code><strong>*</strong></code>, если таблица не содержит пустых значений. Если же в столбцах есть значения <code><strong>Null</strong></code>, (для группы по автору Есенин в нашем примере), то</p>

<ul>
	<li><code><strong>COUNT(*) </strong></code>—  подсчитывает  все записи, относящиеся к группе, в том числе и со значением <code><strong>NULL</strong></code>;</li>
	<li><code><strong>COUNT(имя_столбца)</strong></code> — возвращает количество записей конкретного столбца (только <code><strong>NOT NULL</strong></code>), относящихся к группе.</li>
</ul>

<p><strong>ВАЖНО.</strong></p>

<ol>
	<li>Если столбец указан в <code>SELECT</code>  <strong>БЕЗ </strong>применения групповой функции, то он обязательно должен быть указан и в<code>GROUP BY.</code>Иначе получим ошибку.</li>
	<li>Между названием функции и скобкой <span style="color: #ff4363;"><strong>НЕЛЬЗЯ СТАВИТЬ ПРОБЕЛ</strong></span>. Это особенность платформы.</li>
</ol>

<h2>Задание</h2>

<p>Посчитать, количество различных книг и количество экземпляров книг каждого автора , хранящихся на складе.  Столбцы назвать <code><strong>Автор,</strong> <strong>Различных_книг</strong></code> и<strong> <code>Количество_экземпляров</code></strong> соответственно.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------------+----------------+------------------------+
| Автор            | Различных_книг | Количество_экземпляров |
+------------------+----------------+------------------------+
| Булгаков М.А.    | 2              | 8                      |
| Достоевский Ф.М. | 3              | 23                     |
| Есенин С.А.      | 1              | 15                     |
+------------------+----------------+------------------------+
</code></pre>
</details>

<details><summary><strong>Пояснение</strong></summary>

<p>Название столбцов может состоять из нескольких слов, тогда их нужно заключать в кавычки. Но если слова написать через подчеркивание, тогда получится , что название состоит из одного слова, и кавычки можно не ставить. </p>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author as Автор, COUNT(amount) as Различных_книг, SUM(amount) as Количество_экземпляров
FROM book
GROUP BY author



</code></pre><h2>Использование вложенного запроса в выражении</h2>

<p>Вложенный запрос, возвращающий одно значение, может использоваться в выражениях как обычный операнд, например, к нему можно что-то прибавить, вычесть и пр.</p>

<p><strong>Пример</strong></p>

<p>Вывести информацию о книгах, количество экземпляров которых отличается от среднего количества экземпляров книг на складе более чем на 3. То есть нужно вывести и те книги, количество экземпляров которых меньше среднего на 3, и больше среднего на 3.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, amount 
FROM book
WHERE ABS(amount - (SELECT AVG(amount) FROM book)) &gt;3;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+--------+
| title                 | author           | amount |
+-----------------------+------------------+--------+
| Мастер и Маргарита    | Булгаков М.А.    | 3      |
| Братья Карамазовы     | Достоевский Ф.М. | 3      |
| Стихотворения и поэмы | Есенин С.А.      | 15     |
+-----------------------+------------------+--------+</code></pre>

<h2>Задание</h2>

<p>Вывести информацию (автора, название и цену) о тех книгах, цены которых превышают минимальную цену книги на складе не более чем на 150 рублей в отсортированном по возрастанию цены виде.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------------+----------------+--------+
| author           | title          | price  |
+------------------+----------------+--------+
| Достоевский Ф.М. | Идиот          | 460.00 |
| Достоевский Ф.М. | Игрок          | 480.50 |
| Булгаков М.А.    | Белая гвардия  | 540.50 |
| Пушкин А.С.      | Евгений Онегин | 610.00 |
+------------------+----------------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 7       | Евгений Онегин        | Пушкин А.С.      | 610.00 | 10     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, title, price
FROM book
WHERE (price - (SELECT MIN(price) FROM book)) <= 150
ORDER BY price ASC;

</code></pre><h2>Добавление записей в таблицу</h2>

<p>Добавление одной записи в таблицу осуществляется с помощью запроса <code>INSERT</code>, подробно рассмотренного в <a href="https://stepik.org/lesson/297508/step/8?unit=279268" rel="noopener noreferrer nofollow">первом уроке</a>. Запросы обязательно разделять точкой с запятой.</p>

<p>Допускается вставка нескольких записей одновременно, для этого используется SQL запрос следующего вида:</p>

<pre><code class="language-sql">INSERT INTO имя_таблицы(столбец_1, столбец_2, ..., столбец_N)
VALUES
    (значение_1_1, значение_1_2, ..., значение_1_N),
    (значение_2_1, значение_2_2, ..., значение_2_N),
    ...
    (значение_M_1, значение_M_2, ..., значение_M_N);
</code></pre>

<p>Например, чтобы добавить в таблицу <code><strong>book</strong></code><strong> </strong>две новые записи используется запрос:</p>

<pre><code class="language-sql">INSERT INTO book (title, author, price, amount) 
VALUES 
    ('Война и мир','Толстой Л.Н.', 1070.20, 2),
    ('Анна Каренина', 'Толстой Л.Н.', 599.90, 3);</code></pre>

<h2>Задание</h2>

<p>Занесите в таблицу<code><strong> supply</strong></code> четыре записи, чтобы получилась следующая таблица:</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>supply_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Лирика</td>
			<td>Пастернак Б.Л.</td>
			<td>518.99</td>
			<td>2</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Черный человек </td>
			<td>Есенин С.А.</td>
			<td>570.20</td>
			<td>6</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Белая гвардия</td>
			<td>Булгаков М.А.</td>
			<td>540.50</td>
			<td>7</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Идиот</td>
			<td>Достоевский Ф.М.</td>
			<td>360.80</td>
			<td>3</td>
		</tr>
	</tbody>
</table>

<details><summary><strong>Пояснение</strong></summary>

<p>Для просмотра полученной таблицы после запросов (запроса) на добавление  вставить запрос на выборку всех данных из таблицы <code><strong>supply</strong></code>.</p>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1
Affected rows: 1
Affected rows: 1
Affected rows: 1
Query result:
+-----------+----------------+------------------+--------+--------+
| supply_id | title          | author           | price  | amount |
+-----------+----------------+------------------+--------+--------+
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |
+-----------+----------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO supply (title, author, price, amount)
VALUES ('Лирика', 'Пастернак Б.Л.', 518.99, 2),
('Черный человек ', 'Есенин С.А.', 570.20, 6),
('Белая гвардия', 'Булгаков М.А.', 540.50, 7),
('Идиот', 'Достоевский Ф.М.', 360.80, 3);
</code></pre><h2>Задание</h2>

<p>В таблицу <code><strong>fine</strong></code> первые 5 строк уже занесены. Добавить в таблицу записи с ключевыми значениями 6, 7, 8.</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>fine_id</strong></td>
			<td><strong>name</strong></td>
			<td><strong>number_plate</strong></td>
			<td><strong>violation</strong></td>
			<td><strong>sum_fine</strong></td>
			<td><strong>date_violation</strong></td>
			<td><strong>date_payment</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Баранов П.Е.</td>
			<td>Р523ВТ</td>
			<td>Превышение скорости<br>
			(от 40 до 60)</td>
			<td>500.00</td>
			<td>2020-01-12</td>
			<td>2020-01-17</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Абрамова К.А.</td>
			<td>О111АВ</td>
			<td>Проезд на<br>
			запрещающий сигнал</td>
			<td>1000.00</td>
			<td>2020-01-14</td>
			<td>2020-02-27</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Яковлев Г.Р.</td>
			<td>Т330ТТ</td>
			<td>Превышение скорости<br>
			(от 20 до 40)</td>
			<td>500.00</td>
			<td>2020-01-23</td>
			<td>2020-02-23</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Яковлев Г.Р.</td>
			<td>М701АА</td>
			<td>Превышение скорости<br>
			(от 20 до 40)</td>
			<td> </td>
			<td>2020-01-12</td>
			<td> </td>
		</tr>
		<tr>
			<td>5</td>
			<td>Колесов С.П.</td>
			<td>К892АХ</td>
			<td>Превышение скорости<br>
			(от 20 до 40)</td>
			<td> </td>
			<td>2020-02-01</td>
			<td> </td>
		</tr>
		<tr>
			<td>6</td>
			<td>Баранов П.Е.</td>
			<td>Р523ВТ</td>
			<td>Превышение скорости<br>
			(от 40 до 60)</td>
			<td> </td>
			<td>2020-02-14</td>
			<td> </td>
		</tr>
		<tr>
			<td>7</td>
			<td>Абрамова К.А.</td>
			<td>О111АВ</td>
			<td>Проезд на<br>
			запрещающий сигнал</td>
			<td> </td>
			<td>2020-02-23</td>
			<td> </td>
		</tr>
		<tr>
			<td>8</td>
			<td>Яковлев Г.Р.</td>
			<td>Т330ТТ</td>
			<td>Проезд на<br>
			запрещающий сигнал</td>
			<td> </td>
			<td>2020-03-03</td>
			<td> </td>
		</tr>
	</tbody>
</table>

<details><summary><strong>Пояснение</strong></summary>

<ol>
	<li>Между формулировкой нарушения и открывающей скобкой ПРОБЕЛА НЕТ. Например, <em><strong>Превышение скорости(от 40 до 60)</strong></em>. </li>
	<li>Для занесения пустых значений в поля используется оператор <strong><code>Null</code></strong>.</li>
	<li>Номера машин записывать РУССКИМИ буквами.</li>
</ol>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1

Affected rows: 1

Affected rows: 1

Query result:
+---------------+--------------+----------------------------------+----------+------------------+--------------+
| name          | number_plate | violation                        | sum_fine | date_violation   | date_payment |
+---------------+--------------+----------------------------------+----------+------------------+--------------+
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12       | 2020-01-17   |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14       | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23       | 2020-02-23   |
| Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | NULL     | 2020-01-12       | NULL         |
| Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | NULL     | 2020-02-01       | NULL         |
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | NULL     | 2020-02-14       | NULL         |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | NULL     | 2020-02-23       | NULL         |
| Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | NULL     | 2020-03-03       | NULL         |
+---------------+--------------+----------------------------------+----------+------------------+--------------+
</code></pre>
</details>

<details><summary><strong>Важно</strong></summary>

<p>При создании запроса текст с названием нарушений <strong>нужно копировать из таблицы <em>Результат</em></strong>, а не из первой таблицы.</p>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу):</p>

<blockquote>
<p> В таблицу <code><strong>fine</strong></code> первые 5 строк уже занесены. Добавить в таблицу записи с ключевыми значениями 6, 7, 8.</p>
</blockquote>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li>вставка строк (<a href="https://stepik.org/lesson/297508/step/9?unit=279268" rel="noopener noreferrer nofollow">шаг</a>, <a href="https://stepik.org/lesson/305012/step/3?unit=287020" rel="noopener noreferrer nofollow">шаг</a>).</li>
</ul>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO fine (name, number_plate, violation, sum_fine, date_violation, date_payment)
VALUES ("Баранов П.Е.", "Р523ВТ", "Превышение скорости (от 40 до 60)", Null, '2020-02-14', Null),
("Абрамова К.А.", "О111АВ", "Проезд на запрещающий сигнал", NULL, "2020-02-23", NULL),
("Яковлев Г.Р.", "Т330ТТ", "Проезд на запрещающий сигнал", NULL, "2020-03-03", NULL);
</code></pre><h2>Внешнее соединение LEFT и RIGHT OUTER JOIN</h2>

<p>Оператор внешнего соединения <code>LEFT OUTER JOIN</code>  (можно использовать <code>LEFT JOIN</code>) соединяет две таблицы. Порядок таблиц для оператора важен, поскольку оператор не является симметричным.</p>

<pre><code class="language-sql">SELECT
 ...
FROM
    таблица_1 LEFT JOIN  таблица_2
    ON условие
...</code></pre>

<p>Результат запроса формируется так:</p>

<ol>
	<li>в результат включается внутреннее соединение (<code>INNER JOIN</code>) первой и второй таблицы в соответствии с условием;</li>
	<li>затем в результат добавляются те записи первой таблицы, которые не вошли во внутреннее соединение на шаге 1, для таких записей соответствующие поля второй таблицы заполняются значениями <code>NULL</code>.</li>
</ol>

<p>Соединение <code>RIGHT JOIN</code> действует аналогично, только в пункте 2 первая таблица меняется на вторую и наоборот.</p>

<p><strong>Пример</strong></p>

<p>Вывести название всех книг каждого автора, если книг некоторых авторов в данный момент нет на складе – вместо названия книги указать <code>Null</code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT name_author, title 
FROM author LEFT JOIN book
     ON author.author_id = book.author_id
ORDER BY name_author;     </code></pre>

<p>Результат:</p>

<pre><code class="language-sql">+------------------+-----------------------+
| name_author      | title                 |
+------------------+-----------------------+
| Булгаков М.А.    | Мастер и Маргарита    |
| Булгаков М.А.    | Белая гвардия         |
| Достоевский Ф.М. | Игрок                 |
| Достоевский Ф.М. | Идиот                 |
| Достоевский Ф.М. | Братья Карамазовы     |
| Есенин С.А.      | Стихотворения и поэмы |
| Есенин С.А.      | Черный человек        |
| Лермонтов М.Ю.   | NULL                  |
| Пастернак Б.Л.   | Лирика                |
+------------------+-----------------------+</code></pre>

<p>Так как в таблице<code><strong> book</strong></code> нет книг Лермонтова, напротив этой фамилии стоит <code>Null</code>.</p>

<h2>Задание</h2>

<p>Вывести все жанры, которые не представлены в книгах на складе.</p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/"></p>

<details><summary><strong>Пояснение</strong></summary>

<ol>
	<li>При использовании внешнего соединения названия книг и другие столбцы таблицы <code><strong>book </strong></code>для жанра тех книг, которого нет на складе, будут содержать значение <code>Null</code>.</li>
	<li>Для сравнения с пустым значением используется запись <code><strong>IS Null</strong></code> (написать <code><strong>= Null </strong></code>нельзя).</li>
</ol>
</details>

<p><em><strong>Текст задания (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p>Вывести все жанры, которые не представлены в книгах на складе.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------------+
| name_genre  |
+-------------+
| Приключения |
+-------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code class="language-sql">Таблица genre:
+----------+-------------+
| genre_id | name_genre  |
+----------+-------------+
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |
+----------+-------------+

Таблица author:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
+-----------+------------------+

Таблица book:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_genre
FROM genre LEFT OUTER JOIN book ON genre.genre_id = book.genre_id
WHERE book.title IS Null;

</code></pre><h2>Запросы на добавление, связанные таблицы</h2>

<p>Запросом на добавление можно добавить записи, отобранные с помощью запроса на выборку, который включает несколько таблиц:</p>

<pre><code class="language-sql">INSERT INTO таблица (список_полей)
SELECT список_полей_из_других_таблиц
FROM 
    таблица_1 
    ... JOIN таблица_2 ON ...
    ...</code></pre>

<p><strong>Пример</strong></p>

<p>В таблице <code><strong>supply</strong></code>  есть новые книги, которых на складе еще не было. Прежде чем добавлять их в таблицу <code><strong>book</strong></code>,  необходимо из таблицы <code><strong>supply</strong></code>отобрать новых авторов, если таковые имеются.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT name_author, supply.author
FROM 
    author 
    RIGHT JOIN supply ON author.name_author = supply.author;</code></pre>

<p>Поскольку таблица <code><strong>author</strong></code> и поле в таблице <code><strong>supply</strong></code> называются одинаково, желательно указывать полную ссылку на поле (<code><strong>supply.author</strong></code>), чтобы запрос был более читабельным.</p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+------------------+
| name_author      | author           |
+------------------+------------------+
| Булгаков М.А.    | Булгаков М.А.    |
| Достоевский Ф.М. | Достоевский Ф.М. |
| Есенин С.А.      | Есенин С.А.      |
| Пастернак Б.Л.   | Пастернак Б.Л.   |
| Лермонтов М.Ю.   | Лермонтов М.Ю.   |
| None             | Стивенсон Р.Л.   |
+------------------+------------------+</code></pre>

<p>Выполнив правое внутреннее соединение таблиц, получили значение<code> Null (None)</code> в поле <code><strong>name_author</strong></code> в строке того автора, которого нет в таблице<code><strong> author</strong></code>, в нашем случае это Стивенсон.</p>

<p>Теперь достаточно в запросе задать условие отбора, и список новых авторов готов для включения в таблицу <code><strong>author</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT supply.author
FROM 
    author 
    RIGHT JOIN supply on author.name_author = supply.author
WHERE name_author IS Null;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+----------------+
| author         |
+----------------+
| Стивенсон Р.Л. |
+----------------+</code></pre>

<h2><strong>Задание</strong></h2>

<p>Включить новых авторов в таблицу <code><strong>author</strong></code> с помощью запроса на добавление, а затем вывести все данные из таблицы <code><strong>author</strong></code>.  Новыми считаются авторы, которые есть в таблице <code><strong>supply</strong></code>, но нет в таблице <code><strong>author</strong></code>.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1

Query result:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |
+-----------+------------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code>Таблица book
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+
Таблица supply
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 12     |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
Таблица author                          Таблица genre
+-----------+------------------+	+----------+-------------+			
| author_id | name_author      |	| genre_id | name_genre  |			
+-----------+------------------+	+----------+-------------+			
| 1         | Булгаков М.А.    |	| 1        | Роман       |			
| 2         | Достоевский Ф.М. |	| 2        | Поэзия      |			
| 3         | Есенин С.А.      |	| 3        | Приключения |			
| 4         | Пастернак Б.Л.   |	+----------+-------------+			
| 5         | Лермонтов М.Ю.   |							
+-----------+------------------+							</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO author (author_id, name_author)
SELECT supply_id AS author_id, author AS name_author
FROM supply LEFT JOIN author ON supply.author = author.name_author
WHERE name_author IS Null;
SELECT * FROM author;
</code></pre><h2>Задание</h2>

<p>Создать новый заказ для Попова Ильи. Его комментарий для заказа: «Связаться со мной по вопросу доставки».</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/410c7a2e-696d-4865-b9b6-a176350d5cbd/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/4?unit=287020" rel="noopener noreferrer nofollow">добавление записей</a></u>;</li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/310417/step/2?unit=292723" rel="noopener noreferrer nofollow">добавление константы</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p> Создать новый заказ для Попова Ильи. Его комментарий для заказа: «Связаться со мной по вопросу доставки».</p>

<p><strong>Важно</strong>! В решении нельзя использоваться <strong>VALUES</strong> и делать отбор по <code><strong>client_id</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1

Query result (выборка из таблицы buy):
+--------+---------------------------------------+-----------+
| buy_id | buy_description                       | client_id |
+--------+---------------------------------------+-----------+
| 1      | Доставка только вечером               | 1         |
| 2      | NULL                                  | 3         |
| 3      | Упаковать каждую книгу по отдельности | 2         |
| 4      | NULL                                  | 1         |
| 5      | Связаться со мной по вопросу доставки | 5         |
+--------+---------------------------------------+-----------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц(перед выполнением шага)</strong></summary> <img alt="" height="878" name="112.png" src="https://ucarecdn.com/9400701b-01aa-4581-a938-a5c665e55bd3/" width="711"></details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO buy (buy_description, client_id)
SELECT 'Связаться со мной по вопросу доставки', client_id
FROM client
WHERE name_client = 'Попов Илья';
</code></pre><h2>Задание</h2>

<p>Вывести образовательные программы, на которые для поступления необходим предмет «Информатика». Программы отсортировать в обратном алфавитном порядке.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8b1f2861-3ed6-4533-9ed0-10fde1ec0f92/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p> Вывести образовательные программы, на которые для поступления необходим предмет «Информатика». Программы отсортировать в обратном алфавитном порядке.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------------------------------------+
| name_program                        |
+-------------------------------------+
| Прикладная математика и информатика |
| Математика и компьютерные науки     |
+-------------------------------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>program</code>, <code>subject</code>, <code>program_subject</code></strong></summary>

<pre><code class="language-sql">таблица program
+------------+-------------------------------------+---------------+------+
| program_id | name_program                        | department_id | plan |
+------------+-------------------------------------+---------------+------+
| 1          | Прикладная математика и информатика | 2             | 1    |
| 2          | Математика и компьютерные науки     | 2             | 2    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |
+------------+-------------------------------------+---------------+------+
таблица subject
+------------+--------------+
| subject_id | name_subject |
+------------+--------------+
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |
+------------+--------------+
таблица program_subject
+--------------------+------------+------------+------------+
| program_subject_id | program_id | subject_id | min_result |
+--------------------+------------+------------+------------+
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |
+--------------------+------------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_program
FROM program INNER JOIN program_subject USING(program_id) INNER JOIN subject USING(subject_id)
WHERE name_subject = 'Информатика'
ORDER BY name_program DESC

</code></pre><h2>Задание</h2>

<p>Из таблицы <code><strong>applicant</strong></code>, созданной на предыдущем шаге, удалить записи, если абитуриент на выбранную образовательную программу не набрал минимального балла хотя бы по одному предмету (использовать <a href="https://stepik.org/lesson/310418/step/11?unit=292724" rel="noopener noreferrer nofollow">запрос</a> из предыдущего урока).</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/823d0242-0982-4087-b52b-94aabc9bbb94/"></p>

<p>Таблица <code><strong>applicant</strong></code>:</p>

<p><img alt="" src="https://ucarecdn.com/de0838ba-43ec-4cf8-a237-fad5de177b5a/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Возможный вариант решения - использование <code><strong>DELETE</strong></code> совместно с <code><strong>USING</strong></code>, подробно рассмотрено на этом <a href="https://stepik.org/lesson/308887/step/8?unit=291013" rel="noopener noreferrer nofollow">шаге</a>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li>удаление строк из таблицы (<u><a href="https://stepik.org/lesson/305012/step/9?unit=287020" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/308887/step/8?unit=291013" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a></u></li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Из таблицы <code><strong>applicant</strong></code>,  созданной на предыдущем шаге, удалить записи, если абитуриент на выбранную образовательную программу не набрал минимального балла хотя бы по одному предмету (использовать <a href="https://stepik.org/lesson/310418/step/11?unit=292724" rel="noopener noreferrer nofollow">запрос</a> из предыдущего урока).</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2

Query result:
+------------+-------------+------+
| program_id | enrollee_id | itog |
+------------+-------------+------+
| 1          | 3           | 230  |
| 1          | 2           | 226  |
| 1          | 1           | 213  |
| 2          | 6           | 276  |
| 2          | 3           | 230  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 238  |
| 3          | 5           | 192  |
| 4          | 6           | 270  |
| 4          | 3           | 242  |
| 4          | 5           | 192  |
+------------+-------------+------+
Affected rows: 12</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">DELETE FROM applicant
WHERE itog NOT IN (SELECT SUM(result) As Itog
FROM enrollee INNER JOIN program_enrollee USING(enrollee_id)
INNER JOIN program USING(program_id)
INNER JOIN program_subject USING(program_id)
INNER JOIN subject USING(subject_id)
INNER JOIN enrollee_subject ON enrollee.enrollee_id = enrollee_subject.enrollee_id AND subject.subject_id = enrollee_subject.subject_id
WHERE result >= min_result
GROUP BY program.program_id, enrollee.enrollee_id
HAVING COUNT(*) > 2);

SELECT * FROM applicant</code></pre><h2>Задание</h2>

<p>Вывести, сколько попыток сделали студенты по каждой дисциплине, а также средний результат попыток, который округлить до 2 знаков после запятой. Под результатом попытки понимается процент правильных ответов на вопросы теста, который занесен в столбец <code><strong>result</strong></code>.  В результат включить название дисциплины, а также вычисляемые столбцы <code><strong>Количество</strong></code> и <code><strong>Среднее</strong></code>. Информацию вывести по убыванию средних результатов.</p>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/d8715483-b850-4ce8-8e2d-12ac8ba18d0c/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Чтобы вывести дисциплину, тестирование по которой никто не проходил, использовать оператор <a href="https://stepik.org/lesson/308886/step/3?unit=291012" rel="noopener noreferrer nofollow">внешнего соединения</a>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/3?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li>групповые функции (<u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297515/step/4?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу)</p>

<blockquote>
<p>Вывести, сколько попыток сделали студенты по каждой дисциплине, а также средний результат попыток, который округлить до 2 знаков после запятой. Под результатом попытки понимается процент правильных ответов на вопросы теста, который занесен в столбец <code><strong>result</strong></code>.  В результат включить название дисциплины, а также вычисляемые столбцы <code><strong>Количество</strong></code> и <code><strong>Среднее</strong></code>. Информацию вывести по убыванию средних результатов.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------------------+------------+---------+
| name_subject      | Количество | Среднее |
+-------------------+------------+---------+
| Основы SQL        | 4          | 58.25   |
| Основы баз данных | 3          | 55.67   |
| Физика            | 0          | NULL    |
+-------------------+------------+---------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц <code>attempt</code> и <code>subject</code></strong></summary>

<pre><code class="language-sql">таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
таблица subject
+------------+-------------------+
| subject_id | name_subject      |
+------------+-------------------+
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |
+------------+-------------------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_subject, COUNT(result) as Количество, ROUND(AVG(result), 2) AS Среднее
FROM subject LEFT JOIN attempt ON subject.subject_id=attempt.subject_id
GROUP BY name_subject
ORDER BY Среднее DESC;

</code></pre><h2>Задание </h2>

<p>Случайным образом выбрать три вопроса (<a href="https://stepik.org/lesson/310421/step/7?unit=292727" rel="noopener noreferrer nofollow">запрос</a>) по дисциплине, тестирование по которой собирается проходить студент, занесенный в таблицу <code><strong>attempt</strong></code> последним, и добавить их в таблицу<strong> </strong><code><strong>testing</strong></code>.<strong> </strong><code><strong>id</strong></code> последней попытки получить как максимальное значение<strong> </strong><code><strong>id</strong></code> из таблицы <code><strong>attempt</strong></code>.</p>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/c3b8ce24-eaaa-48b7-96c6-6c57dc6e48ca/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Обозначенная связь показывает способ соединения таблиц.</p>
</details>

<p><strong>Корректируемая таблица:</strong></p>

<p><img alt="" src="https://ucarecdn.com/58cd697f-3a21-4d89-83db-c8bba6328cdf/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/4?unit=287020" rel="noopener noreferrer nofollow">добавление записей</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297514/step/2?unit=279274" rel="noopener noreferrer nofollow">вложенные запросы в условии отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/4?unit=279275" rel="noopener noreferrer nofollow">групповые функции</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/310421/step/7?auth=login&amp;unit=292727" rel="noopener noreferrer nofollow">сортировка в случайном порядке</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297510/step/5?auth=login&amp;unit=279270" rel="noopener noreferrer nofollow">ограничение вывода</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p> Случайным образом выбрать три вопроса (<a href="https://stepik.org/lesson/310421/step/7?unit=292727" rel="noopener noreferrer nofollow">запрос</a>) по дисциплине, тестирование по которой собирается проходить студент, занесенный в таблицу <code><strong>attempt</strong></code> последним, и добавить их в таблицу<strong> </strong><code><strong>testing.</strong></code><code><strong>id</strong></code> последней попытки получить как максимальное значение<strong> </strong><code><strong>id</strong></code> из таблицы <code><strong>attempt</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<p>Примечание: при выполнении запроса номера вставленных вопросов будут отличаться от образца, поскольку выбираются случайным образом.</p>

<pre><code class="language-sql">Affected rows: 3

Query result:
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
| 22         | 8          | 6           | NULL      |
| 23         | 8          | 8           | NULL      |
| 24         | 8          | 7           | NULL      |
+------------+------------+-------------+-----------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>question</code>, <code>attempt</code>, <code>testing</code>(перед выполнением шага)</strong></summary>

<pre><code class="language-sql">таблица question
+-------------+------------------------------------------------------------+------------+
| question_id | name_question                                              | subject_id |
+-------------+------------------------------------------------------------+------------+
| 1           | Запрос на выборку начинается с ключевого слова:            | 1          |
| 2           | Условие, по которому отбираются записи, задается после...  | 1          |
| 3           | Для сортировки используется:                               | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:       | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:   | 1          |
| 6           | База данных - это:                                         | 2          |
| 7           | Отношение - это:                                           | 2          |
| 8           | Концептуальная модель используется для                     | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?        | 2          |
+-------------+------------------------------------------------------------+------------+
таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | NULL   |
+------------+------------+------------+--------------+--------+
таблица testing
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
+------------+------------+-------------+-----------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO testing(attempt_id, question_id, answer_id)
SELECT attempt_id, question_id, Null
FROM question INNER JOIN attempt USING(subject_id)
WHERE subject_id = (SELECT subject_id FROM attempt WHERE attempt_id = (SELECT MAX(attempt_id) FROM attempt)) AND attempt_id = (SELECT MAX(attempt_id) FROM attempt)
ORDER BY RAND()
LIMIT 3;

SELECT * FROM testing;
</code></pre><h2>Задание</h2>

<p><em><strong>автор -</strong> Анатолий Алексеев</em></p>

<p>Вывести всю информацию из таблицы <strong>book</strong>, упорядоченную по возрастанию длины названия книги.</p>

<p><strong> Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>

<p><strong>Пояснение. </strong></p>

<ol>
	<li>Для вычисления длины тестовой строки используется функция<code> l<strong>ength().</strong></code></li>
	<li>Сортировку можно осуществлять не только по названию столбца, но и по любому выражению.</li>
</ol>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Вывести всю информацию из таблицы <strong>book</strong>, упорядоченную по возрастанию длины названия книги.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/218555543?etk=WzI0MSwxNzA1MzA0OV0.1jRYHe.tJO-cu82zfgAgJsR6M9zbsksBA0" rel=" noopener noreferrer nofollow" target="_blank">Артём Чепк</a> </p>

<p>Создать новую таблицу <code><strong>store</strong></code>, в которую занести данные из таблиц <code><strong>book</strong></code> и <code><strong>supply</strong></code>, при условии, что количество книг будет больше среднего количества книг по двум таблицам; если книга есть в обеих таблицах, то стоимость выбрать большую из двух. Отсортировать данные из таблицы их по имени автора в алфавитном порядке и по убыванию цены. Вывести данные из полученной таблицы.</p>

<p><strong>Структура таблиц:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"><img alt="" src="https://ucarecdn.com/c921a09f-eb1b-4810-84fe-96a07c44fe39/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+--------+--------+
| title                 | author           | price  | amount |
+-----------------------+------------------+--------+--------+
| Белая гвардия         | Булгаков М.А.    | 540.50 | 12     |
| Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| Идиот                 | Достоевский Ф.М. | 460.00 | 13     |
| Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+-----------------------+------------------+--------+--------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Создать новую таблицу <code><strong>store</strong></code>, в которую занести данные из таблиц <code><strong>book</strong></code> и <code><strong>supply</strong></code>, при условии, что количество книг будет больше среднего количества книг по двум таблицам; если книга есть в обеих таблицах, то стоимость выбрать большую из двух. Отсортировать данные из таблицы их по имени автора в алфавитном порядке и по убыванию цены. Вывести данные из полученной таблицы.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p><em><strong>автор -</strong></em><a href="https://stepik.org/users/76913457" rel="noopener noreferrer nofollow">Лариса Фернандес</a></p>

<p>Для клиентов у которых сумма заказов выше средней по суммам заказов клиентов (общей стоимости всех заказов клиентов), вывести имя, общую сумму всех заказов, количество заказов, количество заказанных книг. Этим клиентам мы предложим специальную программу лояльности! Информацию отсортировать по имени клиентов ( в алфавитном порядке).</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/ba3cf5a2-97d6-4772-94fe-c4969b827a0d/"></p>

<p>Результат:</p>

<pre><code class="language-sql">+---------------+---------------------+---------------+------------+
| name_client   | Общая_сумма_заказов | Заказов_всего | Книг_всего |
+---------------+---------------------+---------------+------------+
| Абрамова Катя | 2131.49             | 1             | 4          |
| Баранов Павел | 2291.89             | 2             | 4          |
+---------------+---------------------+---------------+------------+
</code></pre>

<p><strong>Пояснение ( от </strong>Максима Казакова<strong>).</strong> Среднюю стоимость заказов считать как группировка  сумм по заказам (<code><strong>price * amount</strong></code>), а затем среднее из этих сумм.</p>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Для клиентов у которых сумма заказов выше средней по суммам заказов клиентов (общей стоимости всех заказов клиентов), вывести имя, общую сумму всех заказов, количество заказов, количество заказанных книг. Этим клиентам мы предложим специальную программу лояльности! Информацию отсортировать по имени клиентов ( в алфавитном порядке).</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><p>Еще одна возможность улучшить навигацию по курсу - это реализация поиска шагов по ключевым словам. Для этого необходимо создать таблицу с терминами <strong><code>keyword</code></strong>, а затем связать ее с таблицей <code><strong>step</strong></code> через вспомогательную таблицу <code><strong>step_keyword</strong></code>. Каждая запись этой таблицы - это <code><strong>id</strong></code> шага и<code><strong> id</strong></code> встречающегося на этом шаге ключевого слова.</p>

<h2>Задание</h2>

<p>Заполнить таблицу <strong><code>step_keyword</code> </strong>следующим образом: если ключевое слово есть в названии шага, то включить в <code><strong>step_keyword</strong></code> строку с <code><strong>id</strong></code> шага и <code><strong>id</strong></code> ключевого слова. </p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/ac7f46e6-bc33-4aa9-9240-c35f638eee4f/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>1. Чтобы проверить, есть ли ключевое слово в заголовке шага, можно использовать функцию:</p>

<pre><code class="language-sql">INSTR(string_1, string_2)</code></pre>

<p>которая возвращает позицию первого вхождения <code><strong>string_2</strong></code> в <code><strong>string_1</strong></code>. Если вхождения нет - результат функции 0.</p>

<p>2. Обратите внимание, что некоторые ключевые слова, например <code><strong>IN</strong></code>, входят в <code><strong>INNER</strong></code> и <code><strong>JOIN</strong></code>. Нужно учитывать только отдельные слова, которые разделены в названии шага либо <strong>пробелом</strong>, либо <strong>запятой</strong>, либо <strong>открывающей скобкой</strong>.</p>

<p>3. Это задание можно решить с помощью регулярных выражений (<a href="https://stepik.org/lesson/404275/step/3?discussion=2970632&amp;unit=393473" rel="noopener noreferrer nofollow">комментарий </a> Алексея Карелина) или с помощью функции <code><strong>REGEXP_INSTR</strong></code> (<a href="https://stepik.org/lesson/404275/step/3?discussion=2888797&amp;unit=393473" rel="noopener noreferrer nofollow">комментарий</a> Yury Popov).</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/4?unit=287020" rel="noopener noreferrer nofollow">добавление записей</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><em><strong>Текст запроса (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p>Заполнить таблицу <strong><code>step_keyword</code> </strong>следующим образом: если ключевое слово есть в названии шага, то включить в <code><strong>step_keyword</strong></code> строку с<code><strong> id </strong></code>шага и <code><strong>id </strong></code>ключевого слова. </p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<p>Примечание: <strong>это не таблица <code>step_keyword</code> , а запрос, который показывает результат на основе 3-х таблиц, чтобы визуально проверить, правильно ли сформирована таблица</strong>.</p>

<pre><code class="language-sql">ffected rows: 27

Query result:
+--------------------------------------------------------------+--------------+
| step_name                                                    | keyword_name |
+--------------------------------------------------------------+--------------+
| Вложенный запрос после SELECT                                | SELECT       |
| Соединение INNER JOIN                                        | INNER        |
| Внешнее соединение LEFT и RIGHT OUTER JOIN                   | LEFT         |
| Внешнее соединение LEFT и RIGHT OUTER JOIN                   | RIGHT        |
| Внешнее соединение LEFT и RIGHT OUTER JOIN                   | OUTER        |
| Соединение INNER JOIN                                        | JOIN         |
| Внешнее соединение LEFT и RIGHT OUTER JOIN                   | JOIN         |
| Перекрестное соединение CROSS JOIN                           | JOIN         |
| Перекрестное соединение CROSS JOIN                           | CROSS        |
| Выборка данных по условию, групповые функции, WHERE и HAVING | WHERE        |
| Выборка данных по условию, групповые функции, WHERE и HAVING | HAVING       |
| Выборка данных, групповые функции SUM и COUNT                | SUM          |
| Выборка данных, групповые функции MIN, MAX и AVG             | AVG          |
| Выборка данных c вычислением, групповые функции, AVG         | AVG          |
| Выборка данных, групповые функции SUM и COUNT                | COUNT        |
| Выборка данных, групповые функции MIN, MAX и AVG             | MIN          |
| Выборка данных по условию, групповые функции, MIN            | MIN          |
| Выборка данных, групповые функции MIN, MAX и AVG             | MAX          |
| Операция соединение, использование USING()                   | USING        |
| Задание. Работа с архивной таблицей, оператор UNION, часть 1 | UNION        |
| Задание. Работа с архивной таблицей, оператор UNION, часть 2 | UNION        |
| Вложенный запрос, операторы ANY и ALL                        | ALL          |
| Вложенный запрос, операторы ANY и ALL                        | ANY          |
| Выборка данных, операторы BETWEEN, IN                        | IN           |
| Вложенный запрос, оператор IN                                | IN           |
| Выборка данных, оператор LIKE                                | LIKE         |
| Выборка данных, операторы BETWEEN, IN                        | BETWEEN      |
+--------------------------------------------------------------+--------------+</code></pre>

<p>В результате выполнения запроса таблица <code><strong>step_keyword</strong></code>  имеет вид:</p>

<pre><code class="language-sql">Affected rows: 27

Query result:
+---------+------------+
| step_id | keyword_id |
+---------+------------+
| 38      | 1          |
| 81      | 3          |
| 82      | 4          |
| 82      | 5          |
| 82      | 6          |
| 81      | 7          |
| 82      | 7          |
| 83      | 7          |
| 83      | 8          |
| 47      | 10         |
| 47      | 11         |
| 42      | 15         |
| 43      | 16         |
| 44      | 16         |
| 42      | 17         |
| 43      | 18         |
| 46      | 18         |
| 43      | 19         |
| 88      | 26         |
| 112     | 27         |
| 113     | 27         |
| 37      | 28         |
| 37      | 29         |
| 18      | 30         |
| 36      | 30         |
| 19      | 31         |
| 18      | 32         |
+---------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO step_keyword(step_id, keyword_id)
SELECT step_id, keyword_id
FROM keyword CROSS JOIN step
WHERE step_name REGEXP CONCAT('\\b', keyword_name, '\\b')
ORDER BY keyword_id;
SELECT * FROM step_keyword;</code></pre><h2>Выборка отдельных столбцов</h2>

<p>Для того чтобы отобрать данные из определенных столбцов таблицы используется SQL запрос следующей структуры: </p>

<ul>
	<li>ключевое слово <code><strong>SELECT</strong></code> ; </li>
	<li>список столбцов таблицы через запятую; </li>
	<li>ключевое слово<code><strong> FROM</strong></code> ; </li>
	<li>имя таблицы.</li>
</ul>

<p>Результатом является таблица, в которую включены все данные из указанных после <code><strong>SELECT</strong></code> столбцов исходной таблицы.</p>

<p><strong>Пример</strong></p>

<p>Выбрать названия книг и их количества из таблицы <code><strong>book</strong></code> .</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, amount FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+--------+ 
|title                  | amount |
+-----------------------+--------+ 
| Мастер и Маргарита    | 3      | 
| Белая гвардия         | 5      | 
| Идиот                 | 10     | 
| Братья Карамазовы     | 2      | 
| Стихотворения и поэмы | 15     |
+-----------------------+--------+</code></pre>

<p><strong>Пояснение. </strong>Чтобы посмотреть, как работает запрос примера, скопируйте его код в окно для ввода и нажмите на черную кнопку <strong>Запустить код</strong>. После запуска выведется результат запроса, который можно сравнить с приведенным образцом. Задание</p>

<h2>Задание</h2>

<p>Выбрать авторов, название книг и их цену из таблицы <code><strong>book</strong></code>.</p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------------------+--------+
| author           | title                 | price  |
+------------------+-----------------------+--------+
| Булгаков М.А.    | Мастер и Маргарита    | 670.99 |
| Булгаков М.А.    | Белая гвардия         | 540.50 |
| Достоевский Ф.М. | Идиот                 | 460.00 |
| Достоевский Ф.М. | Братья Карамазовы     | 799.01 |
| Есенин С.А.      | Стихотворения и поэмы | 650.00 |
+------------------+-----------------------+--------+
Affected rows: 5</code></pre>
<details><summary><strong>Структура и наполнение таблицы <code>book</code><strong>:</strong></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, title, price FROM book;




</code></pre><h2>Выборка новых столбцов и присвоение им новых имен</h2>

<p>Для того чтобы отобрать данные из определенных столбцов таблицы и одновременно задать столбцам новые имена используется SQL запрос следующей структуры: </p>

<ul>
	<li>ключевое слово <code><strong>SELECT </strong></code>; </li>
	<li>имя столбца;</li>
	<li>ключевое слово <code><strong>AS</strong></code> ; </li>
	<li>новое название столбца (можно русскими буквами), но это должно быть одно слово, если название состоит из двух слов – соединяйте их подчеркиванием, например, <code><strong>Количество_книг </strong></code>; </li>
	<li>запятая; </li>
	<li>имя столбца; </li>
	<li>.... </li>
	<li>ключевое слово<code><strong> FROM</strong></code> ; </li>
	<li>имя таблицы.</li>
</ul>

<p>В одном запросе можно использовать и имена столбцов из таблицы, и новые названия.</p>

<p>Результатом является таблица, в которую включены все данные из указанных после <code><strong>SELECT</strong></code> столбцов исходной таблицы. Каждому столбцу присваивается новое имя, заданное после<code><strong> AS</strong></code>, или столбец получает имя столбца исходной таблицы, если <code><strong>AS </strong></code>отсутствует.</p>

<p><strong>Пример</strong></p>

<p>Выбрать все названия книг и их количества из таблицы<code><strong> book</strong></code> , для столбца <code><strong>title </strong></code>задать новое имя <code><strong>Название</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title AS Название, amount 
FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+--------+
| Название              | amount |
+-----------------------+--------+ 
| Мастер и Маргарита    | 3      |
| Белая гвардия         | 5      | 
| Идиот                 | 10     |
| Братья Карамазовы     | 2      |
| Стихотворения и поэмы | 15     |
+-----------------------+--------+</code></pre>

<h2><strong>Задание</strong></h2>

<p>Выбрать названия книг и авторов из таблицы <code><strong>book</strong></code>, для поля <code><strong>title </strong></code>задать имя(псевдоним) <strong>Название</strong>, для поля <code><strong>author</strong></code> –  <strong>Автор</strong>. </p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+
| Название              | Автор            |
+-----------------------+------------------+
| Мастер и Маргарита    | Булгаков М.А.    |
| Белая гвардия         | Булгаков М.А.    |
| Идиот                 | Достоевский Ф.М. |
| Братья Карамазовы     | Достоевский Ф.М. |
| Стихотворения и поэмы | Есенин С.А.      |
+-----------------------+------------------+
Affected rows: 5</code></pre>

<details><summary><strong>Структура и наполнение таблицы <code>book</code><strong>:</strong></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT title AS Название, author AS Автор
FROM book




</code></pre><h2>Выборка данных, групповые функции MIN, MAX и AVG</h2>

<p>К групповым функциям SQL относятся: <code>MIN()</code>, <code>MAX()</code> и <code>AVG()</code>, которые вычисляют минимальное, максимальное и среднее значение элементов столбца, относящихся к группе.</p>

<p><strong>Пример</strong></p>

<p>Вывести минимальную цену книги каждого автора</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT author, MIN(price) AS min_price
FROM book
GROUP BY author;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------+
| author           | min_price |
+------------------+-----------+
| Булгаков М.А.    | 540.50    |
| Достоевский Ф.М. | 460.00    |
| Есенин С.А.      | 650.00    |
+------------------+-----------+</code></pre>

<h2>Задание</h2>

<p>Вывести фамилию и инициалы автора, минимальную, максимальную и среднюю цену книг каждого автора . Вычисляемые столбцы назвать <strong>Минимальная_цена, Максимальная_цена</strong> и<strong> Средняя_цена</strong> соответственно.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------------+------------------+-------------------+--------------+
| author           | Минимальная_цена | Максимальная_цена | Средняя_цена |
+------------------+------------------+-------------------+--------------+
| Булгаков М.А.    | 540.50           | 670.99            | 605.745000   |
| Достоевский Ф.М. | 460.00           | 799.01            | 579.836667   |
| Есенин С.А.      | 650.00           | 650.00            | 650.000000   |
+------------------+------------------+-------------------+--------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, MIN(price) as Минимальная_цена, MAX(price) as Максимальная_цена, AVG(price) as Средняя_цена
FROM book
GROUP BY author



</code></pre><h2>Вложенный запрос, оператор IN</h2>

<p>Вложенный запрос может возвращать несколько значений одного столбца.  Оператор <code>IN</code> определяет, совпадает ли указанное в логическом выражении значение с одним из значений, содержащихся во вложенном запросе ,  при этом логическое выражение получает значение истина. Оператор <code>NOT IN</code> выполняет обратное действие – выражение истинно, если значение не содержится во вложенном запросе.</p>

<p><strong>Пример</strong></p>

<p>Вывести информацию о книгах тех авторов, общее количество экземпляров книг которых не менее 12.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, amount, price
FROM book
WHERE author IN (
        SELECT author 
        FROM book 
        GROUP BY author 
        HAVING SUM(amount) &gt;= 12
      );</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+--------+--------+
| title                 | author           | amount | price  |
+-----------------------+------------------+--------+--------+
| Идиот                 | Достоевский Ф.М. | 10     | 460.00 |
| Братья Карамазовы     | Достоевский Ф.М. | 3      | 799.01 |
| Игрок                 | Достоевский Ф.М. | 10     | 480.50 |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 650.00 |
+-----------------------+------------------+--------+--------+</code></pre>

<p>Вложенный запрос отбирает двух авторов (Достоевского и Есенина). А в основном запросе для каждой записи таблицы <code><strong>book</strong></code>  проверяется, входит ли автор книги в отобранный список, если входит - информация о книге включается в запрос.</p>

<h2><strong>Задание</strong></h2>

<p>Вывести информацию (автора, книгу и количество) о тех книгах, количество экземпляров которых в таблице <code><strong>book</strong></code> не дублируется.</p>

<details><summary><strong>Пояснение к заданию</strong></summary>

<p>В таблице <strong><code>book</code></strong> в столбце <strong><code>amount</code></strong> хранится количество экземпляров каждой книги:</p>

<pre><code class="language-sql">+-----------------------+--------+
| title                 | amount |
+-----------------------+--------+
| Мастер и Маргарита    | 3      |
| Белая гвардия         | 5      |
| Идиот                 | 10     |
| Братья Карамазовы     | 3      |
| Игрок                 | 10     |
| Стихотворения и поэмы | 15     |
+-----------------------+--------+</code></pre>

<p>В соответствии с этой таблицей:</p>

<ul>
	<li>количество экземпляров книг "Мастер и Маргарита" и "Братья Карамазовы" одинаково и равно 3 (так как число 3 встречается в таблице два раза, книги с таким количеством не подходят под условие);</li>
	<li>количество экземпляров книг "Идиот" и "Игрок" тоже одинаково и равно 10 (не подходят под условие);</li>
	<li>количество экземпляров книги "Белая гвардия равно" 5, при этом в таблице нет других книг, количество экземпляров которых равно 5, следовательно, эта книга подходит под условие задачи (так как количество экземпляров 5 в таблице не дублируется);</li>
	<li>количество экземпляров книги "Стихотворение и поэмы"  - 15, в таблице нет других книг, количество экземпляров которых тоже равно 15, следовательно, и эта книга подходит под условие.</li>
</ul>

<p>Таким образом, необходимо вывести те строки таблицы, у которых числа в столбце <code><strong>amount</strong></code> не повторяются.</p>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------+-----------------------+--------+
| author        | title                 | amount |
+---------------+-----------------------+--------+
| Булгаков М.А. | Белая гвардия         | 5      |
| Есенин С.А.   | Стихотворения и поэмы | 15     |
+---------------+-----------------------+--------+</code></pre>
</details>

<details><summary><strong>Пояснение к решению</strong></summary>

<p>Во вложенном запросе отберите те значения столбца <code><strong>amount</strong></code>, количество которых, вычисленное с помощью функции <code><strong>count()</strong></code>, равно 1. </p>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, title, amount
FROM book
WHERE amount IN (SELECT amount FROM book GROUP BY amount HAVING COUNT(amount) = 1);


</code></pre><h2>Добавление записей из другой таблицы</h2>

<p>С помощью запроса на добавление можно не только добавить в таблицу конкретные значения (список <code>VALUES</code>), но и записи из другой таблицы, отобранные с помощью запроса на выборку.  В этом случае вместо раздела <code>VALUES</code> записывается запрос на выборку, начинающийся с <code>SELECT</code>.  В нем можно использовать <code>WHERE, GROUP BY, ORDER BY</code>.</p>

<p>Правила соответствия между полями таблицы и вставляемыми значениями из запроса:</p>

<ol>
	<li>количество полей в таблице и количество полей в запросе должны совпадать;</li>
	<li>должно существовать прямое соответствие между позицией одного и того же элемента в обоих списках, поэтому первый столбец запроса должен относиться к первому столбцу в списке столбцов таблицы, второй – ко второму столбцу и т.д.</li>
	<li> типы столбцов запроса должны быть совместимы с типами данных соответствующих столбцов таблицы ( целое число можно занести в поле типа <code>DECIMAL</code>, обратная операция – недопустима).</li>
</ol>

<p><strong>Пример</strong></p>

<p>Занести все книги из таблицы <code><strong>supply</strong></code> в таблицу <code><strong>book</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">INSERT INTO book (title, author, price, amount) 
SELECT title, author, price, amount 
FROM supply;

SELECT * FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 4
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |
| 7       | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 8       | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 9       | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
+---------+-----------------------+------------------+--------+--------+
Affected rows: 9</code></pre>

<p>С помощью этого запроса в таблицу <code><strong>book</strong></code> включены все книги из <strong><code>supply</code></strong>, даже те, которые в <code><strong>book </strong></code>уже есть («Белая гвардия» и «Идиот»). В результате в таблице одна и та же книга, например «Белая гвардия», имеет код 2 и 8. Для реляционной модели это нежелательная ситуация. Устранить эту проблему можно с помощью вложенных запросов, которые будут рассмотрены в следующем шаге.</p>

<h2>Задание</h2>

<p>Добавить из таблицы <code><strong>supply</strong></code> в таблицу <code><strong>book</strong></code>, все книги, кроме книг, написанных Булгаковым М.А. и Достоевским Ф.М.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |
| 7       | Черный человек        | Есенин С.А.      | 570.20 | 6      |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details>

<details><summary><strong>Пояснение</strong></summary>

<p>Задание нужно выполнить без вложенных запросов.</p>
</details>

<details><summary><strong>Структура и наполнение таблиц <code>book</code> и <code>supply</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>

<pre><code>+-----------+----------------+------------------+--------+--------+
| supply_id | title          | author           | price  | amount |
+-----------+----------------+------------------+--------+--------+
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |
+-----------+----------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO book (title, author, price, amount)
SELECT title, author, price, amount
FROM supply
WHERE author NOT IN ('Булгаков М.А.', 'Достоевский Ф.М.');
</code></pre><h2>Задание</h2>

<p>Для каждого города посчитать, сколько раз сотрудники в нем были.  Информацию вывести в отсортированном в алфавитном порядке по названию городов. Вычисляемый столбец назвать <strong>Количество</strong>.<strong> </strong></p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------+------------+
| city            | Количество |
+-----------------+------------+
| Владивосток     | 3          |
| Воронеж         | 1          |
| Москва          | 7          |
| Новосибирск     | 4          |
| Санкт-Петербург | 3          |
| Томск           | 2          |
+-----------------+------------+</code></pre>

<p> </p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</li>
	<li><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>trip</strong></code></strong></summary>

<pre><code>+---------+---------------+-----------------+----------+------------+------------+
| trip_id | name          | city            | per_diem | date_first | date_last  |
+---------+---------------+-----------------+----------+------------+------------+
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |
+---------+---------------+-----------------+----------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT city, COUNT(city) AS Количество
FROM trip
GROUP BY city
ORDER BY city ASC;

</code></pre><h2>Использование временного имени таблицы (алиаса)</h2>

<p><em>Теоретический материал для этого шага подготовлен </em><a href="https://stepik.org/users/15955624" rel="noopener noreferrer nofollow">Михаилом Захаров</a>ым <em>. Большое ему спасибо!</em></p>

<p>Чтобы не писать название таблицы каждый раз, удобно использовать алиасы.</p>

<p>Алиас, это псевдоним, который мы присваивали столбцам после ключевого слова <code><strong>AS</strong></code>(<a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">шаг</a>).  Алиасы так же можно использовать и для таблиц. Это становится актуальным, при увеличении числа используемых таблиц, их иногда может быть и 5 и 10 и более. Псевдонимы помогают сделать запрос чище и читабельнее.</p>

<p>Для присваивания псевдонима существует 2 варианта: </p>

<ul>
	<li>с использованием ключевого слова <code><strong>AS</strong></code> </li>
</ul>

<pre><code class="language-sql">FROM fine AS f, traffic_violation AS tv</code></pre>

<ul>
	<li>а так же и без него</li>
</ul>

<pre><code class="language-sql">FROM fine f, traffic_violation tv</code></pre>

<p>После присвоения таблице алиаса, он используется во всех разделах запроса, в котором алиас задан. Например:</p>

<pre><code>WHERE f.violation = tv.violation</code></pre>

<p><strong>Пример</strong></p>

<p>Для тех, кто уже оплатил штраф, вывести информацию о том, изменялась ли стандартная сумма штрафа.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT  f.name, f.number_plate, f.violation, 
   if(
    f.sum_fine = tv.sum_fine, "Стандартная сумма штрафа", 
    if(
      f.sum_fine &lt; tv.sum_fine, "Уменьшенная сумма штрафа", "Увеличенная сумма штрафа"
    )
  ) AS description               
FROM  fine f, traffic_violation tv
WHERE tv.violation = f.violation and f.sum_fine IS NOT Null;</code></pre>

<p><em>Результат: </em></p>

<pre><code class="language-sql">+---------------+--------------+----------------------------------+--------------------------+
| name          | number_plate | violation                        | description              |
+---------------+--------------+----------------------------------+--------------------------+
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | Уменьшенная сумма штрафа |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | Стандартная сумма штрафа |
| Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | Стандартная сумма штрафа |
+---------------+--------------+----------------------------------+--------------------------+
</code></pre>

<h2><em>З</em>адание</h2>

<p>Занести в таблицу <code><strong>fine</strong></code> суммы штрафов, которые должен оплатить водитель, в соответствии с данными из таблицы <code><strong>traffic_violation</strong></code>. При этом суммы заносить только в пустые поля столбца <span style="color: #000000;"><strong> <code>sum_fine</code></strong></span>.</p>

<p>Таблица <code><strong>traffic_violation</strong></code>создана и заполнена.</p>

<p><strong>Важно!</strong> Сравнение значения столбца с пустым значением осуществляется с помощью оператора <strong><code>IS NULL</code></strong>.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>1. После ключевого слова <code>UPDATE </code>кроме обновляемой таблицы<code><strong>fine</strong></code> укажите таблицу <code><strong>traffic_violation, </strong></code>для того чтобы запрос видел таблицы источники.  Сначала перечисляем <strong>все источники,</strong> потом выполняем необходимые действия.</p>

<p>2.Обновляйте только те записи таблицы<code><strong>fine</strong></code>, у которых значение столбца <code><strong>violation</strong></code>совпадает со значением соответствующего столбца таблицы <code><strong>traffic_violation</strong></code>, а также значение столбца <code><strong>sum_fine</strong></code> пусто.</p>
</details>

<details><summary><strong>Результат</strong></summary>

<p><em>Примечание: для сокращения записи ключевой столбец не показан.</em></p>

<pre><code class="language-sql">Affected rows: 5
Query result:
+---------------+--------+------------------------------+----------+----------------+--------------+
| name          | number | violation                    | sum_fine | date_violation | date_payment |
|               | _plate |                              |          |                |              |
+---------------+--------+------------------------------+----------+----------------+--------------+
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 500.00   | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 1000.00  | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 1000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 1000.00  | 2020-03-03     | NULL         |
+---------------+--------+------------------------------+----------+----------------+--------------+
</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li>обновление данных (<a href="https://stepik.org/lesson/305012/step/7?unit=287020" rel="noopener noreferrer nofollow">шаг</a>, <a href="https://stepik.org/lesson/305012/step/8?unit=287020" rel="noopener noreferrer nofollow">шаг</a>);</li>
	<li><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение исходной таблицы <code><strong>fine</strong></code> (без ключевого столбца) и таблицы<code><strong>traffic_violation</strong></code></strong></summary>

<pre><code class="language-sql">+---------------+--------+------------------------------+----------+----------------+--------------+
| name          | number | violation                    | sum_fine | date_violation | date_payment | 
|               | _plate |                              |          |                |              | 
+---------------+--------+------------------------------+----------+----------------+--------------+
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | NULL     | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | NULL     | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | NULL     | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| NULL     | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| NULL     | 2020-03-03     | NULL         |
+---------------+--------+------------------------------+----------+----------------+--------------+</code></pre>

<pre><code class="language-sql">+--------------+----------------------------------+----------+
| violation_id | violation                        | sum_fine |
+--------------+----------------------------------+----------+
| 1            | Превышение скорости(от 20 до 40) | 500.00   |
| 2            | Превышение скорости(от 40 до 60) | 1000.00  |
| 3            | Проезд на запрещающий сигнал     | 1000.00  |
+--------------+----------------------------------+----------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE fine AS f, traffic_violation AS tv
SET f.sum_fine = tv.sum_fine
WHERE f.violation = tv.violation AND f.sum_fine IS null;
</code></pre><h2><strong>Перекрестное соединение CROSS JOIN</strong></h2>

<p>Оператор перекрёстного соединения, или декартова произведения <code>CROSS JOIN</code> (в запросе вместо ключевых слов можно поставить запятую между таблицами) соединяет две таблицы. Порядок таблиц для оператора неважен, поскольку оператор является симметричным. Его структура:</p>

<pre><code class="language-sql">SELECT
 ...
FROM
    таблица_1 CROSS JOIN  таблица_2
...</code></pre>

<p>или</p>

<pre><code class="language-sql">SELECT
 ...
FROM
    таблица_1, таблица_2
...</code></pre>

<p>Результат запроса формируется так: каждая строка одной таблицы соединяется с каждой строкой другой таблицы, формируя  в результате все возможные сочетания строк двух таблиц.</p>

<p>Например, запрос:</p>

<pre><code class="language-sql">SELECT name_author, name_genre
FROM 
    author, genre;</code></pre>

<p>каждому автору из таблицы <code><strong>author</strong></code> поставит в соответствие все возможные жанры из таблицы <code><strong>genre</strong></code>:</p>

<pre><code class="language-sql">+------------------+-------------+
| name_author      | name_genre  |
+------------------+-------------+
| Булгаков М.А.    | Роман       |
| Булгаков М.А.    | Поэзия      |
| Булгаков М.А.    | Приключения |
| Достоевский Ф.М. | Роман       |
| Достоевский Ф.М. | Поэзия      |
| Достоевский Ф.М. | Приключения |
| Есенин С.А.      | Роман       |
| Есенин С.А.      | Поэзия      |
| Есенин С.А.      | Приключения |
| Пастернак Б.Л.   | Роман       |
| Пастернак Б.Л.   | Поэзия      |
| Пастернак Б.Л.   | Приключения |
| Лермонтов М.Ю.   | Роман       |
| Лермонтов М.Ю.   | Поэзия      |
| Лермонтов М.Ю.   | Приключения |
+------------------+-------------+</code></pre>

<h2><strong>Задание</strong></h2>

<p>Есть список городов, хранящийся в таблице <code><strong>city</strong></code>:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>city_id</strong></td>
			<td><strong>name_city</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Москва</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Санкт-Петербург</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Владивосток</td>
		</tr>
	</tbody>
</table>

<p>Необходимо в каждом городе провести выставку книг каждого автора в течение 2020 года. Дату проведения выставки выбрать случайным образом. Создать запрос, который выведет город, автора и дату проведения выставки. Последний столбец назвать <strong>Дата</strong>. Информацию вывести, отсортировав сначала в алфавитном порядке по названиям городов, а потом по убыванию дат проведения выставок.</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/4d2b7a6d-ef2f-4597-a12f-87b3af48494e/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>1. Для генерации случайной даты можно к первому числу года ('2020-01-01') прибавить целое случайное число в интервале от 0 до 365.</p>

<p>Генерации случайных чисел в интервале от 0 до 1 (не включительно) осуществляется с помощью функции <code>RAND()</code>. Если эту функцию умножить на 365, то она будет генерировать вещественные числа от 0 до 365 (не включительно). Осталось только отбросить дробную часть. Это можно сделать с помощью функции <code>FLOOR()</code>, которая возвращает наибольшее целое число, меньшее или равное указанному числовому значению. Таким образом, случайное число от 0 до 365 можно получить с помощью выражения:</p>

<pre><code>FLOOR(RAND() * 365)</code></pre>

<p><strong>Важно! </strong>Даты должны быть за 2020 год, первое число года - 1 января 2020 года.</p>

<p>2. Для сложения  даты с числом используется функция:</p>

<pre><code class="language-sql">DATE_ADD(дата, INTERVAL число единица_измерения),

где
  единица_измерения (использовать прописные буквы) – это день (DAY), месяц(MONTH), неделя(WEEK) и пр., 
  число – целое число,
  дата – значение даты или даты и времени.</code></pre>

<p>Функция к <strong>дате</strong>  прибавляет указанное <strong>число</strong>, выраженное в днях, месяцах и пр. , в зависимости от заданного интервала, и возвращает новую дату.</p>

<p>Например:</p>

<pre><code class="language-sql">DATE_ADD('2020-02-02', INTERVAL 45 DAY) возвращает 18 марта 2020 года
DATE_ADD('2020-02-02', INTERVAL 6 MONTH) возвращает 2 августа 2020 года</code></pre>
</details>

<p><em><strong>Текст задания (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p> Есть список городов, хранящийся в таблице <code><strong>city</strong></code>:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>city_id</strong></td>
			<td><strong>name_city</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Москва</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Санкт-Петербург</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Владивосток</td>
		</tr>
	</tbody>
</table>

<p>Необходимо в каждом городе провести выставку книг каждого автора в течение 2020 года. Дату проведения выставки выбрать случайным образом. Создать запрос, который выведет город, автора и дату проведения выставки. Последний столбец назвать <strong>Дата</strong>. Информацию вывести, отсортировав сначала в алфавитном порядке по названиям городов, а потом по убыванию дат проведения выставок.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<p>Примечание: даты при каждом запуске получаются разными, и не должны совпадать с приведенными значениями.</p>

<pre><code class="language-sql">+-----------------+------------------+------------+
| name_city       | name_author      | Дата       |
+-----------------+------------------+------------+
| Владивосток     | Достоевский Ф.М. | 2020-12-04 |
| Владивосток     | Лермонтов М.Ю.   | 2020-10-21 |
| Владивосток     | Пастернак Б.Л.   | 2020-08-23 |
| Владивосток     | Есенин С.А.      | 2020-08-14 |
| Владивосток     | Булгаков М.А.    | 2020-01-08 |
| Москва          | Лермонтов М.Ю.   | 2020-09-30 |
| Москва          | Достоевский Ф.М. | 2020-07-21 |
| Москва          | Есенин С.А.      | 2020-06-23 |
| Москва          | Булгаков М.А.    | 2020-05-28 |
| Москва          | Пастернак Б.Л.   | 2020-04-08 |
| Санкт-Петербург | Булгаков М.А.    | 2020-11-05 |
| Санкт-Петербург | Лермонтов М.Ю.   | 2020-10-22 |
| Санкт-Петербург | Достоевский Ф.М. | 2020-09-19 |
| Санкт-Петербург | Есенин С.А.      | 2020-08-11 |
| Санкт-Петербург | Пастернак Б.Л.   | 2020-06-28 |
+-----------------+------------------+------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code class="language-sql">Таблица genre:
+----------+-------------+
| genre_id | name_genre  |
+----------+-------------+
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |
+----------+-------------+

Таблица author:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
+-----------+------------------+

Таблица book:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_city, name_author, DATE_ADD('2022-04-02', INTERVAL 'FLOOR(RAND() * 365)' DAY) AS Дата
FROM author CROSS JOIN city
ORDER BY name_city ASC, Дата DESC;

</code></pre><h2>Запрос на добавление, связанные таблицы</h2>

<p>Следующий шаг - добавить новые записи о книгах, которые есть в таблице <code><strong>supply</strong></code> и нет в таблице <strong><code>book</code></strong>. (В таблицах <code><strong>supply</strong></code> и <code><strong>book</strong></code> сохранены изменения предыдущих шагов). Поскольку в таблице <code><strong>supply</strong></code> не указан жанр книги, оставить его пока пустым (занести значение <code>Null</code>).</p>

<p><strong>Пример</strong></p>

<p>Прежде всего необходимо сформировать запрос с полями, которые соответствуют полям таблицы <code><strong>book</strong></code>, так как использовать только таблицу <code><strong>supply</strong></code> нельзя - в ней вместо кода автора стоит его фамилия. </p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author_id, price, amount
FROM 
    author 
    INNER JOIN supply ON author.name_author = supply.author;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+-----------+--------+--------+
| title                 | author_id | price  | amount |
+-----------------------+-----------+--------+--------+
| Доктор Живаго         | 4         | 380.80 | 4      |
| Черный человек        | 3         | 570.20 | 0      |
| Белая гвардия         | 1         | 540.50 | 0      |
| Идиот                 | 2         | 360.80 | 0      |
| Стихотворения и поэмы | 5         | 255.90 | 4      |
| Остров сокровищ       | 6         | 599.99 | 5      |
+-----------------------+-----------+--------+--------+</code></pre>

<p>Далее необходимо отобрать только новые книги из таблицы <code><strong>supply</strong></code>. Как видно из таблицы с результатами запроса, в тех записях, которые нужно добавить, значения столбца <code><strong>amount</strong></code> не равны 0 (количество уже учтенных книг обнулены предыдущим запросом). Добавим это условие в запрос.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author_id, price, amount
FROM 
    author 
    INNER JOIN supply ON author.name_author = supply.author
WHERE amount &lt;&gt; 0;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+-----------+--------+--------+
| title                 | author_id | price  | amount |
+-----------------------+-----------+--------+--------+
| Доктор Живаго         | 4         | 380.80 | 4      |
| Стихотворения и поэмы | 5         | 255.90 | 4      |
| Остров сокровищ       | 6         | 599.99 | 5      |
+-----------------------+-----------+--------+--------+</code></pre>

<h2>Задание</h2>

<p>Добавить новые книги из таблицы <code><strong>supply</strong></code> в таблицу <code><strong>book</strong></code> на основе сформированного выше запроса. Затем вывести для просмотра таблицу <code><strong>book</strong></code>.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>Если нужно оставить какое-то поле пустым - его просто не указывают в списке полей таблицы, в которую добавляются записи.</p>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 3

Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | NULL     | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | NULL     | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | NULL     | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code>Таблица book
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+
Таблица supply
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 0      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 0      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 0      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
Таблица author                          Таблица genre
+-----------+------------------+	+----------+-------------+			
| author_id | name_author      |	| genre_id | name_genre  |			
+-----------+------------------+	+----------+-------------+			
| 1         | Булгаков М.А.    |	| 1        | Роман       |			
| 2         | Достоевский Ф.М. |	| 2        | Поэзия      |			
| 3         | Есенин С.А.      |	| 3        | Приключения |			
| 4         | Пастернак Б.Л.   |	+----------+-------------+			
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |
+-----------+------------------+							</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO book(title, author_id, price, amount)
SELECT title, author.author_id AS author_id, price, amount
FROM author INNER JOIN supply ON author.name_author = supply.author
WHERE amount <> 0;

SELECT * FROM book;</code></pre><h2>Задание</h2>

<p>В таблицу <code><strong>buy_book</strong></code> добавить заказ с номером 5. Этот заказ должен содержать книгу Пастернака «Лирика» в количестве двух экземпляров и книгу Булгакова «Белая гвардия» в одном экземпляре.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/b6bd319d-0d03-4b9a-86a2-98ac762fa4dc/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для вставки каждой книги используйте отдельный запрос. Не забывайте между запросами ставить точку с запятой.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li>добавление записей (<u><a href="https://stepik.org/lesson/305012/step/4?unit=287020" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297508/step/9?unit=279268" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/305012/step/3?unit=287020" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/10?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/310417/step/2?unit=292723" rel="noopener noreferrer nofollow">добавление константы</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>В таблицу <code><strong>buy_book</strong></code> добавить заказ с номером 5. Этот заказ должен содержать книгу Пастернака «Лирика» в количестве двух экземпляров и книгу Булгакова «Белая гвардия» в одном экземпляре.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">
Affected rows: 1

Affected rows: 1

Query result (выборка из таблицы buy_book):
+-------------+--------+---------+--------+
| buy_book_id | buy_id | book_id | amount |
+-------------+--------+---------+--------+
| 1           | 1      | 1       | 1      |
| 2           | 1      | 7       | 2      |
| 3           | 1      | 4       | 1      |
| 4           | 2      | 8       | 2      |
| 5           | 3      | 3       | 2      |
| 6           | 3      | 2       | 1      |
| 7           | 3      | 1       | 1      |
| 8           | 4      | 5       | 1      |
| 9           | 5      | 8       | 2      |
| 10          | 5      | 2       | 1      |
+-------------+--------+---------+--------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц(перед выполнением шага)</strong></summary> <img alt="" height="878" name="113.png" src="https://ucarecdn.com/47a49f1d-5a55-4a33-a16f-f51184695798/" width="711"></details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO buy_book (buy_id, book_id, amount)
SELECT 5, book_id, 2
FROM book INNER JOIN author USING(author_id)
WHERE title = 'Лирика' AND name_author LIKE "Пастернак%";
</code></pre><h2>Задание</h2>

<p>Выведите количество абитуриентов, сдавших ЕГЭ по каждому предмету, максимальное, минимальное и среднее значение баллов по предмету ЕГЭ. Вычисляемые столбцы назвать <code><strong>Количество</strong></code>, <code><strong>Максимум</strong></code>, <code><strong>Минимум</strong></code>, <code><strong>Среднее</strong></code>. Информацию отсортировать по названию предмета в алфавитном порядке, среднее значение округлить до одного знака после запятой.</p>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/b519096f-729d-43ef-b4b2-a752f8169843/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li>групповые функции (<u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297515/step/4?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p> Выведите количество абитуриентов, сдавших ЕГЭ по каждому предмету, максимальное, минимальное и среднее значение баллов по предмету ЕГЭ. Вычисляемые столбцы назвать <code><strong>Количество</strong></code>, <code><strong>Максимум</strong></code>, <code><strong>Минимум</strong></code>, <code><strong>Среднее</strong></code>. Информацию отсортировать по названию предмета в алфавитном порядке, среднее значение округлить до одного знака после запятой.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------------+------------+----------+---------+---------+
| name_subject | Количество | Максимум | Минимум | Среднее |
+--------------+------------+----------+---------+---------+
| Информатика  | 4          | 94       | 75      | 82.0    |
| Математика   | 6          | 92       | 67      | 75.3    |
| Русский язык | 6          | 90       | 65      | 77.5    |
| Физика       | 5          | 90       | 41      | 69.8    |
+--------------+------------+----------+---------+---------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>subject</code>, <code>enrollee_subject</code></strong></summary>

<pre><code class="language-sql">таблица subject
+------------+--------------+
| subject_id | name_subject |
+------------+--------------+
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |
+------------+--------------+
таблица enrollee_subject
+---------------------+-------------+------------+--------+
| enrollee_subject_id | enrollee_id | subject_id | result |
+---------------------+-------------+------------+--------+
| 1                   | 1           | 1          | 68     |
| 2                   | 1           | 2          | 70     |
| 3                   | 1           | 3          | 41     |
| 4                   | 1           | 4          | 75     |
| 5                   | 2           | 1          | 75     |
| 6                   | 2           | 2          | 70     |
| 7                   | 2           | 4          | 81     |
| 8                   | 3           | 1          | 85     |
| 9                   | 3           | 2          | 67     |
| 10                  | 3           | 3          | 90     |
| 11                  | 3           | 4          | 78     |
| 12                  | 4           | 1          | 82     |
| 13                  | 4           | 2          | 86     |
| 14                  | 4           | 3          | 70     |
| 15                  | 5           | 1          | 65     |
| 16                  | 5           | 2          | 67     |
| 17                  | 5           | 3          | 60     |
| 18                  | 6           | 1          | 90     |
| 19                  | 6           | 2          | 92     |
| 20                  | 6           | 3          | 88     |
| 21                  | 6           | 4          | 94     |
+---------------------+-------------+------------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_subject, Count(enrollee_id) AS Количество, MAX(result) AS Максимум, MIN(result) AS Минимум, ROUND(AVG(result), 1) AS Среднее
FROM subject INNER JOIN enrollee_subject USING(subject_id)
GROUP BY name_subject
ORDER BY name_subject

</code></pre><h2>Задание</h2>

<p>Повысить итоговые баллы абитуриентов в таблице <code><strong>applicant</strong></code> на значения дополнительных баллов (использовать <a href="https://stepik.org/lesson/310418/step/7?unit=292724" rel="noopener noreferrer nofollow">запрос</a> из предыдущего урока).</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/14d04390-f8c1-4245-be43-dfb319b12ffc/"></p>

<p><strong>Структура корректируемой таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/72ed7dbb-3a6c-450f-8825-37071fd73eb3/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>1. В запросах на обновление можно использовать несколько связанных таблиц. Например, чтобы обновить поле <code><strong>itog</strong></code><strong> </strong>таблицы <code><strong>applicant</strong></code> для записей, относящихся к образовательной программе «Прикладная механика», используется запрос:</p>

<pre><code class="language-sql">UPDATE 
    applicant
    INNER JOIN program ON applicant.program_id = program.program_id
SET itog = 2
WHERE name_program = "Прикладная механика";
</code></pre>

<p>2. В нашем случае вместо таблицы <code><strong>program </strong></code>можно использовать вложенный запрос, в котором посчитаны дополнительные баллы абитуриентов. А в качестве условия соединения таблиц после ключевого слова  <code>ON</code> указать, что <strong><code>id</code></strong> абитуриентов в таблице <code><strong>applicant</strong></code><strong> </strong>и во вложенном запросе совпадают.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li>обновление данных (<u><a href="https://stepik.org/lesson/305012/step/6?unit=287020" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/305012/step/8?unit=287020" rel="noopener noreferrer nofollow">шаг</a></u>, <a href="https://stepik.org/lesson/308887/step/2?unit=291013" rel="noopener noreferrer nofollow">шаг</a>);</li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Повысить итоговые баллы абитуриентов в таблице <code><strong>applicant</strong></code> на значения дополнительных баллов (использовать <a href="https://stepik.org/lesson/310418/step/7?unit=292724" rel="noopener noreferrer nofollow">запрос</a> из предыдущего урока).</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 7

Query result:
+------------+-------------+------+
| program_id | enrollee_id | itog |
+------------+-------------+------+
| 1          | 3           | 235  |
| 1          | 2           | 226  |
| 1          | 1           | 219  |
| 2          | 6           | 276  |
| 2          | 3           | 235  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 239  |
| 3          | 5           | 200  |
| 4          | 6           | 270  |
| 4          | 3           | 247  |
| 4          | 5           | 200  |
+------------+-------------+------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE applicant, (
    SELECT enrollee_id, SUM(bonus) AS bonus
    FROM enrollee_achievement INNER JOIN achievement Using(achievement_id)
    GROUP BY enrollee_id) AS table_2
SET applicant.itog = applicant.itog + table_2.bonus
WHERE applicant.enrollee_id = table_2.enrollee_id;

SELECT * FROM applicant
</code></pre><h2>Задание</h2>

<p>Вывести студентов (различных студентов), имеющих максимальные результаты попыток. Информацию отсортировать в алфавитном порядке по фамилии студента.</p>

<p>Максимальный результат не обязательно будет 100%, поэтому явно это значение в запросе не задавать.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/3d7b1b34-90b4-4d76-aea0-03369872489d/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для получения максимального результата используйте <a href="https://stepik.org/lesson/297514/step/2?unit=279274" rel="noopener noreferrer nofollow">вложенный запрос</a>. </p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297514/step/2?unit=279274" rel="noopener noreferrer nofollow">вложенные запросы в условии отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу)</p>

<blockquote>
<p>Вывести студентов (различных студентов), имеющих максимальные результаты попыток . Информацию отсортировать в алфавитном порядке по фамилии студента.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------+--------+
| name_student    | result |
+-----------------+--------+
| Семенов Иван    | 100    |
| Яковлева Галина | 100    |
+-----------------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц <code>attempt</code> и <code>student</code></strong></summary>

<pre><code class="language-sql">таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
таблица student
+------------+-----------------+
| student_id | name_student    |
+------------+-----------------+
| 1          | Баранов Павел   |
| 2          | Абрамова Катя   |
| 3          | Семенов Иван    |
| 4          | Яковлева Галина |
+------------+-----------------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_student, result
FROM attempt INNER JOIN student USING(student_id)
WHERE result = (SELECT MAX(result) FROM attempt)



</code></pre><h2>Задание</h2>

<p>Студент прошел тестирование (то есть все его ответы занесены в таблицу <code><strong>testing</strong></code>), далее необходимо вычислить результат(<a href="https://stepik.org/lesson/310421/step/9?unit=292727" rel="noopener noreferrer nofollow">запрос</a>) и занести его в таблицу <code><strong>attempt</strong></code><strong> </strong>для соответствующей попытки.  Результат попытки вычислить как количество правильных ответов, деленное на 3 (количество вопросов в каждой попытке) и умноженное на 100. Результат округлить до целого.</p>

<p> Будем считать, что мы знаем <code><strong>id</strong></code><strong> </strong>попытки,  для которой вычисляется результат, в нашем случае это 8. В таблицу <code><strong>testing</strong></code> занесены следующие ответы пользователя:</p>

<pre><code class="language-sql">+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 22         | 8          | 7           | 19        |
| 23         | 8          | 6           | 17        |
| 24         | 8          | 8           | 22        |
+------------+------------+-------------+-----------+</code></pre>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/3d63945a-d5c5-44c8-a3c3-0c44479f7f30/"></p>

<p><strong>Корректируемая таблица:</strong></p>

<p><img alt="" src="https://ucarecdn.com/d1382132-e039-43a2-8cba-30c5f195e4b6/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Используйте вложенный запрос для вычисления результатов всех попыток по таблице <code><strong>testing</strong></code>, а в таблице <code><strong>attempt</strong></code> обновляйте только запись с <code><strong>id</strong></code><strong> </strong>равным 8.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li>обновление данных (<u><a href="https://stepik.org/lesson/305012/step/6?unit=287020" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/305012/step/8?unit=287020" rel="noopener noreferrer nofollow">шаг</a></u>, <a href="https://stepik.org/lesson/308887/step/2?unit=291013" rel="noopener noreferrer nofollow">шаг</a>);</li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/305762/step/6?unit=287773" rel="noopener noreferrer nofollow">вложенный запрос как отдельная таблица</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Студент прошел тестирование (то есть все его ответы занесены в таблицу <code><strong>testing</strong></code>), далее необходимо вычислить результат(<a href="https://stepik.org/lesson/310421/step/9?unit=292727" rel="noopener noreferrer nofollow">запрос</a>) и занести его в таблицу <code><strong>attempt</strong></code><strong> </strong>для соответствующей попытки.  Результат попытки вычислить как количество правильных ответов, деленное на 3 (количество вопросов в каждой попытке) и умноженное на 100. Результат округлить до целого.</p>

<p> Будем считать, что мы знаем <code><strong>id</strong></code><strong> </strong>попытки,  для которой вычисляется результат, в нашем случае это 8.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1

Query result:
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | 67     |
+------------+------------+------------+--------------+--------+
</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>answer</code>, <code>attempt</code>, <code>testing</code>(перед выполнением шага)</strong></summary>

<pre><code class="language-sql">таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | NULL   |
+------------+------------+------------+--------------+--------+
таблица testing
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
| 22         | 8          | 7           | 19        |
| 23         | 8          | 6           | 17        |
| 24         | 8          | 8           | 22        |
+------------+------------+-------------+-----------+
таблица answer
+-----------+--------------------------------------------------------+-------------+------------+
| answer_id | name_answer                                            | question_id | is_correct |
+-----------+--------------------------------------------------------+-------------+------------+
| 1         | UPDATE                                                 | 1           | 0          |
| 2         | SELECT                                                 | 1           | 1          |
| 3         | INSERT                                                 | 1           | 0          |
| 4         | GROUP BY                                               | 2           | 0          |
| 5         | FROM                                                   | 2           | 0          |
| 6         | WHERE                                                  | 2           | 1          |
| 7         | SELECT                                                 | 2           | 0          |
| 8         | SORT                                                   | 3           | 0          |
| 9         | ORDER BY                                               | 3           | 1          |
| 10        | RANG BY                                                | 3           | 0          |
| 11        | SELECT * FROM student                                  | 4           | 1          |
| 12        | SELECT student                                         | 4           | 0          |
| 13        | INNER JOIN                                             | 5           | 1          |
| 14        | LEFT JOIN                                              | 5           | 0          |
| 15        | RIGHT JOIN                                             | 5           | 0          |
| 16        | CROSS JOIN                                             | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным...  | 6           | 1          |
| 18        | совокупность программ для хранения иобработки ...      | 6           | 0          |
| 19        | строка                                                 | 7           | 0          |
| 20        | столбец                                                | 7           | 0          |
| 21        | таблица                                                | 7           | 1          |
| 22        | обобщенное представление пользователей о данных        | 8           | 1          |
| 23        | описание представления данных в памяти компьютера      | 8           | 0          |
| 24        | база данных                                            | 8           | 0          |
| 25        | file                                                   | 9           | 1          |
| 26        | INT                                                    | 9           | 0          |
| 27        | VARCHAR                                                | 9           | 0          |
| 28        | DATE                                                   | 9           | 0          |
+-----------+--------------------------------------------------------+-------------+------------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE attempt,(
    SELECT ROUND((SUM(is_correct) /3 * 100), 0) AS result
    FROM answer INNER JOIN testing USING(answer_id)
    WHERE attempt_id = 8) AS tbl
SET attempt.result = tbl.result
WHERE attempt.attempt_id = 8;

SELECT * FROM attempt

</code></pre><h2> Задание</h2>

<p><em><strong>автор -</strong> Анатолий Алексеев</em></p>

<p>Удалить из таблиц <code><strong>book </strong></code>и <code><strong>supply</strong></code>книги, цены которых заканчиваются на 99 копеек. Например, книга с ценой 670.99 должна быть удалена.</p>

<p><strong>Структура таблиц:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"><img alt="" src="https://ucarecdn.com/c921a09f-eb1b-4810-84fe-96a07c44fe39/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 1

Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+
Affected rows: 5

Affected rows: 1

Query result:
+-----------+----------------+------------------+--------+--------+
| supply_id | title          | author           | price  | amount |
+-----------+----------------+------------------+--------+--------+
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |
+-----------+----------------+------------------+--------+--------+
Affected rows: 3</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Удалить из таблиц <code><strong>book </strong></code>и <code><strong>supply</strong></code>книги, цены которых заканчиваются на 99 копеек. Например, книга с ценой 670.99 должна быть удалена.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/76913457" rel="noopener noreferrer nofollow">Лариса Фернандес</a></p>

<p>Объявить столбец "категории цены" (<code><strong>price_category</strong></code>): &lt;500 - "низкая", 500 - 700 - "средняя", более 700 - "высокая"<br>
Вывести автора, название, категорию, стоимость (цена * количество), исключив из авторов Есенина, из названий "Белую гвардию". Отсортировать по убыванию стоимости и названию (по возрастанию)</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+--------------------+----------------+---------+
| author           | title              | price_category | cost    |
+------------------+--------------------+----------------+---------+
| Достоевский Ф.М. | Игрок              | низкая         | 4805.00 |
| Достоевский Ф.М. | Идиот              | низкая         | 4600.00 |
| Достоевский Ф.М. | Братья Карамазовы  | высокая        | 2397.03 |
| Булгаков М.А.    | Мастер и Маргарита | средняя        | 2012.97 |
+------------------+--------------------+----------------+---------+</code></pre>

<p><strong>Пояснение. </strong>Реализовать это задание как запрос <strong>на выборку</strong>.</p>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Объявить столбец "категории цены" (<code><strong>price_category</strong></code>): &lt;500 - "низкая", 500 - 700 - "средняя", более 700 - "высокая"<br>
Вывести автора, название, категорию, стоимость (цена * количество), исключив из авторов Есенина, из названий "Белую гвардию". Отсортировать по убыванию стоимости и названию (по возрастанию)</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/77819533" rel="noopener noreferrer nofollow">Adilbek Kaliyev</a></p>

<p>Составить рейтинг книг в зависимости от того, какая книга принесет больше всего выручки (в процентах), при условии продажи всех книг. Рейтинг отсортировать по убыванию выручки. Выручка в процентах вычисляется как стоимость всех экземпляров книги деленное на суммарную стоимость всех экземпляров книг на складе и умноженное на 100, полученный результат округлить до двух знаков после запятой.<br>
Судя по результату, магазин хорошо вложился в Стихи Есенина</p>

<p><strong> Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------------------+--------+--------+----------------+
| author           | title                 | price  | amount | income_percent |
+------------------+-----------------------+--------+--------+----------------+
| Есенин С.А.      | Стихотворения и поэмы | 650.00 | 15     | 33.83          |
| Достоевский Ф.М. | Игрок                 | 480.50 | 10     | 16.67          |
| Достоевский Ф.М. | Идиот                 | 460.00 | 10     | 15.96          |
| Есенин С.А.      | Черный человек        | 670.99 | 5      | 11.64          |
| Булгаков М.А.    | Белая гвардия         | 540.50 | 5      | 9.38           |
| Булгаков М.А.    | Мастер и Маргарита    | 670.99 | 3      | 6.98           |
| Достоевский Ф.М. | Братья Карамазовы     | 799.01 | 2      | 5.54           |
+------------------+-----------------------+--------+--------+----------------+
</code></pre>

<pre><strong>Текст задания </strong>(чтобы не прокручивать страницу): 
</pre>

<blockquote>
<p>Составить рейтинг книг в зависимости от того, какая книга принесет больше всего выручки (в процентах), при условии продажи всех книг. Рейтинг отсортировать по убыванию выручки. Выручка в процентах вычисляется как стоимость всех экземпляров книги деленное на суммарную стоимость всех экземпляров книг на складе и умноженное на 100, полученный результат округлить до двух знаков после запятой.<br>
Судя по результату, магазин хорошо вложился в Стихи Есенина</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p>Реализовать поиск по ключевым словам. Вывести шаги, с которыми связаны ключевые слова <code><strong>MAX</strong></code> и <code><strong>AVG</strong></code> одновременно. Для шагов указать <strong>id</strong> модуля, позицию урока в модуле, позицию шага в уроке через точку, после позиции шага перед заголовком - пробел. Позицию шага в уроке вывести в виде двух цифр (если позиция шага меньше 10, то перед цифрой поставить 0). Столбец назвать <code><strong>Шаг</strong></code>. Информацию отсортировать по первому столбцу в алфавитном порядке.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>В таблице <code><strong>step_keyword</strong></code> хранится информация о том, какие ключевые слова в каких шагах используются. При этом <strong>ключевое слово может быть связано с шагом, в названии которого этого ключевого слова нет</strong>. </p>
</details>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/11b91b0f-e8c1-42b2-a34d-1e8ad5e41960/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/310421/step/10?auth=login&amp;unit=292727" rel="noopener noreferrer nofollow">функция CONCAT()</a>;</u></li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/10?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><em><strong>Текст запроса (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p>Реализовать поиск по ключевым словам. Вывести шаги, с которыми связаны ключевые слова <code><strong>MAX</strong></code> и <code><strong>AVG</strong></code> одновременно. Для шагов указать <strong>id</strong> модуля, позицию урока в модуле, позицию шага в уроке через точку, после позиции шага перед заголовком - пробел. Позицию шага в уроке вывести в виде двух цифр (если позиция шага меньше 10, то перед цифрой поставить 0). Столбец назвать <code><strong>Шаг</strong></code>. Информацию отсортировать по первому столбцу в алфавитном порядке.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------------------------------------------------+
| Шаг                                                     |
+---------------------------------------------------------+
| 1.3.04 Выборка данных, групповые функции MIN, MAX и AVG |
| 1.4.06 Вложенный запрос после SELECT                    |
+---------------------------------------------------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT CONCAT(module.module_id, '.', lesson.lesson_position, '.', IF(step.step_position > 9, step.step_position, CONCAT(0, step.step_position)), ' ', step_name) AS Шаг
From module inner join lesson USING(module_id)
INNER JOIN step USING(lesson_id)
INNER JOIN step_keyword USING(step_id)
INNER JOIN keyword USING(keyword_id)
WHERE keyword.keyword_name REGEXP CONCAT('\\b', 'MAX', '\\b') OR keyword.keyword_name REGEXP CONCAT('\\b', 'AVG', '\\b')
GROUP BY module.module_id,step.step_id
HAVING COUNT(step_name) = 2
ORDER BY 1;</code></pre><h2>Выборка данных с созданием вычисляемого столбца</h2>

<p>С помощью SQL запросов можно осуществлять вычисления по каждой строке таблицы с помощью вычисляемого столбца. Для него в списке полей после оператора <code><strong>SELECT</strong></code> указывается выражение и задается имя.</p>

<p>Выражение может включать имена столбцов, константы, знаки операций, встроенные функции.</p>

<p>Результатом является таблица, в которую включены все данные из указанных после <code><strong>SELECT</strong></code> столбцов, а также новый столбец, в каждой строке которого вычисляется заданное выражение.</p>

<p><strong>Пример</strong></p>

<p>Вывести всю информацию о книгах, а также для каждой позиции посчитать ее стоимость (произведение цены на количество). Вычисляемому столбцу дать имя <code><strong>total</strong></code> .</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, price, amount, 
     price * amount AS total 
FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+--------+--------+---------+ 
| title                 | author           | price  | amount | total   | 
+-----------------------+------------------+--------+--------+---------+ 
| Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      | 2012.97 | 
| Белая гвардия         | Булгаков М.А.    | 540.50 | 5      | 2702.50 | 
| Идиот                 | Достоевский Ф.М. | 460.00 | 10     | 4600.00 | 
| Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      | 1598.02 | 
| Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     | 9750.00 |
+-----------------------+------------------+--------+--------+---------+ </code></pre>

<h2><strong>Задание</strong></h2>

<p>Для упаковки каждой книги требуется один лист бумаги, цена которого 1 рубль 65 копеек. Посчитать стоимость упаковки для каждой книги (сколько денег потребуется, чтобы упаковать все экземпляры книги). В запросе вывести название книги, ее количество и стоимость упаковки, последний столбец назвать <code><strong>pack</strong></code>. </p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+--------+-------+
| title                 | amount | pack  |
+-----------------------+--------+-------+
| Мастер и Маргарита    | 3      | 4.95  |
| Белая гвардия         | 5      | 8.25  |
| Идиот                 | 10     | 16.50 |
| Братья Карамазовы     | 2      | 3.30  |
| Стихотворения и поэмы | 15     | 24.75 |
+-----------------------+--------+-------+
Affected rows: 5</code></pre>

<details><summary><strong>Структура и наполнение таблицы <code>book</code><strong>:</strong></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, amount, amount * 1.65 AS pack
FROM book




</code></pre><h2>Выборка данных c вычислением, групповые функции</h2>

<p>В качестве аргумента групповых функций  SQL может использоваться не только столбец, но и любое допустимое в SQL арифметическое выражение.</p>

<p><strong>Пример</strong></p>

<p>Вывести суммарную стоимость книг каждого автора.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT author, SUM(price * amount) AS Стоимость
FROM book
GROUP BY author;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------+
| author           | Стоимость |
+------------------+-----------+
| Булгаков М.А.    | 4715.47   |
| Достоевский Ф.М. | 11802.03  |
| Есенин С.А.      | 9750.00   |
+------------------+-----------+</code></pre>

<p>Групповые функции могут быть элементами выражений. Например, при вычислении средней стоимости книг каждого автора на предыдущем шаге получились значения с шестью знаками после запятой. А поскольку это деньги, значения нужно округлить до 2 знаков после запятой.</p>

<p><strong> Пример</strong></p>

<p>Найти среднюю цену книг каждого автора.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT author, ROUND(AVG(price),2) AS Средняя_цена
FROM book
GROUP BY author;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+--------------+
| author           | Средняя_цена |
+------------------+--------------+
| Булгаков М.А.    | 605.75       |
| Достоевский Ф.М. | 579.84       |
| Есенин С.А.      | 650.00       |
+------------------+--------------+
</code></pre>

<h2>Задание</h2>

<p>Для каждого автора вычислить суммарную стоимость книг <strong>S</strong> (имя столбца <strong>Стоимость</strong>), а также вычислить налог на добавленную стоимость  для полученных сумм (имя столбца <strong>НДС</strong> ) , который <strong>включен в стоимость</strong> и составляет k = 18%,  а также стоимость книг  (<strong>Стоимость_без_НДС</strong>) без него. Значения округлить до двух знаков после запятой. В запросе для расчета НДС(<strong><em>tax</em></strong>)  и Стоимости без НДС(<strong><em>S_without_tax</em></strong>) использовать следующие формулы:</p>

<p><span class="math-tex">\[tax= {{S *{ k \over 100}} \over {1+{k\over 100}}},\]</span></p>

<p><span class="math-tex">\[S\_without\_tax= {{S} \over {1+{k\over 100}}}\]</span></p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------------+-----------+---------+-------------------+
| author           | Стоимость | НДС     | Стоимость_без_НДС |
+------------------+-----------+---------+-------------------+
| Булгаков М.А.    | 4715.47   | 719.31  | 3996.16           |
| Достоевский Ф.М. | 11802.03  | 1800.31 | 10001.72          |
| Есенин С.А.      | 9750.00   | 1487.29 | 8262.71           |
+------------------+-----------+---------+-------------------+
</code></pre>
</details>

<details><summary><strong>Пояснение</strong></summary>

<p>Имена столбцов, присвоенные им с помощью <code>AS</code>, нельзя использовать в выражениях, используйте названия столбцов исходной таблицы.</p>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, ROUND(SUM(price*amount),2) as Стоимость, ROUND(SUM((price*amount*18)/118),2) as НДС,
ROUND(SUM(price*amount/1.18),2) as Стоимость_без_НДС
FROM book
GROUP BY author;



</code></pre><h2>Вложенный запрос, операторы ANY и ALL</h2>

<p> Вложенный запрос, возвращающий несколько значений одного столбца, можно использовать для отбора записей с помощью операторов <code>ANY</code> и <code>ALL</code> совместно с операциями отношения (=, &lt;&gt;, &lt;=, &gt;=, &lt;, &gt;).</p>

<p>Операторы <code>ANY</code> и <code>ALL</code> используются  в SQL для сравнения некоторого значения с результирующим набором вложенного запроса, состоящим из одного столбца. При этом тип данных столбца, возвращаемого вложенным запросом, должен совпадать с типом данных столбца (или выражения), с которым происходит сравнение.</p>

<p>При использовании оператора <code>ANY</code> в результирующую таблицу будут включены все записи, для которых  выражение со знаком отношения верно хотя бы для одного элемента результирующего запроса. Как работает оператор <code>ANY()</code>:</p>

<ul>
	<li>
	<p><code>amount &gt; ANY (10, 12)</code> эквивалентно <code>amount &gt; 10</code></p>
	</li>
	<li>
	<p><code>amount &lt; ANY (10, 12)</code> эквивалентно <code>amount &lt; 12</code></p>
	</li>
	<li>
	<p><code>amount = ANY (10, 12)</code> эквивалентно <code>(amount = 10) OR (amount = 12)</code>, а также <code>amount IN  (10,12)</code></p>
	</li>
	<li>
	<p><code>amount &lt;&gt; ANY (10, 12)</code> вернет все записи с любым значением <code>amount,</code> включая 10 и 12</p>
	</li>
</ul>

<p>При использовании оператора <code>ALL</code> в результирующую таблицу будут включены все записи, для которых  выражение со знаком отношения верно для всех элементов результирующего запроса. Как работает оператор <code>ALL</code>:</p>

<ul>
	<li>
	<p><code>amount &gt; ALL (10, 12)</code> эквивалентно <code>amount &gt; 12</code></p>
	</li>
	<li>
	<p><code>amount &lt; ALL (10, 12)</code> эквивалентно <code>amount &lt; 10</code></p>
	</li>
	<li><code>amount = ALL (10, 12)</code><span style="color: #222222; font-size: inherit;"> не вернет ни одной записи, так как </span><span style="color: #222222; font-size: inherit;">эквивалентно</span><span style="color: #222222; font-size: inherit;"> </span><code>(amount = 10) AND (amount = 12)</code></li>
	<li>
	<p><code>amount &lt;&gt; ALL (10, 12)</code> вернет все записи кроме тех,  в которых<code>amount равно 10 или 12</code></p>
	</li>
</ul>

<p><strong>Важно! </strong>Операторы <code><strong>ALL</strong></code> и <code><strong>ANY</strong></code> можно использовать т<strong>олько с вложенными запросами</strong>. В примерах выше (10, 12) приводится как результат вложенного запроса просто для того, чтобы показать как эти операторы работают. В запросах так записывать нельзя.</p>

<p><strong>Пример</strong></p>

<p>Вывести информацию о тех книгах, количество которых меньше самого маленького среднего количества книг каждого автора.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, amount, price
FROM book
WHERE amount &lt; ALL (
        SELECT AVG(amount) 
        FROM book 
        GROUP BY author 
      );</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------------------+------------------+--------+--------+
| title              | author           | amount | price  |
+--------------------+------------------+--------+--------+
| Мастер и Маргарита | Булгаков М.А.    | 3      | 670.99 |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 799.01 |
+--------------------+------------------+--------+--------+</code></pre>

<details><summary><strong>Пояснение</strong></summary>

<p>1. Вложенный запрос</p>

<pre><code class="language-sql">SELECT AVG(amount) 
        FROM book 
        GROUP BY author</code></pre>

<p>отбирает следующие записи:</p>

<pre><code class="language-sql">+-------------+
| AVG(amount) |
+-------------+
| 4.0000      |
| 7.6667      |
| 15.0000     |
+-------------+</code></pre>

<p>2. Условие отбора в основном запросе</p>

<pre><code class="language-sql">amount &lt; ALL (
        SELECT AVG(amount) 
        FROM book 
        GROUP BY author 
      )</code></pre>

<p>можно переписать (если заменить вложенный запрос списком отобранных значений):</p>

<pre><code class="language-sql">amount &lt; ALL ( 4.0000, 7.6667, 15.0000)</code></pre>

<p>что в соответствии с определением <code><strong>ALL</strong></code>, это значит, что подходят все <code><strong>amount</strong></code> меньшие <strong>4.000</strong>.</p>

<p>Таким образом, наш запрос отобрал все книги книги <strong>Мастер и Маргарита</strong> и <strong>Братья Карамазовы</strong>, количество которых равно 3. </p>
</details>

<p><strong>Пример</strong></p>

<p>Вывести информацию о тех книгах, количество которых меньше самого большого среднего количества книг каждого автора.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, amount, price
FROM book
WHERE amount &lt; ANY (
        SELECT AVG(amount) 
        FROM book 
        GROUP BY author 
      );</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------------------+------------------+--------+--------+
| title              | author           | amount | price  |
+--------------------+------------------+--------+--------+
| Мастер и Маргарита | Булгаков М.А.    | 3      | 670.99 |
| Белая гвардия      | Булгаков М.А.    | 5      | 540.50 |
| Идиот              | Достоевский Ф.М. | 10     | 460.00 |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 799.01 |
| Игрок              | Достоевский Ф.М. | 10     | 480.50 |
+--------------------+------------------+--------+--------+</code></pre>

<details><summary><strong>Пояснение</strong></summary>

<p>В этом примере <code><strong>amount &lt; ANY ( 4.0000, 7.6667, 15.0000) </strong></code> означает, что подходят <code><strong>amount </strong></code>меньше самого большого значения из списка.</p>
</details>

<h2>Задание</h2>

<p>Вывести информацию о книгах(автор, название, цена), цена которых меньше самой большой из минимальных цен, вычисленных для каждого автора.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------------+---------------+--------+
| author           | title         | price  |
+------------------+---------------+--------+
| Булгаков М.А.    | Белая гвардия | 540.50 |
| Достоевский Ф.М. | Идиот         | 460.00 |
| Достоевский Ф.М. | Игрок         | 480.50 |
+------------------+---------------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, title, price
FROM book
WHERE price < ANY (SELECT MIN(price) FROM book GROUP BY author);


</code></pre><h2>Добавление записей, вложенные запросы</h2>

<p>В запросах на добавление можно использовать вложенные запросы.</p>

<p><strong>Пример</strong></p>

<p>Занести из таблицы <code><strong>supply</strong></code> в таблицу <code><strong>book</strong></code> только те книги, названия которых отсутствуют в таблице <code><strong>book.</strong></code></p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">INSERT INTO book (title, author, price, amount) 
SELECT title, author, price, amount 
FROM supply
WHERE title NOT IN (
        SELECT title 
        FROM book
      );

SELECT * FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 2

Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |
| 7       | Черный человек        | Есенин С.А.      | 570.20 | 6      |
+---------+-----------------------+------------------+--------+--------+</code></pre>

<p>Вложенным запросом отбираются все названия книг, которые есть в таблице <code><strong>book</strong></code>. Основным запросом <code>SELECT</code> из таблицы <code><strong>supply</strong></code> выбираются книги, названия которых нет в результате вложенного запроса. Отобранные записи добавляются в конец таблицы <code><strong>book</strong></code>запросом на добавление <code>INSERT</code>.</p>

<h2>Задание</h2>

<p>Занести из таблицы <code><strong>supply</strong></code> в таблицу <code><strong>book</strong></code> только те книги, авторов которых нет в  <code><strong>book.</strong></code></p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1

Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц <code>book</code> и <code>supply</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>

<pre><code>+-----------+----------------+------------------+--------+--------+
| supply_id | title          | author           | price  | amount |
+-----------+----------------+------------------+--------+--------+
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |
+-----------+----------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO book (title, author, price, amount)
SELECT title, author, price, amount
FROM supply
WHERE author NOT IN (SELECT author FROM book);
</code></pre><h2><strong>Оператор LIMIT</strong></h2>

<p>Для ограничения вывода записей в SQL используется оператор <code>LIMIT</code> , после которого указывается количество строк.  Результирующая таблица будет иметь количество строк не более указанного после <code>LIMIT</code>. <code>LIMIT</code> размещается после раздела <code>ORDER BY</code>.</p>

<p>Как правило, этот оператор используется, чтобы отобрать заданное количество отсортированных строк результата запроса. </p>

<p><strong>Пример</strong></p>

<p>Вывести информацию о первой  командировке из таблицы <code><strong>trip</strong></code>. "Первой" считать командировку с самой ранней датой начала.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT *
FROM trip
ORDER BY  date_first
LIMIT 1;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+---------+--------------+--------+----------+------------+------------+
| trip_id | name         | city   | per_diem | date_first | date_last  |
+---------+--------------+--------+----------+------------+------------+
| 1       | Баранов П.Е. | Москва | 700.00   | 2020-01-12 | 2020-01-17 |
+---------+--------------+--------+----------+------------+------------+</code></pre>

<p><strong>Важно.</strong> Оператор <code>LIMIT</code> нужно использовать очень осторожно. Например, если бы в таблице <code><strong>trip</strong></code> было несколько командировок с одинаковой датой начала, этот запрос работал бы НЕВЕРНО. Это связано с тем, что заранее не известно точное значение таких командировок.</p>

<h2>Задание</h2>

<p>Вывести два города, в которых чаще всего были в командировках сотрудники. Вычисляемый столбец назвать <strong>Количество</strong>.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------------+------------+
| city        | Количество |
+-------------+------------+
| Москва      | 7          |
| Новосибирск | 4          |
+-------------+------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</li>
	<li><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>trip</strong></code></strong></summary>

<pre><code>+---------+---------------+-----------------+----------+------------+------------+
| trip_id | name          | city            | per_diem | date_first | date_last  |
+---------+---------------+-----------------+----------+------------+------------+
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |
+---------+---------------+-----------------+----------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT city, COUNT(city) AS Количество
FROM trip
GROUP BY city
ORDER BY Количество DESC
LIMIT 2;
</code></pre><h2>Группировка данных по нескольким столбцам</h2>

<p>В разделе <code>GROUP BY</code> можно указывать несколько столбцов, разделяя их запятыми. Тогда к одной группе будут относиться записи, у которых значения столбцов, входящих в группу, равны. Рассмотрим группировку по нескольким столбцам на примере следующего запроса:</p>

<pre><code class="language-sql">SELECT name, number_plate, violation, count(*)
FROM fine
GROUP BY name, number_plate, violation;</code></pre>

<p>1. Сначала записи таблицы  <strong><code>fine</code></strong> разделяются на группы. В каждую группу включаются строки, у которых равны значения в столбцах <code><strong>name</strong></code>, <code><strong>number_plate</strong></code> и <code><strong>violation</strong></code>  соответственно. Получается 6 групп. </p>

<p><img alt="" src="https://ucarecdn.com/ff298302-7c99-4ecc-8245-d26c32c1d524/"></p>

<p>2. Затем вычисляется функция <code><strong>count(*)</strong></code>, которая определяет количество записей в каждой группе. Получается, что к первым двум группам относятся по две записи, ко всем остальным - по одной.</p>

<p><img alt="" src="https://ucarecdn.com/4bb9e222-d1ba-4806-8fd8-b7eb8c64f11b/"></p>

<p><strong>Важно! </strong>В разделе <code><strong>GROUP BY</strong></code> нужно перечислять все НЕАГРЕГИРОВАННЫЕ столбцы (к которым не применяются групповые функции) из <code><strong>SELECT</strong></code>.</p>

<h2>Задание</h2>

<p>Вывести фамилию, номер машины и нарушение только для тех водителей, которые на одной машине нарушили одно и то же правило   два и более раз. При этом учитывать все нарушения, независимо от того оплачены они или нет. Информацию отсортировать в алфавитном порядке, сначала по фамилии водителя, потом по номеру машины и, наконец, по нарушению.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>Под увеличение  штрафа в два раза подходит водитель «Абрамова К.А.», который на машине с государственным номером «О111АВ» совершил повторное нарушение «Проезд на запрещающий сигнал», а также водитель  «Баранов П.Е.» , который на машине с номером  «Р523ВТ» дважды совершил нарушение «Превышение скорости(от 40 до 60) ».</p>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------+--------------+----------------------------------+
| name          | number_plate | violation                        |
+---------------+--------------+----------------------------------+
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     |
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) |
+---------------+--------------+----------------------------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</li>
	<li><a href="https://stepik.org/lesson/297515/step/7?unit=279275" rel="noopener noreferrer nofollow">условие отбора в запросах группировки</a> ;</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>fine</strong></code> (без ключевого столбца) перед выполнением этого шага</strong></summary>

<pre><code class="language-sql">+---------------+--------+------------------------------+----------+----------------+--------------+
| name          | number | violation                    | sum_fine | date_violation | date_payment |
|               | _plate |                              |          |                |              |
+---------------+--------+------------------------------+----------+----------------+--------------+
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 500.00   | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 1000.00  | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 1000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 1000.00  | 2020-03-03     | NULL         |
+---------------+--------+------------------------------+----------+----------------+--------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name, number_plate, violation
FROM fine
GROUP BY name, number_plate, violation
HAVING COUNT(*) >= 2
ORDER BY name ASC, number_plate, violation;
</code></pre><h2>Запросы на выборку из нескольких таблиц</h2>

<p>Запрос на выборку может выбирать данные из двух и более таблиц базы данных. При этом таблицы должны быть логически связаны между собой. Для каждой пары таблиц, включаемых в запрос, необходимо указать свой оператор соединения. Наиболее распространенным является внутреннее соединение <code>INNER JOIN</code>, поэтому в примерах будем использовать его.</p>

<p>Пусть таблицы связаны между собой следующим образом:</p>

<p><img alt="" src="https://ucarecdn.com/ce01d392-5623-4e6c-aa60-2f58246a2b7f/"></p>

<p>тогда запрос на выборку для этих таблиц будет иметь вид:</p>

<pre><code class="language-sql">SELECT
 ...
FROM
    first 
    INNER JOIN  second ON first.first_id = second.first_id
    INNER JOIN  third  ON second.second_id = third.second_id
...</code></pre>

<p>Если же таблицы связаны так:</p>

<p><img alt="" src="https://ucarecdn.com/5da25bff-06fd-42f7-a32e-3fc65ca67954/"></p>

<p>то запрос на выборку выглядит следующим образом:</p>

<pre><code class="language-sql">SELECT
 ...
FROM
    first 
    INNER JOIN  third ON first.first_id = third.first_id
    INNER JOIN second ON third.second_id = second.second_id 
...</code></pre>

<p>В этом случае рекомендуется соединение таблиц записывать последовательно, «по кругу»: <code><strong>first → third → second</strong></code>.</p>

<p><strong>Пример</strong></p>

<p>Вывести информацию о тех книгах, их авторах и жанрах, цена которых принадлежит интервалу от 500  до 700 рублей  включительно.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, name_author, name_genre, price, amount
FROM
    author 
    INNER JOIN  book ON author.author_id = book.author_id
    INNER JOIN genre ON genre.genre_id = book.genre_id
WHERE price BETWEEN 500 AND 700;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+----------------+------------+--------+--------+
| title                 | name_author    | name_genre | price  | amount |
+-----------------------+----------------+------------+--------+--------+
| Мастер и Маргарита    | Булгаков М.А.  | Роман      | 670.99 | 3      |
| Белая гвардия         | Булгаков М.А.  | Роман      | 540.50 | 5      |
| Стихотворения и поэмы | Есенин С.А.    | Поэзия     | 650.00 | 15     |
| Черный человек        | Есенин С.А.    | Поэзия     | 570.20 | 6      |
| Лирика                | Пастернак Б.Л. | Поэзия     | 518.99 | 2      |
+-----------------------+----------------+------------+--------+--------+</code></pre>

<h2>Задание</h2>

<p> Вывести информацию о книгах (жанр, книга, автор), относящихся к жанру, включающему слово «роман» в отсортированном по названиям книг виде.</p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/"></p>

<p><em><strong>Текст задания (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p> Вывести информацию о книгах (жанр, книга, автор), относящихся к жанру, включающему слово «роман» в отсортированном по названиям книг виде.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------+--------------------+------------------+
| name_genre | title              | name_author      |
+------------+--------------------+------------------+
| Роман      | Белая гвардия      | Булгаков М.А.    |
| Роман      | Братья Карамазовы  | Достоевский Ф.М. |
| Роман      | Игрок              | Достоевский Ф.М. |
| Роман      | Идиот              | Достоевский Ф.М. |
| Роман      | Мастер и Маргарита | Булгаков М.А.    |
+------------+--------------------+------------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code class="language-sql">Таблица genre:
+----------+-------------+
| genre_id | name_genre  |
+----------+-------------+
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |
+----------+-------------+

Таблица author:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
+-----------+------------------+

Таблица book:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_genre, title, name_author
FROM genre INNER JOIN book ON genre.genre_id = book.genre_id
INNER JOIN author ON author.author_id = book.author_id
WHERE name_genre LIKE '%роман%'
ORDER BY title ASC;

</code></pre><h2>Запрос на обновление, вложенные запросы</h2>

<p>После того, как новые книги добавлены в таблицу <code><strong>book</strong></code>, нужно указать к какому жанру они относятся. Для этого используется запрос на обновление, в котором можно указать значения столбцов из других таблиц, либо использовать вложенные запросы для получения этих значений.</p>

<p><strong>Пример</strong></p>

<p>Задать для книги Пастернака «Доктор Живаго»  жанр «Роман».</p>

<p>Если мы знаем код этой книги в таблице <code><strong>book </strong></code>(в нашем случае это 9) и код жанра «Роман» в таблице <code><strong>genre</strong></code> (это 1), запрос будет очень простым.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">UPDATE book
SET genre_id = 1
WHERE book_id = 9;

SELECT * FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 1

Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | NULL     | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | NULL     | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>

<p>Более сложным будет запрос, если известно только название жанра (результат будет точно таким же):</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">UPDATE book
SET genre_id = 
      (
       SELECT genre_id 
       FROM genre 
       WHERE name_genre = 'Роман'
      )
WHERE book_id = 9;

SELECT * FROM book;</code></pre>

<h2>Задание</h2>

<p> Занести для книги «Стихотворения и поэмы» Лермонтова жанр «Поэзия», а для книги «Остров сокровищ» Стивенсона - «Приключения». (Использовать два запроса).</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2

Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code>Таблица book
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | Null     | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | Null     | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+

Таблица author                          Таблица genre
+-----------+------------------+	+----------+-------------+			
| author_id | name_author      |	| genre_id | name_genre  |			
+-----------+------------------+	+----------+-------------+			
| 1         | Булгаков М.А.    |	| 1        | Роман       |			
| 2         | Достоевский Ф.М. |	| 2        | Поэзия      |			
| 3         | Есенин С.А.      |	| 3        | Приключения |			
| 4         | Пастернак Б.Л.   |	+----------+-------------+			
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |
+-----------+------------------+							</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE book
SET genre_id = IF(title = 'Стихотворения и поэмы' AND author_id = (
SELECT author_id FROM author WHERE name_author = 'Лермонтов М.Ю.'), (
SELECT genre_id FROM genre WHERE name_genre = 'Поэзия'), (
SELECT genre_id FROM genre WHERE name_genre = 'Приключения'))
WHERE book_id IN (10, 11);

SELECT * FROM book;
</code></pre><h2>Запросы на основе трех и более связанных таблиц</h2>

<p><strong>Пример</strong></p>

<p>Вывести фамилии всех клиентов, которые заказали книгу Булгакова «Мастер и Маргарита».</p>

<p><em>Запрос:</em></p>

<p>Этот запрос строится на основе нескольких таблиц, для удобства нужно определить фрагмент логической схемы базы данных, на основе которой строится запрос. В нашем случае выбираются название книги из таблицы <code><strong>book</strong></code> и фамилия клиента из таблицы <code><strong>client</strong></code>. Эти таблицы между собой непосредственно не связаны, поэтому нужно добавить «связующие» таблицы  <strong><code>buy</code></strong> и <code><strong>buy_book</strong></code>:</p>

<p> </p>

<p>Для соединения этих таблиц используется <code>INNER JOIN</code>. Для удобства рекомендуется связи описывать последовательно: <code><strong>client </strong></code>→ <code><strong>buy </strong></code>→ <code><strong>buy_book </strong></code>→ <code><strong>book</strong></code>.  А для соединения использовать пару <strong>первичный ключ</strong> и <strong>внешний ключ</strong> соответствующих таблиц. Например, соединение таблиц <code><strong>client </strong></code>и <code><strong>buy</strong></code> осуществляется по условию <strong><code>client.client_id = buy.client_id</code></strong>.</p>

<p>Чтобы не усложнять схему, будем считать, что нам известен <strong>id</strong> Булгакова (это 1)</p>

<pre><code class="language-sql">SELECT DISTINCT name_client
FROM 
    client 
    INNER JOIN buy ON client.client_id = buy.client_id
    INNER JOIN buy_book ON buy_book.buy_id = buy.buy_id
    INNER JOIN book ON buy_book.book_id=book.book_id
WHERE title ='Мастер и Маргарита' and author_id = 1;                    </code></pre>

<p>В запросе отбираются уникальные клиенты (<code>DISTINCT</code>) так как один и тот же клиент мог заказать одну и ту же книгу несколько раз.</p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+---------------+
| name_client   |
+---------------+
| Баранов Павел |
| Абрамова Катя |
+---------------+</code></pre>

<h2>Задание</h2>

<p>Вывести все заказы Баранова Павла (<code><strong>id</strong></code> заказа, какие книги, по какой цене и в каком количестве он заказал) в отсортированном по номеру заказа и названиям книг виде.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>Если в нескольких таблицах столбцы называются одинаково – необходимо явно указывать из какой таблицы берется столбец. Например, столбец <code><strong>amount</strong></code> есть и в таблице <code><strong>book</strong></code>, и в таблице <strong><code>buy_book</code></strong>. В запросе нужно указать количество заказанных книг, то есть <code><strong>buy_book.amount</strong></code>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</li>
	<li><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</li>
	<li>условие отбора (<a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a>, <a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a>);</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------+--------------------+--------+--------+
| buy_id | title              | price  | amount |
+--------+--------------------+--------+--------+
| 1      | Идиот              | 460.00 | 1      |
| 1      | Мастер и Маргарита | 670.99 | 1      |
| 1      | Черный человек     | 570.20 | 2      |
| 4      | Игрок              | 480.50 | 1      |
+--------+--------------------+--------+--------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT buy.buy_id, book.title, book.price, buy_book.amount
FROM buy INNER JOIN client ON buy.client_id = client.client_id INNER JOIN buy_book ON buy.buy_id = buy_book.buy_id INNER JOIN book ON buy_book.book_id = book.book_id
WHERE name_client = 'Баранов Павел'
ORDER BY buy_id ASC;

</code></pre><h2>Задание</h2>

<p>Количество тех книг на складе, которые были включены в заказ с номером 5, уменьшить на то количество, которое в заказе с номером 5  указано.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/96d439bc-b2d4-4850-9762-ade76851aa9e/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для изменения количества книг используйте запрос <code>UPDATE</code>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li>обновление данных (<u><a href="https://stepik.org/lesson/305012/step/6?unit=287020" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/305012/step/8?unit=287020" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>).</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Уменьшить количество тех книг на складе, которые были включены в заказ с номером 5.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2

Query result (выборка из таблицы book):
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 4      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 0      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц(перед выполнением шага)</strong></summary> <img alt="" height="878" name="113.png" src="https://ucarecdn.com/5444f7f5-a900-43f2-b116-093fa1c12984/" width="711"></details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE book
INNER JOIN buy_book ON book.book_id = buy_book.book_id
SET book.amount = book.amount - buy_book.amount
WHERE buy_book.buy_id = 5;
</code></pre><h2>Задание</h2>

<p>Вывести образовательные программы, для которых минимальный балл ЕГЭ по каждому предмету больше или равен 40 баллам. Программы вывести в отсортированном по алфавиту виде.</p>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/c159caa8-0d39-41f8-b5bf-7ccb16669df9/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/7?unit=279275" rel="noopener noreferrer nofollow">условие отбора в запросах группировки</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/4?unit=279275" rel="noopener noreferrer nofollow">групповые функции</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Вывести образовательные программы, для которых минимальный балл ЕГЭ по каждому предмету больше или равен 40 баллам. Программы вывести в отсортированном по алфавиту виде.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------------------------------------+
| name_program                        |
+-------------------------------------+
| Мехатроника и робототехника         |
| Прикладная математика и информатика |
+-------------------------------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>program</code>, <code>program_subject</code></strong></summary>

<pre><code class="language-sql">таблица program
+------------+-------------------------------------+---------------+------+
| program_id | name_program                        | department_id | plan |
+------------+-------------------------------------+---------------+------+
| 1          | Прикладная математика и информатика | 2             | 1    |
| 2          | Математика и компьютерные науки     | 2             | 2    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |
+------------+-------------------------------------+---------------+------+
таблица program_subject
+--------------------+------------+------------+------------+
| program_subject_id | program_id | subject_id | min_result |
+--------------------+------------+------------+------------+
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |
+--------------------+------------+------------+------------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_program
FROM program INNER JOIN program_subject USING(program_id)
GROUP BY name_program
HAVING MIN(min_result) >= 40
ORDER BY name_program;

</code></pre><h2>Задание</h2>

<p>Поскольку при добавлении дополнительных баллов, абитуриенты по каждой образовательной программе могут следовать не в порядке убывания суммарных баллов, необходимо создать новую таблицу <code><strong>applicant_order</strong></code> на основе таблицы <code><strong>applicant</strong></code>.<strong> </strong>При создании таблицы данные нужно отсортировать сначала по <code><strong>id</strong></code> образовательной программы, потом по убыванию итогового балла. А таблицу <code><strong>applicant</strong></code>, которая была создана как вспомогательная, необходимо удалить.</p>

<p><strong>Структура корректируемой таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/72ed7dbb-3a6c-450f-8825-37071fd73eb3/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для удаления таблицы используется SQL запрос <code>DROP</code>:</p>

<pre><code class="language-sql">DROP TABLE таблица;</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/10?unit=287020" rel="noopener noreferrer nofollow">создание таблицы</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Поскольку при добавлении дополнительных баллов, абитуриенты по каждой образовательной программе могут следовать не в порядке убывания суммарных баллов, необходимо создать новую таблицу <code><strong>applicant_order</strong></code> на основе таблицы <code><strong>applicant</strong></code>.<strong> </strong>При создании таблицы данные нужно отсортировать сначала по <code><strong>id</strong></code> образовательной программы, потом по убыванию итогового балла. А таблицу <code><strong>applicant</strong></code>, которая была создана как вспомогательная, необходимо удалить.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 12

Affected rows: 0

Query result:
+------------+-------------+------+
| program_id | enrollee_id | itog |
+------------+-------------+------+
| 1          | 3           | 235  |
| 1          | 2           | 226  |
| 1          | 1           | 219  |
| 2          | 6           | 276  |
| 2          | 3           | 235  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 239  |
| 3          | 5           | 200  |
| 4          | 6           | 270  |
| 4          | 3           | 247  |
| 4          | 5           | 200  |
+------------+-------------+------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE applicant_order AS
SELECT program_id, enrollee_id, itog
FROM applicant
ORDER BY program_id, itog DESC;

DELETE FROM applicant;
</code></pre><h2>Задание</h2>

<p>Если студент совершал <strong>несколько попыток</strong> по одной и той же дисциплине, то вывести разницу в днях между первой и последней попыткой. В результат включить фамилию и имя студента, название дисциплины и вычисляемый столбец <code><strong>Интервал</strong></code>. Информацию вывести по возрастанию разницы. Студентов, сделавших одну попытку по дисциплине, не учитывать. </p>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/0702acbe-ec20-457d-85e4-6df22e070656/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Дату первой и последней попытки получить как минимальное и максимальное значение даты с помощью <a href="https://stepik.org/lesson/297515/step/4?unit=279275" rel="noopener noreferrer nofollow">групповых функций</a>, для вычисления разницы между датами использовать функцию <a href="https://stepik.org/lesson/297510/step/6?unit=279270" rel="noopener noreferrer nofollow">DATEDIFF()</a>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/4?unit=279275" rel="noopener noreferrer nofollow">групповые функции</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297510/step/6?unit=279270" rel="noopener noreferrer nofollow">вычитание дат</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/7?unit=279275" rel="noopener noreferrer nofollow">условие отбора в запросах группировки</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу)</p>

<blockquote>
<p>Если студент совершал <strong>несколько попыток</strong> по одной и той же дисциплине, то вывести разницу в днях между первой и последней попыткой. В результат включить фамилию и имя студента, название дисциплины и вычисляемый столбец <code><strong>Интервал</strong></code>. Информацию вывести по возрастанию разницы. Студентов, сделавших одну попытку по дисциплине, не учитывать. </p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------+-------------------+----------+
| name_student    | name_subject      | Интервал |
+-----------------+-------------------+----------+
| Яковлева Галина | Основы баз данных | 26       |
| Семенов Иван    | Основы SQL        | 55       |
+-----------------+-------------------+----------+
</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code class="language-sql">таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
таблица student                   таблица subject
+------------+-----------------+  +------------+-------------------+
| student_id | name_student    |  | subject_id | name_subject      |
+------------+-----------------+  +------------+-------------------+
| 1          | Баранов Павел   |  | 1          | Основы SQL        |
| 2          | Абрамова Катя   |  | 2          | Основы баз данных |
| 3          | Семенов Иван    |  | 3          | Физика            |
| 4          | Яковлева Галина |  +------------+-------------------+
+------------+-----------------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_student, name_subject, DATEDIFF(MAX(date_attempt), MIN(date_attempt)) AS Интервал
FROM attempt INNER JOIN student ON attempt.student_id = student.student_id INNER JOIN subject ON attempt.subject_id = subject.subject_id
GROUP BY name_student, name_subject
HAVING COUNT(*) > 1
ORDER BY Интервал ASC;</code></pre><h2>Задание</h2>

<p>Удалить из таблицы<strong> </strong><code><strong>attempt</strong></code><strong> </strong>все попытки, выполненные раньше 1 мая 2020 года. Также удалить и все соответствующие этим попыткам вопросы из таблицы<strong> </strong><code><strong>testing</strong></code>, которая создавалась следующим запросом:</p>

<pre><code class="language-sql">CREATE TABLE testing (
    testing_id INT PRIMARY KEY AUTO_INCREMENT, 
    attempt_id INT, 
    question_id INT, 
    answer_id INT,
    FOREIGN KEY (attempt_id)  REFERENCES attempt (attempt_id) ON DELETE CASCADE
);</code></pre>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/a474d45f-603e-4c75-b581-8d6cdceabbd7/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/9?unit=287020" rel="noopener noreferrer nofollow">удаление строк из таблицы</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Удалить из таблицы<strong> </strong><code><strong>attempt</strong></code><strong> </strong>все попытки, выполненные раньше 1 мая 2020 года. Также удалить и все соответствующие этим попыткам вопросы из таблицы<strong> </strong><code><strong>testing</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 6

Query result:
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | 67     |
+------------+------------+------------+--------------+--------+
Affected rows: 2

Query result:
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
| 22         | 8          | 7           | 19        |
| 23         | 8          | 6           | 17        |
| 24         | 8          | 8           | 22        |
+------------+------------+-------------+-----------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>attempt</code>, <code>testing</code>(перед выполнением шага)</strong></summary>

<pre><code class="language-sql">таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | 67     |
+------------+------------+------------+--------------+--------+
таблица testing
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
| 22         | 8          | 7           | 19        |
| 23         | 8          | 6           | 17        |
| 24         | 8          | 8           | 22        |
+------------+------------+-------------+-----------+

</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">DELETE FROM attempt
WHERE date_attempt < '2020-05-01'



</code></pre><h2> Задание</h2>

<p><em><strong>автор -</strong> Елена Петухова</em></p>

<p>Снизить цены книг, цена которых больше 600 рублей, на 20%. Вывести информацию о книгах, скидку (столбец <code><strong>sale_20</strong></code>) и цену книги со скидкой (<code><strong>price_sale)</strong></code>.  Результаты округлить до двух знаков после запятой. Для тех книг, на которые скидка не действует, в последних двух столбцах вывести символ  "-".  Отсортировать информацию сначала по фамилии автора, а потом по названию книги.</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------------------+--------+--------+---------+------------+
| author           | title                 | price  | amount | sale_20 | price_sale |
+------------------+-----------------------+--------+--------+---------+------------+
| Булгаков М.А.    | Белая гвардия         | 540.50 | 5      | -       | -          |
| Булгаков М.А.    | Мастер и Маргарита    | 670.99 | 3      | 134.20  | 536.79     |
| Достоевский Ф.М. | Братья Карамазовы     | 799.01 | 3      | 159.80  | 639.21     |
| Достоевский Ф.М. | Игрок                 | 480.50 | 10     | -       | -          |
| Достоевский Ф.М. | Идиот                 | 460.00 | 10     | -       | -          |
| Есенин С.А.      | Стихотворения и поэмы | 650.00 | 15     | 130.00  | 520.00     |
+------------------+-----------------------+--------+--------+---------+------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Снизить цены книг, цена которых больше 600 рублей, на 20%. Вывести информацию о книгах, скидку (столбец <code><strong>sale_20</strong></code>) и цену книги со скидкой (<code><strong>price_sale)</strong></code>.  Результаты округлить до двух знаков после запятой. Для тех книг, на которые скидка не действует, в последних двух столбцах вывести символ  "-".  Отсортировать информацию сначала по фамилии автора, а потом по названию книги.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/76913457" rel="noopener noreferrer nofollow">Лариса Фернандес</a></p>

<p>Для нечетного количества книг посчитать разницу максимальной стоимости (цена * количество) и стоимостью всех экземпляров конкретной книги. Отсортировать по этой разнице по убыванию. Вывести название, автора, количество, разницу с максимальной стоимостью.</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+--------+---------------------------+
| title                 | author           | amount | Разница_с_макс_стоимостью |
+-----------------------+------------------+--------+---------------------------+
| Мастер и Маргарита    | Булгаков М.А.    | 3      | 7737.03                   |
| Братья Карамазовы     | Достоевский Ф.М. | 3      | 7352.97                   |
| Белая гвардия         | Булгаков М.А.    | 5      | 7047.50                   |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 0.00                      |
+-----------------------+------------------+--------+---------------------------+</code></pre>

<p><strong>Пояснение. </strong>Для того, чтобы узнать четным или нечетным является число, можно использовать операцию % - остаток от деления. Например:</p>

<p>5 % 3 = 2</p>

<p>6 % 3 = 0 </p>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Для нечетного количества книг посчитать разницу максимальной стоимости (цена * количество) и стоимостью всех экземпляров конкретной книги. Отсортировать по этой разнице по убыванию. Вывести название, автора, количество, разницу с максимальной стоимостью.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p><em><strong>автор -</strong></em><a href="https://stepik.org/users/76913457" rel="noopener noreferrer nofollow">Лариса Фернандес</a></p>

<p>Для каждого автора из таблицы<code><strong> author</strong></code> вывести количество книг, написанных им в каждом жанре.</p>

<p><strong>Вывести:</strong> ФИО автора, жанр, количество.</p>

<p><strong>Отсортировать:</strong> по фамилии, затем - по убыванию количества написанных книг, а затем в алфавитном порядке по названию жанра.</p>

<p><strong>Важно!</strong> Реализовать задание одним запросом на выборку.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/986d8fd2-0158-44f6-a6df-26cbdc8d46b1/"></p>

<p>Результат:</p>

<pre><code class="language-sql">+------------------+-------------+------------+
| name_author      | name_genre  | Количество |
+------------------+-------------+------------+
| Булгаков М.А.    | Роман       | 2          |
| Булгаков М.А.    | Поэзия      | 0          |
| Булгаков М.А.    | Приключения | 0          |
| Достоевский Ф.М. | Роман       | 3          |
| Достоевский Ф.М. | Поэзия      | 0          |
| Достоевский Ф.М. | Приключения | 0          |
| Есенин С.А.      | Поэзия      | 2          |
| Есенин С.А.      | Приключения | 0          |
| Есенин С.А.      | Роман       | 0          |
| Лермонтов М.Ю.   | Поэзия      | 0          |
| Лермонтов М.Ю.   | Приключения | 0          |
| Лермонтов М.Ю.   | Роман       | 0          |
| Пастернак Б.Л.   | Поэзия      | 1          |
| Пастернак Б.Л.   | Приключения | 0          |
| Пастернак Б.Л.   | Роман       | 0          |
+------------------+-------------+------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :  </p>

<blockquote>
<p>Для каждого автора из таблицы<code><strong> author</strong></code> вывести количество книг, написанных им в каждом жанре.</p>

<p><strong>Вывести:</strong> ФИО автора, жанр, количество.</p>

<p><strong>Отсортировать:</strong> по фамилии, затем - по убыванию количества написанных книг, а затем в алфавитном порядке по названию жанра.</p>

<p><strong>Важно!</strong> Реализовать задание одним запросом на выборку.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Выборка данных по нескольким условиям, оператор CASE</h2>

<p>С помощью оператора <strong><code>CASE</code></strong> можно в зависимости от нескольких условий получить один из нескольких результатов.</p>

<p>Оператор <code><strong>CASE</strong></code> записывается в виде:</p>

<pre><code class="language-sql">CASE  
     WHEN логическое_выражение_1 THEN выражение_1
     WHEN логическое_выражение_2 THEN выражение_2
     ...
     ELSE выражение_else   
END  </code></pre>

<p>Раздел<strong> <code>ELSE</code></strong> является необязательным.</p>

<p>Выполняется оператор <code><strong>CASE</strong></code> так:</p>

<ul>
	<li>вычисляется <code><strong>логическое_выражение_1</strong></code>, если оно истинно, то результатом оператора является <code><strong>выражение_1</strong></code>, если ложно - выполнение оператора продолжается;</li>
	<li>вычисляется <strong><code>логическое_выражение_2</code>,</strong> если оно истинно, то результатом оператора является <code><strong>выражение_2</strong></code>, если ложно - выполнение оператора продолжается;</li>
	<li>если все логические выражения оказались ложными, то результат оператора - <code><strong>выражение_else</strong></code></li>
</ul>

<p><strong><code>CASE</code> </strong>можно использовать в  <code><strong>SELECT, UPDATE, DELETE, SET, WHERE, ORDER BY, HAVING</strong></code> - всюду, где можно использовать выражения.</p>

<p><strong>Пример</strong></p>

<p>Отнести каждого студента к группе,  в зависимости от пройденных заданий:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr>
			<td style="text-align: center;"><strong>Интервал</strong></td>
			<td style="text-align: center;"><strong>Группа</strong></td>
		</tr>
		<tr>
			<td style="text-align: center;">от 0 до 10</td>
			<td style="text-align: center;">I</td>
		</tr>
		<tr>
			<td style="text-align: center;">от 11 до 15</td>
			<td style="text-align: center;">II</td>
		</tr>
		<tr>
			<td style="text-align: center;">от 16 до 27</td>
			<td style="text-align: center;">III</td>
		</tr>
		<tr>
			<td style="text-align: center;">больше 27</td>
			<td style="text-align: center;">IV</td>
		</tr>
	</tbody>
</table>

<p>Пройденными считаются задания с хотя бы одним верным ответом. В таблице <code><strong>step_student</strong></code> сохраняются все попытки пользователей, следовательно, могут быть пользователи, у которых на одно задание есть несколько верных попыток.</p>

<p><em><strong> Фрагмент логической схемы базы данных:</strong></em></p>

<p><img alt="" src="https://ucarecdn.com/e32cf2e7-200e-4ba9-9a7c-86244317d7fb/"></p>

<p><em><strong>Шаг 1. </strong></em>Выведем всех студентов и все шаги, которые они прошли с результатом "correct". Этот шаг обязателен, чтобы не учитывать  правильные решения несколько раз.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT student_name, step_id
FROM 
    student 
    INNER JOIN step_student USING(student_id)
WHERE result = "correct"
GROUP BY student_name, step_id;</code></pre>

<p>Результат:</p>

<pre><code class="language-sql">Query result:
+--------------+---------+
| student_name | step_id |
+--------------+---------+
| student_52   | 10      |
| student_11   | 10      |
| student_19   | 10      |
| student_4    | 10      |
| student_5    | 10      |
| student_53   | 10      |
| student_39   | 10      |
| student_32   | 10      |
| student_61   | 10      |
| student_43   | 10      |
| student_13   | 10      |
| student_57   | 10      |
             ...
+--------------+---------+

Affected rows: 1126.</code></pre>

<p><em><strong> Шаг 2. </strong></em>Посчитаем, сколько шагов прошел каждый студент.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT student_name, count(*) as rate
FROM 
    (
     SELECT student_name, step_id
     FROM 
         student 
         INNER JOIN step_student USING(student_id)
     WHERE result = "correct"
     GROUP BY student_name, step_id
    ) query_in
GROUP BY student_name
ORDER BY 2;</code></pre>

<p>Результат:</p>

<pre><code class="language-sql">+--------------+------+
| student_name | rate |
+--------------+------+
| student_29   | 8    |
| student_47   | 8    |
| student_16   | 9    |
| student_5    | 9    |
| student_63   | 9    |
| student_33   | 10   |
| student_17   | 10   |
| student_64   | 10   |
            ...
+--------------+------+
Affected rows: 64
</code></pre>

<p><strong><em>Шаг 3</em></strong>. Отнести каждого студента к группе в зависимости от пройденных шагов.</p>

<p><em> Запрос:</em></p>

<pre><code class="language-sql">SELECT student_name, rate, 
    CASE
        WHEN rate &lt;= 10 THEN "I"
        WHEN rate &lt;= 15 THEN "II"
        WHEN rate &lt;= 27 THEN "III"
        ELSE "IV"
    END AS Группа
FROM      
    (
     SELECT student_name, count(*) as rate
     FROM 
         (
          SELECT student_name, step_id
          FROM 
              student 
              INNER JOIN step_student USING(student_id)
          WHERE result = "correct"
          GROUP BY student_name, step_id
         ) query_in
     GROUP BY student_name 
     ORDER BY 2
    ) query_in_1;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Query result:
+--------------+------+--------+
| student_name | rate | Группа |
+--------------+------+--------+
| student_29   | 8    | I      |
| student_47   | 8    | I      |
| student_16   | 9    | I      |
| student_5    | 9    | I      |
| student_63   | 9    | I      |
| student_33   | 10   | I      |
| student_17   | 10   | I      |
| student_64   | 10   | I      |
| student_58   | 10   | I      |
| student_38   | 10   | I      |
| student_12   | 11   | II     |
| student_10   | 11   | II     |
              ...
+--------------+------+--------+
Affected rows: 64</code></pre>

<h2><strong>Задание</strong></h2>

<p>Посчитать, сколько студентов относится к каждой группе. Столбцы назвать <code><strong>Группа</strong></code>, <code><strong>Интервал</strong></code>, <code><strong>Количество</strong></code>. Указать границы интервала.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>Если логическое выражения во всех <code><strong>WHEN</strong></code> представляет собой сравнение на равенство с некоторым значением, то оператор <code><strong>CASE</strong></code> можно записать в виде:</p>

<pre><code class="language-sql">CASE столбец 
     WHEN значение_1 THEN выражение_1
     WHEN значение_2 THEN выражение_2
     ...
     ELSE значение_else   
END  </code></pre>

<p>Это задание можно решить и другим способом (без  <code><strong>CASE</strong></code>). Для этого можно создать таблицу с интервалами и использовать ее в запросе.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/8?unit=291012" rel="noopener noreferrer nofollow">вложенные запросы в операторах соединения</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------+-------------+------------+
| Группа | Интервал    | Количество |
+--------+-------------+------------+
| I      | от 0 до 10  | 10         |
| II     | от 11 до 15 | 27         |
| III    | от 16 до 27 | 9          |
| IV     | больше 27   | 18         |
+--------+-------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT Группа, 
CASE
    WHEN Группа = 'I' THEN 'от 0 до 10'
    WHEN Группа = 'II' THEN 'от 11 до 15'
    WHEN Группа = 'III' THEN 'от 16 до 27'
    ELSE 'больше 27' END AS Интервал,
    COUNT(*) AS Количество
FROM (
    SELECT student_name, rate,
    CASE 
        WHEN rate <= 10 THEN "I"
        WHEN rate <= 15 THEN 'II'
        WHEN rate <= 27 THEN 'III'
        ELSE 'IV'
        END AS Группа
    FROM (
        SELECT student_name, COUNT(*) AS rate
        FROM (
            SELECT student_name, step_id
            FROM step_student INNER JOIN student USING(student_id)
            WHERE result = 'correct'
            GROUP BY student_name, step_id) AS query_1
        GROUP BY student_name
        ORDER BY 2) AS query_2) AS query_3
GROUP BY Группа</code></pre><h2>Выборка данных, вычисляемые столбцы, математические функции</h2>

<p>В SQL реализовано множество  <a href="https://docs.microsoft.com/ru-ru/sql/t-sql/functions/mathematical-functions-transact-sql?view=sql-server-ver15" rel="noopener noreferrer nofollow">математических функций</a> для работы с числовыми данными. В таблице приведены некоторые из них.</p>

<table border="1" cellpadding="1" cellspacing="1">
	<thead>
		<tr style="background-color: #e6f8e0; background: #e6f8e0; text-align: center;">
			<td><strong>Функция</strong></td>
			<td><strong>Описание</strong></td>
			<td><strong>Пример</strong></td>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><code>CEILING(x)</code></td>
			<td>возвращает наименьшее целое число, большее или равное <strong>x</strong><br>
			(округляет до целого числа в большую сторону)</td>
			<td><code>CEILING(4.2)=5<br>
			CEILING(-5.8)=-5</code></td>
		</tr>
		<tr>
			<td><code>ROUND(x, k)</code></td>
			<td>округляет значение <strong>x</strong> до <strong>k</strong> знаков после запятой,<br>
			если <strong>k </strong>не указано –<strong> x</strong> округляется до целого</td>
			<td><code>ROUND(4.361)=4<br>
			ROUND(5.86592,1)=5.9</code></td>
		</tr>
		<tr>
			<td><code>FLOOR(x)</code></td>
			<td>возвращает наибольшее целое число, меньшее или равное <strong>x</strong><br>
			(округляет до  целого числа в меньшую сторону)</td>
			<td><code>FLOOR(4.2)=4<br>
			FLOOR(-5.8)=-6</code></td>
		</tr>
		<tr>
			<td><code>POWER(x, y)</code></td>
			<td>возведение <strong>x</strong> в степень<strong> y</strong></td>
			<td><code>POWER(3,4)=81.0</code></td>
		</tr>
		<tr>
			<td><code>SQRT(x)</code></td>
			<td>квадратный корень из <strong>x</strong></td>
			<td><code>SQRT(4)=2.0<br>
			SQRT(2)=1.41...</code></td>
		</tr>
		<tr>
			<td><code>DEGREES(x)</code></td>
			<td>конвертирует значение <strong>x</strong> из радиан в градусы</td>
			<td><code>DEGREES(3) = 171.8...</code></td>
		</tr>
		<tr>
			<td><code>RADIANS(x)</code></td>
			<td>конвертирует значение <strong>x </strong>из градусов в радианы</td>
			<td><code>RADIANS(180)=3.14...</code></td>
		</tr>
		<tr>
			<td><code>ABS(x)</code></td>
			<td>модуль числа <strong>x </strong></td>
			<td><code>ABS(-1) = 1<br>
			ABS(1) = 1</code></td>
		</tr>
		<tr>
			<td><code>PI()</code></td>
			<td>pi = 3.1415926...</td>
			<td> </td>
		</tr>
	</tbody>
</table>

<p><strong>Пояснение.</strong>   Существуют разные способы округления чисел. В SQL реализовано <strong>математическое округление</strong>. Для округления вещественного числа нужно в записи числа выбрать разряд в дробной части, до которого производится округление. Цифра, записанная в выбранном разряде: не меняется, если следующая за ней справа цифра - 0, 1, 2, 3 или 4; увеличивается на единицу, если следующая за ней справа цифра - 5,6,7,8 или 9.</p>

<p><strong>Пример </strong></p>

<p>Для каждой книги из таблицы <code><strong>book</strong></code> вычислим налог на добавленную стоимость (имя столбца <code><strong>tax</strong></code>) , который включен в цену и составляет k = 18%,  а также цену книги (<code><strong>price_tax</strong></code>) без него. Формулы для вычисления:</p>

<p><span class="math-tex">\[tax= {{price *{ k \over 100}} \over {1+{k\over 100}}},\]</span></p>

<p><span class="math-tex">\[price\_tax= {{price} \over {1+{k\over 100}}}\]</span></p>

<details><summary><strong>Пояснение от <a href="https://stepik.org/users/137112290" rel="noopener noreferrer nofollow">Андрея Виноградов</a>а<strong>:</strong></strong></summary>

<p>Эта формула НДС отвечает на вопрос "Какую сумму увеличили на 18%, чтобы получить текущее значение"</p>
</details>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, price, 
    (price*18/100)/(1+18/100) AS tax, 
    price/(1+18/100) AS price_tax 
FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+--------+----------------+------------+
| title                 | price  | tax            | price_tax  |
+-----------------------+--------+----------------+------------+
| Мастер и Маргарита    | 670.99 | 102.3544067797 | 568.635593 |
| Белая гвардия         | 540.50 | 82.4491525424  | 458.050847 |
| Идиот                 | 460.00 | 70.1694915254  | 389.830508 |
| Братья Карамазовы     | 799.01 | 121.8828813559 | 677.127119 |
| Стихотворения и поэмы | 650.00 | 99.1525423729  | 550.847458 |
+-----------------------+--------+----------------+------------+</code></pre>

<p>Сумма налога и цена книги без налога – это деньги, поэтому количество знаков после запятой у этих чисел должно быть 2. Следовательно необходимо округлить полученные значения.</p>

<p><em>Запрос</em>:</p>

<pre><code class="language-sql">SELECT title, 
    price, 
    ROUND((price*18/100)/(1+18/100),2) AS tax, 
    ROUND(price/(1+18/100),2) AS price_tax 
FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+--------+--------+-----------+
| title                 | price  | tax    | price_tax |
+-----------------------+--------+--------+-----------+
| Мастер и Маргарита    | 670.99 | 102.35 | 568.64    |
| Белая гвардия         | 540.50 | 82.45  | 458.05    |
| Идиот                 | 460.00 | 70.17  | 389.83    |
| Братья Карамазовы     | 799.01 | 121.88 | 677.13    |
| Стихотворения и поэмы | 650.00 | 99.15  | 550.85    |
+-----------------------+--------+--------+-----------+</code></pre>

<h2><strong>Задание</strong></h2>

<p>В конце года цену всех книг на складе пересчитывают – снижают ее на 30%. Написать SQL запрос, который из таблицы <code><strong>book</strong></code> выбирает названия, авторов, количества и вычисляет новые цены книг. Столбец с новой ценой назвать <code><strong>new_price</strong></code>, цену округлить до 2-х знаков после запятой.</p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+--------+-----------+
| title                 | author           | amount | new_price |
+-----------------------+------------------+--------+-----------+
| Мастер и Маргарита    | Булгаков М.А.    | 3      | 469.69    |
| Белая гвардия         | Булгаков М.А.    | 5      | 378.35    |
| Идиот                 | Достоевский Ф.М. | 10     | 322.00    |
| Братья Карамазовы     | Достоевский Ф.М. | 2      | 559.31    |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 455.00    |
+-----------------------+------------------+--------+-----------+</code></pre>

<details><summary><strong>Структура и наполнение таблицы <code>book</code><strong>:</strong></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, author, amount,
ROUND((price * 0.7), 2) AS new_price
FROM book




</code></pre><h2>Вычисления по таблице целиком</h2>

<p>Групповые функции позволяют вычислять итоговые значения по всей таблице. Например, можно посчитать общее количество книг на складе, вычислить суммарную стоимость и пр. Для этого после ключевого слова <code>SELECT</code> указывается групповая функция для выражения или имени столбца, а ключевые слова <code>GROUP BY</code> опускаются.</p>

<p><strong>Пример</strong></p>

<p>Посчитать количество экземпляров книг на складе.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT SUM(amount) AS Количество
FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------+
| Количество |
+------------+
| 46         |
+------------+ </code></pre>

<p>Результатом таких запросов является единственная строка с вычисленными по таблице значениями.</p>

<p><strong> Пример</strong></p>

<p>Посчитать общее количество экземпляров книг на складе и их стоимость .</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT SUM(amount) AS Количество, 
    SUM(price * amount) AS Стоимость
FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------+-----------+
| Количество | Стоимость |
+------------+-----------+
| 46         | 26267.50  |
+------------+-----------+
</code></pre>

<h2>Задание</h2>

<p>Вывести  цену самой дешевой книги, цену самой дорогой и среднюю цену уникальных книг на складе. Названия столбцов <strong>Минимальная_цена, Максимальная_цена, Средняя_цена</strong> соответственно. Среднюю цену округлить до двух знаков после запятой.</p>

<p><strong>Пояснение</strong>. В задании нужно посчитать среднюю цену уникальных книг на складе, а не среднюю цену всех экземпляров книг.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------------+-------------------+--------------+
| Минимальная_цена | Максимальная_цена | Средняя_цена |
+------------------+-------------------+--------------+
| 460.00           | 799.01            | 600.17       |
+------------------+-------------------+--------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT MIN(price) as Минимальная_цена, MAX(price) as Максимальная_цена, ROUND(AVG(price),2) as Средняя_цена
FROM book


</code></pre><h2>Вложенный запрос после SELECT</h2>

<p>Вложенный запрос может располагаться после ключевого слова <code>SELECT</code>. В этом случае результат выполнения запроса выводится в отдельном столбце результирующей таблицы. При этом результатом запроса может быть только одно значение, тогда оно будет повторяться во всех строках. Также вложенный запрос может использоваться в выражениях.</p>

<p><strong>Пример</strong></p>

<p>Вывести информацию о книгах, количество экземпляров которых отличается от среднего количества экземпляров книг на складе более чем на 3,  а также указать среднее значение количества экземпляров книг.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, amount, 
    (
     SELECT AVG(amount) 
     FROM book
    ) AS Среднее_количество 
FROM book
WHERE abs(amount - (SELECT AVG(amount) FROM book)) &gt;3;</code></pre>

<details><summary><strong>Пояснение</strong></summary>

<p>В запросе используется функция <a href="https://stepik.org/lesson/297509/step/6?unit=279269" rel="noopener noreferrer nofollow">модуля</a>, которая позволяет учесть, что количество может отличаться от среднего как в большую, так и в меньшую сторону.</p>
</details>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+--------+--------------------+
| title                 | author           | amount | Среднее_количество |
+-----------------------+------------------+--------+--------------------+
| Мастер и Маргарита    | Булгаков М.А.    | 3      | 7.6667             |
| Братья Карамазовы     | Достоевский Ф.М. | 3      | 7.6667             |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 7.6667             |
+-----------------------+------------------+--------+--------------------+</code></pre>

<p>Во вложенном запросе вычисляется среднее количество экземпляров книг на складе. Этот запрос используется и в условии отбора, и для создания столбца <strong>Среднее_количество</strong> в результирующей таблице запроса. Значения  столбца одинаковы во всех строках, поскольку  вложенный запрос возвращает одно значение.</p>

<p>Среднее количество в виде дробного числа выглядит не очень правильно. Полученное значение можно <a href="https://stepik.org/lesson/297509/step/6?unit=279269" rel="noopener noreferrer nofollow">округлить "вниз"</a> - до ближайшего меньшего целого.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, amount, 
      FLOOR((SELECT AVG(amount) FROM book)) AS Среднее_количество 
FROM book
WHERE abs(amount - (SELECT AVG(amount) FROM book)) &gt;3;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+--------+--------------------+
| title                 | author           | amount | Среднее_количество |
+-----------------------+------------------+--------+--------------------+
| Мастер и Маргарита    | Булгаков М.А.    | 3      | 7                  |
| Братья Карамазовы     | Достоевский Ф.М. | 3      | 7                  |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 7                  |
+-----------------------+------------------+--------+--------------------+</code></pre>

<h2>Задание</h2>

<p>Посчитать сколько и каких экземпляров книг нужно заказать поставщикам, чтобы на складе стало одинаковое количество экземпляров каждой книги, равное значению самого большего количества экземпляров одной книги на складе. Вывести название книги, ее автора, текущее количество экземпляров на складе и количество заказываемых экземпляров книг. Последнему столбцу присвоить имя <strong>Заказ</strong>. В результат не включать книги, которые заказывать не нужно.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------------------+------------------+--------+-------+
| title              | author           | amount | Заказ |
+--------------------+------------------+--------+-------+
| Мастер и Маргарита | Булгаков М.А.    | 3      | 12    |
| Белая гвардия      | Булгаков М.А.    | 5      | 10    |
| Идиот              | Достоевский Ф.М. | 10     | 5     |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 12    |
| Игрок              | Достоевский Ф.М. | 10     | 5     |
+--------------------+------------------+--------+-------+</code></pre>
</details>

<details><summary><strong>Пояснение</strong></summary>

<p>Поскольку книгу с максимальным количеством экземпляров заказывать не нужно, в условии отбора запроса укажите, что книгу с максимальным значением количества в результирующую таблицу не включать. </p>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, author, amount, ((
SELECT (MAX(amount)) FROM book
) - amount) AS Заказ
FROM book
HAVING Заказ > 0;
</code></pre><h2>Запросы на обновление</h2>

<p>Под обновлением данных подразумевается изменение значений в существующих записях таблицы. При этом возможно как изменение значений полей в группе строк (даже всех строк таблицы), так и правка значения поля отдельной строки.</p>

<p>Изменение записей в таблице реализуется с помощью запроса <code>UPDATE</code>. Простейший запрос на  обновление выглядит так:</p>

<pre><code class="language-sql">UPDATE таблица SET поле = выражение</code></pre>

<p>где <br>
<strong>таблица</strong> – имя таблицы, в которой будут проводиться изменения;<br>
<strong>поле</strong> – поле таблицы, в которое будет внесено изменение;<br>
<strong>выражение</strong> – выражение,  значение которого будет занесено в поле.</p>

<p><strong>Пример</strong></p>

<p>Уменьшить на 30% цену книг в таблице <code><strong>book</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">UPDATE book 
SET price = 0.7 * price;

SELECT * FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 5
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 469.69 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 378.35 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 322.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 559.31 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 455.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>

<p>С помощью запросов на обновление можно изменять не все записи в таблице (как в предыдущем запросе), а только часть из них. Для этого в запрос включается ключевое слово <code>WHERE</code>, после которого указывается условие отбора строк для изменения.</p>

<p><strong>Пример</strong></p>

<p>Уменьшить на 30% цену тех книг в таблице <code><strong>book</strong></code>, количество которых меньше 5.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">UPDATE book 
SET price = 0.7 * price 
WHERE amount &lt; 5;

SELECT * FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 2
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 469.69 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 559.31 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>

<p>В этом запросе обновляется только 2 записи (цена книг «Мастер и Маргарита» и «Братья Карамазовы»).</p>

<h2>Задание</h2>

<p>Уменьшить на 10% цену тех книг в таблице <code><strong>book</strong></code>, количество которых принадлежит интервалу от 5 до 10, включая границы.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 486.45 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 414.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE book
SET price = 0.9 * price
WHERE amount BETWEEN 5 AND 10;

</code></pre><h2>Задание</h2>

<p>Вывести информацию о командировках во все города кроме Москвы и Санкт-Петербурга (фамилии и инициалы сотрудников, город ,  длительность командировки в днях, при этом первый и последний день относится к периоду командировки). Последний столбец назвать <code><strong>Длительность</strong></code>. Информацию вывести в упорядоченном по убыванию длительности поездки, а потом по убыванию названий городов (в обратном алфавитном порядке).</p>

<h4>Немного теории</h4>

<p>Для вычитания двух дат используется функция <code><strong>DATEDIFF(дата_1, дата_2)</strong></code>, результатом которой является количество дней между <strong>дата_1</strong> и <strong>дата_2</strong>. Например,</p>

<pre><code class="language-sql">DATEDIFF('2020-04-01', '2020-03-28')=4

DATEDIFF('2020-05-09','2020-05-01')=8

DATEDIFF(date_last, date_first)</code></pre>

<details><summary><strong>Пояснение</strong></summary>

<p>Увеличьте разницу на 1, чтобы включить первый день командировки.</p>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу):</p>

<blockquote>
<p>Вывести информацию о командировках во все города кроме Москвы и Санкт-Петербурга (фамилии и инициалы сотрудников, город ,  длительность командировки в днях, при этом первый и последний день относится к периоду командировки). Последний столбец назвать <code><strong>Длительность</strong></code>. Информацию вывести в упорядоченном по убыванию длительности поездки, а потом по убыванию названий городов (в обратном алфавитном порядке).</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------+-------------+--------------+
| name          | city        | Длительность |
+---------------+-------------+--------------+
| Ильиных Г.Р.  | Владивосток | 22           |
| Баранов П.Е.  | Новосибирск | 17           |
| Колесов С.П.  | Новосибирск | 15           |
| Абрамова К.А. | Владивосток | 14           |
| Лебедев Т.К.  | Томск       | 12           |
| Абрамова К.А. | Владивосток | 12           |
| Федорова А.Ю. | Новосибирск | 11           |
| Колесов С.П.  | Новосибирск | 10           |
| Федорова А.Ю. | Томск       | 7            |
| Баранов П.Е.  | Воронеж     | 7            |
+---------------+-------------+--------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</li>
	<li>условие отбора (<a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a>, <a href="https://stepik.org/lesson/297509/step/10?unit=279269" rel="noopener noreferrer nofollow">шаг</a>);</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>trip</strong></code></strong></summary>

<pre><code>+---------+---------------+-----------------+----------+------------+------------+
| trip_id | name          | city            | per_diem | date_first | date_last  |
+---------+---------------+-----------------+----------+------------+------------+
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |
+---------+---------------+-----------------+----------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name, city, (DATEDIFF(date_last, date_first) + 1) AS Длительность
FROM trip
WHERE city NOT IN ('Москва', 'Санкт-Петербург')
ORDER BY Длительность DESC;


</code></pre><h2>Задание</h2>

<p>В таблице <code><strong>fine</strong></code> увеличить в два раза сумму неоплаченных штрафов для отобранных на предыдущем шаге записей. </p>

<details><summary><strong>Пояснение<span style="color: #339966;"> !!! если не получается запрос или валидатор выдает ошибки, раскройте это пояснение!!!</span></strong></summary>

<ol>
	<li>Для всех нарушений, по которым штраф еще не оплачен, (тех, у которых <code><strong>date_payment</strong></code> имеет пустое значение <span style="color: #000000;"><strong>Null</strong></span>), необходимо проверить, является ли данное нарушение для водителя и машины повторным, если да –  увеличить штраф в два раза.</li>
	<li>Если водитель совершил нарушение на другой машине, ему увеличивать штраф не нужно.</li>
	<li>Если несколько повторных нарушений не оплачены, то штраф увеличить для всех.</li>
	<li>Этот запрос реализован на предыдущем <a href="https://stepik.org/lesson/305762/step/5?unit=287773" rel="noopener noreferrer nofollow">шаге</a>.</li>
</ol>

<p>При реализации можно использовать вложенный запрос как отдельную таблицу, записанную после ключевого слова <code>UPDATE</code>, при этом вложенному запросу необходимо присвоить имя, например <code><strong>query_in</strong></code>:</p>

<pre><code class="language-sql">UPDATE fine, 
    (
     SELECT ...
    ) query_in
SET ...
WHERE указать, что совпадают нарушение, фамилия водителя и номер машины в таблицах fine и вложенном запросе query_in соответственно, а также дата оплаты в таблице fine пуста</code></pre>

<p>Другим способом решения является использование двух запросов: сначала создать временную таблицу, например <code><strong>query_in</strong></code>, в которую включить информацию о тех штрафах, сумму которых нужно увеличить в два раза, а затем уже обновлять информацию в таблице <code><strong>fine</strong></code>:</p>

<pre><code class="language-sql">CREATE TABLE query_in ...;

UPDATE fine, query_in
SET ...
WHERE ...;</code></pre>

<p>После ключевого слова <code>WHERE</code>  указывается условие, при котором нужно обновлять данные. В нашем случае  данные обновляются, если и фамилия, и государственный номер, и нарушение совпадают в таблице <code><strong>fine </strong></code>и в результирующей таблице запроса <code><strong>query_in</strong></code>. Например, для связи по фамилии используется запись <code><strong>fine.name = query_in.name</strong></code>. Также в условии нужно учесть, что данные обновляются только для тех записей, у которых в столбце <code><strong>date_payment</strong></code><span style="color: #000000;"><strong> </strong></span>пусто.</p>
</details>

<p><strong>Важно! </strong>Если в запросе используется несколько таблиц или запросов, включающих одинаковые поля, то применяется полное имя столбца, включающего название таблицы через символ «<strong>.</strong>». Например, <strong> </strong><code><strong>fine.name</strong></code>  и  <code><strong>query_in.name</strong></code>.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2

Query result:
+---------------+--------------+----------------------------------+----------+------------------+--------------+
| name          | number_plate | violation                        | sum_fine | date_violation   | date_payment |
+---------------+--------------+----------------------------------+----------+------------------+--------------+
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12       | 2020-01-17   |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14       | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23       | 2020-02-23   |
| Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-12       | NULL        |
| Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01       | NULL         |
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14       | NULL         |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23       | NULL         |
| Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-03-03       | NULL         |
+---------------+--------------+----------------------------------+----------+------------------+--------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li>обновление данных (<a href="https://stepik.org/lesson/305012/step/6?unit=287020" rel="noopener noreferrer nofollow">шаг</a>, <a href="https://stepik.org/lesson/305012/step/7?unit=287020" rel="noopener noreferrer nofollow">шаг</a>, <a href="https://stepik.org/lesson/305012/step/8?unit=287020" rel="noopener noreferrer nofollow">шаг</a>);</li>
	<li><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>fine</strong></code> (без ключевого столбца) перед выполнением этого шага</strong></summary>

<pre><code class="language-sql">+---------------+--------+------------------------------+----------+----------------+--------------+
| name          | number | violation                    | sum_fine | date_violation | date_payment |
|               | _plate |                              |          |                |              |
+---------------+--------+------------------------------+----------+----------------+--------------+
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 500.00   | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 1000.00  | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 1000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 1000.00  | 2020-03-03     | NULL         |
+---------------+--------+------------------------------+----------+----------------+--------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE fine, (SELECT name, number_plate, violation FROM fine GROUP BY name, number_plate, violation HAVING COUNT(*) > 1) AS fine_2
SET fine.sum_fine = fine.sum_fine * 2
WHERE fine.date_payment IS Null AND fine.name = fine_2.name AND fine.violation = fine_2.violation AND fine.number_plate = fine_2.number_plate;

</code></pre><h2><strong>Задание</strong></h2>

<p>Создать таблицу<code><strong> author </strong></code>следующей структуры:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #e6f8e0; background: #e6f8e0; text-align: center;">
			<td><strong>Поле</strong></td>
			<td><strong>Тип, описание</strong></td>
		</tr>
		<tr>
			<td>author_id</td>
			<td><code>INT PRIMARY KEY AUTO_INCREMENT</code></td>
		</tr>
		<tr>
			<td>name_author</td>
			<td><code>VARCHAR(50)</code></td>
		</tr>
	</tbody>
</table> <br><hr><br> <pre><code class="hljs language-sql">
CREATE TABLE author (
author_id INT PRIMARY KEY AUTO_INCREMENT,
name_author VARCHAR(50));



</code></pre><h2>Запросы для нескольких таблиц с группировкой</h2>

<p>В запросах с групповыми функциями могут использоваться несколько таблиц, между которыми используются различные типы соединений.</p>

<p><strong>Пример</strong></p>

<p>Вывести количество различных книг каждого автора. Информацию отсортировать в алфавитном порядке по фамилиям  авторов.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT name_author, count(title) AS Количество
FROM 
    author INNER JOIN book
    on author.author_id = book.author_id
GROUP BY name_author
ORDER BY name_author;    </code></pre>

<p><em>Результат</em></p>

<pre><code class="language-sql">+------------------+------------+
| name_author      | Количество |
+------------------+------------+
| Булгаков М.А.    | 2          |
| Достоевский Ф.М. | 3          |
| Есенин С.А.      | 2          |
| Пастернак Б.Л.   | 1          |
+------------------+------------+</code></pre>

<p>При использовании соединения <code>INNER JOIN</code> мы не можем узнать, что книг Лермонтова на складе нет, но предполагается, что они могут быть.  Чтобы автор Лермонтов был включен в результат, нужно изменить соединение таблиц.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT name_author, count(title) AS Количество
FROM 
    author LEFT JOIN book
    on author.author_id = book.author_id
GROUP BY name_author
ORDER BY name_author;   </code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+------------+
| name_author      | Количество |
+------------------+------------+
| Булгаков М.А.    | 2          |
| Достоевский Ф.М. | 3          |
| Есенин С.А.      | 2          |
| Лермонтов М.Ю.   | 0          |
| Пастернак Б.Л.   | 1          |
+------------------+------------+</code></pre>

<h2><strong>Задание</strong></h2>

<p>Посчитать количество экземпляров  книг каждого автора из таблицы <code><strong>author</strong></code>.  Вывести тех авторов,  количество книг которых меньше 10, в отсортированном по возрастанию количества виде. Последний столбец назвать <code><strong>Количество</strong></code>.</p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Чтобы в результат были включены авторы, книг которых на складе нет, необходимо в условии отбора, кроме того, что общее количество книг каждого автора меньше 10, учесть, что у автора вообще может не быть книг (то есть <code><strong>COUNT(title) = 0</strong></code>).</p>
</details>

<p><em><strong>Текст задания (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p>Посчитать количество экземпляров  книг каждого автора из таблицы <code><strong>author</strong></code>.  Вывести тех авторов,  количество книг которых меньше 10, в отсортированном по возрастанию количества виде. Последний столбец назвать <code><strong>Количество</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+----------------+------------+
| name_author    | Количество |
+----------------+------------+
| Лермонтов М.Ю. | NULL       |
| Пастернак Б.Л. | 2          |
| Булгаков М.А.  | 8          |
+----------------+------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code class="language-sql">Таблица genre:
+----------+-------------+
| genre_id | name_genre  |
+----------+-------------+
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |
+----------+-------------+

Таблица author:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
+-----------+------------------+

Таблица book:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_author, SUM(amount) AS Количество
FROM author LEFT OUTER JOIN book ON author.author_id = book.author_id
GROUP BY name_author
HAVING Количество < 10 OR Количество IS Null
ORDER BY Количество ASC;
</code></pre><h2>Каскадное удаление записей связанных таблиц</h2>

<p>При создании таблицы для внешних ключей с помощью <code>ON DELETE</code><strong> </strong><a href="https://stepik.org/lesson/308885/step/9?unit=291011" rel="noopener noreferrer nofollow">устанавливаются опции</a>, которые определяют действия , выполняемые при удалении связанной строки из главной таблицы.</p>

<p>В частности, <code>ON DELETE CASCADE</code> автоматически удаляет строки из зависимой таблицы при удалении  связанных строк в главной таблице.</p>

<p>В таблице <code><strong>book</strong></code> эта опция установлена для поля <strong><code>author_id</code></strong>.</p>

<p><strong>Пример</strong></p>

<p>Удалим из таблицы <code><strong>author</strong></code> всех авторов, фамилия которых начинается на «Д», а из таблицы <code><strong>book</strong></code>  - все книги этих авторов.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">DELETE FROM author
WHERE name_author LIKE "Д%";

SELECT * FROM author;

SELECT * FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 1

Query result:
+-----------+----------------+
| author_id | name_author    |
+-----------+----------------+
| 1         | Булгаков М.А.  |
| 3         | Есенин С.А.    |
| 4         | Пастернак Б.Л. |
| 5         | Лермонтов М.Ю. |
| 6         | Стивенсон Р.Л. |
+-----------+----------------+
Affected rows: 5

Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>

<p>Одним запросом удаляются связанные записи из главной и зависимой таблицы. В нашем случае удалился автор Достоевский и все его книги.</p>

<h2>Задание</h2>

<p>Удалить всех авторов и все их книги, общее количество книг которых меньше 20.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для подсчета количества книг каждого автора используйте вложенный запрос. </p>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 4

Query result:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
+-----------+------------------+
Affected rows: 2

Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
+---------+-----------------------+-----------+----------+--------+--------+
Affected rows: 5</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code>Таблица book
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+
Таблица supply
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
Таблица author                          Таблица genre
+-----------+------------------+	+----------+-------------+			
| author_id | name_author      |	| genre_id | name_genre  |			
+-----------+------------------+	+----------+-------------+			
| 1         | Булгаков М.А.    |	| 1        | Роман       |			
| 2         | Достоевский Ф.М. |	| 2        | Поэзия      |			
| 3         | Есенин С.А.      |	| 3        | Приключения |			
| 4         | Пастернак Б.Л.   |	+----------+-------------+			
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |
+-----------+------------------+						</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">DELETE FROM author
WHERE author_id IN (SELECT book.author_id FROM book INNER JOIN
(SELECT book.author_id, SUM(amount)
FROM author INNER JOIN book ON author.author_id = book.author_id
GROUP BY author.author_id
HAVING SUM(amount) < 20) as query_1 ON book.author_id = query_1.author_id);
</code></pre><h2>Задание</h2>

<p>Посчитать, сколько раз была заказана каждая книга, для книги вывести ее автора (нужно посчитать, в каком количестве заказов фигурирует каждая книга).  Вывести фамилию и инициалы автора, название книги, последний столбец назвать <code><strong>Количество</strong></code>. Результат отсортировать сначала  по фамилиям авторов, а потом по названиям книг.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/c9356f96-1b19-42ce-8c9e-e7a8169734fc/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для того, чтобы были выведены книги, которые клиенты не заказывали, использовать <a href="https://stepik.org/lesson/308886/step/3?unit=291012" rel="noopener noreferrer nofollow">внешнее соединение</a>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a></u>;</li>
	<li>соединение таблиц (<u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">групповые функции</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу)</p>

<blockquote>
<p>Посчитать, сколько раз была заказана каждая книга, для книги вывести ее автора (нужно посчитать, в каком количестве заказов фигурирует каждая книга).  Вывести фамилию и инициалы автора, название книги, последний столбец назвать <code><strong>Количество</strong></code>. Результат отсортировать сначала  по фамилиям авторов, а потом по названиям книг.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------------+-----------------------+------------+
| name_author      | title                 | Количество |
+------------------+-----------------------+------------+
| Булгаков М.А.    | Белая гвардия         | 1          |
| Булгаков М.А.    | Мастер и Маргарита    | 2          |
| Достоевский Ф.М. | Братья Карамазовы     | 0          |
| Достоевский Ф.М. | Игрок                 | 1          |
| Достоевский Ф.М. | Идиот                 | 2          |
| Есенин С.А.      | Стихотворения и поэмы | 0          |
| Есенин С.А.      | Черный человек        | 1          |
| Пастернак Б.Л.   | Лирика                | 1          |
+------------------+-----------------------+------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_author, book.title, COUNT(buy_book.amount) AS Количество
FROM book INNER JOIN author ON book.author_id = author.author_id LEFT OUTER JOIN buy_book ON book.book_id = buy_book.book_id 
GROUP BY book.title, name_author
ORDER BY name_author ASC, title ASC;

</code></pre><h2>Задание</h2>

<p>Создать счет (таблицу <strong><code>buy_pay</code></strong>) на оплату заказа с номером 5, в который включить название книг, их автора, цену, количество заказанных книг и  стоимость. Последний столбец назвать <code><strong>Стоимость</strong></code>. Информацию в таблицу занести в отсортированном по названиям книг виде.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" height="363" src="https://ucarecdn.com/cf0254ce-b399-4abd-afa4-29c3613272b0/" width="211"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для создании таблицы используйте запрос <code>CREATE</code>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/10?unit=287020" rel="noopener noreferrer nofollow">создание таблицы</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/5?unit=279269" rel="noopener noreferrer nofollow">вычисления в SELECT</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Создать счет (таблицу <strong><code>buy_pay</code></strong>) на оплату заказа с номером 5, в который включить название книг, их автора, цену, количество заказанных книг и  стоимость. Последний столбец назвать <code><strong>Стоимость</strong></code>. Информацию в таблицу занести в отсортированном по названиям книг виде.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2

Query result (выборка из таблицы buy_pay):
+---------------+----------------+--------+--------+-----------+
| title         | name_author    | price  | amount | Стоимость |
+---------------+----------------+--------+--------+-----------+
| Белая гвардия | Булгаков М.А.  | 540.50 | 1      | 540.50    |
| Лирика        | Пастернак Б.Л. | 518.99 | 2      | 1037.98   |
+---------------+----------------+--------+--------+-----------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц(перед выполнением шага)</strong></summary> <img alt="" height="878" name="115.png" src="https://ucarecdn.com/023077f7-c72f-44cb-959c-d7dc0adfdbfd/" width="711"></details> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE buy_pay AS
SELECT title, name_author, price, buy_book.amount, (price * buy_book.amount) AS Стоимость
FROM buy_book INNER JOIN book USING(book_id) INNER JOIN author USING(author_id)
WHERE buy_id = 5
ORDER BY title ASC;

</code></pre><h2>Задание</h2>

<p>Вывести образовательные программы, которые имеют самый большой план набора, <strong> </strong>вместе с этой величиной.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/c59b5da0-f7bc-47ae-bd7d-882a3ccd84a3/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297514/step/2?unit=279274" rel="noopener noreferrer nofollow">вложенные запросы в условии отбора</a></u>.</li>
</ul>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------------------+------+
| name_program                | plan |
+-----------------------------+------+
| Мехатроника и робототехника | 3    |
+-----------------------------+------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>program</code></strong></summary>

<pre><code class="language-sql">таблица program
+------------+-------------------------------------+---------------+------+
| program_id | name_program                        | department_id | plan |
+------------+-------------------------------------+---------------+------+
| 1          | Прикладная математика и информатика | 2             | 1    |
| 2          | Математика и компьютерные науки     | 2             | 2    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |
+------------+-------------------------------------+---------------+------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_program, plan
FROM program
WHERE plan = (SELECT MAX(plan) FROM program)


</code></pre><h2>Зачисление студентов</h2>

<p>Рассмотрим, как происходит формирование списка абитуриентов, проходящих по конкурсу на образовательные программы. </p>

<p>В таблицу <code><strong>applicant_order</strong></code> для пояснения включены столбцы «План набора» и «Результат». Каждая программа имеет свой план набора, например, план набора образовательной программы с<strong> <code>id</code></strong> 1 – 2 человека.  Проходящими по конкурсу считаются первые два человека в списке  отсортированных по итоговому баллу абитуриентов, подавших заявление на  образовательную программу. Это абитуриенты с <code><strong>id</strong></code> 3 и 2. Аналогично отбираются абитуриенты на остальные образовательные программы. В таблице все проходящие по конкурсу выделены зеленым цветом.</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>program_id</strong></td>
			<td><strong>план набора</strong></td>
			<td><strong>enrollee_id</strong></td>
			<td><strong>itog</strong></td>
			<td><strong>Результат</strong></td>
		</tr>
		<tr style="background-color: #98fb98; background: #98fb98;">
			<td>1</td>
			<td>2</td>
			<td>3</td>
			<td>235</td>
			<td>рекомендован к зачислению</td>
		</tr>
		<tr style="background-color: #98fb98; background: #98fb98;">
			<td>1</td>
			<td>2</td>
			<td>2</td>
			<td>226</td>
			<td>рекомендован к зачислению</td>
		</tr>
		<tr>
			<td>1</td>
			<td>2</td>
			<td>1</td>
			<td>219</td>
			<td> </td>
		</tr>
		<tr style="background-color: #98fb98; background: #98fb98;">
			<td>2</td>
			<td>1</td>
			<td>6</td>
			<td>276</td>
			<td>рекомендован к зачислению</td>
		</tr>
		<tr>
			<td>2</td>
			<td>1</td>
			<td>3</td>
			<td>235</td>
			<td> </td>
		</tr>
		<tr>
			<td>2</td>
			<td>1</td>
			<td>2</td>
			<td>226</td>
			<td> </td>
		</tr>
		<tr style="background-color: #98fb98; background: #98fb98;">
			<td>3</td>
			<td>2</td>
			<td>6</td>
			<td>270</td>
			<td>рекомендован к зачислению</td>
		</tr>
		<tr style="background-color: #98fb98; background: #98fb98;">
			<td>3</td>
			<td>2</td>
			<td>4</td>
			<td>239</td>
			<td>рекомендован к зачислению</td>
		</tr>
		<tr>
			<td>3</td>
			<td>2</td>
			<td>5</td>
			<td>200</td>
			<td> </td>
		</tr>
		<tr style="background-color: #98fb98; background: #98fb98;">
			<td>4</td>
			<td>3</td>
			<td>6</td>
			<td>270</td>
			<td>рекомендован к зачислению</td>
		</tr>
		<tr style="background-color: #98fb98; background: #98fb98;">
			<td>4</td>
			<td>3</td>
			<td>3</td>
			<td>247</td>
			<td>рекомендован к зачислению</td>
		</tr>
		<tr style="background-color: #98fb98; background: #98fb98;">
			<td>4</td>
			<td>3</td>
			<td>5</td>
			<td>200</td>
			<td>рекомендован к зачислению</td>
		</tr>
	</tbody>
</table>

<p>Для отбора рекомендованных к зачислению студентов можно разработать различные алгоритмы. Мы реализуем несколько SQL запросов. В первом запросе вставим в таблицу <code><strong>applicant_order</strong></code> новый столбец для последовательной нумерации строк. </p>

<p>Для изменения структуры таблицы используется оператор <code>ALTER TABLE</code>. С его помощью можно вставить новый столбец, удалить существующий, переименовать столбец и пр.</p>

<p>Для вставки нового столбца используется SQL запросы:</p>

<pre><code class="language-sql">ALTER TABLE таблица ADD имя_столбца тип; - вставляет столбец после последнего
ALTER TABLE таблица ADD имя_столбца тип FIRST; - вставляет столбец перед первым
ALTER TABLE таблица ADD имя_столбца тип AFTER имя_столбца_1; - вставляет столбец после укзанного столбца</code></pre>

<p>Для удаления столбца используется SQL запросы:</p>

<pre><code>ALTER TABLE таблица DROP COLUMN имя_столбца; - удаляет столбец с заданным именем
ALTER TABLE таблица DROP имя_столбца; - ключевое слово COLUMN не обязательно указывать
ALTER TABLE таблица DROP имя_столбца,
                    DROP имя_столбца_1; - удаляет два столбца</code></pre>

<p>Для переименования столбца используется  запрос (тип данных указывать обязательно):</p>

<pre><code>ALTER TABLE таблица CHANGE имя_столбца новое_имя_столбца ТИП ДАННЫХ;</code></pre>

<p>Для изменения типа  столбца используется запрос (два раза указывать имя столбца обязательно): </p>

<pre><code>ALTER TABLE таблица CHANGE имя_столбца имя_столбца НОВЫЙ_ТИП_ДАННЫХ;</code></pre>

<h2>Задание</h2>

<p>Включить в таблицу <code><strong>applicant_order</strong></code> новый столбец <code><strong>str_id</strong></code> целого типа , расположить его перед первым.</p>

<p><strong>Структура корректируемой таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/56d55eb1-112b-406f-a961-a656d00f3258/"></p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------+------------+-------------+------+
| str_id | program_id | enrollee_id | itog |
+--------+------------+-------------+------+
| None   | 1          | 3           | 235  |
| None   | 1          | 2           | 226  |
| None   | 1          | 1           | 219  |
| None   | 2          | 6           | 276  |
| None   | 2          | 3           | 235  |
| None   | 2          | 2           | 226  |
| None   | 3          | 6           | 270  |
| None   | 3          | 4           | 239  |
| None   | 3          | 5           | 200  |
| None   | 4          | 6           | 270  |
| None   | 4          | 3           | 247  |
| None   | 4          | 5           | 200  |
+--------+------------+-------------+------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">ALTER TABLE applicant_order ADD str_id INT FIRST;



SELECT * FROM applicant_order

</code></pre><h2>Задание</h2>

<p>Студенты могут тестироваться по одной или нескольким дисциплинам (не обязательно по всем). Вывести дисциплину и количество уникальных студентов (столбец назвать <code><strong>Количество</strong></code>), которые по ней проходили тестирование . Информацию отсортировать сначала по убыванию количества, а потом по названию дисциплины. В результат включить и дисциплины, тестирование по которым студенты еще не проходили, в этом случае указать количество студентов 0.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>Если один и тот же студент тестировался несколько раз по одной и той же дисциплине, то студента учитывать один раз.</p>
</details>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/306248a6-1b7c-4b93-8106-31a368482f0c/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Чтобы вывести дисциплину, по которой никто не проходил тестирование, используйте <a href="https://stepik.org/lesson/308886/step/3?unit=291012" rel="noopener noreferrer nofollow">внешнее соединение</a> таблиц.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/3?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/2?unit=279275" rel="noopener noreferrer nofollow">уникальные записи</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу)</p>

<blockquote>
<p>Студенты могут тестироваться по одной или нескольким дисциплинам (не обязательно по всем). Вывести дисциплину и количество уникальных студентов (столбец назвать <code><strong>Количество</strong></code>), которые по ней проходили тестирование . Информацию отсортировать сначала по убыванию количества, а потом по названию дисциплины. В результат включить и дисциплины, тестирование по которым студенты не проходили, в этом случае указать количество студентов 0.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------------------+------------+
| name_subject      | Количество |
+-------------------+------------+
| Основы SQL        | 2          |
| Основы баз данных | 2          |
| Физика            | 0          |
+-------------------+------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц <code>attempt</code> и <code>subject</code></strong></summary>

<pre><code class="language-sql">таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
таблица subject
+------------+-------------------+
| subject_id | name_subject      |
+------------+-------------------+
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |
+------------+-------------------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_subject, COUNT(DISTINCT(student_id)) AS Количество
FROM subject LEFT JOIN attempt ON subject.subject_id = attempt.subject_id
GROUP BY name_subject
ORDER BY Количество DESC;

</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов корректировки данных для предметной области «Тестирование» (в таблицы занесены данные, как на первом шаге урока). Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно реализовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/e4669333-8898-434f-b1a5-4fa88b39ae02/"></p>

<details><summary><strong>Наполнение таблиц</strong></summary>

<pre><code class="language-sql">таблица student                   таблица subject
+------------+-----------------+  +------------+-------------------+
| student_id | name_student    |  | subject_id | name_subject      |
+------------+-----------------+  +------------+-------------------+
| 1          | Баранов Павел   |  | 1          | Основы SQL        |
| 2          | Абрамова Катя   |  | 2          | Основы баз данных |
| 3          | Семенов Иван    |  | 3          | Физика            |
| 4          | Яковлева Галина |  +------------+-------------------+
+------------+-----------------+
таблица question
+-------------+------------------------------------------------------------+------------+
| question_id | name_question                                              | subject_id |
+-------------+------------------------------------------------------------+------------+
| 1           | Запрос на выборку начинается с ключевого слова:            | 1          |
| 2           | Условие, по которому отбираются записи, задается после...  | 1          |
| 3           | Для сортировки используется:                               | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:       | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:   | 1          |
| 6           | База данных - это:                                         | 2          |
| 7           | Отношение - это:                                           | 2          |
| 8           | Концептуальная модель используется для                     | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?        | 2          |
+-------------+------------------------------------------------------------+------------+
таблица answer
+-----------+--------------------------------------------------------+-------------+------------+
| answer_id | name_answer                                            | question_id | is_correct |
+-----------+--------------------------------------------------------+-------------+------------+
| 1         | UPDATE                                                 | 1           | 0          |
| 2         | SELECT                                                 | 1           | 1          |
| 3         | INSERT                                                 | 1           | 0          |
| 4         | GROUP BY                                               | 2           | 0          |
| 5         | FROM                                                   | 2           | 0          |
| 6         | WHERE                                                  | 2           | 1          |
| 7         | SELECT                                                 | 2           | 0          |
| 8         | SORT                                                   | 3           | 0          |
| 9         | ORDER BY                                               | 3           | 1          |
| 10        | RANG BY                                                | 3           | 0          |
| 11        | SELECT * FROM student                                  | 4           | 1          |
| 12        | SELECT student                                         | 4           | 0          |
| 13        | INNER JOIN                                             | 5           | 1          |
| 14        | LEFT JOIN                                              | 5           | 0          |
| 15        | RIGHT JOIN                                             | 5           | 0          |
| 16        | CROSS JOIN                                             | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным...  | 6           | 1          |
| 18        | совокупность программ для хранения иобработки ...      | 6           | 0          |
| 19        | строка                                                 | 7           | 0          |
| 20        | столбец                                                | 7           | 0          |
| 21        | таблица                                                | 7           | 1          |
| 22        | обобщенное представление пользователей о данных        | 8           | 1          |
| 23        | описание представления данных в памяти компьютера      | 8           | 0          |
| 24        | база данных                                            | 8           | 0          |
| 25        | file                                                   | 9           | 1          |
| 26        | INT                                                    | 9           | 0          |
| 27        | VARCHAR                                                | 9           | 0          |
| 28        | DATE                                                   | 9           | 0          |
+-----------+--------------------------------------------------------+-------------+------------+
таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
таблица testing
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
+------------+------------+-------------+-----------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE attempt,(
    SELECT ROUND((SUM(is_correct) /3 * 100), 0) AS result
    FROM answer INNER JOIN testing USING(answer_id)
    WHERE attempt_id = 5) AS tbl
SET attempt.result = tbl.result
WHERE attempt.attempt_id = 5;




</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em>Елена Голяева</p>

<p>Вывести авторов и суммарную стоимость их книг, если хотя бы одна их книга имеет цену выше средней по складу. Средняя цена рассчитывается как простое среднее, с помощью <code><strong>avg().</strong></code> Информацию отсортировать по убыванию суммарной стоимости.</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------+
| author           | Стоимость |
+------------------+-----------+
| Достоевский Ф.М. | 11802.03  |
| Есенин С.А.      | 9750.00   |
| Булгаков М.А.    | 4715.47   |
+------------------+-----------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Вывести авторов и суммарную стоимость их книг, если хотя бы одна их книга имеет цену выше средней по складу. Средняя цена рассчитывается как простое среднее, с помощью <code><strong>avg().</strong></code> Информацию отсортировать по убыванию суммарной стоимости.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/215417533" rel="noopener noreferrer nofollow">Илья Кадочников</a></p>

<p>Магазин решил быстрее распродать остатки книг, цена которых выше 600, а также прописать условия доставки. Создать запрос на выборку, в котором:</p>

<ol>
	<li>Столбцы назовите<code><strong> Наименование</strong></code>, <code><strong>Цена</strong></code> и <code><strong> Стоимость доставки</strong></code>.</li>
	<li>Отберите все книги, цена которых выше 600.</li>
	<li>Если остаток по отдельной книге меньше или равен 5, то стоимость доставки будет 500 рублей, если больше 5, то доставка будет бесплатной (вместо стоимости доставки вставить <strong>Бесплатно</strong>).</li>
	<li>Отсортируйте значения по убыванию цены книг.</li>
</ol>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+--------+--------------------+
| Наименование          | Цена   | Стоимость_доставки |
+-----------------------+--------+--------------------+
| Братья Карамазовы     | 799.01 | 500                |
| Мастер и Маргарита    | 670.99 | 500                |
| Черный человек        | 670.99 | 500                |
| Стихотворения и поэмы | 650.00 | Бесплатно          |
+-----------------------+--------+--------------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Магазин решил быстрее распродать остатки книг, цена которых выше 600, а также прописать условия доставки. Создать запрос на выборку, в котором:</p>

<ol>
	<li>Столбцы назовите<code><strong> Наименование</strong></code>, <code><strong>Цена</strong></code> и <code><strong> Стоимость доставки</strong></code>.</li>
	<li>Отберите все книги, цена которых выше 600.</li>
	<li>Если остаток по отдельной книге меньше или равен 5, то стоимость доставки будет 500 рублей, если больше 5, то доставка будет бесплатной (вместо стоимости доставки вставить <strong>Бесплатно</strong>).</li>
	<li>Отсортируйте значения по убыванию цены книг.</li>
</ol>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/58247085" rel="noopener noreferrer nofollow">Игорь Владимирович Лапшин</a></p>

<p>Акция "Купи книгу от 500 руб. и получи подарок".<br>
Вывести автора, название книги и цену. Выбрать книги с ценой 500 рублей и выше, отсортировать информацию в алфавитном порядке по автору и названию книги. Добавить столбец <code><strong>Подарок</strong></code>,  в котором вывести, какой подарок получает покупатель: если куплена книга от 500 рублей до 600 рублей (включительно), то подарок - ручка, от 600 до 700 (включительно) - детская раскраска, выше 700 - гороскоп.</p>

<p><strong>  Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------------------+--------+-------------------+
| Автор            | Название_книги        | Цена   | Подарок           |
+------------------+-----------------------+--------+-------------------+
| Булгаков М.А.    | Белая гвардия         | 540.50 | ручка             |
| Булгаков М.А.    | Мастер и Маргарита    | 670.99 | детская раскраска |
| Достоевский Ф.М. | Братья Карамазовы     | 799.01 | гороскоп          |
| Есенин С.А.      | Стихотворения и поэмы | 650.00 | детская раскраска |
| Есенин С.А.      | Черный человек        | 670.99 | детская раскраска |
+------------------+-----------------------+--------+-------------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Акция "Купи книгу от 500 руб. и получи подарок".<br>
Вывести автора, название книги и цену. Выбрать книги с ценой 500 рублей и выше, отсортировать информацию в алфавитном порядке по автору и названию книги. Добавить столбец <code><strong>Подарок</strong></code>,  в котором вывести, какой подарок получает покупатель: если куплена книга от 500 рублей до 600 рублей (включительно), то подарок - ручка, от 600 до 700 (включительно) - детская раскраска, выше 700 - гороскоп.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Табличные выражения, оператор WITH</h2>

<p>Табличное выражение определяется с помощью оператора<strong> <code>WITH</code></strong> и является частью запроса. Его синтаксис: </p>

<pre><code class="language-sql">WITH имя_выражения (имя_1, имя_2,...)
  AS
    (
     SELECT столбец_1, столбец_2,
     FROM 
       ... 
     )
SELECT ...
   FROM имя_выражения
   ...</code></pre>

<p>В табличном выражении определяется запрос, результат которого нужно использовать в основной части запроса после <code><strong>SELECT</strong></code>. При этом основной запрос может обратиться к столбцам результата табличного выражения через имена, заданные в заголовке <code><strong>WITH</strong></code>. При этом количество имен должно совпадать с количеством результирующих столбцов табличного выражения.</p>

<p>В одном запросе может быть несколько табличных выражений. При этом в каждом табличном выражении можно использовать все предшествующие ему табличные выражения.</p>

<p>В табличном выражении необязательно давать имена столбцам результата. В этом случае в основном запросе можно использовать имена столбцов, указанных после <code><strong>SELECT</strong></code> в табличном выражении. При наличии одинаковых имен в нескольких табличных выражениях необходимо использовать полное имя столбца (имя табличного выражения, точка, имя столбца).</p>

<p><strong>Пример</strong></p>

<p>Для каждого шага вывести процент правильных решений. Информацию упорядочить по возрастанию процента верных решений. Столбцы результата назвать <code><strong>Шаг</strong></code> и <strong><code>Успешность</code></strong>, процент успешных решений округлить до целого.</p>

<p><strong>Важно. </strong>Только для этого задания для одного из шагов установлено, что все ответы пользователей - неверные.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/d023dc5c-765a-4d03-ad49-6f5655790cde/"></p>

<p><strong>Шаг 1. </strong>Создадим запрос, который для каждого шага вычисляет количество правильных ответов, данных пользователями.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT step_name, count(*)
FROM 
    step 
    INNER JOIN step_student USING (step_id)
WHERE result = "correct"
GROUP BY step_name;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+---------------------------------------------------------------+----------+
| step_name                                                     | count(*) |
+---------------------------------------------------------------+----------+
| Выборка всех данных из таблицы                                | 66       |
| Выборка отдельных столбцов                                    | 65       |
| Выборка отдельных столбцов и присвоение им новых имен         | 66       |
| Выборка данных с созданием вычисляемого столбца               | 64       |
| Выборка данных, вычисляемые столбцы, математические функции   | 66       |
                           ...
+---------------------------------------------------------------+----------+
Affected rows: 31</code></pre>

<p><strong>Шаг 2. </strong>Создадим запрос, который для каждого шага вычисляет количество неверных ответов, данных пользователями.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT step_name, count(*)
FROM 
    step 
    INNER JOIN step_student USING (step_id)
WHERE result = "wrong"
GROUP BY step_name;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+---------------------------------------------------------------+----------+
| step_name                                                     | count(*) |
+---------------------------------------------------------------+----------+
| Выборка всех данных из таблицы                                | 10       |
| Выборка отдельных столбцов                                    | 20       |
| Выборка отдельных столбцов и присвоение им новых имен         | 13       |
| Выборка данных с созданием вычисляемого столбца               | 23       |
                           ...
+---------------------------------------------------------------+----------+
Affected rows: 30</code></pre>

<p><strong>Шаг 3.</strong> Создадим запрос с табличными выражениями, который вычисляет процент верных решений. Запрос первого шага включим как табличное выражение с именем <code><strong>get_count_correct</strong></code>, запрос второго шага - как табличное выражение <code><strong>get_count_wrong</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">WITH get_count_correct (st_n_c, count_correct) 
  AS (
      SELECT step_name, count(*)
      FROM 
          step 
          INNER JOIN step_student USING (step_id)
      WHERE result = "correct"
      GROUP BY step_name
   ),
  get_count_wrong (st_n_w, count_wrong) 
  AS (
    SELECT step_name, count(*)
    FROM 
        step 
        INNER JOIN step_student USING (step_id)
    WHERE result = "wrong"
    GROUP BY step_name
   )  
SELECT st_n_c AS Шаг, 
    ROUND(count_correct / (count_correct + count_wrong) * 100) AS Успешность
FROM  
    get_count_correct 
    INNER JOIN get_count_wrong ON st_n_c = st_n_w
</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------------------------------------------------------------------------+------------+
| Шаг                                                                      | Успешность |
+--------------------------------------------------------------------------+------------+
| Выборка данных, оператор LIKE                                            | 19         |
| Вложенные запросы в операторах соединения                                | 32         |
| Задание. Вывести самый популярный жанр                                   | 33         |
| Запросы для нескольких таблиц с группировкой                             | 33         |
                              ...
+--------------------------------------------------------------------------+------------+
Affected rows: 30
</code></pre>

<p><strong>Шаг 4. </strong>Обратите внимание, что всего вопросов в таблице 32,  но запрос первого шага вывел общее количество вопросов - 31, а запрос второго шага - 30. Это значит, что на одно задание все пользователи дали неверный ответ, а на два -  все пользователи дали верный ответ. </p>

<p>Следовательно, нужно вместо внутреннего соединения<strong> <code>INNER JOIN</code></strong> применить полное внешнее соединение <code><strong>FULL JOIN</strong></code>. Это соединение в MySQL не поддерживается, его можно реализовать запросами с<strong> <code>LEFT</code></strong> и <code><strong>RIGHT JOIN</strong></code>, соединенных оператором <code><strong>UNION</strong></code>:</p>

<pre><code class="language-sql">SELECT ...
   FROM таблица_1 LEFT JOIN таблица_2 ON ...
...
UNION
SELECT ...
   FROM таблица_1 RIGHT JOIN таблица_2 ON ...
...</code></pre>

<p><em>Запрос шага 4</em>:</p>

<pre><code class="language-sql">WITH get_count_correct (st_n_c, count_correct) 
  AS (
    SELECT step_name, count(*)
    FROM 
        step 
        INNER JOIN step_student USING (step_id)
    WHERE result = "correct"
    GROUP BY step_name
   ),
  get_count_wrong (st_n_w, count_wrong) 
  AS (
    SELECT step_name, count(*)
    FROM 
        step 
        INNER JOIN step_student USING (step_id)
    WHERE result = "wrong"
    GROUP BY step_name
   )  
SELECT st_n_c AS Шаг,
    ROUND(count_correct / (count_correct + count_wrong) * 100) AS Успешность
FROM  
    get_count_correct 
    LEFT JOIN get_count_wrong ON st_n_c = st_n_w
UNION
SELECT st_n_w AS Шаг,
    ROUND(count_correct / (count_correct + count_wrong) * 100) AS Успешность
FROM  
    get_count_correct 
    RIGHT JOIN get_count_wrong ON st_n_c = st_n_w
ORDER BY 2 ;
</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------------------------------------------------------------------------+------------+
| Шаг                                                                      | Успешность |
+--------------------------------------------------------------------------+------------+
| Задание. Работа с архивной таблицей, оператор UNION, часть 1             | None       |
| Задание. Работа с архивной таблицей, оператор UNION, часть 2             | None       |
| Построение логической схемы базы данных                                  | None       |
| Выборка данных, оператор LIKE                                            | 19         |
| Вложенные запросы в операторах соединения                                | 32         |
| Задание. Вывести самый популярный жанр                                   | 33         |
| Запросы для нескольких таблиц с группировкой                             | 33         |     
                              ...
+--------------------------------------------------------------------------+------------+
Affected rows: 32
</code></pre>

<p>Процент успешных попыток для тех шагов, которые не имеют неверных ответов  или не имеют верных - <code><strong>Null</strong></code>, а должно быть 100% и 0%  соответственно. Это произошло из-за того, что при внешнем соединении, вместо отсутствующего значения в результат подставляется <code><strong>Null</strong></code>.</p>

<h2>Задание</h2>

<p>Исправить запрос примера так: для шагов, которые  не имеют неверных ответов,  указать 100 как процент успешных попыток, если же шаг не имеет верных ответов, указать 0. Информацию отсортировать сначала по возрастанию успешности, а затем по названию шага в алфавитном порядке.</p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li>соединение таблиц (<u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/308886/step/3?unit=291012" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow">функция IF()</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------------------------------------------------------------------------+------------+
| Шаг                                                                      | Успешность |
+--------------------------------------------------------------------------+------------+
| Задание. Работа с архивной таблицей, оператор UNION, часть 1             | 0          |
| Выборка данных, оператор LIKE                                            | 19         |
| Вложенные запросы в операторах соединения                                | 32         |
                     ....
| Выборка отдельных столбцов и присвоение им новых имен                    | 84         |
| Выборка всех данных из таблицы                                           | 87         |
| Задание. Работа с архивной таблицей, оператор UNION, часть 2             | 100        |
| Построение логической схемы базы данных                                  | 100        |
+--------------------------------------------------------------------------+------------+
Affected rows: 32</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">WITH get_count_correct (st_n_c, count_correct) 
  AS (
    SELECT step_name, count(*)
    FROM 
        step 
        INNER JOIN step_student USING (step_id)
    WHERE result = "correct"
    GROUP BY step_name
   ),
  get_count_wrong (st_n_w, count_wrong) 
  AS (
    SELECT step_name, count(*)
    FROM 
        step 
        INNER JOIN step_student USING (step_id)
    WHERE result = "wrong"
    GROUP BY step_name
   )  
SELECT st_n_c AS Шаг,
    IF(st_n_c NOT IN (
    Select st_n_w From get_count_wrong), 100, ROUND(count_correct / (count_correct + count_wrong) * 100)) AS Успешность
FROM  
    get_count_correct 
    LEFT JOIN get_count_wrong ON st_n_c = st_n_w
UNION
SELECT st_n_w AS Шаг,
    IF(st_n_w NOT IN (SELECT st_n_c From get_count_correct), 0, ROUND(count_correct / (count_correct + count_wrong) * 100)) AS Успешность
FROM  
    get_count_correct 
    RIGHT JOIN get_count_wrong ON st_n_c = st_n_w
ORDER BY 2, 1 ASC ;




</code></pre><h2>Выборка данных, вычисляемые столбцы, логические функции</h2>

<p>В SQL реализована возможность заносить в поле значение в зависимости от условия. Для этого используется функция <code>IF</code>:</p>

<pre><code class="language-sql">IF(логическое_выражение, выражение_1, выражение_2)</code></pre>

<p>Функция вычисляет <code>логическое_выражение,</code> если оно истина – в поле заносится значение <code>выражения_1</code>, в противном случае –  значение <code>выражения_2. </code>Все три параметра <code>IF() </code>являются обязательными.</p>

<p>Допускается использование вложенных функций, вместо <code>выражения_1</code> или <code>выражения_2</code> может стоять новая функция <code><strong>IF</strong></code>.</p>

<p><strong>Пример </strong></p>

<p>Для каждой книги из таблицы <code><strong>book</strong></code> установим скидку следующим образом: если количество книг меньше 4, то скидка будет составлять 50% от цены, в противном случае 30%.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, amount, price, 
    IF(amount&lt;4, price*0.5, price*0.7) AS sale
FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+--------+--------+---------+
| title                 | amount | price  | sale    |
+-----------------------+--------+--------+---------+
| Мастер и Маргарита    | 3      | 670.99 | 335.495 |
| Белая гвардия         | 5      | 540.50 | 378.350 |
| Идиот                 | 10     | 460.00 | 322.000 |
| Братья Карамазовы     | 2      | 799.01 | 399.505 |
| Стихотворения и поэмы | 15     | 650.00 | 455.000 |
+-----------------------+--------+--------+---------+</code></pre>

<p>Цена по скидке должна отображаться с двумя знаками после запятой, добавим в запрос округление:</p>

<pre><code class="language-sql">SELECT title, amount, price, 
    ROUND(IF(amount&lt;4, price*0.5, price*0.7),2) AS sale
FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+--------+--------+--------+
| title                 | amount | price  | sale   |
+-----------------------+--------+--------+--------+
| Мастер и Маргарита    | 3      | 670.99 | 335.50 |
| Белая гвардия         | 5      | 540.50 | 378.35 |
| Идиот                 | 10     | 460.00 | 322.00 |
| Братья Карамазовы     | 2      | 799.01 | 399.51 |
| Стихотворения и поэмы | 15     | 650.00 | 455.00 |
+-----------------------+--------+--------+--------+</code></pre>

<p><strong>Пример</strong></p>

<p>Усложним вычисление скидки в зависимости от количества книг. Если количество книг меньше 4 – то скидка 50%, меньше 11 – 30%, в остальных случаях – 10%. И еще укажем какая именно скидка на каждую книгу.</p>

<p>Запрос:</p>

<pre><code class="language-sql">SELECT title, amount, price,
    ROUND(IF(amount &lt; 4, price * 0.5, IF(amount &lt; 11, price * 0.7, price * 0.9)), 2) AS sale,
    IF(amount &lt; 4, 'скидка 50%', IF(amount &lt; 11, 'скидка 30%', 'скидка 10%')) AS Ваша_скидка
FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+--------+--------+--------+-------------+
| title                 | amount | price  | sale   | Ваша_скидка |
+-----------------------+--------+--------+--------+-------------+
| Мастер и Маргарита    | 3      | 670.99 | 335.50 | скидка 50%  |
| Белая гвардия         | 5      | 540.50 | 378.35 | скидка 30%  |
| Идиот                 | 10     | 460.00 | 322.00 | скидка 30%  |
| Братья Карамазовы     | 2      | 799.01 | 399.51 | скидка 50%  |
| Стихотворения и поэмы | 15     | 650.00 | 585.00 | скидка 10%  |
+-----------------------+--------+--------+--------+-------------+</code></pre>

<h2><strong>Задание</strong></h2>

<p>При анализе продаж книг выяснилось, что наибольшей популярностью пользуются книги Михаила Булгакова, на втором месте книги Сергея Есенина. Исходя из этого решили поднять цену книг Булгакова на 10%, а цену книг Есенина - на 5%. Написать запрос, куда включить автора, название книги и новую цену, последний столбец назвать <code><strong>new_price</strong></code>. Значение округлить до двух знаков после запятой.</p>

<details><summary><strong>Пояснение</strong></summary>

<ul>
	<li>фамилию автора задавать с инициалами (как занесено в таблице), заключая в одинарные или двойные кавычки;</li>
	<li>для сравнения на равенство использовать знак =, например <code><strong>author = "Булгаков М.А."</strong></code>.</li>
</ul>
</details>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------------------+-----------+
| author           | title                 | new_price |
+------------------+-----------------------+-----------+
| Булгаков М.А.    | Мастер и Маргарита    | 738.09    |
| Булгаков М.А.    | Белая гвардия         | 594.55    |
| Достоевский Ф.М. | Идиот                 | 460.00    |
| Достоевский Ф.М. | Братья Карамазовы     | 799.01    |
| Есенин С.А.      | Стихотворения и поэмы | 682.50    |
+------------------+-----------------------+-----------+</code></pre>

<details><summary><strong>Структура и наполнение таблицы <code>book</code><strong>:</strong></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, title,
ROUND(IF(author = 'Булгаков М.А.', price * 1.1, IF(author = 'Есенин С.А.', price * 1.05, price)), 2) AS new_price
FROM book




</code></pre><h2>Выборка данных по условию, групповые функции</h2>

<p>В запросы с групповыми функциями можно включать условие отбора строк, которое в обычных запросах записывается после <code>WHERE</code>. В запросах с групповыми функциями вместо <code>WHERE</code> используется ключевое слово <code>HAVING</code> , которое размещается после оператора <code>GROUP BY</code>.</p>

<p><strong>Пример</strong></p>

<p>Найти минимальную и максимальную цену книг всех авторов, общая стоимость книг которых больше 5000.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT author,
    MIN(price) AS Минимальная_цена, 
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(price * amount) &gt; 5000; </code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+------------------+-------------------+
| author           | Минимальная_цена | Максимальная_цена |
+------------------+------------------+-------------------+
| Достоевский Ф.М. | 460.00           | 799.01            |
| Есенин С.А.      | 650.00           | 650.00            |
+------------------+------------------+-------------------+</code></pre>

<p>Также в запросах с группировкой можно сортировать данные.</p>

<p><strong> Пример</strong></p>

<p>Найти минимальную и максимальную цену книг всех авторов, общая стоимость книг которых больше 5000. Результат вывести по убыванию минимальной цены.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT author,
    MIN(price) AS Минимальная_цена, 
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(price * amount) &gt; 5000 
ORDER BY Минимальная_цена DESC;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+------------------+-------------------+
| author           | Минимальная_цена | Максимальная_цена |
+------------------+------------------+-------------------+
| Есенин С.А.      | 650.00           | 650.00            |
| Достоевский Ф.М. | 460.00           | 799.01            |
+------------------+------------------+-------------------+</code></pre>

<details><summary><strong>Пояснение</strong></summary>

<p>При указании столбца, по которому выполняется сортировка, если столбцу присвоено имя  с помощью <code>AS</code>, можно использовать это имя.</p>
</details>

<h2>Задание</h2>

<p>Вычислить среднюю цену и суммарную стоимость тех книг, количество экземпляров которых принадлежит интервалу от 5 до 14, включительно. Столбцы назвать <code><strong>Средняя_цена</strong></code> и <code><strong>Стоимость</strong></code>, значения округлить до 2-х знаков после запятой.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------------+-----------+
| Средняя_цена | Стоимость |
+--------------+-----------+
| 493.67       | 12107.50  |
+--------------+-----------+</code></pre>
</details>

<details><summary><strong>Пояснение</strong></summary>

<p>Если в запросе с групповыми функциями отсутствует<strong> </strong><code>GROUP BY</code>, то для отбора записей используется ключевое слово <code>WHERE</code><strong>.</strong></p>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT ROUND(AVG(price),2) as Средняя_цена, ROUND(SUM(price*amount),2) as Стоимость
FROM book
WHERE amount >= 5 AND amount <= 14
ORDER BY Средняя_цена DESC
</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов к нашей таблице <code><strong>book</strong></code>, используя вложенные запросы. Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно использовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p>В последнем модуле создан отдельный урок, в котором  мы разместим запросы, набравшие наибольшее количество лайков. </p>

<p>Структура и наполнение таблицы <code><strong>book</strong></code>:</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr style="background-color: #dcdcdc; background: #dcdcdc; text-align: center;">
			<td><sup><strong>INT PRIMARY KEY AUTO_INCREMENT</strong></sup></td>
			<td><sup><strong>VARCHAR(50)</strong></sup></td>
			<td><sup><strong>VARCHAR(30)</strong></sup></td>
			<td><sup><strong>DECIMAL(8,2)</strong></sup></td>
			<td><sup><strong>INT</strong></sup></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Мастер и Маргарита</td>
			<td>Булгаков М.А.</td>
			<td>670.99</td>
			<td>3</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Белая гвардия</td>
			<td>Булгаков М.А.</td>
			<td>540.50</td>
			<td>5</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Идиот</td>
			<td>Достоевский Ф.М.</td>
			<td>460.00</td>
			<td>10</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Братья Карамазовы</td>
			<td>Достоевский Ф.М.</td>
			<td>799.01</td>
			<td>3</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Игрок</td>
			<td>Достоевский Ф.М.</td>
			<td>480.50</td>
			<td>10</td>
		</tr>
		<tr>
			<td>6</td>
			<td>Стихотворения и поэмы</td>
			<td>Есенин С.А.</td>
			<td>650.00</td>
			<td>15</td>
		</tr>
	</tbody>
</table> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, author, price, amount, ((SELECT MAX(amount) From book) - amount) AS to_order, ROUND((price * 0.18 / 1.18), 2) AS VAT, ROUND((price / 1.18), 2) AS price_without_VAT
FROM book
WHERE price > ANY (SELECT MIN(price) FROM book)
ORDER BY price ASC;

</code></pre><h2>Запросы на обновление нескольких столбцов</h2>

<p>Запросом <code>UPDATE</code> можно обновлять значения нескольких столбцов одновременно. В этом случае простейший запрос будет выглядеть так:</p>

<pre><code class="language-sql">UPDATE таблица SET поле1 = выражение1, поле2 = выражение2</code></pre>

<p>На складе, кроме хранения и получения книг, выполняется их оптовая продажа. Для реализации этого действия включим дополнительный столбец <code><strong>buy</strong></code>  в таблицу <code><strong>book</strong></code>:</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
			<td><strong>buy</strong></td>
		</tr>
		<tr style="background-color: #dcdcdc; background: #dcdcdc; text-align: center;">
			<td><sup><strong>INT PRIMARY KEY AUTO_INCREMENT</strong></sup></td>
			<td><sup><strong>VARCHAR(50)</strong></sup></td>
			<td><sup><strong>VARCHAR(30)</strong></sup></td>
			<td><sup><strong>DECIMAL(8,2)</strong></sup></td>
			<td><sup><strong>INT</strong></sup></td>
			<td>int</td>
		</tr>
		<tr>
			<td>1</td>
			<td>Мастер и Маргарита</td>
			<td>Булгаков М.А.</td>
			<td>670.99</td>
			<td>3</td>
			<td>0</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Белая гвардия</td>
			<td>Булгаков М.А.</td>
			<td>540.50</td>
			<td>5</td>
			<td>3</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Идиот</td>
			<td>Достоевский Ф.М.</td>
			<td>460.00</td>
			<td>10</td>
			<td>8</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Братья Карамазовы</td>
			<td>Достоевский Ф.М.</td>
			<td>799.01</td>
			<td>2</td>
			<td>0</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Стихотворения и поэмы</td>
			<td>Есенин С.А.</td>
			<td>650.00</td>
			<td>15</td>
			<td>18</td>
		</tr>
	</tbody>
</table>

<p><strong>Пример</strong></p>

<p>В столбце <code><strong>buy</strong></code> покупатель указывает количество книг, которые он хочет приобрести. Для каждой книги, выбранной покупателем, необходимо уменьшить ее количество на складе на указанное в столбце<code><strong>buy</strong></code> количество, а в столбец <code><strong>buy</strong></code> занести 0.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">UPDATE book 
SET amount = amount - buy,
    buy = 0;

SELECT * FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 3
Query result:
+---------+-----------------------+------------------+--------+--------+-----+
| book_id | title                 | author           | price  | amount | buy |
+---------+-----------------------+------------------+--------+--------+-----+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 2      | 0   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 2      | 0   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | -3     | 0   |
+---------+-----------------------+------------------+--------+--------+-----+</code></pre>

<p>Как видно из таблицы, без проверки данных, которые занесены в столбец,  нельзя запускать запрос на обновление (может получиться отрицательное значение количества).</p>

<h2>Задание</h2>

<p>В таблице <strong>book</strong> необходимо скорректировать значение для покупателя в столбце <strong>buy </strong>таким образом, чтобы оно не превышало количество экземпляров книг, указанных в столбце <strong>amount</strong>. А цену тех книг, которые покупатель не заказывал, снизить на 10%.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 3
Query result:
+---------+-----------------------+------------------+--------+--------+-----+
| book_id | title                 | author           | price  | amount | buy |
+---------+-----------------------+------------------+--------+--------+-----+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 603.89 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      | 3   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     | 8   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 719.11 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     | 15  |
+---------+-----------------------+------------------+--------+--------+-----+</code></pre>
</details>

<details><summary><strong>Пояснение</strong></summary>

<p>Запрос на обновление количества книг должен корректировать значения в столбце <code><strong>buy</strong></code>  таблицы<code><strong> book</strong></code> следующим образом:</p>

<ul>
	<li>если покупатель заказал количество книг больше, чем есть на складе, то заменить значение <code><strong>buy</strong></code> на имеющееся на складе количество <code><strong>amount</strong></code>;</li>
	<li>если покупатель хочет купить количество книг меньшее или равное количеству книг на складе, то значение <code><strong>buy</strong></code> изменять не надо.</li>
</ul>

<p>Для реализации этого запроса можно  использовать функцию <a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow"><code><strong>if()</strong></code></a>.  Синтаксис раздела <code>SET </code>при использовании функции <strong><code>if() </code></strong>следующий:</p>

<pre><code>SET столбец = IF(условие, выражение_1, выражение_2)</code></pre>

<p>Выполняется этот оператор так:</p>

<ul>
	<li>сначала вычисляется <code><strong>условие</strong></code>;</li>
	<li>если условие ИСТИНА, то вычисляется <code><strong>выражение_1</strong></code>, в противном случае (если условие ЛОЖНО) вычисляется <code><strong>выражение_2</strong></code>;</li>
	<li>в столбец заносится результат выполнения функции (либо значение <code><strong>выражения_1</strong></code>, либо значение <code><strong>выражения_2</strong></code> в зависимости от условия).</li>
</ul>

<p>Например, для увеличения на 10% только цен книг Булгакова используется запрос:</p>

<pre><code class="language-sql">UPDATE book 
SET price = IF(author = "Булгаков М.А.", price * 1.1, price);</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code class="language-sql">+---------+-----------------------+------------------+--------+--------+-----+
| book_id | title                 | author           | price  | amount | buy |
+---------+-----------------------+------------------+--------+--------+-----+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      | 3   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     | 8   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     | 18  |
+---------+-----------------------+------------------+--------+--------+-----+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE book
SET buy = IF(buy > amount, amount, buy), price = IF(buy = 0, 0.9 * price, price);


</code></pre><h2>Задание</h2>

<p>Вывести информацию о командировках сотрудника(ов), которые были самыми короткими по времени. В результат включить столбцы <code><strong>name</strong></code>, <code><strong>city</strong></code>, <code><strong>date_first</strong></code>, <code><strong>date_last</strong></code>.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>Используйте вложенный запрос, чтобы найти длительность самой короткой командировки. </p>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------------+-----------------+------------+------------+
| name         | city            | date_first | date_last  |
+--------------+-----------------+------------+------------+
| Семенов И.В. | Санкт-Петербург | 2020-06-01 | 2020-06-03 |
+--------------+-----------------+------------+------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</li>
	<li><a href="https://stepik.org/lesson/297514/step/3?unit=279274" rel="noopener noreferrer nofollow">вложенный запрос в WHERE</a>;</li>
	<li><a href="https://stepik.org/lesson/297510/step/6?unit=279270" rel="noopener noreferrer nofollow">вычитание дат</a>;</li>
	<li><a href="https://stepik.org/lesson/297515/step/6?unit=279275" rel="noopener noreferrer nofollow">групповые вычисления по всей таблице</a>;</li>
	<li><a href="https://stepik.org/lesson/297515/step/4?unit=279275" rel="noopener noreferrer nofollow">групповые функции</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>trip</strong></code></strong></summary>

<pre><code>+---------+---------------+-----------------+----------+------------+------------+
| trip_id | name          | city            | per_diem | date_first | date_last  |
+---------+---------------+-----------------+----------+------------+------------+
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |
+---------+---------------+-----------------+----------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name, city, date_first, date_last
FROM trip
WHERE (DATEDIFF(date_last, date_first) + 1) = (SELECT MIN(DATEDIFF(date_last, date_first) + 1) FROM trip)


</code></pre><h2>Задание</h2>

<p>Водители оплачивают свои штрафы. В таблице <code><strong>payment </strong></code>занесены даты их оплаты:</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>payment_id</strong></td>
			<td><strong>name</strong></td>
			<td><strong>number_plate</strong></td>
			<td><strong>violation</strong></td>
			<td><strong>date_violation</strong></td>
			<td><strong>date_payment</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Яковлев Г.Р.</td>
			<td>М701АА</td>
			<td>Превышение скорости<br>
			(от 20 до 40)</td>
			<td>2020-01-12</td>
			<td>2020-01-22</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Баранов П.Е.</td>
			<td>Р523ВТ</td>
			<td>Превышение скорости<br>
			(от 40 до 60)</td>
			<td>2020-02-14</td>
			<td>2020-03-06</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Яковлев Г.Р.</td>
			<td>Т330ТТ</td>
			<td>Проезд на<br>
			запрещающий сигнал</td>
			<td>2020-03-03</td>
			<td>2020-03-23</td>
		</tr>
	</tbody>
</table>

<p>Необходимо:</p>

<ul>
	<li>в таблицу <code><strong>fine </strong></code>занести дату оплаты соответствующего штрафа из таблицы <code><strong>payment;</strong></code> </li>
	<li>уменьшить начисленный штраф в таблице <code><strong>fine</strong></code> в два раза  (только для тех штрафов, информация о которых занесена в таблицу <code><strong>payment</strong></code>) , если оплата произведена не позднее 20 дней со дня нарушения.</li>
</ul>

<details><summary><strong>Пояснение к заданию</strong></summary>

<p>1. Для уменьшения суммы штрафа в два раза в зависимости от условия можно  использовать функцию <a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow"><code><strong>if()</strong></code></a>.  Синтаксис раздела <code>SET </code>при использовании функции <strong><code>if() </code></strong>следующий:</p>

<pre><code class="language-sql">SET столбец = IF(условие, выражение_1, выражение_2)</code></pre>

<p>Выполняется этот оператор так:</p>

<ul>
	<li>сначала вычисляется <code><strong>условие</strong></code>;</li>
	<li>если условие ИСТИНА, то вычисляется <code><strong>выражение_1</strong></code>, в противном случае (если условие ЛОЖНО) вычисляется <code><strong>выражение_2</strong></code>;</li>
	<li>в столбец заносится результат выполнения функции (либо значение <code><strong>выражения_1</strong></code>, либо значение <code><strong>выражения_2</strong></code> в зависимости от условия).</li>
</ul>

<p>Например, чтобы обнулить штрафы, меньшие или равные 500 рублей, а остальные оставить без изменения, используется запрос:</p>

<pre><code class="language-sql">UPDATE fine
SET sum_fine = IF(sum_fine &lt;= 500, 0, sum_fine)</code></pre>

<p>2. Количество дней между датой нарушения и датой оплаты считается по формуле:</p>

<p><strong><code>количество_дней = дата_оплаты - дата_нарушения </code></strong></p>
</details>

<details><summary><strong>Пояснение к решению  <span style="color: #339966;">!!! </span><span style="color: #339933;">раскройте пояснение, если не получается решить или ошибка в запросе !!!</span></strong></summary>

<p>Шаблон запроса:</p>

<pre><code class="language-sql">UPDATE 
    fine, payment
SET 
    fine.date_payment = дата оплаты из payment,
    fine.sum_fine = сравнить разницу между датой нарушения и датой оплаты (из payment) 
                    и при необходимости уменьшить размер штрафа (использовать IF)
WHERE
    указать условие, что совпадают и номера машин, и нарушения, и 
    фамилия водителя в таблицах fine и payment, а также, что
    дата оплаты в fine должна быть пуста</code></pre>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 3
Query result:
+---------------+--------+----------------------------------+----------+---------------------------+
| name          | number_| violation                        | sum_fine | date_      | date_payment |
|               |  plate |                                  |          | violation  |              |
+---------------+--------+----------------------------------+----------+------------+--------------+
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12 | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14 | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23 | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20 до 40) | 250.00   | 2020-01-12 | 2020-01-22   |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01 | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14 | 2020-03-06   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23 | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигнал     | 500.00   | 2020-03-03 | 2020-03-23   |
+---------------+--------+----------------------------------+----------+------------+--------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li>обновление данных (<a href="https://stepik.org/lesson/305012/step/6?unit=287020" rel="noopener noreferrer nofollow">шаг</a>, <a href="https://stepik.org/lesson/305012/step/7?unit=287020" rel="noopener noreferrer nofollow">шаг</a>, <a href="https://stepik.org/lesson/305012/step/8?unit=287020" rel="noopener noreferrer nofollow">шаг</a>);</li>
	<li><a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow">функция IF()</a>;</li>
	<li><a href="https://stepik.org/lesson/297510/step/6?unit=279270" rel="noopener noreferrer nofollow">вычитание дат</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>fine</strong></code> (без ключевого столбца) перед выполнением этого шага</strong></summary>

<pre><code class="language-sql">+---------------+--------+------------------------------+----------+----------------+--------------+
| name          | number | violation                    | sum_fine | date_violation | date_payment |
|               | _plate |                              |          |                |              |
+---------------+--------+------------------------------+----------+----------------+--------------+
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 500.00   | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 2000.00  | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 2000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 1000.00  | 2020-03-03     | NULL         |
+---------------+--------+------------------------------+----------+----------------+--------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE fine AS f, payment AS p
SET f.date_payment = p.date_payment, f.sum_fine = IF(DATEDIFF(p.date_payment, p.date_violation) < 21, f.sum_fine/2, f.sum_fine)
WHERE f.name = p.name AND f.number_plate = p.number_plate AND f.violation = p.violation AND f.date_payment IS Null;
</code></pre><h2>Задание</h2>

<p>Заполнить таблицу <code><strong>author</strong></code>. В нее включить следующих авторов:</p>

<ul>
	<li>Булгаков М.А.</li>
	<li>Достоевский Ф.М.</li>
	<li>Есенин С.А.</li>
	<li>Пастернак Б.Л.</li>
</ul>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1
Affected rows: 1
Affected rows: 1
Affected rows: 1

Query result:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
+-----------+------------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO author (name_author)
VALUES ('Булгаков М.А.'),
('Достоевский Ф.М.'),
('Есенин С.А.'),
('Пастернак Б.Л.');



</code></pre><h2>Запросы для нескольких таблиц со вложенными запросами</h2>

<p>В запросах, построенных на нескольких таблицах, можно использовать вложенные запросы. Вложенный запрос может быть включен:  после ключевого слова <code>SELECT</code>,  после <code>FROM</code> и в условие отбора после <code>WHERE (HAVING)</code>.</p>

<p><strong>Пример</strong></p>

<p>Вывести авторов, общее количество книг которых на складе максимально.</p>

<p>Это достаточно сложный запрос, поэтому будем решать его по шагам (реализуя каждый запрос по отдельности), а потом объединим все запросы в один.</p>

<p><strong>Шаг 1.</strong> Найдем суммарное количество книг на складе по каждому автору. Поскольку фамилии автора в этой таблице нет, то группировку будем осуществлять по <code><strong>author_id</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT author_id, SUM(amount) AS sum_amount FROM book GROUP BY author_id</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------+------------+
| author_id | sum_amount |
+-----------+------------+
| 1         | 8          |
| 2         | 23         |
| 3         | 21         |
| 4         | 2          |
+-----------+------------+</code></pre>

<p><strong>Шаг 2</strong>. В результирующей таблице предыдущего запроса необходимо найти максимальное значение, то есть 23. Для этого запросу, созданному на шаге 1, необходимо присвоить имя (например, <code><strong>query_in</strong></code>) и использовать его в качестве таблицы-источника после <code>FROM</code>. Затем уже находить максимум по столбцу <code><strong>sum_amount</strong></code>.</p>

<p><em>Запрос:  </em></p>

<pre><code class="language-sql">SELECT MAX(sum_amount) AS max_sum_amount
FROM 
    (
     SELECT author_id, SUM(amount) AS sum_amount 
     FROM book 
     GROUP BY author_id
    ) query_in</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+----------------+
| max_sum_amount |
+----------------+
| 23             |
+----------------+</code></pre>

<p><strong>Шаг 3</strong>. Выведем фамилию автора и общее количество книг для него.</p>

<p><em>Запрос:  </em></p>

<pre><code class="language-sql">SELECT name_author, SUM(amount) as Количество
FROM 
    author INNER JOIN book
    on author.author_id = book.author_id
GROUP BY name_author</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+------------+
| name_author      | Количество |
+------------------+------------+
| Булгаков М.А.    | 8          |
| Достоевский Ф.М. | 23         |
| Есенин С.А.      | 21         |
| Пастернак Б.Л.   | 2          |
+------------------+------------+</code></pre>

<p><strong>Шаг 4</strong>.  Включим запрос с шага 2 в условие отбора запроса с шага 3. И получим всех авторов, общее количество книг которых максимально.</p>

<p><em> Запрос:  </em></p>

<pre><code class="language-sql">SELECT name_author, SUM(amount) as Количество
FROM 
    author INNER JOIN book
    on author.author_id = book.author_id
GROUP BY name_author
HAVING SUM(amount) = 
     (/* вычисляем максимальное из общего количества книг каждого автора */
      SELECT MAX(sum_amount) AS max_sum_amount
      FROM 
          (/* считаем количество книг каждого автора */
            SELECT author_id, SUM(amount) AS sum_amount 
            FROM book GROUP BY author_id
          ) query_in
      );</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+------------+
| name_author      | Количество |
+------------------+------------+
| Достоевский Ф.М. | 23         |
+------------------+------------+</code></pre>

<h2><strong>Задание</strong></h2>

<p>Вывести в алфавитном порядке всех авторов, которые пишут только в одном жанре. Поскольку у нас в таблицах так занесены данные, что у каждого автора книги только в одном жанре,  для этого запроса внесем изменения в таблицу <code><strong>book</strong></code>. Пусть у нас  книга Есенина «Черный человек» относится к жанру «Роман», а книга Булгакова «Белая гвардия» к «Приключениям» (эти изменения в таблицы уже внесены).</p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/"></p>

<p><em><strong>Текст задания (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p> Вывести в алфавитном порядке всех авторов, которые пишут только в одном жанре. Поскольку у нас в таблицах так занесены данные, что у каждого автора книги только в одном жанре,  для этого запроса внесем изменения в таблицу <code><strong>book</strong></code>. Пусть у нас  книга Есенина «Черный человек» относится к жанру «Роман», а книга Булгакова «Белая гвардия» к «Приключениям» (эти изменения в таблицы уже внесены).</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------------+
| name_author      |
+------------------+
| Достоевский Ф.М. |
| Пастернак Б.Л.   |
+------------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code class="language-sql">Таблица genre:
+----------+-------------+
| genre_id | name_genre  |
+----------+-------------+
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |
+----------+-------------+

Таблица author:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
+-----------+------------------+

Таблица book:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 3        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 1        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_author
FROM author INNER JOIN book ON author.author_id = book.author_id
GROUP BY name_author
HAVING COUNT(DISTINCT genre_id) = 1;

</code></pre><h2>Удаление записей главной таблицы с сохранением записей в зависимой</h2>

<p>При создании таблицы для внешних ключей с помощью <code>ON DELETE</code><strong> </strong><a href="https://stepik.org/lesson/308885/step/9?unit=291011" rel="noopener noreferrer nofollow">устанавливаются опции</a>, которые определяют действия, выполняемые при удалении связанной строки из главной таблицы.</p>

<p>Если задано <code>SET NULL</code>, то при удалении связанной строки из главной таблицы в зависимой, в столбце внешнего ключа, устанавливается значение <strong><code>NULL</code></strong>. (При этом в столбце внешнего ключа должно быть допустимо значение<strong> <code>NULL</code></strong>)</p>

<p>В таблице <code><strong>book</strong></code> эта опция установлена на поле <strong><code>genre_id</code></strong>.</p>

<p><strong>Пример</strong></p>

<p>Удалим из таблицы <code><strong>genre</strong></code> все  жанры, название которых заканчиваются на «я» , а в таблице <code><strong>book</strong></code>  -  для этих жанров установим значение <code>Null</code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">DELETE FROM genre
WHERE name_genre LIKE "%я";

SELECT * FROM genre;

SELECT * FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 2

Query result:
+----------+------------+
| genre_id | name_genre |
+----------+------------+
| 1        | Роман      |
+----------+------------+
Affected rows: 1

Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | Null     | 650.00 | 15     |
| 7       | Черный человек        | 3         | Null     | 570.20 | 12     |
| 8       | Лирика                | 4         | Null     | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | Null     | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | Null     | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+
Affected rows: 11
</code></pre>

<p>В нашем случае удалились жанры «Поэзия» и «Приключения».</p>

<h2>Задание</h2>

<p>Удалить все жанры, к которым относится меньше 4-х книг. В таблице <code><strong>book</strong></code> для этих жанров установить значение <code>Null</code>.</p>

<details><summary><strong>Пояснение</strong></summary>

<ol>
	<li>В запросе считать <strong>все уникальные книги.</strong> Например, книги "Стихотворения и поэмы" написаны разными авторами и имеют разный <code><strong>book_id</strong></code>, то есть это разные книги.</li>
	<li>Для отбора жанров, к которым относится меньше 4-х книг,  использовать вложенный запрос.</li>
</ol>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Query result:
+----------+------------+
| genre_id | name_genre |
+----------+------------+
| 1        | Роман      |
| 2        | Поэзия     |
+----------+------------+
Affected rows: 2

Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | Null     | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+
Affected rows: 11</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code>Таблица book
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+
Таблица supply
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
Таблица author                          Таблица genre
+-----------+------------------+	+----------+-------------+			
| author_id | name_author      |	| genre_id | name_genre  |			
+-----------+------------------+	+----------+-------------+			
| 1         | Булгаков М.А.    |	| 1        | Роман       |			
| 2         | Достоевский Ф.М. |	| 2        | Поэзия      |			
| 3         | Есенин С.А.      |	| 3        | Приключения |			
| 4         | Пастернак Б.Л.   |	+----------+-------------+			
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |
+-----------+------------------+						</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">DELETE FROM genre
WHERE genre_id IN (SELECT genre_id FROM book GROUP BY genre_id HAVING COUNT(title) < 4);

</code></pre><h2>Задание </h2>

<p>Вывести города, в которых живут клиенты, оформлявшие заказы в интернет-магазине. Указать количество заказов в каждый город, этот столбец назвать <code><strong>Количество</strong></code>. Информацию вывести по убыванию количества заказов, а затем в алфавитном порядке по названию городов.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/1e4836b9-6cf8-41bd-9f82-38b11c7882aa/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Вывести города, в которых живут клиенты, оформлявшие заказы в интернет-магазине. Указать количество заказов в каждый город, этот столбец назвать <code><strong>Количество</strong></code>. Информацию вывести по убыванию количества заказов, а затем в алфавитном порядке по названию городов.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------+------------+
| name_city       | Количество |
+-----------------+------------+
| Владивосток     | 2          |
| Москва          | 1          |
| Санкт-Петербург | 1          |
+-----------------+------------+</code></pre>
</details>
<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_city, COUNT(buy.client_id) AS Количество
FROM city LEFT OUTER JOIN client ON city.city_id = client.city_id INNER JOIN buy ON client.client_id = buy.client_id
GROUP BY name_city
ORDER BY Количество DESC, name_city ASC;

</code></pre><h2>Задание</h2>

<p>Создать общий счет (таблицу <code><strong>buy_pay</strong></code>) на оплату заказа с номером 5. Куда включить номер заказа, количество книг в заказе (название столбца <code><strong>Количество</strong></code>) и его общую стоимость (название столбца <code><strong>Итого</strong></code>). Для решения используйте ОДИН запрос.</p>

<p><em>Фрагмент логической схемы базы данных:</em></p>

<p><img alt="" src="https://ucarecdn.com/44e123c6-e706-43d9-8f5e-e54c3e35338f/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/10?unit=287020" rel="noopener noreferrer nofollow">создание таблицы</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/5?unit=279269" rel="noopener noreferrer nofollow">вычисления в SELECT</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Создать общий счет (таблицу <code><strong>buy_pay</strong></code>) на оплату заказа с номером 5. Куда включить номер заказа, количество книг в заказе (название столбца <code><strong>Количество</strong></code>) и его общую стоимость (название столбца <code><strong>Итого</strong></code>).  Для решения используйте ОДИН запрос.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1

Query result (выборка из таблицы buy_pay):
+--------+------------+---------+
| buy_id | Количество | Итого   |
+--------+------------+---------+
| 5      | 3          | 1578.48 |
+--------+------------+---------+</code></pre>
</details>
<details><summary><strong>Наполнение таблиц(перед выполнением шага)</strong></summary> <img alt="" height="878" name="115.png" src="https://ucarecdn.com/023077f7-c72f-44cb-959c-d7dc0adfdbfd/" width="711"></details> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE buy_pay AS
SELECT buy_id, SUM(buy_book.amount) AS Количество, SUM(buy_book.amount * price) AS Итого
FROM buy_book INNER JOIN book USING(book_id)
WHERE buy_id = 5;
</code></pre><h2>Задание</h2>

<p>Посчитать, сколько дополнительных баллов получит каждый абитуриент. Столбец с дополнительными баллами назвать <code><strong>Бонус</strong></code>. Информацию вывести в отсортированном по фамилиям виде.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/4bd9ba3f-142d-436f-9207-6512de694370/"></p>

<details><summary><strong>Пояснение</strong></summary>

<ol>
	<li> Чтобы включить в результирующую таблицу всех абитуриентов, а не только тех, у кого есть дополнительные баллы, используйте <a href="https://stepik.org/lesson/308886/step/3?unit=291012" rel="noopener noreferrer nofollow">оператор внешнего соединения</a>.</li>
	<li>После использования оператора внешнего соединения, у тех абитуриентов, у которых нет дополнительных баллов, в столбец «Бонус» будет занесено значение <code>Null</code> (на Stepik отображается <code>None</code>). Включите в запрос <a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow">функцию <code>if()</code></a>, которая будет сравнивать сумму баллов с <code>Null</code> и,  если сравнение верно, то заносить 0, в противном случае – сумму баллов.</li>
</ol>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/3?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow">функция IF()</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/305762/step/4?unit=287773" rel="noopener noreferrer nofollow">сравнение с пустым значением</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Посчитать, сколько дополнительных баллов получит каждый абитуриент. Столбец с дополнительными баллами назвать <code><strong>Бонус</strong></code>. Информацию вывести в отсортированном по фамилиям виде.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------+-------+
| name_enrollee   | Бонус |
+-----------------+-------+
| Абрамова Катя   | 0     |
| Баранов Павел   | 6     |
| Попов Илья      | 8     |
| Семенов Иван    | 5     |
| Степанова Дарья | 0     |
| Яковлева Галина | 1     |
+-----------------+-------+</code></pre>
</details>

<details><summary> <strong>Наполнение таблиц <code>achievement</code>, <code><span style="color: #000000;">enrollee</span></code></strong><span style="color: #000000;">, </span><code><strong><span style="color: #000000;">enrollee_achievement</span></strong></code></summary>

<pre><code class="language-sql">таблица achievement
+----------------+-----------------------+-------+
| achievement_id | name_achievement      | bonus |
+----------------+-----------------------+-------+
| 1              | Золотая медаль        | 5     |
| 2              | Серебряная медаль     | 3     |
| 3              | Золотой значок ГТО    | 3     |
| 4              | Серебряный значок ГТО | 1     |
+----------------+-----------------------+-------+
таблица enrollee
+-------------+-----------------+
| enrollee_id | name_enrollee   |
+-------------+-----------------+
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |
+-------------+-----------------+
таблица enrollee_achievement
+--------------------+-------------+----------------+
| enrollee_achiev_id | enrollee_id | achievement_id |
+--------------------+-------------+----------------+
| 1                  | 1           | 2              |
| 2                  | 1           | 3              |
| 3                  | 3           | 1              |
| 4                  | 4           | 4              |
| 5                  | 5           | 1              |
| 6                  | 5           | 3              |
+--------------------+-------------+----------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_enrollee, SUM(IF(e.enrollee_id = ea.enrollee_id, bonus, 0)) AS Бонус
FROM enrollee e 
LEFT JOIN enrollee_achievement ea ON e.enrollee_id = ea.enrollee_id
LEFT JOIN achievement a ON ea.achievement_id = a.achievement_id
GROUP BY name_enrollee
ORDER BY name_enrollee


</code></pre><h2>Нумерация строк</h2>

<p>Номер строки в таблице или запросе в некоторых версиях SQL можно получить с помощью оконной функции  <code><strong>row_number()</strong></code>.  Когда создавался этот шаг версии SQL на платформе Stepik эта функция не поддерживалась. Сейчас версию изменили, оконные функции рассматриваются в следующем уроке.</p>

<p>На этом шаге нумерацию реализуем с помощью переменных.  Переменные задаются с помощью ключевого слова <code><strong>SET</strong></code>,  перед именем указывается символ @. Например, создадим переменную <code><strong>@row_num</strong></code> и присвоим ей значение 1:</p>

<pre><code class="language-sql">SET @row_num := 1;</code></pre>

<p>Теперь эту переменную можно использовать в запросах,  кроме того в запросах можно изменить ее значение. </p>

<p><strong>Пример</strong></p>

<p>Пронумеруем записи в таблице <code><strong>applicant_order</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SET @row_num := 0;

SELECT *, (@row_num := @row_num + 1) AS str_num
FROM  applicant_order;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------+-------------+------+---------+
| program_id | enrollee_id | itog | str_num |
+------------+-------------+------+---------+
| 1          | 3           | 235  | 1       |
| 1          | 2           | 226  | 2       |
| 1          | 1           | 219  | 3       |
| 2          | 6           | 276  | 4       |
| 2          | 3           | 235  | 5       |
| 2          | 2           | 226  | 6       |
| 3          | 6           | 270  | 7       |
| 3          | 4           | 239  | 8       |
| 3          | 5           | 200  | 9       |
| 4          | 6           | 270  | 10      |
| 4          | 3           | 247  | 11      |
| 4          | 5           | 200  | 12      |
+------------+-------------+------+---------+</code></pre>

<details><summary><strong>Пояснение</strong></summary>

<p>Выражение  <code><strong>@row_num := @row_num + 1</strong></code> означает, что для каждой записи, выводимой в запрос, значение переменной <code><strong>@row_num</strong></code> увеличивается на 1. В результате получается нумерация строк запроса.</p>
</details>

<p><strong>Пример</strong></p>

<p>Создадим нумерацию, которая начинается заново для каждой образовательной программы. Для этого можно использовать алгоритм, в котором в переменную <code><strong>@row_num</strong></code> заносится 1, если<code><strong> id</strong></code> программы в предыдущей записи не равен <code><strong>id</strong></code> программы в текущей:</p>

<ul>
	<li>объявить переменную <code><strong>@num_pr</strong></code>, задать ей начальное значение;</li>
	<li>запомнить <code><strong>id</strong></code> образовательной программы для текущей записи в переменной <code><strong>@num_pr</strong></code>;</li>
	<li>для следующей записи сравнить значение переменной <code><strong>@num_pr</strong></code> с <code><strong>id</strong></code> образовательной программы;</li>
	<li>если они равны, то продолжить нумерацию <code><strong>@row_num := @row_num + 1</strong></code>;</li>
	<li>в противном случае начать нумерацию снова, для этого установить <code><strong>@row_num := 1</strong></code>.</li>
</ul>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SET @num_pr := 0;
SET @row_num := 1;

SELECT *, 
     if(program_id = @num_pr, @row_num := @row_num + 1, @row_num := 1) AS str_num,
     @num_pr := program_id AS add_var 
from applicant_order;
</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------+-------------+------+---------+---------+
| program_id | enrollee_id | itog | str_num | add_var |
+------------+-------------+------+---------+---------+
| 1          | 3           | 235  | 1       | 1       |
| 1          | 2           | 226  | 2       | 1       |
| 1          | 1           | 219  | 3       | 1       |
| 2          | 6           | 276  | 1       | 2       |
| 2          | 3           | 235  | 2       | 2       |
| 2          | 2           | 226  | 3       | 2       |
| 3          | 6           | 270  | 1       | 3       |
| 3          | 4           | 239  | 2       | 3       |
| 3          | 5           | 200  | 3       | 3       |
| 4          | 6           | 270  | 1       | 4       |
| 4          | 3           | 247  | 2       | 4       |
| 4          | 5           | 200  | 3       | 4       |
+------------+-------------+------+---------+---------+</code></pre>

<h2>Задание</h2>

<p>Занести в столбец<strong> <code>str_id</code> </strong>таблицы <code><strong>applicant_order</strong></code> нумерацию абитуриентов, которая начинается с 1 для каждой образовательной программы.</p>

<p><strong>Структура корректируемой таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/53f4570a-9e0b-4ae7-934b-d74795b99693/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>В запросе на обновление используйте вложенный запрос , в котором нумеруются записи таблицы <code><strong>applicant_order</strong></code><strong> </strong>по образовательным программам. В качестве условия соединения таблицы и вложенного запроса после ключевого слова   указать, что <strong><code>id</code></strong> программ в таблице <code><strong>applicant_order</strong></code><strong> </strong>и во вложенном запросе совпадают, а также <code><strong>id</strong></code> абитуриентов в таблице <code><strong>applicant_order</strong></code> и во вложенном запросе совпадают.</p>
</details>

<details><summary><strong>Пояснение от Илья Бодня</strong></summary>

<p>В <code><strong>IF</strong></code> можно делать операции над несколькими переменными, используя <code><strong>AND</strong></code>. То есть</p>

<pre><code>IF(логическое_выражение, выражение AND выражение, выражение)</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/6?unit=287020" rel="noopener noreferrer nofollow">обновление данных</a></u>.</li>
</ul>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 12

Query result:
+--------+------------+-------------+------+
| str_id | program_id | enrollee_id | itog |
+--------+------------+-------------+------+
| 1      | 1          | 3           | 235  |
| 2      | 1          | 2           | 226  |
| 3      | 1          | 1           | 219  |
| 1      | 2          | 6           | 276  |
| 2      | 2          | 3           | 235  |
| 3      | 2          | 2           | 226  |
| 1      | 3          | 6           | 270  |
| 2      | 3          | 4           | 239  |
| 3      | 3          | 5           | 200  |
| 1      | 4          | 6           | 270  |
| 2      | 4          | 3           | 247  |
| 3      | 4          | 5           | 200  |
+--------+------------+-------------+------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SET @row_num := 1;
SET @num_pr := 0;

UPDATE applicant_order, (SELECT @num_pr := program_id AS add_var FROM applicant_order) AS new_table
SET str_id = IF(applicant_order.program_id = @num_pr, @row_num := @row_num + 1, @row_num := 1 AND @num_pr := new_table.add_var)
WHERE applicant_order.program_id = new_table.add_var;

SELECT * FROM applicant_order;
</code></pre><h2>Задание</h2>

<p>Случайным образом отберите 3 вопроса по дисциплине «Основы баз данных». В результат включите столбцы <code><strong>question_id</strong></code> и <code><strong>name_question</strong></code>.</p>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/332c38fe-08e4-4c27-bc71-3b3200f43c3b/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для выбора случайных вопросов можно отсортировать вопросы в случайном порядке:</p>

<pre><code class="language-sql">ORDER BY RAND()</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><a href="https://stepik.org/lesson/297510/step/5?auth=login&amp;unit=279270" rel="noopener noreferrer nofollow">ограничение вывода</a>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) </p>

<blockquote>
<p>Случайным образом отберите 3 вопроса по дисциплине «Основы баз данных». В результат включите столбцы <code><strong>question_id</strong></code> и <code><strong>name_question</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<p>Примечание: вопросы выбираются случайным образом, поэтому результат выполнения запроса может не совпадать с образцом</p>

<pre><code class="language-sql">+-------------+----------------------------------------+
| question_id | name_question                          |
+-------------+----------------------------------------+
| 8           | Концептуальная модель используется для |
| 7           | Отношение - это:                       |
| 6           | База данных - это:                     |
+-------------+----------------------------------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц <code>question</code> и <code>subject</code></strong></summary>

<pre><code class="language-sql">таблица question

+-------------+-------------------------------------------------------------------------+------------+
| question_id | name_question                                                           | subject_id |
+-------------+-------------------------------------------------------------------------+------------+
| 1           | Запрос на выборку начинается с ключевого слова:                         | 1          |
| 2           | Условие, по которому отбираются записи, задается после ключевого слова: | 1          |
| 3           | Для сортировки используется:                                            | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:                    | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:                | 1          |
| 6           | База данных - это:                                                      | 2          |
| 7           | Отношение - это:                                                        | 2          |
| 8           | Концептуальная модель используется для                                  | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?                     | 2          |
+-------------+-------------------------------------------------------------------------+------------+
таблица subject
+------------+-------------------+
| subject_id | name_subject      |
+------------+-------------------+
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |
+------------+-------------------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT question_id, name_question
FROM question INNER JOIN subject ON question.subject_id = subject.subject_id
WHERE name_subject = 'Основы баз данных'
ORDER BY RAND()
LIMIT 3;
</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/38398039" rel="noopener noreferrer nofollow">Максим</a></p>

<p>Вывести автора, название, количество, цену (Розничная_цена). Для тех книг количество которых больше или равно 10, отобразить оптовую скидку 15% (Скидка), округлить до двух знаков после запятой и вывести оптовую цену с учетом скидки -15% (Оптовая_цена). Все атрибуты перевести на русский язык. Отсортировать по автору и названию книги.</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------------------+------------+----------------+--------+--------------+
| Автор            | Название_книги        | Количество | Розничная_цена | Скидка | Оптовая_цена |
+------------------+-----------------------+------------+----------------+--------+--------------+
| Булгаков М.А.    | Белая гвардия         | 5          | 540.50         | 0      | 540.50       |
| Булгаков М.А.    | Мастер и Маргарита    | 3          | 670.99         | 0      | 670.99       |
| Достоевский Ф.М. | Братья Карамазовы     | 3          | 799.01         | 0      | 799.01       |
| Достоевский Ф.М. | Игрок                 | 10         | 480.50         | 15     | 408.43       |
| Достоевский Ф.М. | Идиот                 | 10         | 460.00         | 15     | 391.00       |
| Есенин С.А.      | Стихотворения и поэмы | 15         | 650.00         | 15     | 552.50       |
+------------------+-----------------------+------------+----------------+--------+--------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Вывести автора, название, количество, цену (Розничная_цена). Для тех книг количество которых больше или равно 10, отобразить оптовую скидку 15% (Скидка), округлить до двух знаков после запятой и вывести оптовую цену с учетом скидки -15% (Оптовая_цена). Все атрибуты перевести на русский язык. Отсортировать по автору и названию книги.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/224743846" rel="noopener noreferrer nofollow">Сатурова Инна</a></p>

<p>На распродаже размер скидки устанавливается в зависимости от количества экземпляров книги в магазине и от цены книги: для книг в остатке не менее 5 шт скидка 50%, тогда как для книг в остатке менее 5 шт скидка устанавливается в зависимости от цены (на книги не дешевле 700 руб скидка 20%, на остальные 10%). Два последних столбца назвать <code><strong>Скидка</strong></code> и <code><strong>Цена_со_скидкой</strong></code>.  Последний столбец округлить до двух знаков после запятой.</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p>Результат:</p>

<pre><code class="language-sql">+------------------+-----------------------+--------+--------+--------+-----------------+
| author           | title                 | amount | price  | Скидка | Цена_со_скидкой |
+------------------+-----------------------+--------+--------+--------+-----------------+
| Булгаков М.А.    | Мастер и Маргарита    | 3      | 670.99 | 10%    | 603.89          |
| Булгаков М.А.    | Белая гвардия         | 5      | 540.50 | 50%    | 270.25          |
| Достоевский Ф.М. | Идиот                 | 10     | 460.00 | 50%    | 230.00          |
| Достоевский Ф.М. | Братья Карамазовы     | 3      | 799.01 | 20%    | 639.21          |
| Достоевский Ф.М. | Игрок                 | 10     | 480.50 | 50%    | 240.25          |
| Есенин С.А.      | Стихотворения и поэмы | 15     | 650.00 | 50%    | 325.00          |
| Есенин С.А.      | Черный человек        | 5      | 670.99 | 50%    | 335.50          |
+------------------+-----------------------+--------+--------+--------+-----------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>На распродаже размер скидки устанавливается в зависимости от количества экземпляров книги в магазине и от цены книги: для книг в остатке не менее 5 шт скидка 50%, тогда как для книг в остатке менее 5 шт скидка устанавливается в зависимости от цены (на книги не дешевле 700 руб скидка 20%, на остальные 10%). Два последних столбца назвать <code><strong>Скидка</strong></code> и <code><strong>Цена_со_скидкой</strong></code>.  Последний столбец округлить до двух знаков после запятой.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/58247085" rel="noopener noreferrer nofollow">Игорь Владимирович Лапшин</a></p>

<p>При анализе остатков книг на складе было решено дополнительно заказать книги авторов, у которых суммарное число экземпляров книг меньше 10. В таблице должны быть отображены авторы, наименьшее и наибольшее количество их книг.</p>

<p><strong>  Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+----------------+-------------------+-------------------+
| Автор          | Наименьшее_кол_во | Наибольшее_кол_во |
+----------------+-------------------+-------------------+
| Булгаков М.А.  | 3                 | 5                 |
| Пастернак Б.Л. | 6                 | 6                 |
+----------------+-------------------+-------------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :  </p>

<blockquote>
<p>При анализе остатков книг на складе было решено дополнительно заказать книги авторов, у которых суммарное число экземпляров книг меньше 10. В таблице должны быть отображены авторы, наименьшее и наибольшее количество их книг.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p>Вычислить прогресс пользователей по курсу. Прогресс вычисляется как отношение верно пройденных шагов к общему количеству шагов в процентах, округленное до целого. В нашей базе данные о решениях занесены не для всех шагов, поэтому общее количество шагов определить как количество различных шагов в таблице <strong><code>step_student</code>.</strong></p>

<p>Тем пользователям, которые прошли все шаги (прогресс = 100%) выдать "Сертификат с отличием". Тем, у кого прогресс больше или равен 80% - "Сертификат". Для остальных записей в столбце <strong>Результат </strong>задать пустую строку ("").</p>

<p>Информацию отсортировать по убыванию прогресса, затем по имени пользователя в алфавитном порядке.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/e32cf2e7-200e-4ba9-9a7c-86244317d7fb/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/404275/step/6?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">табличные выражения</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow">функция IF()</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/404275/step/5?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">оператор CASE</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания (чтобы не прокручивать страницу):</strong></p>

<blockquote>
<p>Вычислить прогресс пользователей по курсу. Прогресс вычисляется как отношение верно пройденных шагов к общему количеству шагов в процентах, округленное до целого. В нашей базе данные о решениях занесены не для всех шагов, поэтому общее количество шагов определить как количество различных шагов в таблице <strong><code>step_student</code>.</strong></p>

<p>Тем пользователям, которые прошли все шаги (прогресс = 100%) выдать "Сертификат с отличием". Тем, у кого прогресс больше или равен 80% -  "Сертификат". Для остальных записей в столбце <strong>Результат </strong>задать пустую строку ("").</p>

<p>Информацию отсортировать по убыванию прогресса, затем по имени пользователя в алфавитном порядке.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------+----------+-----------------------+
| Студент    | Прогресс | Результат             |
+------------+----------+-----------------------+
| student_60 | 100      | Сертификат с отличием |
| student_15 | 94       | Сертификат            |
| student_18 | 94       | Сертификат            |
                 ...
| student_29 | 25       |                       |
| student_47 | 25       |                       |
+------------+----------+-----------------------+
Affected rows: 64</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">WITH get_correct_answers(student_name, count_correst) AS
(SELECT student_name, COUNT(DISTINCT(step_id))
FROM step_student INNER JOIN student USING(student_id)
WHERE result = 'correct'
GROUP BY student_id),
get_all_answers(count_all) AS
(SELECT COUNT(DISTINCT(step_id))
FROM step_student)
SELECT student_name AS Студент, ROUND((count_correst/count_all)*100) AS Прогресс,
CASE
WHEN ROUND((count_correst/count_all)*100) < 80 THEN ''
WHEN ROUND((count_correst/count_all)*100) < 100 THEN 'Сертификат'
ELSE 'Сертификат с отличием'
END AS Результат
FROM get_correct_answers CROSS JOIN get_all_answers
ORDER BY Прогресс DESC</code></pre><p><span style="color: #006600;">На этом шаге нужно написать и проверить SQL запрос. Сначала кратко описывается структура и особенности запроса, приводится пример. А затем формулируется задание, для которого нужно реализовать запрос.</span></p>

<h2>Создание таблицы</h2>

<p>Для создания таблицы используется SQL-запрос. В нем указывается какая таблица создается, из каких атрибутов(полей) она состоит и какой тип данных имеет каждое поле, при необходимости указывается описание полей (ключевое поле и т.д.). Его структура :</p>

<ul>
	<li>ключевые слова : <code>CREATE TABLE</code></li>
	<li>имя создаваемой таблицы;</li>
	<li>открывающая круглая скобка «(»;</li>
	<li>название поля и его описание, которое включает тип поля и другие необязательные характеристики;</li>
	<li>запятая;</li>
	<li>название поля и его описание;</li>
	<li>...</li>
	<li>закрывающая скобка «)».</li>
</ul>

<p><strong>Пример. </strong>Создадим таблицу <code><strong>genre</strong></code> следующей структуры:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #e6f8e0; background: #e6f8e0; text-align: center;">
			<td style="text-align: center;"><strong>Поле</strong></td>
			<td style="text-align: center;"><strong>Тип, описание</strong></td>
		</tr>
		<tr>
			<td>genre_id</td>
			<td><code>INT PRIMARY KEY AUTO_INCREMENT</code></td>
		</tr>
		<tr>
			<td>name_genre</td>
			<td><code>VARCHAR(30)</code></td>
		</tr>
	</tbody>
</table>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">CREATE TABLE genre(
    genre_id INT PRIMARY KEY AUTO_INCREMENT, 
    name_genre VARCHAR(30)
);</code></pre>

<p>Созданная таблица - пустая.</p>

<p><em><strong>Рекомендации по записи SQL запроса</strong></em></p>

<ul>
	<li>Ключевые слова: SQL не является регистрозависимым языком (<span style="color: #000000;">CREATE</span> и <code>create</code> - одно и тоже ключевое слово). </li>
	<li>Ключевые слова SQL и типы данных рекомендуется  записывать прописными (большими) буквами.</li>
	<li>Имена таблиц и полей - строчными (маленькими) буквами.</li>
	<li>SQL-запрос можно писать на нескольких строках.</li>
	<li>В конце SQL-запроса ставится точка с запятой (хотя если Вы пишете один запрос, это необязательно).</li>
</ul>

<h2>Задание</h2>

<p>Сформулируйте SQL запрос для создания таблицы <code><strong>book</strong></code>, занесите  его в окно кода (расположено ниже)  и отправьте на проверку (кнопка <strong>Отправить</strong>). Структура таблицы <code><strong>book</strong></code>:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #e6f8e0; background: #e6f8e0; text-align: center;">
			<td style="text-align: center;"><strong>Поле</strong></td>
			<td style="text-align: center;"><strong>Тип, описание</strong></td>
		</tr>
		<tr>
			<td><code>book_id</code></td>
			<td><code>INT PRIMARY KEY AUTO_INCREMENT</code></td>
		</tr>
		<tr>
			<td><code>title</code></td>
			<td><code>VARCHAR(50)</code></td>
		</tr>
		<tr>
			<td><code>author</code></td>
			<td><code>VARCHAR(30)</code></td>
		</tr>
		<tr>
			<td><code>price</code></td>
			<td><code>DECIMAL(8, 2)</code></td>
		</tr>
		<tr>
			<td><code>amount</code></td>
			<td><code>INT</code></td>
		</tr>
	</tbody>
</table>

<p> </p>

<details><summary><strong>Пояснение</strong> - <span style="color: #ff4363;">кликните по этой строке, чтобы раскрыть пояснение</span></summary>

<p>При записи сохраняйте порядок следования полей. </p>
</details>

<p> </p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 0</code></pre> <br><hr><br> <pre><code class="hljs language-sql">CREATE book(
book_id INT PRIMARY KEY AUTO_INCREMENT,
title VARCHAR(50),
author VARCHAR(30),
price DECIMAL(8, 2),
amount INT);




</code></pre><h2>Выборка данных по условию</h2>

<p>С помощью запросов можно включать в итоговую выборку не все строки исходной таблицы, а только те, которые отвечают некоторому условию. Для этого после указания таблицы, откуда выбираются данные, задается ключевое слово <code>WHERE</code> и логическое выражение, от результата которого зависит будет ли включена строка в выборку или нет. Если условие – истина, то строка(запись)  включается в выборку, если ложь – нет.</p>

<p>Логическое выражение может включать <strong>операторы сравнения </strong>(равно «<strong>=</strong>», не равно «<strong>&lt;&gt;</strong>», больше «<strong>&gt;</strong>», меньше «<strong>&lt;</strong>», больше или равно«<strong>&gt;=</strong>», меньше или равно «<strong>&lt;=</strong>») и выражения, допустимые в SQL.</p>

<p><strong>Пример</strong></p>

<p>Вывести название и цену тех книг, цены которых меньше 600 рублей.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, price 
FROM book
WHERE price &lt; 600;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+---------------+--------+
| title         | price  |
+---------------+--------+
| Белая гвардия | 540.50 |
| Идиот         | 460.00 |
+---------------+--------+</code></pre>

<p><strong> Пример</strong></p>

<p>Вывести название, автора  и стоимость (цена умножить на количество) тех книг, стоимость которых больше 4000 рублей</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, price * amount AS total
FROM book
WHERE price * amount &gt; 4000;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+---------+
| title                 | author           | total   |
+-----------------------+------------------+---------+
| Идиот                 | Достоевский Ф.М. | 4600.00 |
| Стихотворения и поэмы | Есенин С.А.      | 9750.00 |
+-----------------------+------------------+---------+</code></pre>

<details><summary><strong>Пояснение</strong></summary>

<p>В логическом выражении после <code><strong>WHERE</strong></code> нельзя использовать названия столбцов, присвоенные им с помощью <code><strong>AS</strong></code>,  так как при выполнении запроса сначала вычисляется логическое выражение для каждой строки исходной таблицы, выбираются строки, для которых оно истинно. А только после этого формируется "шапка запроса" – столбцы, включаемые в запрос.</p>
</details>

<h2>Задание</h2>

<p>Вывести автора, название  и цены тех книг, количество которых меньше 10.</p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+--------------------+--------+
| author           | title              | price  |
+------------------+--------------------+--------+
| Булгаков М.А.    | Мастер и Маргарита | 670.99 |
| Булгаков М.А.    | Белая гвардия      | 540.50 |
| Достоевский Ф.М. | Братья Карамазовы  | 799.01 |
+------------------+--------------------+--------+</code></pre>

<details><summary><strong>Структура и наполнение таблицы <code>book</code><strong>:</strong></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, title, price
FROM book
WHERE amount < 10




</code></pre><h2>Запросы на обновление нескольких таблиц </h2>

<p>В запросах на обновление можно использовать несколько таблиц, но тогда</p>

<ul>
	<li>для столбцов, имеющих одинаковые имена, необходимо указывать имя таблицы, к которой они относятся, например, <code><strong>book.price</strong></code> – столбец <code><strong>price </strong></code>из таблицы <code><strong>book</strong></code>, <strong><code>supply.price</code></strong> – столбец <code><strong>price</strong></code> из таблицы <code><strong>supply</strong></code>;</li>
	<li>все таблицы, используемые в запросе, нужно перечислить после ключевого слова <code>UPDATE</code>;</li>
	<li>в запросе обязательно условие <code>WHERE</code>, в котором указывается условие при котором обновляются данные.</li>
</ul>

<p><strong>Пример</strong></p>

<p>Если в таблице <code><strong>supply</strong></code>  есть те же книги, что и в таблице<code><strong> book</strong></code>, добавлять эти книги в таблицу <code><strong>book</strong></code> не имеет смысла. Необходимо увеличить их количество на значение столбца <code><strong>amount</strong></code>таблицы <code><strong>supply</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">UPDATE book, supply 
SET book.amount = book.amount + supply.amount
WHERE book.title = supply.title AND book.author = supply.author;

SELECT * FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 2
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 12     |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 13     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>

<p>В этом запросе увеличилось количество двух книг: «Белая гвардия», которая в <code><strong>supply</strong></code> имеет ту же цену, и «Идиот», но цена этой книги в таблицах <code><strong>book</strong></code> и <strong><code>supply</code></strong> отличается. Для этой книги нужно пересчитать цену.</p>

<h2>Задание</h2>

<p>Для тех книг в таблице <code><strong>book</strong></code> , которые есть в таблице <strong><code>supply, </code></strong>не только увеличить их количество в таблице <code><strong>book</strong></code> ( увеличить их количество на значение столбца <code><strong>amount</strong></code>таблицы <code><strong>supply</strong></code>), но и пересчитать их цену (для каждой книги найти сумму цен из таблиц <code><strong>book</strong></code> и <strong><code>supply</code></strong> и разделить на 2).</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 12     |
| 3       | Идиот                 | Достоевский Ф.М. | 410.40 | 13     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details>

<details><summary><strong>Пояснение</strong></summary>

<p>Пересчет для книг с одинаковым названием и ценой не повлияет на результат, поэтому в запросе не обязательно рассматривать два случая: когда цена у одинаковых книг равна и когда нет.</p>
</details>

<details><summary><strong>Структура и наполнение таблиц <code>book</code> и <code>supply</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>

<pre><code>+-----------+----------------+------------------+--------+--------+
| supply_id | title          | author           | price  | amount |
+-----------+----------------+------------------+--------+--------+
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |
+-----------+----------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE book, supply
SET book.amount = book.amount + supply.amount, book.price = (book.price + supply.price) / 2
WHERE book.title = supply.title AND book.author = supply.author;

</code></pre><h2>Задание</h2>

<p>Вывести информацию о командировках, начало и конец которых относятся к одному месяцу (год может быть любой). В результат включить столбцы <code><strong>name</strong></code>, <code><strong>city</strong></code>, <code><strong>date_first</strong></code>, <code><strong>date_last</strong></code>. Строки отсортировать сначала  в алфавитном порядке по названию города, а затем по фамилии сотрудника .</p>

<p><strong>Немного теории</strong></p>

<p>Для того, чтобы выделить номер месяца из даты используется функция <code><strong>MONTH(дата)</strong></code>.</p>

<p>Например, <code><strong>MONTH('2020-04-12') = 4</strong></code>.</p>

<p>Если определяется месяц для  значений столбца <code><strong>date_first</strong></code>, то используется запись <code><strong>MONTH(date_first)</strong></code></p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------+-----------------+------------+------------+
| name          | city            | date_first | date_last  |
+---------------+-----------------+------------+------------+
| Абрамова К.А. | Владивосток     | 2020-01-14 | 2020-01-27 |
| Абрамова К.А. | Владивосток     | 2020-07-02 | 2020-07-13 |
| Баранов П.Е.  | Воронеж         | 2020-07-19 | 2020-07-25 |
| Абрамова К.А. | Москва          | 2020-04-06 | 2020-04-14 |
| Баранов П.Е.  | Москва          | 2020-01-12 | 2020-01-17 |
| Баранов П.Е.  | Москва          | 2020-02-14 | 2020-02-22 |
| Колесов С.П.  | Москва          | 2020-02-01 | 2020-02-06 |
| Лебедев Т.К.  | Москва          | 2020-03-03 | 2020-03-06 |
| Семенов И.В.  | Москва          | 2020-01-23 | 2020-01-31 |
| Колесов С.П.  | Новосибирск     | 2020-06-03 | 2020-06-12 |
| Семенов И.В.  | Санкт-Петербург | 2020-06-01 | 2020-06-03 |
| Лебедев Т.К.  | Томск           | 2020-05-20 | 2020-05-31 |
| Федорова А.Ю. | Томск           | 2020-06-20 | 2020-06-26 |
+---------------+-----------------+------------+------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>trip</strong></code></strong></summary>

<pre><code>+---------+---------------+-----------------+----------+------------+------------+
| trip_id | name          | city            | per_diem | date_first | date_last  |
+---------+---------------+-----------------+----------+------------+------------+
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |
+---------+---------------+-----------------+----------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name, city, date_first, date_last
FROM trip
WHERE MONTH(date_first) = MONTH(date_last)
ORDER BY city ASC, name ASC;</code></pre><h2>Задание</h2>

<p>Создать новую таблицу <strong><code>back_payment</code></strong>, куда внести информацию о неоплаченных штрафах (Фамилию и инициалы водителя, номер машины, нарушение, сумму штрафа  и  дату нарушения) из таблицы <code><strong>fine</strong></code>.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для неоплаченных штрафов столбец <code><strong>date_payment</strong></code> имеет пустое значение.</p>
</details>

<p><strong>Важно. </strong>На этом шаге необходимо создать таблицу на основе запроса! Не нужно одним запросом создавать таблицу, а вторым в нее добавлять строки.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2
Query result:
+---------------+--------------+----------------------------------+----------+------------------+
| name          | number_plate | violation                        | sum_fine | date_violation   |
+---------------+--------------+----------------------------------+----------+------------------+
| Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01       |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23       |
+---------------+--------------+----------------------------------+----------+------------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/305012/step/10?unit=287020" rel="noopener noreferrer nofollow">создание таблицы</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</li>
	<li><a href="https://stepik.org/lesson/305762/step/4?unit=287773" rel="noopener noreferrer nofollow">сравнение с пустым значением.</a></li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>fine</strong></code> (без ключевого столбца) перед выполнением этого шага</strong></summary>

<pre><code class="language-sql">+---------------+--------+------------------------------+----------+----------------+--------------+
| name          | number | violation                    | sum_fine | date_violation | date_payment |
|               | _plate |                              |          |                |              |
+---------------+--------+------------------------------+----------+----------------+--------------+
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 250.00   | 2020-01-12     | 2020-01-22   |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 2000.00  | 2020-02-14     | 2020-03-05   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 2000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 500.00   | 2020-03-03     | 2020-03-22   |
+---------------+--------+------------------------------+----------+----------------+--------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE back_payment AS SELECT name, number_plate, violation, sum_fine, date_violation FROM fine
WHERE date_payment IS null;

</code></pre><h2>Создание таблицы с внешними ключами</h2>

<p>При создании зависимой таблицы (таблицы, которая содержит внешние ключи) необходимо учитывать, что :</p>

<ul>
	<li>каждый внешний ключ должен иметь такой же тип данных, как связанное поле главной таблицы (в наших примерах это <code><strong>INT)</strong></code>;</li>
	<li>необходимо указать главную для нее таблицу и столбец, по которому осуществляется связь:</li>
</ul>

<pre><code class="language-sql">FOREIGN KEY (связанное_поле_зависимой_таблицы)  
REFERENCES главная_таблица (связанное_поле_главной_таблицы)</code></pre>

<p>По умолчанию любой столбец, кроме ключевого, может содержать значение <code><strong>NULL</strong></code>. При создании таблицы это можно переопределить,  используя  ограничение<code><strong> NOT NULL</strong></code> для этого столбца:</p>

<pre><code class="language-sql">CREATE TABLE таблица (
    столбец_1 INT NOT NULL, 
    столбец_2 VARCHAR(10) 
);</code></pre>

<p> В созданной таблице в <code><strong>столбец_1</strong></code> не может содержать пустое значение, а<code><strong> столбец_2</strong></code> - может.</p>

<p>Для внешних ключей рекомендуется устанавливать ограничение <code><strong>NOT NULL</strong></code> (если это совместимо с другими опциями, которые будут рассмотрены в следующем шаге).</p>

<p><strong> Пример</strong></p>

<p>Создать таблицу <strong><code>book</code></strong> следующей структуры:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #e6f8e0; background: #e6f8e0; text-align: center;">
			<td style="text-align: center;"><strong>Поле</strong></td>
			<td style="text-align: center;"><strong>Тип, описание</strong></td>
			<td style="text-align: center;"><strong>Связи</strong></td>
		</tr>
		<tr>
			<td><code>book_id</code></td>
			<td><code>INT PRIMARY KEY AUTO_INCREMENT</code></td>
			<td> </td>
		</tr>
		<tr>
			<td><code>title</code></td>
			<td><code>VARCHAR(50)</code></td>
			<td> </td>
		</tr>
		<tr>
			<td><code>author_id</code></td>
			<td><code>INT </code></td>
			<td>внешний ключ:<br>
			главная таблица <code><strong>author</strong></code>,<br>
			связанный столбец <code><strong>author.author_id</strong></code>,<br>
			пустое значение не допускается</td>
		</tr>
		<tr>
			<td><code>price</code></td>
			<td><code>DECIMAL(8, 2)</code></td>
			<td> </td>
		</tr>
		<tr>
			<td><code>amount</code></td>
			<td><code>INT</code></td>
			<td> </td>
		</tr>
	</tbody>
</table>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">CREATE TABLE book (
    book_id INT PRIMARY KEY AUTO_INCREMENT, 
    title VARCHAR(50), 
    author_id INT NOT NULL, 
    price DECIMAL(8,2), 
    amount INT, 
    FOREIGN KEY (author_id)  REFERENCES author (author_id) 
);</code></pre>

<h2>Задание</h2>

<p>Перепишите запрос на создание таблицы <code><strong>book</strong></code> , чтобы ее структура соответствовала структуре, показанной на логической схеме (таблица <code><strong>genre</strong></code> уже создана, порядок следования столбцов - как на логической схеме в таблице <code><strong>book</strong></code>, <code><strong>genre_id</strong></code>  - внешний ключ) . Для <strong><code>genre_id</code></strong> ограничение о недопустимости пустых значений <strong>не задавать</strong>. В качестве главной таблицы для описания поля  <strong><code>genre_id</code></strong>использовать таблицу <a href="https://stepik.org/lesson/297508/step/5?unit=279268" rel="noopener noreferrer nofollow"><code><strong>genre</strong></code></a> следующей структуры:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #e6f8e0; background: #e6f8e0; text-align: center;">
			<td style="text-align: center;"><strong>Поле</strong></td>
			<td style="text-align: center;"><strong>Тип, описание</strong></td>
		</tr>
		<tr>
			<td><code>genre_id</code></td>
			<td><code>INT PRIMARY KEY AUTO_INCREMENT</code></td>
		</tr>
		<tr>
			<td><code>name_genre</code></td>
			<td><code>VARCHAR(30)</code></td>
		</tr>
	</tbody>
</table>

<p><strong>Логическая схема</strong> (нужно создать только таблицу <strong><code>book</code></strong>):</p>

<p><img alt="" src="https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/"></p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 0</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE book (
book_id INT PRIMARY KEY AUTO_INCREMENT,
title VARCHAR(50),
author_id INT NOT NULL,
genre_id INT,
price DECIMAL(8, 2),
amount INT,
FOREIGN KEY (author_id) REFERENCES author (author_id),
FOREIGN KEY (genre_id) REFERENCES genre (genre_id));
</code></pre><h2>Вложенные запросы в операторах соединения</h2>

<p>Вложенные запросы могут использоваться в операторах соединения <code>JOIN</code>.  При этом им необходимо присваивать имя, которое записывается сразу после закрывающей скобки вложенного запроса.</p>

<pre><code class="language-sql">SELECT
 ...
FROM
    таблица ... JOIN  
       (
        SELECT ...
       ) имя_вложенного_запроса
    ON условие
...</code></pre>

<p>Вложенный запрос может стоять как справа, так и слева от оператора <code>JOIN</code>. Допускается использование двух запросов в операторах соединения.</p>

<p><strong>Пример</strong></p>

<p>Вывести авторов, пишущих книги в самом популярном жанре. Указать этот жанр.</p>

<p>Самым популярным считать жанр, общее количество экземпляров книг которого на складе максимально. Таких жанров может быть несколько, если они имеют одинаковое максимальное значение общего количества экземпляров. Только для этого шага изменена запись в таблице <code><strong>book</strong></code>.</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author_id</strong></td>
			<td><strong>genre_id</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr>
			<td>8</td>
			<td>Лирика</td>
			<td>4</td>
			<td>2</td>
			<td>518.9910</td>
			<td><span style="color: #ff4363;">10</span></td>
		</tr>
	</tbody>
</table>

<p>А также добавлены новые записи:</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author_id</strong></td>
			<td><strong>genre_id</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr>
			<td>9</td>
			<td>Герой нашего времени</td>
			<td>5</td>
			<td>3</td>
			<td>570.59</td>
			<td>2</td>
		</tr>
		<tr>
			<td>10</td>
			<td>Доктор Живаго</td>
			<td>4</td>
			<td>3</td>
			<td>740.50</td>
			<td>5</td>
		</tr>
	</tbody>
</table>

<p>Рассмотрим реализацию этого запроса по шагам.</p>

<p><strong>Шаг 1.</strong> Найдем общее количество книг по каждому жанру, отсортируем его по убыванию и ограничим вывод одной строкой. Рекомендуется, если запрос будет использоваться в качестве вложенного (особенно в операциях соединения), вычисляемым полям запроса давать собственное имя.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT genre_id, SUM(amount) AS sum_amount
FROM book
GROUP BY genre_id
ORDER BY sum_amount DESC
LIMIT 1</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+---------------+------------+
|  genre_id     | sum_amount |
+---------------+------------+
| 1             | 31         |
+---------------+------------+</code></pre>

<p>Кажется, что, уже используя этот запрос, можно получить<strong> <code>id</code></strong> самого популярного жанра. Но это не так, поскольку несколько жанров могут иметь одинаковую популярность. Поэтому нам необходим запрос, который отберет ВСЕ жанры, суммарное количество книг которых равно <code><strong>sum_amount</strong></code>.</p>

<p><strong>Шаг 2.</strong> Используя запрос с предыдущего шага, найдем <code><strong>id</strong></code> самых популярных жанров.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT query_in_1.genre_id
FROM 
    (/* выбираем код жанра и количество произведений, относящихся к нему */
      SELECT genre_id, SUM(amount) AS sum_amount
      FROM book
      GROUP BY genre_id 
    )query_in_1
    INNER JOIN
    (/* выбираем запись, в которой указан код жанр с максимальным количеством книг */
      SELECT genre_id, SUM(amount) AS sum_amount
      FROM book
      GROUP BY genre_id
      ORDER BY sum_amount DESC
      LIMIT 1
     ) query_in_2
     ON query_in_1.sum_amount= query_in_2.sum_amount              
  </code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+----------+
| genre_id |
+----------+
| 1        |
| 2        |
+----------+</code></pre>

<p><strong>Шаг 3.</strong> Используя запрос с шага 2, выведем фамилии авторов, которые пишут в самых популярных жанрах, и названия этих жанров. В этом запросе обязательно выполнить группировку по фамилиям авторов и <code><strong>id</strong></code> жанров, так как без этого фамилии авторов будут повторяться, поскольку в таблице<strong> <code>book</code></strong> есть разные книги, написанные автором в одном жанре.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT  name_author, name_genre
FROM 
    author 
    INNER JOIN book ON author.author_id = book.author_id
    INNER JOIN genre ON  book.genre_id = genre.genre_id
GROUP BY name_author,name_genre, genre.genre_id
HAVING genre.genre_id IN
         (/* выбираем автора, если он пишет книги в самых популярных жанрах*/
          SELECT query_in_1.genre_id
          FROM 
              ( /* выбираем код жанра и количество произведений, относящихся к нему */
                SELECT genre_id, SUM(amount) AS sum_amount
                FROM book
                GROUP BY genre_id
               )query_in_1
          INNER JOIN 
              ( /* выбираем запись, в которой указан код жанр с максимальным количеством книг */
                SELECT genre_id, SUM(amount) AS sum_amount
                FROM book
                GROUP BY genre_id
                ORDER BY sum_amount DESC
                LIMIT 1
               ) query_in_2
          ON query_in_1.sum_amount= query_in_2.sum_amount
         );   </code></pre>

<p><strong>Важно!</strong></p>

<ol>
	<li>Обратите внимание, что в группировку включен столбец<code><strong>genre_id</strong></code>, который используется в <code>HAVING.</code> Это связано с тем, что в <code>HAVING</code> можно использовать либо столбцы, перечисленные в <code>GROUP BY</code>, либо вычисляемые с помощью групповых функций столбцы. Добавление столбца <code><strong>genre_id</strong></code>не влияет на группировку, так как между названием жанра и его <strong>id</strong> - взаимно-однозначное соответствие.</li>
	<li>Название столбца<code><strong> genre_id </strong></code>задается с указанием имени таблицы (<code><strong>genre.genre_id</strong></code>), так как этот столбец входит в структуру двух таблиц <code><strong>book</strong></code> и <strong><code>genre</code></strong>.  Для этого запроса можно было бы указать и <code><strong>book.genre_id</strong></code>, так как эти таблицы связаны внутренним соединением <code>INNER JOIN</code> и имеют одинаковые значения в полях <code><strong>genre.genre_id</strong></code> и <code><strong>book.genre_id</strong></code>.</li>
</ol>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+------------+
| name_author      | name_genre |
+------------------+------------+
| Достоевский Ф.М. | Роман      |
| Булгаков М.А.    | Роман      |
| Пастернак Б.Л.   | Поэзия     |
| Есенин С.А.      | Поэзия     |
+------------------+------------+</code></pre>

<h2>Задание</h2>

<p>Вывести информацию о книгах (название книги, фамилию и инициалы автора, название жанра, цену и количество экземпляров книги), написанных в самых популярных жанрах, в отсортированном в алфавитном порядке по названию книг виде. Самым популярным считать жанр, общее количество экземпляров книг которого на складе максимально.</p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/"></p>

<p><em><strong>Текст задания (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p> Вывести информацию о книгах (название книги, фамилию и инициалы автора, название жанра, цену и количество экземпляров книг), написанных в самых популярных жанрах, в отсортированном в алфавитном порядке по названию книг виде. Самым популярным считать жанр, общее количество экземпляров книг которого на складе максимально.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------------+------------------+------------+--------+--------+
| title                 | name_author      | name_genre | price  | amount |
+-----------------------+------------------+------------+--------+--------+
| Белая гвардия         | Булгаков М.А.    | Роман      | 540.50 | 5      |
| Братья Карамазовы     | Достоевский Ф.М. | Роман      | 799.01 | 3      |
| Игрок                 | Достоевский Ф.М. | Роман      | 480.50 | 10     |
| Идиот                 | Достоевский Ф.М. | Роман      | 460.00 | 10     |
| Лирика                | Пастернак Б.Л.   | Поэзия     | 518.99 | 10     |
| Мастер и Маргарита    | Булгаков М.А.    | Роман      | 670.99 | 3      |
| Стихотворения и поэмы | Есенин С.А.      | Поэзия     | 650.00 | 15     |
| Черный человек        | Есенин С.А.      | Поэзия     | 570.20 | 6      |
+-----------------------+------------------+------------+--------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code class="language-sql">Таблица genre:
+----------+-------------+
| genre_id | name_genre  |
+----------+-------------+
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |
+----------+-------------+

Таблица author:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
+-----------+------------------+

Таблица book:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 4       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 5       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 6       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 7       | Лирика                | 4         | 2        | 518.99 | 10     |
| 8       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 9       | Герой нашего времени  | 5         | 3        | 570.59 | 2      |
| 10      | Доктор Живаго         | 4         | 3        | 740.50 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, name_author, name_genre, price, amount
FROM author INNER JOIN book ON author.author_id = book.author_id INNER JOIN genre ON genre.genre_id = book.genre_id
WHERE genre.genre_id IN (
(SELECT query_2.genre_id
FROM
(SELECT genre_id, SUM(amount) AS sum_amount
FROM book
GROUP BY genre_id
ORDER BY sum_amount DESC) query_2
INNER JOIN
(SELECT genre_id, SUM(amount) AS max_amount
FROM book
GROUP BY genre_id
ORDER BY max_amount DESC
LIMIT 1) query_1
ON query_2.sum_amount=query_1.max_amount))
ORDER BY title ASC;</code></pre><h2>Задание</h2>

<p>Вывести номера всех оплаченных заказов и даты, когда они были оплачены.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/a6be5406-fcef-4a74-89bc-eb7833621092/">​​</p>

<details><summary><strong>Пояснение</strong></summary>

<p>С каждым заказом в таблице <code><strong>buy_step</strong></code> связаны 4 записи, которые фиксируют этапы  заказа.</p>

<p><img alt="" height="233" src="https://ucarecdn.com/fbb768ee-19b3-4c9f-a506-195a5ff4c907/" width="500"></p>

<p>Для каждого заказа сначала выставляется счет на оплату ( в запись с<code> <strong>step_id</strong></code> со значением 1 («Оплата») в столбец <strong><code>date_step_beg</code></strong> заносится  дата выставления счета по заказу ). После того, как счет оплачен, в столбец <strong><code>date_step_end</code></strong> той же записи заносится дата оплаты заказа.</p>

<p>Затем в таблице  <code><strong>buy_step </strong></code>заполняется  <code><strong>step_id</strong></code> со значением 2 («Упаковка»)  для текущего заказа: после передачи заказа на упаковку заполняется поле <strong><code>date_step_beg</code></strong>, а после окончания упаковки – поле <strong><code>date_step_end</code></strong>. И так далее для оставшихся двух шагов («Транспортировка» и «Доставка»).</p>

<p>Для реализации запроса учитывать тот факт, что те заказы, которые не оплачены в таблице <strong><code>buy_step</code></strong> в записи с<code> <strong>step_id</strong></code> со значением 1 («Оплата»)  в столбце <code><strong>date_step_end</strong></code>  имеют значение <code>Null.</code></p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/305762/step/4?unit=287773" rel="noopener noreferrer nofollow">сравнение с пустым значением</a></u>;</li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Вывести номера всех оплаченных заказов и даты, когда они были оплачены.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------+---------------+
| buy_id | date_step_end |
+--------+---------------+
| 1      | 2020-02-20    |
| 2      | 2020-02-28    |
| 3      | 2020-03-05    |
+--------+---------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT buy_id, date_step_beg
FROM buy_step INNER JOIN step ON buy_step.step_id = step.step_id
WHERE date_step_beg IS NOT Null AND name_step = (SELECT name_step FROM step WHERE step_id = 1) AND date_step_end IS NOT Null


</code></pre><h2>Задание</h2>

<p>В таблицу <strong><code>buy_step</code></strong> для заказа с номером 5 включить все этапы из таблицы <code><strong>step</strong></code>, которые должен пройти этот заказ. В столбцы <code><strong>date_step_beg</strong></code> и <code><strong>date_step_end </strong></code>всех записей занести <code>Null</code>.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/b104b25f-4a80-4b07-ab1a-f73c25dc3e0b/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Все этапы в таблицу<code><strong> buy_step</strong></code> можно вставить одним запросом, для этого используется соединение <code><a href="https://stepik.org/lesson/308886/step/4?unit=291012" rel="noopener noreferrer nofollow">CROSS JOIN</a> </code>для таблиц <code><strong>buy</strong></code> и <code><strong>step</strong></code>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/4?unit=287020" rel="noopener noreferrer nofollow">добавление записей</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/4?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>В таблицу <strong><code>buy_step</code></strong> для заказа с номером 5 включить все этапы из таблицы <code><strong>step</strong></code>, которые должен пройти этот заказ. В столбцы <code><strong>date_step_beg</strong></code> и <code><strong>date_step_end </strong></code>всех записей занести <code>Null</code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 4

Query result (выборка из таблицы buy_step):
+-------------+--------+---------+---------------+---------------+
| buy_step_id | buy_id | step_id | date_step_beg | date_step_end |
+-------------+--------+---------+---------------+---------------+
| 1           | 1      | 1       | 2020-02-20    | 2020-02-20    |
| 2           | 1      | 2       | 2020-02-20    | 2020-02-21    |
| 3           | 1      | 3       | 2020-02-22    | 2020-03-07    |
| 4           | 1      | 4       | 2020-03-06    | 2020-03-06    |
| 5           | 2      | 1       | 2020-02-28    | 2020-02-28    |
| 6           | 2      | 2       | 2020-02-29    | 2020-03-01    |
| 7           | 2      | 3       | 2020-03-02    | NULL          |
| 8           | 2      | 4       | NULL          | NULL          |
| 9           | 3      | 1       | 2020-03-05    | 2020-03-05    |
| 10          | 3      | 2       | 2020-03-05    | 2020-03-06    |
| 11          | 3      | 3       | 2020-03-06    | 2020-03-10    |
| 12          | 3      | 4       | 2020-03-11    | NULL          |
| 13          | 4      | 1       | 2020-03-20    | NULL          |
| 14          | 4      | 2       | NULL          | NULL          |
| 15          | 4      | 3       | NULL          | NULL          |
| 16          | 4      | 4       | NULL          | NULL          |
| 17          | 5      | 1       | NULL          | NULL          |
| 18          | 5      | 2       | NULL          | NULL          |
| 19          | 5      | 3       | NULL          | NULL          |
| 20          | 5      | 4       | NULL          | NULL          |
+-------------+--------+---------+---------------+---------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц(перед выполнением шага)</strong></summary> <img alt="" height="878" name="115.png" src="https://ucarecdn.com/023077f7-c72f-44cb-959c-d7dc0adfdbfd/" width="711"></details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO buy_step (buy_id, step_id, date_step_beg, date_step_end)
SELECT 5, step_id, Null, Null
FROM buy CROSS JOIN step
WHERE buy_id = 5;
</code></pre><h2><strong>Задание</strong></h2>

<p>Выведите сколько человек подало заявление на каждую образовательную программу и конкурс на нее (число поданных заявлений деленное на количество мест по плану), округленный до 2-х знаков после запятой. В запросе вывести название факультета, к которому относится образовательная программа, название образовательной программы, план набора абитуриентов на образовательную программу (<code><strong>plan</strong></code>), количество поданных заявлений (<strong>Количество</strong>) и <strong>Конкурс</strong>. Информацию отсортировать в порядке убывания конкурса.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" height="321" name="22.jpg" src="https://ucarecdn.com/232b551a-2fbc-435e-85e1-513a8bea6043/" width="171"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>После <code>GROUP BY</code> задаются ВСЕ столбцы, указанные после <code>SELECT</code>,  к которым не применяются групповые функции или выражения с групповыми функциями. В этом запросе это <code><strong>name_department</strong></code>, <code><strong>name_program</strong></code> и <code><strong>plan</strong></code>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Выведите сколько человек подало заявление на каждую образовательную программу и конкурс на нее (число поданных заявлений деленное на количество мест по плану), округленный до 2-х знаков после запятой. В запросе вывести название факультета, к которому относится образовательная программа, название образовательной программы, план набора абитуриентов на образовательную программу (<code><strong>plan</strong></code>), количество поданных заявлений (<strong>Количество</strong>) и <strong>Конкурс</strong>. Информацию отсортировать в порядке убывания конкурса.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------------------------+-------------------------------------+------+------------+---------+
| name_department         | name_program                        | plan | Количество | Конкурс |
+-------------------------+-------------------------------------+------+------------+---------+
| Школа естественных наук | Математика и компьютерные науки     | 1    | 3          | 3.00    |
| Инженерная школа        | Прикладная механика                 | 2    | 4          | 2.00    |
| Школа естественных наук | Прикладная математика и информатика | 2    | 3          | 1.50    |
| Инженерная школа        | Мехатроника и робототехника         | 3    | 4          | 1.33    |
+-------------------------+-------------------------------------+------+------------+---------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>department</code>, <code>program</code>, <code>program_enrollee</code></strong></summary>

<pre><code class="language-sql">таблица department
+---------------+-------------------------+
| department_id | name_department         |
+---------------+-------------------------+
| 1             | Инженерная школа        |
| 2             | Школа естественных наук |
+---------------+-------------------------+
таблица program
+------------+-------------------------------------+---------------+------+
| program_id | name_program                        | department_id | plan |
+------------+-------------------------------------+---------------+------+
| 1          | Прикладная математика и информатика | 2             | 1    |
| 2          | Математика и компьютерные науки     | 2             | 2    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |
+------------+-------------------------------------+---------------+------+
таблица program_enrollee
+---------------------+------------+-------------+
| program_enrollee_id | program_id | enrollee_id |
+---------------------+------------+-------------+
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |
+---------------------+------------+-------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_department, name_program, plan, COUNT(enrollee_id) AS Количество, ROUND((COUNT(enrollee_id)/plan), 2) AS Конкурс
FROM program INNER JOIN department USING(department_id)
INNER JOIN program_enrollee USING(program_id)
GROUP BY name_department, name_program, plan
ORDER BY Конкурс DESC
</code></pre><h2>Задание</h2>

<p>Создать таблицу <code><strong>student</strong></code>,  в которую включить абитуриентов, которые могут быть рекомендованы к зачислению  в соответствии с планом набора. Информацию отсортировать сначала в алфавитном порядке по названию программ, а потом по убыванию итогового балла.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/21cacbbd-ab78-4347-b1a4-1df3791c875c/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>На каждую образовательную программу может быть зачислено только обозначенное в плане число абитуриентов (например, <code><strong>n</strong></code>). Выбираются первые <strong>n</strong> абитуриентов, набравших наибольшее количество баллов. В<strong> <code>str_id</code></strong><code> </code>содержится нумерация (отсортированных по сумме баллов абитуриентов), начинающаяся с 1 для каждой образовательной программы. И соответственно, если по плану нужно зачислить <code><strong>n </strong></code>абитуриентов, то выбираются все абитуриенты, порядковый номер которых в <code><strong>str_id</strong> </code>меньше или равен <code><strong>n</strong></code>.</p>

<p>То есть в таблицу на каждую образовательную программу включить абитуриентов, значение <code><strong>str_id</strong></code> которых в таблице <code><strong>applicant_order</strong></code> меньше или равно плану.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/10?unit=287020" rel="noopener noreferrer nofollow">создание таблицы</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу):</p>

<blockquote>
<p>Создать таблицу <code><strong>student</strong></code>,  в которую включить абитуриентов, которые могут быть рекомендованы к зачислению  в соответствии с планом набора. Информацию отсортировать сначала в алфавитном порядке по названию программ, а потом по убыванию итогового балла.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 8

Query result:
+-------------------------------------+-----------------+------+
| name_program                        | name_enrollee   | itog |
+-------------------------------------+-----------------+------+
| Математика и компьютерные науки     | Степанова Дарья | 276  |
| Мехатроника и робототехника         | Степанова Дарья | 270  |
| Мехатроника и робототехника         | Семенов Иван    | 247  |
| Мехатроника и робототехника         | Попов Илья      | 200  |
| Прикладная математика и информатика | Семенов Иван    | 235  |
| Прикладная математика и информатика | Абрамова Катя   | 226  |
| Прикладная механика                 | Степанова Дарья | 270  |
| Прикладная механика                 | Яковлева Галина | 239  |
+-------------------------------------+-----------------+------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE student AS
SELECT name_program, name_enrollee, itog
FROM enrollee INNER JOIN applicant_order USING(enrollee_id) INNER JOIN program USING(program_id)
WHERE str_id <= plan
ORDER BY name_program, itog DESC;

SELECT * FROM student</code></pre><h2>Задание</h2>

<p>Вывести вопросы, которые были включены в тест для Семенова Ивана по дисциплине «Основы SQL» 2020-05-17  (значение <code><strong>attempt_id</strong></code><strong> </strong>для этой попытки равно 7). Указать, какой ответ дал студент и правильный он или нет (вывести <strong>Верно</strong> или <strong>Неверно</strong>). В результат включить вопрос, ответ и вычисляемый столбец  <code><strong>Результат</strong></code>.</p>

<p><strong>Фрагмент логической схемы базы данных</strong></p>

<p><img alt="" src="https://ucarecdn.com/9cea1edc-98ee-4215-ae29-70ebf8aaea21/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для вывода результата используете функцию<code><strong> <a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow">if()</a></strong></code>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow">функция IF()</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) </p>

<blockquote>
<p>Вывести вопросы, которые были включены в тест для Семенова Ивана по дисциплине «Основы SQL» 2020-05-17  (значение <code><strong>attempt_id </strong></code>для этой попытки равно 7). Указать, какой ответ дал студент и правильный он или нет(вывести <strong>Верно</strong> или <strong>Неверно</strong>). В результат включить вопрос, ответ и вычисляемый столбец  <code><strong>Результат</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+----------------------------------------------------------+-----------------------+-----------+
| name_question                                            | name_answer           | Результат |
+----------------------------------------------------------+-----------------------+-----------+
| Запрос на выборку начинается с ключевого слова:          | INSERT                | Неверно   |
| Какой запрос выбирает все записи из таблицы student:     | SELECT * FROM student | Верно     |
| Для внутреннего соединения таблиц используется оператор: | CROSS JOIN            | Неверно   |
+----------------------------------------------------------+-----------------------+-----------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц <code>question</code>, <code>answer</code>, <code>testing</code></strong></summary>

<pre><code class="language-sql">таблица question
+-------------+------------------------------------------------------------+------------+
| question_id | name_question                                              | subject_id |
+-------------+------------------------------------------------------------+------------+
| 1           | Запрос на выборку начинается с ключевого слова:            | 1          |
| 2           | Условие, по которому отбираются записи, задается после...  | 1          |
| 3           | Для сортировки используется:                               | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:       | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:   | 1          |
| 6           | База данных - это:                                         | 2          |
| 7           | Отношение - это:                                           | 2          |
| 8           | Концептуальная модель используется для                     | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?        | 2          |
+-------------+------------------------------------------------------------+------------+

таблица answer
+-----------+--------------------------------------------------------+-------------+------------+
| answer_id | name_answer                                            | question_id | is_correct |
+-----------+--------------------------------------------------------+-------------+------------+
| 1         | UPDATE                                                 | 1           | 0          |
| 2         | SELECT                                                 | 1           | 1          |
| 3         | INSERT                                                 | 1           | 0          |
| 4         | GROUP BY                                               | 2           | 0          |
| 5         | FROM                                                   | 2           | 0          |
| 6         | WHERE                                                  | 2           | 1          |
| 7         | SELECT                                                 | 2           | 0          |
| 8         | SORT                                                   | 3           | 0          |
| 9         | ORDER BY                                               | 3           | 1          |
| 10        | RANG BY                                                | 3           | 0          |
| 11        | SELECT * FROM student                                  | 4           | 1          |
| 12        | SELECT student                                         | 4           | 0          |
| 13        | INNER JOIN                                             | 5           | 1          |
| 14        | LEFT JOIN                                              | 5           | 0          |
| 15        | RIGHT JOIN                                             | 5           | 0          |
| 16        | CROSS JOIN                                             | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным...  | 6           | 1          |
| 18        | совокупность программ для хранения иобработки ...      | 6           | 0          |
| 19        | строка                                                 | 7           | 0          |
| 20        | столбец                                                | 7           | 0          |
| 21        | таблица                                                | 7           | 1          |
| 22        | обобщенное представление пользователей о данных        | 8           | 1          |
| 23        | описание представления данных в памяти компьютера      | 8           | 0          |
| 24        | база данных                                            | 8           | 0          |
| 25        | file                                                   | 9           | 1          |
| 26        | INT                                                    | 9           | 0          |
| 27        | VARCHAR                                                | 9           | 0          |
| 28        | DATE                                                   | 9           | 0          |
+-----------+--------------------------------------------------------+-------------+------------+

таблица testing
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
+------------+------------+-------------+-----------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_question, name_answer, IF(is_correct, 'Верно', 'Неверно') AS Результат
FROM question INNER JOIN testing USING(question_id) INNER JOIN answer USING(answer_id)
WHERE attempt_id = 7


</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/218555543" rel="noopener noreferrer nofollow">Артём Чепк</a></p>

<p>Вывести авторов, у которых есть книги со стоимостью более 500 и количеством более 1 шт на складе. Учитывать книги только тех авторов, у которых не менее 2-х произведений на складе. Вывести автора, количество различных произведений автора, минимальную цену и количество книг на складе. Информацию отсортировать по фамилии автора в алфавитном порядке.</p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p>Результат:</p>

<pre><code class="language-sql">+------------------+-------------------------+------------------+------------+
| author           | Количество_произведений | Минимальная_цена | Число_книг |
+------------------+-------------------------+------------------+------------+
| Булгаков М.А.    | 2                       | 540.50           | 8          |
| Достоевский Ф.М. | 3                       | 460.00           | 23         |
+------------------+-------------------------+------------------+------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Вывести авторов, у которых есть книги со стоимостью более 500 и количеством более 1 шт на складе. Учитывать книги только тех авторов, у которых не менее 2-х произведений на складе. Вывести автора, количество различных произведений автора, минимальную цену и количество книг на складе. Информацию отсортировать по фамилии автора в алфавитном порядке.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Выборка данных по условию, групповые функции, WHERE и HAVING</h2>

<p><em>Для этого урока теоретическая часть подготовлена <a href="https://stepik.org/users/2290685" rel="noopener noreferrer nofollow">Alexandra Klinnikova</a>, спасибо большое!</em></p>

<p><code>WHERE</code> и <code>HAVING</code> могут использоваться в одном запросе. При этом необходимо учитывать <strong>порядок выполнения  SQL запроса на выборку на СЕРВЕРЕ</strong>:</p>

<ol>
	<li>FROM</li>
	<li>WHERE</li>
	<li>GROUP BY</li>
	<li>HAVING</li>
	<li>SELECT</li>
	<li>ORDER BY</li>
</ol>

<p>Сначала определяется таблица, из которой выбираются данные (<code>FROM</code>), затем из этой таблицы отбираются записи в соответствии с условием  <code>WHERE</code>, выбранные данные агрегируются (<code>GROUP BY</code>),  из агрегированных записей выбираются те, которые удовлетворяют условию после <code>HAVING</code>. Потом формируются данные результирующей выборки, как это указано после <code>SELECT</code> ( вычисляются выражения, присваиваются имена и пр. ). Результирующая выборка сортируется, как указано после <code>ORDER BY</code>.</p>

<p><strong>Важно!</strong> Порядок ВЫПОЛНЕНИЯ запросов - это не порядок ЗАПИСИ ключевых слов в запросе на выборку. Порядок записи (синтаксис запроса) остается таким же, как рассматривался ранее в курсе. Порядок ВЫПОЛНЕНИЯ  нужен для того, чтобы понять, почему, например, в <code><strong>WHERE</strong></code> нельзя использовать имена выражений из <code><strong>SELECT</strong></code>. Просто <code><strong>SELECT</strong></code> выполняется компилятором позже, чем <code><strong>WHERE</strong></code>, поэтому ему неизвестно, какое там выражение написано.</p>

<p><strong>Пример</strong></p>

<p>Вывести максимальную и минимальную цену книг каждого автора, кроме Есенина, количество экземпляров книг которого больше 10. </p>

<pre><code class="language-sql">SELECT author,
    MIN(price) AS Минимальная_цена,
    MAX(price) AS Максимальная_цена
FROM book
WHERE author &lt;&gt; 'Есенин С.А.'
GROUP BY author
HAVING SUM(amount) &gt; 10;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+------------------+-------------------+
| author           | Минимальная_цена | Максимальная_цена |
+------------------+------------------+-------------------+
| Достоевский Ф.М. | 460.00           | 799.01            |
+------------------+------------------+-------------------+</code></pre>

<p>Другим способом решения примера является запрос:</p>

<pre><code class="language-sql">SELECT author,
    MIN(price) AS Минимальная_цена,
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(amount) &gt; 10 AND author &lt;&gt; 'Есенин С.А.';</code></pre>

<p>Не смотря на то что результат будет одинаковым, так делать <strong>не рекомендуется</strong>. «Потому что как написано - запрос сначала выбирает всех авторов, потом выводит данные, рассчитывая минимальное и максимальное значение цены для каждого, и только после всего убирает Есенина. Можно убрать Есенина в данном случае раньше и не использовать ресурсы базы для расчета его минимального и максимального значения, как это сделано в первом варианте. На небольшой базе быстродействия не ощутить, но если выполнять такое на продуктивной, то второй вариант значительно проигрывает...»[<a href="https://stepik.org/users/2290685" rel="noopener noreferrer nofollow">Alexandra Klinnikova</a>].</p>

<h2><strong>Задание</strong></h2>

<p>Посчитать стоимость всех экземпляров каждого автора без учета книг «Идиот» и «Белая гвардия». В результат включить только тех авторов, у которых суммарная стоимость книг (без учета книг «Идиот» и «Белая гвардия») более 5000 руб. Вычисляемый столбец назвать <code><strong>Стоимость</strong></code>. Результат отсортировать по убыванию стоимости.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------------+-----------+
| author           | Стоимость |
+------------------+-----------+
| Есенин С.А.      | 9750.00   |
| Достоевский Ф.М. | 7202.03   |
+------------------+-----------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, ROUND(SUM(price*amount),2) as Стоимость
FROM book
WHERE title NOT IN ("Идиот", "Белая гвардия")
GROUP BY author
HAVING SUM(price*amount) > 5000
ORDER BY Стоимость DESC</code></pre><h2> Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/211560936" rel="noopener noreferrer nofollow">Vladimir</a></p>

<p><strong>Определить стоимость доставки:</strong><br>
- для книг c ценой 500 и менее, установить в размере 99.99<br>
- при количестве книг на складе менее 5, а ценой выше 500, установить в размере 149.99<br>
- для остальных случаев доставка должна быть бесплатной<br>
<strong>Определить новую стоимость для книг:</strong><br>
- для книг, совокупной стоимостью более 5000, добавить 20% к стоимости за экземпляр<br>
- для остальных случаев снизить стоимость одного экземпляра на 20%<br>
<strong>Настроить фильтр при выборке:</strong><br>
- только позиции творчества авторов: Булгаков и Есенин, при количестве экземпляров на складе: от 3 до 14 включительно.<br>
<strong>Сортировку выполнить:</strong><br>
- по имени автора в порядке возрастания<br>
- затем по названию в порядке убывания<br>
- по стоимости доставки (от меньшей к большей)<br>
<strong>В таблице должны быть отображены данные:</strong><br>
- автора<br>
- название<br>
- количество<br>
- цену, как real_price<br>
- новую цену, как new_price (округлить до двух знаков после запятой)<br>
- стоимость доставки, как delivery_price </p>

<p><strong>Структура таблицы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/8ac5c6c5-1fed-4757-a83c-3038b903e963/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+---------------+--------------------+--------+------------+-----------+----------------+
| author        | title              | amount | real_price | new_price | delivery_price |
+---------------+--------------------+--------+------------+-----------+----------------+
| Булгаков М.А. | Мастер и Маргарита | 3      | 670.99     | 536.79    | 149.99         |
| Булгаков М.А. | Белая гвардия      | 5      | 540.50     | 432.40    | 0              |
| Есенин С.А.   | Черный человек     | 5      | 670.99     | 536.79    | 0              |
+---------------+--------------------+--------+------------+-----------+----------------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p> <strong>Определить стоимость доставки:</strong><br>
- для книг стоимостью 500 и менее, установить в размере 99.99<br>
- при количестве книг на складе менее 5, установить в размере 149.99<br>
- для остальных случаев доставка должна быть бесплатной<br>
<strong>Определить новую стоимость для книг:</strong><br>
- для книг, совокупной стоимостью более 5000, добавить 20% к стоимости за экземпляр<br>
- для остальных случаев снизить стоимость одного экземпляра на 20%<br>
<strong>Настроить фильтр при выборке:</strong><br>
- только позиции творчества авторов: Булгаков и Есенин, при количестве экземпляров на складе: от 3 до 14 включительно.<br>
<strong>Сортировку выполнить:</strong><br>
- по имени автора в порядке возрастания<br>
- затем по названию в порядке убывания<br>
- по стоимости доставки (от меньшей к большей)<br>
<strong>В таблице должны быть отображены данные:</strong><br>
- автора<br>
- название<br>
- количество<br>
- цену, как real_price<br>
- новую цену, как new_price (округлить до двух знаков после запятой)<br>
- стоимость доставки, как delivery_price </p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Задание</h2>

<p><em><strong>автор - </strong></em><a href="https://stepik.org/users/76913457" rel="noopener noreferrer nofollow">Лариса Фернандес</a></p>

<p>В последний заказ (таблица <code><strong>buy_book</strong></code>) клиента Баранов Павел добавить по одному экземпляру всех книг Достоевского, которые есть в таблице <code><strong>book</strong></code>.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/7adb675e-0a82-4331-8287-7f04b4946da9/"></p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 3

Query result:
+-------------+--------+---------+--------+
| buy_book_id | buy_id | book_id | amount |
+-------------+--------+---------+--------+
| 1           | 1      | 1       | 1      |
| 2           | 1      | 7       | 2      |
| 3           | 2      | 8       | 2      |
| 4           | 3      | 3       | 2      |
| 5           | 3      | 2       | 1      |
| 6           | 3      | 1       | 1      |
| 7           | 4      | 5       | 1      |
| 8           | 5      | 8       | 2      |
| 9           | 5      | 2       | 1      |
| 10          | 4      | 3       | 1      |
| 11          | 4      | 4       | 1      |
| 12          | 4      | 5       | 1      |
+-------------+--------+---------+--------+</code></pre>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) : </p>

<blockquote>
<p> В последний заказ (таблица <code><strong>buy_book</strong></code>) клиента Баранов Павел добавить по одному экземпляру всех книг Достоевского, которые есть в таблице <code><strong>book</strong></code>.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">NOT SOLVED!</code></pre><h2>Удаление записей, использование связанных таблиц</h2>

<p>При удалении записей из таблицы можно использовать информацию из других связанных с ней таблиц. В этом случае синтаксис запроса имеет вид:</p>

<pre><code class="language-sql">DELETE FROM таблица_1
USING 
    таблица_1 
    INNER JOIN таблица_2 ON ...
WHERE ...</code></pre>

<p><strong>Пример</strong></p>

<p>Удалить всех авторов из таблицы <code><strong>author</strong></code>, у которых есть книги, количество экземпляров которых меньше 3. Из таблицы <code><strong>book</strong></code> удалить все книги этих авторов.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">DELETE FROM author
USING 
    author 
    INNER JOIN book ON author.author_id = book.author_id
WHERE book.amount &lt; 3;

SELECT * FROM author;

SELECT * FROM book;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 1

Query result:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |
+-----------+------------------+
Affected rows: 5

Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>

<p>Книги из таблицы <code><strong>book</strong></code> будут удалены автоматически, так как для столбца <code><strong>author_id</strong></code> из таблицы <code><strong>book</strong></code> установлено <a href="https://stepik.org/lesson/308887/step/6?unit=291013" rel="noopener noreferrer nofollow">каскадное удаление записей</a>.</p>

<h2>Задание</h2>

<p>Удалить всех авторов, которые пишут в жанре "Поэзия". Из таблицы <code><strong>book</strong></code> удалить все книги этих авторов. В запросе для отбора авторов использовать полное название жанра, а не его <code><strong>id</strong></code>.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 3

Query result:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 6         | Стивенсон Р.Л.   |
+-----------+------------------+
Affected rows: 3

Query result:
+---------+--------------------+-----------+----------+--------+--------+
| book_id | title              | author_id | genre_id | price  | amount |
+---------+--------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия      | 1         | 1        | 540.50 | 12     |
| 3       | Идиот              | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы  | 2         | 1        | 799.01 | 3      |
| 5       | Игрок              | 2         | 1        | 480.50 | 10     |
| 11      | Остров сокровищ    | 6         | 3        | 599.99 | 5      |
+---------+--------------------+-----------+----------+--------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code>Таблица book
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+
Таблица supply
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
Таблица author                          Таблица genre
+-----------+------------------+	+----------+-------------+			
| author_id | name_author      |	| genre_id | name_genre  |			
+-----------+------------------+	+----------+-------------+			
| 1         | Булгаков М.А.    |	| 1        | Роман       |			
| 2         | Достоевский Ф.М. |	| 2        | Поэзия      |			
| 3         | Есенин С.А.      |	| 3        | Приключения |			
| 4         | Пастернак Б.Л.   |	+----------+-------------+			
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |
+-----------+------------------+							</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">DELETE FROM author
USING author INNER JOIN book ON author.author_id = book.author_id INNER JOIN genre ON book.genre_id = genre.genre_id
WHERE name_genre = 'Поэзия';

</code></pre><h2>Оконные функции, оператор OVER, ORDER BY</h2>

<p>Оконные функции позволяют получить некоторую дополнительную информацию о выборке данных .  С помощью оконных функций можно реализовать вычисления для набора строк, некоторым образом связанных с текущей строкой. При этом использование оконной функции не группирует несколько строк в одну, а сохраняет все строки запроса. Синтаксис оконных функций:</p>

<pre><code class="language-sql">название_функции(выражение) 
  OVER (
        PARTITION BY столбец_1, столбец_2, ... - это окно
        ORDER BY ... - сортировка 
        ROWS BETWEEN - границы окна
          ...
  )</code></pre>

<p>Причем все разделы <code><strong>OVER </strong></code>являются не обязательными, но обязательно нужно указать либо окно, либо сортировку. На данном шаге рассмотрим самый простой синтаксис оконного выражения:</p>

<pre><code class="language-sql">название_функции(выражение) 
  OVER (
        ORDER BY ...
  )</code></pre>

<p>Такое оконное выражение позволяет выполнять одинаковые действия над всеми записями таблицы (здесь окно - вся таблица). В качестве функций можно использовать:</p>

<p><code><strong>ROW_NUMBER() </strong></code>- просто нумерация строк;</p>

<p><code><strong>RANK() </strong></code>- ранжирование строк - при одинаковом значении строкам присваивается один номер, с пропуском номеров;</p>

<p><code><strong>DENSE_RANK()</strong></code> - ранжирование строк без пропуска номеров;</p>

<p><code><strong>LAG()</strong></code> - выбирает строку, предшествующую текущей, если таковой нет - выдается <code><strong>NULL</strong></code>;</p>

<p><code><strong>LEAD() </strong></code>- выбирает строку, следующую за текущей, если таковой нет - выдается <code><strong>NULL</strong></code>.</p>

<p><strong>Пример</strong></p>

<p>Вычислить, сколько шагов прошел пользователь. Ранжировать пользователей по убыванию результатов.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/e32cf2e7-200e-4ba9-9a7c-86244317d7fb/"></p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT student_name, count(DISTINCT step_id) AS Kоличество,

    ROW_NUMBER() OVER (ORDER BY  count(DISTINCT step_id) DESC) AS Номер

FROM student INNER JOIN step_student USING (student_id)
WHERE result = "correct"
GROUP BY student_name</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Query result:
+--------------+------------+-------+
| student_name | Kоличество | Номер |
+--------------+------------+-------+
| student_60   | 32         | 1     |
| student_15   | 30         | 2     |
| student_18   | 30         | 3     |
| student_27   | 30         | 4     |
| student_30   | 30         | 5     |
| student_31   | 30         | 6     |
| student_36   | 30         | 7     |
              ...
| student_5    | 9          | 61    |
| student_63   | 9          | 62    |
| student_29   | 8          | 63    |
| student_47   | 8          | 64    |
+--------------+------------+-------+
Affected rows: 64</code></pre>

<p>В этом запросе после того, как были выбраны все студенты, посчитаны их шаги с правильными ответами, с помощью оконной функции была выполнена сортировка по количеству верных шагов (<code><strong>count(DISTINCT step_id)</strong></code>)  и пронумерованы строки (функция <code><strong>ROW_NUMBER()</strong></code>).</p>

<p>Дополнительно ранжируем студентов.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT student_name, count(DISTINCT step_id) AS Kоличество,

    ROW_NUMBER() OVER (ORDER BY  count(DISTINCT step_id) DESC) AS Номер,

    RANK() OVER (ORDER BY  count(DISTINCT step_id) DESC) AS Ранг,
    DENSE_RANK() OVER (ORDER BY  count(DISTINCT step_id) DESC) AS Рейтинг

FROM student INNER JOIN step_student USING (student_id)
WHERE result = "correct"
GROUP BY student_name</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------------+------------+-------+------+---------+
| student_name | Kоличество | Номер | Ранг | Рейтинг |
+--------------+------------+-------+------+---------+
| student_60   | 32         | 1     | 1    | 1       |
| student_15   | 30         | 2     | 2    | 2       |
| student_18   | 30         | 3     | 2    | 2       |
| student_27   | 30         | 4     | 2    | 2       |
| student_30   | 30         | 5     | 2    | 2       |
| student_31   | 30         | 6     | 2    | 2       |
| student_36   | 30         | 7     | 2    | 2       |
| student_39   | 30         | 8     | 2    | 2       |
| student_4    | 30         | 9     | 2    | 2       |
| student_43   | 30         | 10    | 2    | 2       |
| student_44   | 30         | 11    | 2    | 2       |
| student_46   | 30         | 12    | 2    | 2       |
| student_49   | 30         | 13    | 2    | 2       |
| student_51   | 30         | 14    | 2    | 2       |
| student_53   | 30         | 15    | 2    | 2       |
| student_59   | 29         | 16    | 16   | 3       |
| student_9    | 29         | 17    | 16   | 3       |
| student_23   | 28         | 18    | 18   | 4       |
| student_50   | 27         | 19    | 19   | 5       |
                        ...
| student_5    | 9          | 61    | 60   | 15      |
| student_63   | 9          | 62    | 60   | 15      |
| student_29   | 8          | 63    | 63   | 16      |
| student_47   | 8          | 64    | 63   | 16      |
+--------------+------------+-------+------+---------+
Affected rows: 64</code></pre>

<p>С помощью функции <code><strong>RANK()</strong> </code>и<code><strong> DENSE_RANK()</strong></code> все студенты, имеющие 30  верно пройденных шагов, получили ранг 2 и  рейтинг 2. Студентам с 29 балами присвоен ранг 16 и  рейтинг 3.</p>

<p><strong>Пример</strong></p>

<p>Для каждого студента указать, на сколько меньше он прошел шагов, чем идущий перед ним по рейтингу студент.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT student_name, count(DISTINCT step_id) AS Количество,

       LAG(count(DISTINCT step_id)) 
       OVER (ORDER BY  count(DISTINCT step_id) DESC) - count(DISTINCT step_id) AS Разница

FROM student INNER JOIN step_student USING (student_id)
WHERE result = "correct"
GROUP BY student_name</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------------+------------+---------+
| student_name | Количество | Разница |
+--------------+------------+---------+
| student_60   | 32         | None    |
| student_15   | 30         | 2       |
| student_18   | 30         | 0       |
| student_27   | 30         | 0       |
| student_30   | 30         | 0       |
| student_31   | 30         | 0       |
| student_36   | 30         | 0       |

| student_63   | 9          | 0       |
| student_29   | 8          | 1       |
| student_47   | 8          | 0       |
+--------------+------------+---------+
Affected rows: 64</code></pre>

<p>Так как у первой записи нет предыдущей - значение разницы <code><strong>NULL</strong></code>. Заменим ее на 0 с помощью функции:</p>

<pre><code class="language-sql">IFNULL(выражение, результат)</code></pre>

<p>которая возвращает результат, если выражение равно <code><strong>NULL</strong></code>, и само выражение в противном случае.</p>

<p><em>Запрос:</em></p>

<pre><code>SELECT student_name, count(DISTINCT step_id) AS Количество,

       IFNULL(LAG(count(DISTINCT step_id)) 
              OVER (ORDER BY  count(DISTINCT step_id) DESC) - count(DISTINCT step_id), 
              0) AS Разница

FROM student INNER JOIN step_student USING (student_id)
WHERE result = "correct"
GROUP BY student_name</code></pre>

<p><em> Результат:</em></p>

<pre><code class="language-sql">+--------------+------------+---------+
| student_name | Количество | Разница |
+--------------+------------+---------+
| student_60   | 32         | 0       |
| student_15   | 30         | 2       |
| student_18   | 30         | 0       |
| student_27   | 30         | 0       |
| student_30   | 30         | 0       |
| student_31   | 30         | 0       |
| student_36   | 30         | 0       |
              ...
| student_63   | 9          | 0       |
| student_29   | 8          | 1       |
| student_47   | 8          | 0       |
+--------------+------------+---------+
Affected rows: 64
</code></pre>

<h2><strong>Задание</strong></h2>

<p>Для студента с именем<strong> student_61</strong> вывести все его попытки: название шага, результат и дату отправки попытки (<code><strong>submission_time</strong></code>). Информацию отсортировать по дате отправки попытки и указать, сколько минут прошло между отправкой соседних попыток. Название шага ограничить 20 символами и добавить "...". Столбцы назвать <code><strong>Студент, Шаг, Результат, Дата_отправки, Разница</strong></code>.</p>

<p><strong>Фрагмент логической схемы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/7eeaa225-2f02-4721-9d0a-6c3e0beda68d/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p> 1. Время в таблице <code><strong>step_student</strong></code> представлено в формате  <strong>Unix-время</strong> , в котором хранится количество секунд, прошедших с 1 января 1970 года. Для перевода к привычному виду <code><strong>DATE</strong></code> используется формула:</p>

<pre><code class="language-sql">1970-01-01 + time_unix / 86400</code></pre>

<p>В SQL для перевода удобно использовать функцию  <strong><code>FROM_UNIXTIME( ).</code></strong></p>

<p>Например:</p>

<pre><code class="language-sql">FROM_UNIXTIME(1598291490) =  2020-08-24 17:51:30</code></pre>

<p>2. Для перевода количества секунд во временной формат используется функция <code><strong>SEC_TO_TIME(),</strong></code>например:</p>

<p><code><strong>SEC_TO_TIME(288) = 0:04:48</strong></code></p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/310421/step/10?auth=login&amp;unit=292727" rel="noopener noreferrer nofollow">функции LEFT() и CONCAT()</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a></u>.</li>
</ul>
</details>

<p><em><strong>Текст запроса (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p>Для студента с именем<strong> student_61</strong> вывести все его попытки: название шага, результат и дату отправки попытки (<code><strong>submission_time</strong></code>). Информацию отсортировать по дате отправки попытки и указать, сколько минут прошло между отправкой соседних попыток. Название шага ограничить 20 символами и добавить "...". Столбцы назвать <code><strong>Студент, Шаг, Результат, Дата_отправки, Разница</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------+-------------------------+-----------+---------------------+------------------+
| Студент    | Шаг                     | Результат | Дата_отправки       | Разница          |
+------------+-------------------------+-----------+---------------------+------------------+
| student_61 | Выборка всех данных ... | correct   | 2020-08-27 14:22:14 | 0:00:00          |
| student_61 | Выборка отдельных ст... | correct   | 2020-08-27 14:23:53 | 0:01:39          |
| student_61 | Выборка отдельных ст... | correct   | 2020-08-27 14:28:41 | 0:04:48          |
| student_61 | Выборка данных с соз... | wrong     | 2020-08-27 14:33:57 | 0:05:16          |
| student_61 | Выборка данных с соз... | wrong     | 2020-08-27 14:34:24 | 0:00:27          |
                                        ...
| student_61 | Выборка данных с сор... | correct   | 2020-08-27 16:14:15 | 0:01:24          |
| student_61 | Соединение INNER JOI... | correct   | 2020-09-01 07:25:39 | 4 days, 15:11:24 |
| student_61 | Внешнее соединение L... | wrong     | 2020-09-01 09:53:30 | 2:27:51          |
| student_61 | Внешнее соединение L... | correct   | 2020-09-01 09:53:50 | 0:00:20          |
| student_61 | Перекрестное соедине... | wrong     | 2020-09-01 10:45:30 | 0:51:40          |
| student_61 | Перекрестное соедине... | wrong     | 2020-09-01 10:46:21 | 0:00:51          |
| student_61 | Перекрестное соедине... | correct   | 2020-09-01 10:47:55 | 0:01:34          |
+------------+-------------------------+-----------+---------------------+------------------+
Affected rows: 43</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT student_name, CONCAT(LEFT(step_name, 20), '...') AS Шаг,
result AS Результат,
FROM_UNIXTIME(submission_time) AS Дата_отправки,
SEC_TO_TIME(-IFNULL(LAG(submission_time) OVER (ORDER BY submission_time ASC) - submission_time, 0)) AS Разница
FROM step INNER JOIN step_student Using(step_id) INNER JOIN student Using(student_id)
WHERE student_name = 'student_61'
ORDER BY submission_time

</code></pre><p><span style="color: #006600;">На каждом шаге можно посмотреть, как  работает запрос примера. Для этого нужно скопировать его код в окно для ввода и нажать на черную кнопку <strong>Запустить код</strong> (не отправляя на проверку). Те запросы, которые уже проверены, можно не удалять, а просто закомментировать, используя /* и */.</span></p>

<h2>Вставка записи в таблицу</h2>

<p>Для занесения новой записи в таблицу используется SQL запрос, в котором указывается в какую таблицу, в какие поля заносить новые значения. Структура запроса:</p>

<ul>
	<li>ключевые слова <code>INSERT INTO</code> (ключевое слово <code>INTO </code>можно пропустить);</li>
	<li>имя таблицы, в которую добавляется запись;</li>
	<li>открывающая круглая скобка «(»;</li>
	<li> список полей через запятую, в которые следует занести новые данные;</li>
	<li>закрывающая скобка «)»;</li>
	<li>ключевое слово <code>VALUES</code>;</li>
	<li>открывающая круглая скобка «(»;</li>
	<li>список значений через запятую, которые заносятся в соответствующие поля, при этом текстовые значения заключаются в кавычки, числовые значения записываются без кавычек, в качестве разделителя целой и дробной части используется точка;</li>
	<li>закрывающая скобка «)».</li>
</ul>

<p><strong>Пример.</strong> В <code><strong>таблицу</strong></code>, состоящую из двух столбцов добавим новую строку, при этом в <code><strong>поле1</strong></code> заносится<code><strong> значение1</strong></code>,  в <code><strong>поле2</strong></code> - <code><strong>значение2</strong></code>.</p>

<pre><code class="language-sql">INSERT INTO таблица(поле1, поле2) 
VALUES (значение1, значение2);</code></pre>

<p>В результате выполнения запроса новая запись заносится в конец обновляемой таблицы.</p>

<p>При составлении списка полей и списка значений необходимо учитывать следующее:</p>

<ol>
	<li>количество полей и количество значений в списках должны совпадать;</li>
	<li>должно существовать прямое соответствие между позицией одного и того же элемента в обоих списках, поэтому первый элемент списка значений должен относиться к первому столбцу в списке столбцов, второй – ко второму столбцу и т.д.;</li>
	<li> типы данных элементов в списке значений должны быть совместимы с типами данных соответствующих столбцов таблицы ( целое число можно занести в поле типа DECIMAL, обратная операция - недопустима);</li>
	<li>новые значения нельзя добавлять в поля, описанные как <code>PRIMARY KEY AUTO_INCREMENT</code>;</li>
	<li>рекомендуется заполнять все поля записи, если же поле пропущено, значение этого поля зависит от установленных по умолчанию значений, если значения не установлены - на данной платформе вставляется пустое значение (<code><strong>NULL</strong></code>).</li>
</ol>

<p><strong>Пример</strong></p>

<p>Вставим новую запись в таблицу <code><strong>genre</strong></code>, созданную на предыдущем шаге ( в первых двух строках показана структура таблицы, далее - ее содержимое):</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td style="text-align: center;"><strong>genre_id</strong></td>
			<td style="text-align: center;"><strong>name_genre</strong></td>
		</tr>
		<tr style="background-color: #dcdcdc; background: #dcdcdc; text-align: center;">
			<td><sup><strong>INT PRIMARY KEY AUTO_INCREMENT</strong></sup></td>
			<td><sup><strong>VARCHAR(30)</strong></sup></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Роман</td>
		</tr>
	</tbody>
</table>

<p><em> Запрос:</em></p>

<pre><code class="language-sql">INSERT INTO genre (name_genre) 
VALUES ('Роман');</code></pre>

<p>Заносится только значение поля <code><strong>name_genre</strong></code>, значение ключевого поля формируется автоматически.</p>

<p><em>Результат</em>:  в таблицу будет вставлена новая строка, после запуска запроса на платформе <strong>stepik</strong>, имеем:</p>

<p><img alt="" height="183" src="https://ucarecdn.com/edfcf5ef-692c-4eae-a6ae-cd15dc300906/" width="400"></p>

<p>Чтобы увидеть как именно выглядит таблица<code><strong> genre</strong></code>, можно добавить SQL запрос, который выберет все записи из таблицы:</p>

<pre><code class="language-sql">SELECT * FROM genre;</code></pre>

<p><em>Результат:</em></p>

<p><img alt="" height="256" src="https://ucarecdn.com/53df360c-a2aa-4247-aa38-3ba20148123f/" width="400"></p>

<h2>Задание</h2>

<p>Занесите новую строку в таблицу<strong><code> book</code></strong> (текстовые значения (тип <code><strong>VARCHAR</strong></code>) заключать либо в двойные, либо в одинарные кавычки):</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr style="background-color: #dcdcdc; background: #dcdcdc; text-align: center;">
			<td><sup>INT PRIMARY KEY AUTO_INCREMENT</sup></td>
			<td><sup>VARCHAR(50)</sup></td>
			<td><sup>VARCHAR(30)</sup></td>
			<td><sup>DECIMAL(8,2)</sup></td>
			<td><sup>INT</sup></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Мастер и Маргарита</td>
			<td>Булгаков М.А.</td>
			<td>670.99</td>
			<td>3</td>
		</tr>
	</tbody>
</table>

<p><strong>Рекомендация:</strong> текстовые поля копируйте из таблицы, представленной в задании, и вставляйте в запрос во избежание ошибок... </p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 1
Query result:
+---------+--------------------+---------------+--------+--------+
| book_id | title              | author        | price  | amount |
+---------+--------------------+---------------+--------+--------+
| 1       | Мастер и Маргарита | Булгаков М.А. | 670.99 | 3      |
+---------+--------------------+---------------+--------+--------+</code></pre> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO book (title, author, price, amount)
VALUES ('Мастер и Маргарита', 'Булгаков М.А.', 670.99, 3);




</code></pre><h2><strong>Выборка данных, логические операции</strong></h2>

<p><strong> </strong>Логическое выражение после ключевого слова <code>WHERE</code> кроме операторов сравнения  и выражений может включать  <strong>логические операции</strong> (И «<strong>and</strong>», ИЛИ «<strong>or</strong>», НЕ «<strong>not</strong>») и круглые скобки, изменяющие приоритеты выполнения операций.</p>

<p>Приоритеты операций:</p>

<ol>
	<li>круглые скобки</li>
	<li>умножение  (*),  деление (/)</li>
	<li>сложение  (+), вычитание (-)</li>
	<li>операторы сравнения (=, &gt;, &lt;, &gt;=, &lt;=, &lt;&gt;)</li>
	<li>NOT</li>
	<li>AND</li>
	<li>OR</li>
</ol>

<p><strong>Пример</strong></p>

<p>Вывести название, автора и цену тех книг, которые написал Булгаков, ценой больше 600 рублей</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, price 
FROM book
WHERE price &gt; 600 AND author = 'Булгаков М.А.';</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------------------+---------------+--------+
| title              | author        | price  |
+--------------------+---------------+--------+
| Мастер и Маргарита | Булгаков М.А. | 670.99 |
+--------------------+---------------+--------+</code></pre>

<p><strong> Пример</strong></p>

<p>Вывести название, цену  тех книг, которые написал Булгаков или Есенин, ценой больше 600 рублей</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, price 
FROM book
WHERE (author = 'Булгаков М.А.' OR author = 'Есенин С.А.') AND price &gt; 600;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+---------------+--------+
| title                 | author        | price  |
+-----------------------+---------------+--------+
| Мастер и Маргарита    | Булгаков М.А. | 670.99 |
| Стихотворения и поэмы | Есенин С.А.   | 650.00 |
+-----------------------+---------------+--------+</code></pre>
<details><summary><strong>Пояснение. </strong></summary>
<p>В данном запросе обязательно нужно поставить скобки, так как без них сначала вычисляется  <code>author = 'Есенин С.А.' and price &gt; 600,</code> а потом уже выражение через <code>or</code>. Без скобок были бы отобраны все книги Булгакова и те книги Есенина, цена которых больше 600.</p></details>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, price 
FROM book
WHERE author = 'Булгаков М.А.' OR author = 'Есенин С.А.' AND price &gt; 600;</code></pre>

<p><em>Результат (сравните с предыдущим):</em></p>

<pre><code class="language-sql">+-----------------------+---------------+--------+
| title                 | author        | price  |
+-----------------------+---------------+--------+
| Мастер и Маргарита    | Булгаков М.А. | 670.99 |
| Белая гвардия         | Булгаков М.А. | 540.50 |
| Стихотворения и поэмы | Есенин С.А.   | 650.00 |
+-----------------------+---------------+--------+</code></pre>

<h2>Задание</h2>

<p>Вывести название, автора,  цену  и количество всех книг, цена которых меньше 500 или больше 600, а стоимость всех экземпляров этих книг больше или равна 5000.</p>

<p><em> Результат:</em></p>

<pre><code class="language-sql">+-----------------------+-------------+--------+--------+
| title                 | author      | price  | amount |
+-----------------------+-------------+--------+--------+
| Стихотворения и поэмы | Есенин С.А. | 650.00 | 15     |
+-----------------------+-------------+--------+--------+</code></pre>

<details><summary><strong>Структура и наполнение таблицы <code>book</code><strong>:</strong></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, author, price, amount
FROM book
WHERE (amount < 500 OR amount > 600) AND price * amount >= 5000





</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов к нашей таблице <code><strong>book</strong></code>, используя групповые функции. Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно использовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p>В последнем модуле создан отдельный урок, в котором мы разместим запросы, набравшие наибольшее количество лайков. </p>

<p><strong>Структура и наполнение таблицы <code>book:</code></strong></p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr style="background-color: #dcdcdc; background: #dcdcdc; text-align: center;">
			<td><sup><strong>INT PRIMARY KEY AUTO_INCREMENT</strong></sup></td>
			<td><sup><strong>VARCHAR(50)</strong></sup></td>
			<td><sup><strong>VARCHAR(30)</strong></sup></td>
			<td><sup><strong>DECIMAL(8,2)</strong></sup></td>
			<td><sup><strong>INT</strong></sup></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Мастер и Маргарита</td>
			<td>Булгаков М.А.</td>
			<td>670.99</td>
			<td>3</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Белая гвардия</td>
			<td>Булгаков М.А.</td>
			<td>540.50</td>
			<td>5</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Идиот</td>
			<td>Достоевский Ф.М.</td>
			<td>460.00</td>
			<td>10</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Братья Карамазовы</td>
			<td>Достоевский Ф.М.</td>
			<td>799.01</td>
			<td>3</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Игрок</td>
			<td>Достоевский Ф.М.</td>
			<td>480.50</td>
			<td>10</td>
		</tr>
		<tr>
			<td>6</td>
			<td>Стихотворения и поэмы</td>
			<td>Есенин С.А.</td>
			<td>650.00</td>
			<td>15</td>
		</tr>
	</tbody>
</table> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, CEILING(SUM(price*amount)) as Стоимость
FROM book
WHERE title NOT IN("Белая гвардия", "Братья Карамазовы")
GROUP BY author
HAVING SUM(amount) > 6
ORDER BY Стоимость DESC</code></pre><h2>Запросы на удаление</h2>

<p>Запросы корректировки данных позволяют удалить одну или несколько записей из  таблицы. Простейший запрос на удаление имеет вид:</p>

<pre><code class="language-sql">DELETE FROM таблица;</code></pre>

<p>Этот запрос удаляет все записи из указанной после <code>FROM</code> таблицы.</p>

<p><strong>Пример</strong></p>

<p>После того, как информация о книгах из таблицы <code><strong>supply</strong></code> перенесена в <code><strong>book</strong></code> , необходимо очистить таблицу  <code><strong>supply</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">DELETE FROM supply;

SELECT * FROM supply;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 4
Affected rows: 0</code></pre>

<p>Из таблицы удалены все записи. Запрос на выборку отобрал 0 записей.</p>

<p>Запрос на удаления позволяет удалить не все записи таблицы, а только те, которые удовлетворяют условию, указанному после ключевого слова <code>WHERE</code>:</p>

<pre><code class="language-sql">DELETE FROM таблица
WHERE условие;</code></pre>

<p><strong>Пример</strong></p>

<p>Удалить из таблицы <code><strong>supply</strong></code> все книги, названия которых есть в таблице <code><strong>book</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">DELETE FROM supply 
WHERE title IN (
        SELECT title 
        FROM book
      );


SELECT * FROM supply;</code></pre>

<p>Результат:</p>

<pre><code class="language-sql">Affected rows: 2

Query result:
+-----------+--------------------------+------------------+--------+--------+
| supply_id | title                    | author           | price  | amount |
+-----------+--------------------------+------------------+--------+--------+
| 1         | Лирика                   | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек           | Есенин С.А.      | 570.20 | 6      |
+-----------+--------------------------+------------------+--------+--------+</code></pre>

<p>Из таблицы <code><strong>supply</strong></code> удалены две записи о книгах «Белая гвардия» и «Идиот».</p>

<h2><strong>Задание</strong></h2>

<p>Удалить из таблицы <code><strong>supply</strong></code> книги тех авторов, общее количество экземпляров книг которых в таблице <code><strong>book</strong></code> превышает 10.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 2

Query result:
+-----------+---------------+----------------+--------+--------+
| supply_id | title         | author         | price  | amount |
+-----------+---------------+----------------+--------+--------+
| 1         | Лирика        | Пастернак Б.Л. | 518.99 | 2      |
| 3         | Белая гвардия | Булгаков М.А.  | 540.50 | 7      |
+-----------+---------------+----------------+--------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц <code>book</code> и <code>supply</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>

<pre><code>+-----------+----------------+------------------+--------+--------+
| supply_id | title          | author           | price  | amount |
+-----------+----------------+------------------+--------+--------+
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |
+-----------+----------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">DELETE FROM supply
WHERE author IN (SELECT author FROM book GROUP BY author HAVING SUM(amount) > 10);

</code></pre><h2>Задание</h2>

<p>Вывести название месяца и количество командировок для каждого месяца. Считаем, что командировка относится к некоторому месяцу, если она началась в этом месяце. Информацию вывести сначала в отсортированном по убыванию количества, а потом в алфавитном порядке по названию месяца виде. Название столбцов – <strong>Месяц</strong> и <strong>Количество</strong>.</p>

<p><strong>Немного теории</strong></p>

<ol>
	<li>Для того, чтобы выделить название месяца из даты используется функция <code><strong>MONTHNAME(дата)</strong></code>, которая возвращает название месяца на английском языке для указанной даты. Например, <code><strong>MONTHNAME('2020-04-12')='April'</strong></code>.</li>
	<li>Если группировка осуществляется по вычисляемому столбцу (в данном случае «вычисляется» название месяца), то после <code>GROUP BY</code>можно указать как вычисляемое выражение, так и имя столбца, заданное с помощью <code>AS</code>. Важно отметить, что последний вариант (указать имя столбца)  нарушает стандарт по порядку выполнения запросов, но иногда может встречаться на реальных платформах.</li>
</ol>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+----------+------------+
| Месяц    | Количество |
+----------+------------+
| February | 4          |
| January  | 4          |
| June     | 3          |
| May      | 3          |
| April    | 2          |
| July     | 2          |
| March    | 2          |
+----------+------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</li>
	<li><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>trip</strong></code></strong></summary>

<pre><code>+---------+---------------+-----------------+----------+------------+------------+
| trip_id | name          | city            | per_diem | date_first | date_last  |
+---------+---------------+-----------------+----------+------------+------------+
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |
+---------+---------------+-----------------+----------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT MONTHNAME(date_first) AS Месяц, COUNT(MONTHNAME(date_first)) AS Количество
FROM trip
GROUP BY Месяц
ORDER BY Количество DESC, Месяц ASC;

</code></pre><h2>Задание</h2>

<p>Удалить из таблицы <code><strong>fine</strong></code> информацию о нарушениях, совершенных раньше 1 февраля 2020 года. </p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 4

Query result (это выборка из таблицы fine после удаления записей):
+---------------+--------+------------------------------+----------+----------------+--------------+
| name          | number | violation                    | sum_fine | date_violation | date_payment |
|               | _plate |                              |          |                |              |
+---------------+--------+------------------------------+----------+----------------+--------------+
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 2000.00  | 2020-02-14     | 2020-03-05   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 2000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 500.00   | 2020-03-03     | 2020-03-22   |
+---------------+--------+------------------------------+----------+----------------+--------------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/305012/step/9?unit=287020" rel="noopener noreferrer nofollow">удаление строк из таблицы</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>fine</strong></code> (без ключевого столбца) перед выполнением этого шага</strong></summary>

<pre><code class="language-sql">+---------------+--------+------------------------------+----------+----------------+--------------+
| name          | number | violation                    | sum_fine | date_violation | date_payment |
|               | _plate |                              |          |                |              |
+---------------+--------+------------------------------+----------+----------------+--------------+
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 250.00   | 2020-01-12     | 2020-01-22   |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 2000.00  | 2020-02-14     | 2020-03-05   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 2000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 500.00   | 2020-03-03     | 2020-03-22   |
+---------------+--------+------------------------------+----------+----------------+--------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">DELETE FROM fine
WHERE date_violation < '2020-02-01';


</code></pre><h2>Действия при удалении записи главной таблицы</h2>

<p>С помощью выражения<strong> </strong><code>ON DELETE</code> можно установить действия, которые выполняются для записей подчиненной таблицы при удалении связанной строки из главной таблицы. При удалении можно установить следующие опции:</p>

<ul>
	<li><code>CASCADE</code>: автоматически удаляет строки из зависимой таблицы при удалении  связанных строк в главной таблице.</li>
	<li><code>SET NULL</code>: при удалении  связанной строки из главной таблицы устанавливает для столбца внешнего ключа значение <strong><code>NULL</code></strong>. (В этом случае столбец внешнего ключа должен поддерживать установку<code><strong> NULL</strong></code>).</li>
	<li><code>SET DEFAULT</code> похоже на <code>SET NULL</code> за тем исключением, что значение  внешнего ключа устанавливается не в <code>NULL,</code> а в значение по умолчанию для данного столбца.</li>
	<li><code>RESTRICT</code>: отклоняет удаление строк в главной таблице при наличии связанных строк в зависимой таблице.</li>
</ul>

<p><strong>Важно! </strong>Если для столбца установлена опция <code>SET NULL</code>, то при его описании нельзя задать ограничение на пустое значение.</p>

<p><strong>Пример</strong></p>

<p>Будем считать, что при удалении автора из таблицы <code><strong>author</strong></code>, необходимо удалить все записи о книгах из таблицы <code><strong>book</strong></code>, написанные этим автором. Данное действие необходимо прописать при создании таблицы.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">CREATE TABLE book (
    book_id INT PRIMARY KEY AUTO_INCREMENT, 
    title VARCHAR(50), 
    author_id INT NOT NULL, 
    price DECIMAL(8,2), 
    amount INT, 
    FOREIGN KEY (author_id)  REFERENCES author (author_id) ON DELETE CASCADE
);</code></pre>

<h2>Задание</h2>

<p>Создать таблицу <code><strong>book</strong></code> той же структуры, что и на предыдущем шаге. Будем считать, что при удалении автора из таблицы <code><strong>author</strong></code>, должны удаляться все записи о книгах из таблицы <code><strong>book</strong></code>, написанные этим автором. А при удалении жанра из таблицы <code><strong>genre</strong></code> для соответствующей записи <code><strong>book</strong></code> установить значение <code><strong>Null </strong></code>в столбце <code><strong>genre_id</strong></code>. </p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 0</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE book (
book_id INT PRIMARY KEY AUTO_INCREMENT,
title VARCHAR(50),
author_id INT NOT NULL,
genre_id INT,
price DECIMAL(8, 2),
amount INT,
FOREIGN KEY (author_id) REFERENCES author (author_id) ON DELETE CASCADE,
FOREIGN KEY (genre_id) REFERENCES genre (genre_id) ON DELETE SET NULL);


</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов корректировки данных для таблиц <code><strong>book</strong></code>,  <code><strong>author</strong></code>, <code><strong>genre</strong></code> и <code><span style="color: #000000;"><strong>supply</strong></span></code> . Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно использовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p>В последнем модуле создан отдельный урок, в котором мы разместим запросы, набравшие наибольшее количество лайков. </p>

<p><strong>Структура и наполнение таблиц:</strong></p>

<p>Таблица<code><strong> genre</strong></code>:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>genre_id</strong></td>
			<td><strong>name_genre</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Роман</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Поэзия</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Приключения</td>
		</tr>
	</tbody>
</table>

<p>Таблица<code><strong>author</strong></code>:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>author_id</strong></td>
			<td><strong>name_author</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Булгаков М.А.</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Достоевский Ф.М.</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Есенин С.А.</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Пастернак Б.Л.</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Лермонтов М.Ю.</td>
		</tr>
	</tbody>
</table>

<p>Таблица <code><strong>book</strong></code>:</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author_id</strong></td>
			<td><strong>genre_id</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Мастер и Маргарита</td>
			<td>1</td>
			<td>1</td>
			<td>670.99</td>
			<td>3</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Белая гвардия</td>
			<td>1</td>
			<td>1</td>
			<td>540.50</td>
			<td>5</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Идиот</td>
			<td>2</td>
			<td>1</td>
			<td>460.00</td>
			<td>10</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Братья Карамазовы</td>
			<td>2</td>
			<td>1</td>
			<td>799.01</td>
			<td>3</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Игрок</td>
			<td>2</td>
			<td>1</td>
			<td>480.50</td>
			<td>10</td>
		</tr>
		<tr>
			<td>6</td>
			<td>Стихотворения и поэмы</td>
			<td>3</td>
			<td>2</td>
			<td>650.00</td>
			<td>15</td>
		</tr>
		<tr>
			<td>7</td>
			<td>Черный человек</td>
			<td>3</td>
			<td>2</td>
			<td>570.20</td>
			<td>6</td>
		</tr>
		<tr>
			<td>8</td>
			<td>Лирика</td>
			<td>4</td>
			<td>2</td>
			<td>518.99</td>
			<td>2</td>
		</tr>
	</tbody>
</table>

<p>Таблица <strong><code>supply</code></strong>:</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>supply_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Доктор Живаго</td>
			<td>Пастернак Б.Л.</td>
			<td>380.80</td>
			<td>4</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Черный человек </td>
			<td>Есенин С.А.</td>
			<td>570.20</td>
			<td>6</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Белая гвардия</td>
			<td>Булгаков М.А.</td>
			<td>540.50</td>
			<td>7</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Идиот</td>
			<td>Достоевский Ф.М.</td>
			<td>360.80</td>
			<td>3</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Стихотворения и поэмы</td>
			<td>Лермонтов М.Ю.</td>
			<td>255.90</td>
			<td>4</td>
		</tr>
		<tr>
			<td>6</td>
			<td>Остров сокровищ</td>
			<td>Стивенсон Р.Л.</td>
			<td>599.99</td>
			<td>5</td>
		</tr>
	</tbody>
</table> <br><hr><br> <pre><code class="hljs language-sql">DELETE FROM author
USING author INNER JOIN book ON author.author_id = book.author_id
WHERE title NOT LIKE '% %';
</code></pre><h2>Задание</h2>

<p>Вывести информацию о каждом заказе: его номер, кто его сформировал (фамилия пользователя) и его стоимость (сумма произведений количества заказанных книг и их цены), в отсортированном по номеру заказа виде. Последний столбец назвать <code><strong>Стоимость</strong></code>.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/cce071e8-3a35-4642-8fff-460f0899e4eb/">​</p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a></u>;</li>
	<li>групповые функции(<u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297515/step/5?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Вывести информацию о каждом заказе: его номер, кто его сформировал (фамилия пользователя) и его стоимость (сумма произведений количества заказанных книг и их цены), в отсортированном по номеру заказа виде. Последний столбец назвать <code><strong>Стоимость</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------+----------------+-----------+
| buy_id | name_client    | Стоимость |
+--------+----------------+-----------+
| 1      | Баранов Павел  | 2271.39   |
| 2      | Семенонов Иван | 1037.98   |
| 3      | Абрамова Катя  | 2131.49   |
| 4      | Баранов Павел  | 480.50    |
+--------+----------------+-----------+</code></pre>
</details>
<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT buy.buy_id, name_client, SUM(book.price * buy_book.amount) AS Стоимость
FROM client INNER JOIN buy ON client.client_id = buy.client_id INNER JOIN buy_book ON buy.buy_id = buy_book.buy_id INNER JOIN book ON buy_book.book_id = book.book_id
GROUP BY buy.buy_id
ORDER BY buy.buy_id ASC;

</code></pre><h2>Задание</h2>

<p>В таблицу <code><strong>buy_step</strong></code> занести дату 12.04.2020 выставления счета на оплату заказа с номером 5.</p>

<p>Правильнее было бы занести не конкретную, а текущую дату. Это можно сделать с помощью функции <code><strong>Now()</strong></code>. Но при этом в разные дни будут вставляться разная дата, и задание нельзя будет проверить, поэтому  вставим дату 12.04.2020.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/82bcc6a0-9bef-4202-acdf-fed95bdeab67/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Для просмотра данных из таблицы <code><strong>buy_step</strong></code> выбраны не все  записи, а только те, которые относятся к заказу с номером 5.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/8?unit=287020" rel="noopener noreferrer nofollow">обновление данных</a>;</u></li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>).</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>В таблицу <code><strong>buy_step</strong></code> занести дату 12.04.2020 выставления счета на оплату заказа с номером 5.</p>

<p>Правильнее было бы занести не конкретную, а текущую дату. Это можно сделать с помощью функции <code><strong>Now()</strong></code>. Но при этом в разные дни будут вставляться разная дата, и задание нельзя будет проверить, поэтому  вставим дату 12.04.2020.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1

Query result (выборка из таблицы buy_step для заказа с номером 5):
+-------------+--------+---------+---------------+---------------+
| buy_step_id | buy_id | step_id | date_step_beg | date_step_end |
+-------------+--------+---------+---------------+---------------+
| 17          | 5      | 1       | 2020-04-12    | NULL          |
| 18          | 5      | 2       | NULL          | NULL          |
| 19          | 5      | 3       | NULL          | NULL          |
| 20          | 5      | 4       | NULL          | NULL          |
+-------------+--------+---------+---------------+---------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц(перед выполнением шага)</strong></summary> <img alt="" height="934" name="118.png" src="https://ucarecdn.com/bb65b80f-6633-4d29-8d59-53172961a26b/" width="708"></details> <br><hr><br> <pre><code class="hljs language-sql">UPDATE buy_step
SET date_step_beg = '2020-04-12'
WHERE buy_id = 5 AND step_id = 1;

</code></pre><h2>Задание</h2>

<p>Вывести образовательные программы, на которые для поступления необходимы предмет «Информатика» и «Математика» в отсортированном по названию программ виде.</p>

<p><strong>Логическая схемы базы данных (чтобы потренироваться выбирать таблицы для запроса):</strong></p>

<p><img alt="" src="https://ucarecdn.com/98c706e5-0118-4fa9-ae09-4a934ece5bc8/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Сначала отберите все  программы, для которых определены <strong>Математика </strong>или <strong>Информатика</strong>, а потом, сгруппировав результат, отберите те программы, у которых количество отобранных дисциплин ровно две.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297515/step/7?unit=279275" rel="noopener noreferrer nofollow">условие отбора в запросах группировки</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Вывести образовательные программы, на которые для поступления необходимы предмет «Информатика» и «Математика» в отсортированном по названию программ виде.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------------------------------------+
| name_program                        |
+-------------------------------------+
| Математика и компьютерные науки     |
| Прикладная математика и информатика |
+-------------------------------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц </strong></summary>

<pre><code class="language-sql">таблица department
+---------------+-------------------------+
| department_id | name_department         |
+---------------+-------------------------+
| 1             | Инженерная школа        |
| 2             | Школа естественных наук |
+---------------+-------------------------+
таблица program
+------------+-------------------------------------+---------------+------+
| program_id | name_program                        | department_id | plan |
+------------+-------------------------------------+---------------+------+
| 1          | Прикладная математика и информатика | 2             | 1    |
| 2          | Математика и компьютерные науки     | 2             | 2    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |
+------------+-------------------------------------+---------------+------+
таблица enrollee
+-------------+-----------------+
| enrollee_id | name_enrollee   |
+-------------+-----------------+
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |
+-------------+-----------------+
таблица subject
+------------+--------------+
| subject_id | name_subject |
+------------+--------------+
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |
+------------+--------------+
таблица program_subject
+--------------------+------------+------------+------------+
| program_subject_id | program_id | subject_id | min_result |
+--------------------+------------+------------+------------+
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |
+--------------------+------------+------------+------------+
таблица program_enrollee
+---------------------+------------+-------------+
| program_enrollee_id | program_id | enrollee_id |
+---------------------+------------+-------------+
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |
+---------------------+------------+-------------+
таблица enrollee_subject
+---------------------+-------------+------------+--------+
| enrollee_subject_id | enrollee_id | subject_id | result |
+---------------------+-------------+------------+--------+
| 1                   | 1           | 1          | 68     |
| 2                   | 1           | 2          | 70     |
| 3                   | 1           | 3          | 41     |
| 4                   | 1           | 4          | 75     |
| 5                   | 2           | 1          | 75     |
| 6                   | 2           | 2          | 70     |
| 7                   | 2           | 4          | 81     |
| 8                   | 3           | 1          | 85     |
| 9                   | 3           | 2          | 67     |
| 10                  | 3           | 3          | 90     |
| 11                  | 3           | 4          | 78     |
| 12                  | 4           | 1          | 82     |
| 13                  | 4           | 2          | 86     |
| 14                  | 4           | 3          | 70     |
| 15                  | 5           | 1          | 65     |
| 16                  | 5           | 2          | 67     |
| 17                  | 5           | 3          | 60     |
| 18                  | 6           | 1          | 90     |
| 19                  | 6           | 2          | 92     |
| 20                  | 6           | 3          | 88     |
| 21                  | 6           | 4          | 94     |
+---------------------+-------------+------------+--------+
таблица achievement
+----------------+-----------------------+-------+
| achievement_id | name_achievement      | bonus |
+----------------+-----------------------+-------+
| 1              | Золотая медаль        | 5     |
| 2              | Серебряная медаль     | 3     |
| 3              | Золотой значок ГТО    | 3     |
| 4              | Серебряный значок ГТО | 1     |
+----------------+-----------------------+-------+
таблица enrollee_achievement
+--------------------+-------------+----------------+
| enrollee_achiev_id | enrollee_id | achievement_id |
+--------------------+-------------+----------------+
| 1                  | 1           | 2              |
| 2                  | 1           | 3              |
| 3                  | 3           | 1              |
| 4                  | 4           | 4              |
| 5                  | 5           | 1              |
| 6                  | 5           | 3              |
+--------------------+-------------+----------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_program
FROM program p
INNER JOIN program_subject ps ON p.program_id = ps.program_id
INNER JOIN subject s ON ps.subject_id = s.subject_id
WHERE name_subject in ('Информатика', 'Математика')
GROUP BY name_program
HAVING count(name_program)=2</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов корректировки данных для предметной области «Абитуриент» (в таблицы занесены данные, как на предыдущем шаге, таблица <code><strong>student</strong></code><strong> </strong>создана). Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно реализовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p> <br><hr><br> <pre><code class="hljs language-sql">

SELECT * FROM applicant_order;




</code></pre><h2>Задание</h2>

<p>Посчитать результаты тестирования. Результат попытки вычислить как количество правильных ответов, деленное на 3 (количество вопросов в каждой попытке) и умноженное на 100. Результат округлить до двух знаков после запятой. Вывести фамилию студента, название предмета, дату и результат. Последний столбец назвать <code><strong>Результат</strong></code>. Информацию отсортировать сначала по фамилии студента, потом по убыванию даты попытки.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>В запрос не рекомендуется включать таблицу <code><strong>question</strong></code>, нужно связать<code><strong> answer</strong></code> непосредственно с <code><strong>testing. </strong></code>Если же в этом запросе использовать связь <code><strong>testing - question - answer</strong></code> и считать верные ответы, то получится, что считаются ВЕРНЫЕ ответы на вопросы, занесенные в таблицу <code><strong>question</strong></code>, а не верные ответы, которые дал пользователь.</p>
</details>

<p><strong>Логическая схема базы данных (чтобы потренироваться выбирать нужные таблицы):</strong></p>

<p><img alt="" src="https://ucarecdn.com/e4669333-8898-434f-b1a5-4fa88b39ae02/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) </p>

<blockquote>
<p>Посчитать результаты тестирования. Результат попытки вычислить как количество правильных ответов, деленное на 3 (количество вопросов в каждой попытке) и умноженное на 100. Результат округлить до двух знаков после запятой. Вывести фамилию студента, название предмета, дату и результат. Последний столбец назвать <code><strong>Результат</strong></code>. Информацию отсортировать сначала по фамилии студента, потом по убыванию даты попытки.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------+-------------------+--------------+-----------+
| name_student    | name_subject      | date_attempt | Результат |
+-----------------+-------------------+--------------+-----------+
| Баранов Павел   | Основы SQL        | 2020-04-15   | 33.33     |
| Баранов Павел   | Основы баз данных | 2020-03-23   | 66.67     |
| Семенов Иван    | Основы SQL        | 2020-05-17   | 33.33     |
| Семенов Иван    | Основы SQL        | 2020-04-15   | 66.67     |
| Семенов Иван    | Основы SQL        | 2020-03-23   | 100.00    |
| Яковлева Галина | Основы баз данных | 2020-04-21   | 100.00    |
| Яковлева Галина | Основы баз данных | 2020-03-26   | 0.00      |
+-----------------+-------------------+--------------+-----------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц</strong></summary>

<pre><code class="language-sql">таблица student                   таблица subject
+------------+-----------------+  +------------+-------------------+
| student_id | name_student    |  | subject_id | name_subject      |
+------------+-----------------+  +------------+-------------------+
| 1          | Баранов Павел   |  | 1          | Основы SQL        |
| 2          | Абрамова Катя   |  | 2          | Основы баз данных |
| 3          | Семенов Иван    |  | 3          | Физика            |
| 4          | Яковлева Галина |  +------------+-------------------+
+------------+-----------------+

таблица question
+-------------+------------------------------------------------------------+------------+
| question_id | name_question                                              | subject_id |
+-------------+------------------------------------------------------------+------------+
| 1           | Запрос на выборку начинается с ключевого слова:            | 1          |
| 2           | Условие, по которому отбираются записи, задается после...  | 1          |
| 3           | Для сортировки используется:                               | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:       | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:   | 1          |
| 6           | База данных - это:                                         | 2          |
| 7           | Отношение - это:                                           | 2          |
| 8           | Концептуальная модель используется для                     | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?        | 2          |
+-------------+------------------------------------------------------------+------------+
таблица answer
+-----------+--------------------------------------------------------+-------------+------------+
| answer_id | name_answer                                            | question_id | is_correct |
+-----------+--------------------------------------------------------+-------------+------------+
| 1         | UPDATE                                                 | 1           | 0          |
| 2         | SELECT                                                 | 1           | 1          |
| 3         | INSERT                                                 | 1           | 0          |
| 4         | GROUP BY                                               | 2           | 0          |
| 5         | FROM                                                   | 2           | 0          |
| 6         | WHERE                                                  | 2           | 1          |
| 7         | SELECT                                                 | 2           | 0          |
| 8         | SORT                                                   | 3           | 0          |
| 9         | ORDER BY                                               | 3           | 1          |
| 10        | RANG BY                                                | 3           | 0          |
| 11        | SELECT * FROM student                                  | 4           | 1          |
| 12        | SELECT student                                         | 4           | 0          |
| 13        | INNER JOIN                                             | 5           | 1          |
| 14        | LEFT JOIN                                              | 5           | 0          |
| 15        | RIGHT JOIN                                             | 5           | 0          |
| 16        | CROSS JOIN                                             | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным...  | 6           | 1          |
| 18        | совокупность программ для хранения иобработки ...      | 6           | 0          |
| 19        | строка                                                 | 7           | 0          |
| 20        | столбец                                                | 7           | 0          |
| 21        | таблица                                                | 7           | 1          |
| 22        | обобщенное представление пользователей о данных        | 8           | 1          |
| 23        | описание представления данных в памяти компьютера      | 8           | 0          |
| 24        | база данных                                            | 8           | 0          |
| 25        | file                                                   | 9           | 1          |
| 26        | INT                                                    | 9           | 0          |
| 27        | VARCHAR                                                | 9           | 0          |
| 28        | DATE                                                   | 9           | 0          |
+-----------+--------------------------------------------------------+-------------+------------+
таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
таблица testing
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
+------------+------------+-------------+-----------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_student, name_subject, date_attempt, ROUND((SUM(If(is_correct, 1, 0)) / 3 * 100), 2) AS Результат
FROM student 
INNER JOIN attempt ON student.student_id = attempt.student_id
INNER JOIN subject ON subject.subject_id = attempt.subject_id
INNER JOIN testing ON testing.attempt_id = attempt.attempt_id
INNER JOIN answer ON answer.answer_id = testing.answer_id

GROUP BY name_student, name_subject, attempt.attempt_id
ORDER BY name_student, date_attempt DESC

</code></pre><h2>Операция соединение, использование USING()</h2>

<p><em>Данный шаг добавлен по предложениям пользователей </em>(<a href="https://stepik.org/users/60542727" rel="noopener noreferrer nofollow" title="Показать профиль пользователя">Валерий Родькин</a>, <a href="https://stepik.org/users/33149099" rel="noopener noreferrer nofollow">Todor Illia</a>  и другие)<em>.</em></p>

<p>При описании соединения таблиц с помощью <code><strong>JOIN</strong></code> в некоторых случаях вместо <strong><code>ON</code> </strong>и следующего за ним условия можно использовать оператор<strong> <code>USING()</code></strong>.</p>

<p><code><strong>USING</strong></code> позволяет указать набор столбцов, которые есть в обеих объединяемых таблицах. Если база данных хорошо спроектирована, а каждый внешний ключ имеет такое же имя, как и соответствующий первичный ключ (например, <code><strong>genre.genre_id = book.genre_id</strong></code>), тогда можно использовать предложение<strong> <code>USING</code></strong> для реализации операции <code><strong>JOIN</strong></code>. </p>

<p>При этом после <strong><code>SELECT</code></strong>,<strong> </strong>при использовании столбцов из <code><strong>USING()</strong></code>, необязательно указывать, из какой именно таблицы берется столбец.</p>

<p><strong>Пример</strong></p>

<p>Вывести название книг, фамилии и <code><strong>id</strong></code> их авторов.</p>

<p><em>Запрос:</em></p>

<p>Вариант с <code><strong>ON</strong></code></p>

<pre><code class="language-sql">SELECT title, name_author, author.author_id /* явно указать таблицу - обязательно */
FROM 
    author INNER JOIN book
    ON author.author_id = book.author_id;</code></pre>

<p>Вариант с <code><strong>USING</strong></code></p>

<pre><code class="language-sql">SELECT title, name_author, author_id /* имя таблицы, из которой берется author_id, указывать не обязательно*/
FROM 
    author INNER JOIN book
    USING(author_id);</code></pre>

<p><em>Результат (одинаковый для обоих запросов):</em></p>

<pre><code class="language-sql">+-----------------------+------------------+-----------+
| title                 | name_author      | author_id |
+-----------------------+------------------+-----------+
| Мастер и Маргарита    | Булгаков М.А.    | 1         |
| Белая гвардия         | Булгаков М.А.    | 1         |
| Идиот                 | Достоевский Ф.М. | 2         |
| Братья Карамазовы     | Достоевский Ф.М. | 2         |
| Игрок                 | Достоевский Ф.М. | 2         |
| Стихотворения и поэмы | Есенин С.А.      | 3         |
| Черный человек        | Есенин С.А.      | 3         |
| Лирика                | Пастернак Б.Л.   | 4         |
+-----------------------+------------------+-----------+</code></pre>

<p>Запись условия соединения с <strong><code>ON</code> </strong>является более общим случаем, так как</p>

<ul>
	<li>позволяет задавать соединение не только по одноименным полям;</li>
	<li>позволяет использовать произвольное условие на соединение таблиц, при этом в условие может включаться произвольное выражение, например, можно указать связь двух таблиц по двум и более столбцам.</li>
</ul>

<p><strong>Пример</strong></p>

<p>В таблице <strong>supply </strong>занесена информация о книгах, поступивших на склад.</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>supply_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Доктор Живаго</td>
			<td>Пастернак Б.Л.</td>
			<td>618.99</td>
			<td>3</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Черный человек </td>
			<td>Есенин С.А.</td>
			<td>570.20</td>
			<td>6</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Евгений Онегин</td>
			<td>Пушкин А.С.</td>
			<td>440.80</td>
			<td>5</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Идиот</td>
			<td>Достоевский Ф.М.</td>
			<td>360.80</td>
			<td>3</td>
		</tr>
	</tbody>
</table>

<p>Если в таблицах <code><strong>supply</strong></code>  и <code><strong>book</strong></code> есть одинаковые книги,  вывести их название и автора. При этом учесть, что у нескольких авторов могут быть книги с одинаковым названием.</p>

<p><strong>Важно. </strong>В данном примере для соединения <code><strong>book</strong></code> и <code><strong>supply</strong></code> использовать <code><strong>USING</strong></code> нельзя, так как: </p>

<ul>
	<li>в таблице <code><strong>book</strong></code> фамилий авторов вообще нет (их необходимо получить из таблицы<strong> <code>author</code></strong>, столбец<strong> <code>name_author</code></strong>),  а в таблице <code><strong>supply</strong></code> фамилии занесены в столбец <code><strong>author</strong></code>;</li>
	<li>для однозначной идентификации книги нужно указать, что совпадают не только названия, но и авторы книг.</li>
</ul>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT book.title, name_author
FROM 
    author 
    INNER JOIN book USING (author_id)   
    INNER JOIN supply ON book.title = supply.title 
                         and author.name_author = supply.author;
</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+----------------+------------------+
| title          | name_author      |
+----------------+------------------+
| Идиот          | Достоевский Ф.М. |
| Черный человек | Есенин С.А.      |
+----------------+------------------+</code></pre>

<ul>
</ul>

<h2>Задание</h2>

<p>Если в таблицах <code><strong>supply</strong></code>  и <code><strong>book</strong></code> есть одинаковые книги, которые имеют равную цену,  вывести их название и автора, а также посчитать общее количество экземпляров книг в таблицах <code><strong>supply</strong></code> и <code><strong>book</strong></code>,  столбцы назвать <strong><code>Название</code>, <code>Автор</code></strong>  и <strong><code>Количество</code>.</strong></p>

<p><strong>Схема данных:</strong></p>

<p> </p>

<p><img alt="" src="https://ucarecdn.com/6de130b3-aac2-4216-82bb-7421c2a614ad/"></p>

<p><em><strong>Текст задания (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p> Если в таблицах <code><strong>supply</strong></code>  и <code><strong>book</strong></code> есть одинаковые книги, которые имеют равную цену,  вывести их название и автора, а также посчитать общее количество экземпляров книг в таблицах <code><strong>supply</strong></code> и <code><strong>book</strong></code>,  столбцы назвать <strong><code>Название</code>, <code>Автор</code></strong>  и <strong><code>Количество</code>.</strong></p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+----------------+-------------+------------+
| Название       | Автор       | Количество |
+----------------+-------------+------------+
| Черный человек | Есенин С.А. | 12         |
+----------------+-------------+------------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблиц</strong></summary>

<pre><code class="language-sql">Таблица supply:
+-----------+----------------+------------------+--------+--------+
| supply_id | title          | author           | price  | amount |
+-----------+----------------+------------------+--------+--------+
| 1         | Доктор Живаго  | Пастернак Б.Л.   | 618.99 | 3      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Евгений Онегин | Пушкин А.С.      | 440.80 | 5      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |
+-----------+----------------+------------------+--------+--------+

Таблица author:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
+-----------+------------------+

Таблица book:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT book.title AS Название, name_author AS Автор, (book.amount + supply.amount) AS Количество
FROM author INNER JOIN book USING(author_id) INNER JOIN supply ON book.title = supply.title AND author.name_author = supply.author
WHERE book.price = supply.price;


</code></pre><h2>Задание</h2>

<p>Посчитать среднее время, за которое пользователи проходят урок по следующему алгоритму:</p>

<ul>
	<li>для каждого пользователя вычислить время прохождения <strong>шага</strong> как сумму времени, потраченного на каждую попытку (время попытки - это разница между временем отправки задания и временем начала попытки), при этом попытки, которые длились больше 4 часов не учитывать, так как пользователь мог просто оставить задание открытым в браузере, а вернуться к нему на следующий день;</li>
	<li>для каждого студента посчитать общее время, которое он затратил на каждый <strong>урок</strong>;</li>
	<li>вычислить среднее время выполнения урока в часах, результат округлить до 2-х знаков после запятой;</li>
	<li>вывести информацию по возрастанию времени, пронумеровав строки, для каждого урока указать номер модуля и его позицию в нем.</li>
</ul>

<p>Столбцы результата назвать<code><strong> Номер, Урок, Среднее_время</strong></code>.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/46f3ad63-48e6-43d0-94a0-3c6b1379d124/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/310421/step/10?auth=login&amp;unit=292727" rel="noopener noreferrer nofollow">функция CONCAT()</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/404275/step/8?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">оконные функции</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/404275/step/8?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">перевод количества секунд во временной формат</a>;</u></li>
	<li>групповые функции (<u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297515/step/4?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>).</li>
</ul>
</details>

<p><em><strong>Текст задания (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p>Посчитать среднее время, за которое пользователи проходят урок по следующему алгоритму:</p>

<ul>
	<li>для каждого пользователя вычислить время прохождения <strong>шага</strong> как сумму времени, потраченного на каждую попытку (время попытки - это разница между временем отправки задания и временем начала попытки), при этом попытки, которые длились больше 4 часов не учитывать, так как пользователь мог просто оставить задание открытым в браузере, а вернуться к нему на следующий день;</li>
	<li>для каждого студента посчитать общее время, которое он затратил на каждый <strong>урок</strong>;</li>
	<li>вычислить среднее время выполнения урока в часах, результат округлить до 2-х знаков после запятой;</li>
	<li>вывести информацию по возрастанию времени, пронумеровав строки, для каждого урока указать номер модуля и его позицию в нем.</li>
</ul>

<p>Столбцы результата назвать<code><strong> Номер, Урок, Среднее_время</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------+-------------------------------------------------------------+---------------+
| Номер | Урок                                                        | Среднее_время |
+-------+-------------------------------------------------------------+---------------+
| 1     | 2.2 Запросы на выборку, соединение таблиц                   | 2.37          |
| 2     | 1.2 Выборка данных                                          | 2.65          |
| 3     | 2.4 База данных "Интернет-магазин книг", запросы на выборку | 3.65          |
+-------+-------------------------------------------------------------+---------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT ROW_NUMBER() OVER (ORDER BY ROUND(AVG(spent_l), 2) ASC) AS Номер,
CONCAT(module_id, '.', lesson_position, ' ', lesson_name) AS Урок, ROUND(AVG(spent_l), 2) AS Среднее_время
from (
    SELECT student_id, module_id, lesson.lesson_id, lesson_name, (SUM(spent_t)/3600) AS spent_l, lesson_position
    FROM lesson inner join
        (SELECT student_id, step_id, (submission_time - attempt_time) AS spent_t, lesson_id
        FROM step_student INNER JOIN step USING(step_id)
        WHERE (submission_time - attempt_time) < (60*60*4)) AS tabl 
        ON lesson.lesson_id = tabl.lesson_id
    GROUP BY student_id, lesson.lesson_id) AS tbs_2
GROUP BY lesson_id
</code></pre><h2>Задание</h2>

<p>Занесите три последние записи в таблицу<code><strong>book</strong></code>,  первая запись уже добавлена на предыдущем шаге:</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr style="background-color: #dcdcdc; background: #dcdcdc; text-align: center;">
			<td><sup><strong>INT PRIMARY KEY AUTO_INCREMENT</strong></sup></td>
			<td><sup><strong>VARCHAR(50)</strong></sup></td>
			<td><sup><strong>VARCHAR(30)</strong></sup></td>
			<td><sup><strong>DECIMAL(8,2)</strong></sup></td>
			<td><sup><strong>INT</strong></sup></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Мастер и Маргарита</td>
			<td>Булгаков М.А.</td>
			<td>670.99</td>
			<td>3</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Белая гвардия</td>
			<td>Булгаков М.А.</td>
			<td>540.50</td>
			<td>5</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Идиот</td>
			<td>Достоевский Ф.М.</td>
			<td>460.00</td>
			<td>10</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Братья Карамазовы</td>
			<td>Достоевский Ф.М.</td>
			<td>799.01</td>
			<td>2</td>
		</tr>
	</tbody>
</table>

<details><summary><strong>Пояснение </strong>- <span style="color: #ff4363;">кликните по этой строке, чтобы раскрыть пояснение</span></summary>

<p>Каждая строка вставляется отдельным SQL запросом, запросы обязательно разделять точкой с запятой. Для просмотра полученной таблицы после запросов на добавление записей вставить:</p>


<pre><code class="language-sql">SELECT * FROM book;</code></pre>
</details>
<p><em>Результат</em> : </p>

<pre><code class="language-sql">Affected rows: 1
Affected rows: 1
Affected rows: 1
Query result:
+---------+--------------------+------------------+--------+--------+
| book_id | title              | author           | price  | amount |
+---------+--------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия      | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот              | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы  | Достоевский Ф.М. | 799.01 | 2      |
+---------+--------------------+------------------+--------+--------+</code></pre> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO book (title, author, price, amount)
VALUES ('Белая гвардия', 'Булгаков М.А.', 540.50, 5);

INSERT INTO book (title, author, price, amount)
VALUES ('Идиот', 'Достоевский Ф.М.', 460.00, 10);

INSERT INTO book (title, author, price, amount)
VALUES ('Братья Карамазовы', 'Достоевский Ф.М.', 799.01, 2);
</code></pre><h2>Выборка данных, операторы BETWEEN, IN</h2>

<p><strong> </strong>Логическое выражение после ключевого слова <code>WHERE</code> может включать операторы  <strong><code>BETWEEN</code></strong> и <strong><code>IN</code></strong>. Приоритет  у этих операторов такой же как у операторов сравнения, то есть они выполняются раньше, чем <code><strong>NOT</strong></code>, <code><strong>AND</strong>,</code> <code><strong>OR</strong></code>.</p>

<p>Оператор <code>BETWEEN</code> позволяет отобрать данные, относящиеся к некоторому интервалу, включая его границы.</p>

<p><strong>Пример</strong></p>

<p>Выбрать названия и количества тех книг, количество которых от 5 до 14 включительно.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, amount 
FROM book
WHERE amount BETWEEN 5 AND 14;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+---------------+--------+
| title         | amount |
+---------------+--------+
| Белая гвардия | 5      |
| Идиот         | 10     |
+---------------+--------+</code></pre>

<p>Этот запрос можно реализовать по-другому, результат будет точно такой же.</p>

<pre><code class="language-sql">SELECT title, amount 
FROM book
WHERE amount &gt;= 5 AND amount &lt;=14;</code></pre>

<p>Оператор  <code>IN</code>  позволяет выбрать данные, соответствующие значениям из списка.</p>

<p><strong>Пример</strong></p>

<p>Выбрать названия и цены книг, написанных Булгаковым или Достоевским.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, price 
FROM book
WHERE author IN ('Булгаков М.А.', 'Достоевский Ф.М.');</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------------------+--------+
| title              | price  |
+--------------------+--------+
| Мастер и Маргарита | 670.99 |
| Белая гвардия      | 540.50 |
| Идиот              | 460.00 |
| Братья Карамазовы  | 799.01 |
+--------------------+--------+</code></pre>

<p>Этот запрос можно реализовать по-другому, результат будет точно такой же.</p>

<pre><code class="language-sql">SELECT title, price 
FROM book
WHERE author = 'Булгаков М.А.' OR author = 'Достоевский Ф.М.';</code></pre>

<h2>Задание</h2>

<p>Вывести название и авторов тех книг, цены которых принадлежат интервалу от 540.50 до 800 (включая границы),  а количество или 2, или 3, или 5, или 7 .</p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------------------+------------------+
| title              | author           |
+--------------------+------------------+
| Мастер и Маргарита | Булгаков М.А.    |
| Белая гвардия      | Булгаков М.А.    |
| Братья Карамазовы  | Достоевский Ф.М. |
+--------------------+------------------+</code></pre>

<details><summary><strong>Структура и наполнение таблицы <code>book</code><strong>:</strong></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, author
FROM book
WHERE (price BETWEEN 540.50 AND 800) AND amount IN (2, 3, 5, 7)




</code></pre><h2>Запросы на создание таблицы</h2>

<p>Новая таблица может быть создана на основе данных из другой таблицы. Для этого используется запрос <code>SELECT</code>, результирующая таблица которого и будет новой таблицей базы данных. При этом имена столбцов запроса становятся именами столбцов новой таблицы. Запрос на создание новой таблицы имеет вид:</p>

<pre><code class="language-sql">CREATE TABLE имя_таблицы AS
SELECT ...</code></pre>

<p><strong>Пример</strong></p>

<p>Создать таблицу заказ (<code><strong>ordering</strong></code>), куда включить авторов и названия тех книг, количество экземпляров которых в таблице <code><strong>book</strong></code> меньше 4. Для всех книг указать одинаковое количество экземпляров 5.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">CREATE TABLE ordering AS
SELECT author, title, 5 AS amount
FROM book
WHERE amount &lt; 4;

SELECT * FROM ordering;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 2
Query result:
+------------------+--------------------+--------+
| author           | title              | amount |
+------------------+--------------------+--------+
| Булгаков М.А.    | Мастер и Маргарита | 5      |
| Достоевский Ф.М. | Братья Карамазовы  | 5      |
+------------------+--------------------+--------+</code></pre>

<p>При создании таблицы можно использовать вложенные запросы как после <code>SELECT</code>, так и после <code>WHERE</code>.</p>

<p><strong>Пример</strong></p>

<p>Создать таблицу заказ (<code><strong>ordering</strong></code>), куда включить авторов и названия тех книг, количество экземпляров которых в таблице <code><strong>book</strong></code> меньше 4. Для всех книг указать одинаковое значение - среднее количество экземпляров книг в таблице <code><strong>book</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">CREATE TABLE ordering AS
SELECT author, title, 
   (
    SELECT ROUND(AVG(amount)) 
    FROM book
   ) AS amount
FROM book
WHERE amount &lt; 4;

SELECT * FROM ordering;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">Affected rows: 2
Query result:
+------------------+--------------------+--------+
| author           | title              | amount |
+------------------+--------------------+--------+
| Булгаков М.А.    | Мастер и Маргарита | 7      |
| Достоевский Ф.М. | Братья Карамазовы  | 7      |
+------------------+--------------------+--------+</code></pre>

<h2>Задание</h2>

<p>Создать таблицу заказ (<code><strong>ordering</strong></code>), куда включить авторов и названия тех книг, количество экземпляров которых в таблице <code><strong>book</strong></code> меньше среднего количества экземпляров книг в таблице <code><strong>book</strong></code>. В таблицу включить столбец   <code><strong>amount,</strong></code> в котором для всех книг указать одинаковое значение - среднее количество экземпляров книг в таблице <code><strong>book</strong></code>.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 3
Query result:
+------------------+--------------------+--------+
| author           | title              | amount |
+------------------+--------------------+--------+
| Булгаков М.А.    | Мастер и Маргарита | 7      |
| Булгаков М.А.    | Белая гвардия      | 7      |
| Достоевский Ф.М. | Братья Карамазовы  | 7      |
+------------------+--------------------+--------+</code></pre>
</details>

<details><summary><strong>Структура и наполнение таблицы <code>book</code></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">CREATE TABLE ordering AS
SELECT author, title, (SELECT ROUND(AVG(amount), 0) FROM book) AS amount
FROM book
WHERE amount < (SELECT AVG(amount) From book);
</code></pre><h2>Задание</h2>

<p>Вывести сумму суточных (произведение количества дней командировки и размера суточных) для командировок, первый день которых пришелся на февраль или март 2020 года. Значение суточных для каждой командировки занесено в столбец <code><strong>per_diem</strong></code>. Вывести фамилию и инициалы сотрудника, город, первый день командировки и сумму суточных. Последний столбец назвать <code><strong>Сумма</strong></code>. Информацию отсортировать сначала  в алфавитном порядке по фамилиям сотрудников, а затем по убыванию суммы суточных.</p>

<details><summary><strong>Пояснение</strong></summary>

<p><strong>1. </strong>В SQL есть функции, которые позволяют выделить часть даты: день(<code><strong>DAY()</strong></code>), месяц (<code><strong>MONTH()</strong></code>), год(<code><strong>YEAR()</strong></code>) . Например:</p>

<pre><code class="language-sql">DAY('2020-02-01') = 1
MONTH('2020-02-01') = 2
YEAR('2020-02-01') = 2020</code></pre>

<p>2. Количество дней командировки вычисляется как разница между датами последнего и первого дня командировки плюс 1.</p>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------+-----------------+------------+---------+
| name          | city            | date_first | Сумма   |
+---------------+-----------------+------------+---------+
| Абрамова К.А. | Москва          | 2020-02-23 | 5600.00 |
| Баранов П.Е.  | Москва          | 2020-02-14 | 6300.00 |
| Колесов С.П.  | Новосибирск     | 2020-02-27 | 6750.00 |
| Колесов С.П.  | Москва          | 2020-02-01 | 4200.00 |
| Лебедев Т.К.  | Москва          | 2020-03-03 | 2800.00 |
| Семенов И.В.  | Санкт-Петербург | 2020-03-29 | 5600.00 |
+---------------+-----------------+------------+---------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/5?unit=279269" rel="noopener noreferrer nofollow">вычисления в SELECT</a>;</li>
	<li><a href="https://stepik.org/lesson/297510/step/6?unit=279270" rel="noopener noreferrer nofollow">вычитание дат</a>;</li>
	<li><a href="https://stepik.org/lesson/297510/step/8?unit=279270" rel="noopener noreferrer nofollow">выделение номера месяца из даты</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>trip</strong></code></strong></summary>

<pre><code>+---------+---------------+-----------------+----------+------------+------------+
| trip_id | name          | city            | per_diem | date_first | date_last  |
+---------+---------------+-----------------+----------+------------+------------+
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |
+---------+---------------+-----------------+----------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name, city, date_first, (per_diem * (DATEDIFF(date_last, date_first) + 1)) AS Сумма
FROM trip
WHERE MONTH(date_first) IN (2, 3)
ORDER BY name ASC, Сумма DESC;

</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов для таблиц <code><strong>book</strong></code>,  <code><strong>author</strong></code>, <code><strong>genre</strong></code> и <code><strong>city</strong></code>. Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно использовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p>В последнем модуле создан отдельный урок, в котором мы разместим запросы, набравшие наибольшее количество лайков. </p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/"></p>

<p><strong>Структура и наполнение таблиц:</strong></p>

<p>Таблица<code><strong> author</strong></code>:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>author_id</strong></td>
			<td><strong>name_author</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Булгаков М.А.</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Достоевский Ф.М.</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Есенин С.А.</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Пастернак Б.Л.</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Лермонтов М.Ю.</td>
		</tr>
	</tbody>
</table>

<p>Таблица<code><strong> genre</strong></code>:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>genre_id</strong></td>
			<td><strong>name_genre</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Роман</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Поэзия</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Приключения</td>
		</tr>
	</tbody>
</table>

<p>Таблица <code><strong>book</strong></code> :</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author_id</strong></td>
			<td><strong>genre_id</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Мастер и Маргарита</td>
			<td>1</td>
			<td>1</td>
			<td>670.99</td>
			<td>3</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Белая гвардия</td>
			<td>1</td>
			<td>1</td>
			<td>540.50</td>
			<td>5</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Идиот</td>
			<td>2</td>
			<td>1</td>
			<td>460.00</td>
			<td>10</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Братья Карамазовы</td>
			<td>2</td>
			<td>1</td>
			<td>799.01</td>
			<td>3</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Игрок</td>
			<td>2</td>
			<td>1</td>
			<td>480.50</td>
			<td>10</td>
		</tr>
		<tr>
			<td>6</td>
			<td>Стихотворения и поэмы</td>
			<td>3</td>
			<td>2</td>
			<td>650.00</td>
			<td>15</td>
		</tr>
		<tr>
			<td>7</td>
			<td>Черный человек</td>
			<td>3</td>
			<td>2</td>
			<td>570.20</td>
			<td>6</td>
		</tr>
		<tr>
			<td>8</td>
			<td>Лирика</td>
			<td>4</td>
			<td>2</td>
			<td>518.99</td>
			<td>2</td>
		</tr>
	</tbody>
</table>

<p>Таблица <code><strong>city</strong></code>:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>city_id</strong></td>
			<td><strong>name_city</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Москва</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Санкт-Петербург</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Владивосток</td>
		</tr>
	</tbody>
</table> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, name_author, name_genre, price, amount
FROM book INNER JOIN author ON author.author_id = book.author_id
INNER JOIN genre
ON book.genre_id = genre.genre_id
ORDER BY title ASC;

</code></pre><h2>Задание</h2>

<p>Вывести номера заказов (<code><strong>buy_id</strong></code>) и названия этапов,  на которых они в данный момент находятся. Если заказ доставлен –  информацию о нем не выводить. Информацию отсортировать по возрастанию <code><strong>buy_id</strong></code>.</p>

<details><summary><strong>Пояснение</strong></summary>

<p> Текущим  считается тот этап, для которого заполнена дата начала этапа и не заполнена дата его окончания.</p>
</details>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/0178ea29-ab37-4ce9-83ac-bd49d2636c20/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/305762/step/4?unit=287773" rel="noopener noreferrer nofollow">сравнение с пустым значением</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Вывести номера заказов (<code><strong>buy_id</strong></code>) и названия этапов, на которых они в данный момент находятся. Если заказ доставлен –  информацию о нем не выводить. Информацию отсортировать по возрастанию <code><strong>buy_id</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------+-----------------+
| buy_id | name_step       |
+--------+-----------------+
| 2      | Транспортировка |
| 3      | Доставка        |
| 4      | Оплата          |
+--------+-----------------+</code></pre>
</details>
<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT buy_id, name_step
FROM buy_step INNER JOIN step USING(step_id)
WHERE date_step_end IS null AND date_step_beg IS NOT NULL
ORDER BY buy_id ASC;

</code></pre><h2>Задание</h2>

<p>Завершить этап «<strong>Оплата</strong>» для заказа с номером 5, вставив в столбец <code><strong>date_step_end</strong></code> дату 13.04.2020, и начать следующий этап («<strong>Упаковка</strong>»), задав в столбце <code><strong>date_step_beg</strong></code> для этого этапа ту же дату.</p>

<p>Реализовать два запроса для завершения этапа и начала следующего. Они должны быть записаны в общем виде, чтобы его можно было применять для любых этапов, изменив только текущий этап. Для примера пусть это будет этап «<strong>Оплата</strong>».</p>

<p><strong>Фрагмент предметной области:</strong></p>

<p><img alt="" src="https://ucarecdn.com/38630f8f-d5ae-4284-8133-bee549683afc/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>В таблицу <code><strong>step</strong></code> все необходимые этапы занесены последовательно. Если текущий этап «Оплата», его <code><strong>id</strong></code> 1, то у следующего этапа «Упаковка» <code><strong>id</strong></code> будет на единицу больше, то есть 2. Поэтому в условии отбора запроса, который обновляет дату начала следующего этапа, можно использовать вложенный запрос, который выбирает <code><strong>id</strong></code> этапа на 1 больше, чем у текущего:</p>

<pre><code class="language-sql">SELECT step_id + 1 
FROM step
WHERE name_step = 'Оплата'</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/305012/step/8?unit=287020" rel="noopener noreferrer nofollow">обновление данных</a>;</u></li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297514/step/2?unit=279274" rel="noopener noreferrer nofollow">вложенные запросы в условии отбора</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Завершить этап «Оплата» для заказа с номером 5, вставив в столбец <code><strong>date_step_end</strong></code> дату 13.04.2020, и начать следующий этап («Упаковка»), задав в столбце <code><strong>date_step_beg</strong></code> для этого этапа ту же дату.</p>

<p>Реализовать два запроса для завершения этапа и начале следующего. Они должны быть записаны в общем виде, чтобы его можно было применять для любых этапов, изменив только текущий этап. Для примера пусть это будет этап «<strong>Оплата</strong>».</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1

Affected rows: 1

Query result (выборка из таблицы buy_step для заказа с номером 5):
+-------------+--------+---------+---------------+---------------+
| buy_step_id | buy_id | step_id | date_step_beg | date_step_end |
+-------------+--------+---------+---------------+---------------+
| 17          | 5      | 1       | 2020-04-12    | 2020-04-13    |
| 18          | 5      | 2       | 2020-04-13    | NULL          |
| 20          | 5      | 4       | NULL          | NULL          |
+-------------+--------+---------+---------------+---------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц(перед выполнением шага)</strong></summary> <img alt="" height="934" name="119.png" src="https://ucarecdn.com/e1135b6e-3815-43ae-bcc8-467d1d8bc92a/" width="708"></details> <br><hr><br> <pre><code class="hljs language-sql">update buy_step
set date_step_end='2020-04-13'
where buy_id=5 and step_id=1;

update buy_step
set date_step_beg='2020-04-13'
where buy_id=5 and step_id=2;



</code></pre><h2>Задание</h2>

<p>Посчитать количество баллов каждого абитуриента на каждую образовательную программу, на которую он подал заявление, по результатам ЕГЭ. В результат включить название образовательной программы, фамилию и имя абитуриента, а также столбец с суммой баллов, который назвать <code><strong>itog</strong></code>. Информацию вывести в отсортированном сначала по образовательной программе, а потом по убыванию суммы баллов виде.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/4f7e6cd2-4d21-46a0-b7ba-52132f8c1fb8/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>При описании соединения таблиц можно использовать схему <code><strong>enrollee</strong></code><strong> </strong>→<code><strong>program_enrollee</strong></code>→<code><strong>program</strong></code><strong> </strong>→<code><strong>program_subject</strong></code><strong> </strong>→<code><strong>subject</strong></code><strong> </strong>→<code><strong>enrollee_subject</strong></code>. Следующей для соединения идет таблица <code><strong>enrollee</strong></code><strong> </strong>, но она уже в списке есть. Поэтому для последнего соединения <code><strong>subject</strong></code><strong> </strong>→<code><strong>enrollee_subject</strong></code><strong> </strong>нужно использовать дополнительное условие связи между <code><strong>enrollee_subject</strong></code><strong> </strong>и<strong> <code>enrollee</code></strong>:</p>

<pre><code class="language-sql">subject.subject_id = enrollee_subject.subject_id 
and enrollee_subject.enrollee_id = enrollee.enrollee_id</code></pre>

<p><strong>Важно! </strong>Можно использовать и другие способы соединения таблиц.</p>

<p><em><strong>Подробное объяснение</strong></em>, зачем нужно дополнительное условие для соединения предложила <a href="https://stepik.org/users/38611568" rel="noopener noreferrer nofollow">Lidiya Ribakova</a>:</p>

<p>Если не использовать это условие, "не сходятся данные, например, по Степанова Дарья и Семенов Иван, так как они сдали 4 ЕГЭ, а для поступления нужны только 3 предмета, то есть надо из 4 суммировать только 3. И вот как раз в таблице<code><strong> program_subject </strong></code>хранятся предметы, которые нужны на определенное направление".</p>

<p><em><strong>Объяснение</strong></em>, предложенное <a href="https://stepik.org/users/58656720" rel="noopener noreferrer nofollow">Данил Дегтерев</a>:</p>

<p>"Если мы джойним <code>enrollee_subject</code> только по <code>subject_id</code> , то мы подсоединяем результаты всех людей, у которых они есть по этому предмету."</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Посчитать количество баллов каждого абитуриента на каждую образовательную программу, на которую он подал заявление, по результатам ЕГЭ. В результат включить название образовательной программы, фамилию и имя абитуриента, а также столбец с суммой баллов, который назвать <code><strong>itog</strong></code>. Информацию вывести в отсортированном сначала по образовательной программе, а потом по убыванию суммы баллов виде.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------------------------------------+-----------------+------+
| name_program                        | name_enrollee   | itog |
+-------------------------------------+-----------------+------+
| Математика и компьютерные науки     | Степанова Дарья | 276  |
| Математика и компьютерные науки     | Семенов Иван    | 230  |
| Математика и компьютерные науки     | Абрамова Катя   | 226  |
| Мехатроника и робототехника         | Степанова Дарья | 270  |
| Мехатроника и робототехника         | Семенов Иван    | 242  |
| Мехатроника и робототехника         | Попов Илья      | 192  |
| Мехатроника и робототехника         | Баранов Павел   | 179  |
| Прикладная математика и информатика | Семенов Иван    | 230  |
| Прикладная математика и информатика | Абрамова Катя   | 226  |
| Прикладная математика и информатика | Баранов Павел   | 213  |
| Прикладная механика                 | Степанова Дарья | 270  |
| Прикладная механика                 | Яковлева Галина | 238  |
| Прикладная механика                 | Попов Илья      | 192  |
| Прикладная механика                 | Баранов Павел   | 179  |
+-------------------------------------+-----------------+------+</code></pre>
</details>
<details><summary><strong>Наполнение таблиц </strong></summary>

<pre><code class="language-sql">таблица department
+---------------+-------------------------+
| department_id | name_department         |
+---------------+-------------------------+
| 1             | Инженерная школа        |
| 2             | Школа естественных наук |
+---------------+-------------------------+
таблица program
+------------+-------------------------------------+---------------+------+
| program_id | name_program                        | department_id | plan |
+------------+-------------------------------------+---------------+------+
| 1          | Прикладная математика и информатика | 2             | 1    |
| 2          | Математика и компьютерные науки     | 2             | 2    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |
+------------+-------------------------------------+---------------+------+
таблица enrollee
+-------------+-----------------+
| enrollee_id | name_enrollee   |
+-------------+-----------------+
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |
+-------------+-----------------+
таблица subject
+------------+--------------+
| subject_id | name_subject |
+------------+--------------+
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |
+------------+--------------+
таблица program_subject
+--------------------+------------+------------+------------+
| program_subject_id | program_id | subject_id | min_result |
+--------------------+------------+------------+------------+
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |
+--------------------+------------+------------+------------+
таблица program_enrollee
+---------------------+------------+-------------+
| program_enrollee_id | program_id | enrollee_id |
+---------------------+------------+-------------+
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |
+---------------------+------------+-------------+
таблица enrollee_subject
+---------------------+-------------+------------+--------+
| enrollee_subject_id | enrollee_id | subject_id | result |
+---------------------+-------------+------------+--------+
| 1                   | 1           | 1          | 68     |
| 2                   | 1           | 2          | 70     |
| 3                   | 1           | 3          | 41     |
| 4                   | 1           | 4          | 75     |
| 5                   | 2           | 1          | 75     |
| 6                   | 2           | 2          | 70     |
| 7                   | 2           | 4          | 81     |
| 8                   | 3           | 1          | 85     |
| 9                   | 3           | 2          | 67     |
| 10                  | 3           | 3          | 90     |
| 11                  | 3           | 4          | 78     |
| 12                  | 4           | 1          | 82     |
| 13                  | 4           | 2          | 86     |
| 14                  | 4           | 3          | 70     |
| 15                  | 5           | 1          | 65     |
| 16                  | 5           | 2          | 67     |
| 17                  | 5           | 3          | 60     |
| 18                  | 6           | 1          | 90     |
| 19                  | 6           | 2          | 92     |
| 20                  | 6           | 3          | 88     |
| 21                  | 6           | 4          | 94     |
+---------------------+-------------+------------+--------+
таблица achievement
+----------------+-----------------------+-------+
| achievement_id | name_achievement      | bonus |
+----------------+-----------------------+-------+
| 1              | Золотая медаль        | 5     |
| 2              | Серебряная медаль     | 3     |
| 3              | Золотой значок ГТО    | 3     |
| 4              | Серебряный значок ГТО | 1     |
+----------------+-----------------------+-------+
таблица enrollee_achievement
+--------------------+-------------+----------------+
| enrollee_achiev_id | enrollee_id | achievement_id |
+--------------------+-------------+----------------+
| 1                  | 1           | 2              |
| 2                  | 1           | 3              |
| 3                  | 3           | 1              |
| 4                  | 4           | 4              |
| 5                  | 5           | 1              |
| 6                  | 5           | 3              |
+--------------------+-------------+----------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_program, name_enrollee, SUM(result) AS itog
FROM program INNER JOIN program_subject USING(program_id)
INNER JOIN subject USING(subject_id)
INNER JOIN program_enrollee ON program.program_id = program_enrollee.program_id

INNER JOIN enrollee ON enrollee.enrollee_id = program_enrollee.enrollee_id

INNER JOIN enrollee_subject ON subject.subject_id = enrollee_subject.subject_id  and enrollee_subject.enrollee_id = enrollee.enrollee_id

GROUP BY name_enrollee, name_program
ORDER BY name_program, itog DESC</code></pre><h2>Задание </h2>

<p>Для каждого вопроса вывести процент успешных решений, то есть отношение количества верных ответов к общему количеству ответов, значение округлить до 2-х знаков после запятой. Также вывести название предмета, к которому относится вопрос, и общее количество ответов на этот вопрос. В результат включить название дисциплины, вопросы по ней (столбец назвать <code><strong>Вопрос</strong></code>), а также два вычисляемых столбца <code><strong>Всего_ответов</strong></code> и <code><strong>Успешность</strong></code>. Информацию отсортировать сначала по названию дисциплины, потом по убыванию успешности, а потом по тексту вопроса в алфавитном порядке.</p>

<p>Поскольку тексты вопросов могут быть длинными, обрезать их 30 символов и добавить многоточие "...".</p>

<p><strong>Логическая схема базы данных (чтобы потренироваться выбирать таблицы):</strong></p>

<p><img alt="" src="https://ucarecdn.com/e4669333-8898-434f-b1a5-4fa88b39ae02/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>1. Чтобы выделить крайние левые <code><strong>n </strong></code>символов из строки используется функция <code><strong>LEFT(строка, n)</strong></code>:</p>

<pre><code class="language-sql">LEFT("abcde", 3) -&gt; "abc"</code></pre>

<p>2. Соединение строк осуществляется с помощью функции <code><strong>CONCAT(строка_1, строка_2)</strong></code>:</p>

<pre><code class="language-sql">CONCAT("ab","cd") -&gt; "abcd"</code></pre>

<p>3. Поле <code><strong>is_correct</strong></code> - имеет тип <code><strong>BOOLEAN</strong></code>. Если ответ верный (<code><strong>TRUE</strong></code>), то в нем хранится 1, если неверный (<code><strong>FALSE</strong></code>), то в нем хранится 0. Можно заметить, что суммирование этого поля (при верно установленных связях) позволит посчитать количество верных ответов.</p>

<p>4. Чтобы включить в запрос вопросы,  на которые все пользователи  ответили неверно, используйте операторы <a href="https://stepik.org/lesson/308886/step/3?unit=291012" rel="noopener noreferrer nofollow">внешнего соединения</a>. (Можно придумать и другой способ включения таких вопросов в результат).</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/3?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) </p>

<blockquote>
<p>Для каждого вопроса вывести процент успешных решений, то есть отношение количества верных ответов к общему количеству ответов, значение округлить до 2-х знаков после запятой. Также вывести название предмета, к которому относится вопрос, и общее количество ответов на этот вопрос. В результат включить название дисциплины, вопросы по ней (столбец назвать <code><strong>Вопрос</strong></code>), а также два вычисляемых столбца <code><strong>Всего_ответов</strong></code> и <code><strong>Успешность</strong></code>. Информацию отсортировать сначала по названию дисциплины, потом по убыванию успешности, а потом по тексту вопроса в алфавитном порядке.</p>

<p>Поскольку тексты вопросов могут быть длинными, обрезать их 30 символов и добавить многоточие "...".</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-------------------+-----------------------------------+---------------+------------+
| name_subject      | Вопрос                            | Всего_ответов | Успешность |
+-------------------+-----------------------------------+---------------+------------+
| Основы SQL        | Условие, по которому отбираютс... | 1             | 100.00     |
| Основы SQL        | Запрос на выборку начинается с... | 4             | 75.00      |
| Основы SQL        | Какой запрос выбирает все запи... | 3             | 66.67      |
| Основы SQL        | Для сортировки используется:...   | 2             | 50.00      |
| Основы SQL        | Для внутреннего соединения таб... | 2             | 0.00       |
| Основы баз данных | База данных - это:...             | 3             | 66.67      |
| Основы баз данных | Какой тип данных не допустим в... | 2             | 50.00      |
| Основы баз данных | Концептуальная модель использу... | 2             | 50.00      |
| Основы баз данных | Отношение - это:...               | 2             | 50.00      |
+-------------------+-----------------------------------+---------------+------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц</strong></summary>

<pre><code class="language-sql">таблица student                   таблица subject
+------------+-----------------+  +------------+-------------------+
| student_id | name_student    |  | subject_id | name_subject      |
+------------+-----------------+  +------------+-------------------+
| 1          | Баранов Павел   |  | 1          | Основы SQL        |
| 2          | Абрамова Катя   |  | 2          | Основы баз данных |
| 3          | Семенов Иван    |  | 3          | Физика            |
| 4          | Яковлева Галина |  +------------+-------------------+
+------------+-----------------+

таблица question
+-------------+------------------------------------------------------------+------------+
| question_id | name_question                                              | subject_id |
+-------------+------------------------------------------------------------+------------+
| 1           | Запрос на выборку начинается с ключевого слова:            | 1          |
| 2           | Условие, по которому отбираются записи, задается после...  | 1          |
| 3           | Для сортировки используется:                               | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:       | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:   | 1          |
| 6           | База данных - это:                                         | 2          |
| 7           | Отношение - это:                                           | 2          |
| 8           | Концептуальная модель используется для                     | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?        | 2          |
+-------------+------------------------------------------------------------+------------+
таблица answer
+-----------+--------------------------------------------------------+-------------+------------+
| answer_id | name_answer                                            | question_id | is_correct |
+-----------+--------------------------------------------------------+-------------+------------+
| 1         | UPDATE                                                 | 1           | 0          |
| 2         | SELECT                                                 | 1           | 1          |
| 3         | INSERT                                                 | 1           | 0          |
| 4         | GROUP BY                                               | 2           | 0          |
| 5         | FROM                                                   | 2           | 0          |
| 6         | WHERE                                                  | 2           | 1          |
| 7         | SELECT                                                 | 2           | 0          |
| 8         | SORT                                                   | 3           | 0          |
| 9         | ORDER BY                                               | 3           | 1          |
| 10        | RANG BY                                                | 3           | 0          |
| 11        | SELECT * FROM student                                  | 4           | 1          |
| 12        | SELECT student                                         | 4           | 0          |
| 13        | INNER JOIN                                             | 5           | 1          |
| 14        | LEFT JOIN                                              | 5           | 0          |
| 15        | RIGHT JOIN                                             | 5           | 0          |
| 16        | CROSS JOIN                                             | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным...  | 6           | 1          |
| 18        | совокупность программ для хранения иобработки ...      | 6           | 0          |
| 19        | строка                                                 | 7           | 0          |
| 20        | столбец                                                | 7           | 0          |
| 21        | таблица                                                | 7           | 1          |
| 22        | обобщенное представление пользователей о данных        | 8           | 1          |
| 23        | описание представления данных в памяти компьютера      | 8           | 0          |
| 24        | база данных                                            | 8           | 0          |
| 25        | file                                                   | 9           | 1          |
| 26        | INT                                                    | 9           | 0          |
| 27        | VARCHAR                                                | 9           | 0          |
| 28        | DATE                                                   | 9           | 0          |
+-----------+--------------------------------------------------------+-------------+------------+
таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
таблица testing
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
+------------+------------+-------------+-----------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_subject, CONCAT(LEFT(name_question, 30), '...') AS Вопрос, COUNT(is_correct) AS Всего_ответов, ROUND(SUM(is_correct) / COUNT(is_correct) * 100, 2) AS Успешность
FROM answer
INNER JOIN testing ON answer.answer_id = testing.answer_id
INNER JOIN question ON answer.question_id = question.question_id
INNER JOIN subject ON question.subject_id = subject.subject_id
GROUP BY name_subject, name_question
ORDER BY name_subject, Успешность DESC, Вопрос</code></pre><h2>Оконные функции, оператор OVER, PARTITION BY</h2>

<p>Рассмотрим оконную функцию, которая включает два раздела:</p>

<pre><code class="language-sql">название_функции(выражение) 
  OVER (
        PARTITION BY ...
        ORDER BY ... 
  )</code></pre>

<p>Такое оконное выражение позволяет выполнять одинаковые действия над всеми записями таблицы, ограниченными "окном". Столбцы, образующие окно записываются после  PARTITION BY. Окном считается совокупность записей, имеющих в столбцах, указанных после  PARTITION BY, одинаковые значения.</p>

<p>В качестве функций можно использовать те же функции, которые применялись в оконных функциях без указания окна:</p>

<p><code><strong>ROW_NUMBER() </strong></code>- просто нумерация строк внутри окна;</p>

<p><code><strong>RANK() </strong></code>- ранжирование строк внутри окна - при одинаковом значении строкам присваивается один номер, с пропуском номеров;</p>

<p><code><strong>DENSE_RANK()</strong></code> - ранжирование строк внутри окна без пропуска номеров;</p>

<p><code><strong>LAG()</strong></code> - выбирает строку внутри окна, предшествующую текущей, если таковой нет - выдается NULL;</p>

<p><code><strong>LEAD() </strong></code>- выбирает строку внутри окна, следующую за текущей, если таковой нет - выдается NULL.</p>

<p><strong>Пример</strong></p>

<p>Вычислить, <a href="https://stepik.org/lesson/404275/step/8?unit=393473" rel="noopener noreferrer nofollow">сколько шагов прошел пользователь </a>по каждому модулю. Ранжировать пользователей по убыванию результатов в каждом модуле.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/c6a428d7-dbe1-4339-baac-273cb5616865/"></p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">WITH get_rate_lesson(mod_id, stud, rate) 
AS
(
   SELECT module_id, student_name, count(DISTINCT step_id)
   FROM student INNER JOIN step_student USING(student_id)
                INNER JOIN step USING (step_id)
                INNER JOIN lesson USING (lesson_id)
   WHERE result = "correct"
   GROUP BY module_id, student_name
)
SELECT mod_id AS Модуль, stud AS Студент, rate AS Рейтинг,
    ROW_NUMBER() OVER (PARTITION BY mod_id ORDER BY  rate DESC) AS Номер,
    RANK() OVER (PARTITION BY mod_id ORDER BY  rate DESC) AS Ранг,
    DENSE_RANK() OVER (PARTITION BY mod_id ORDER BY  rate DESC) AS Рейтинг  
FROM get_rate_lesson </code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------+------------+---------+-------+------+---------+
| Модуль | Студент    | Рейтинг | Номер | Ранг | Рейтинг |
+--------+------------+---------+-------+------+---------+
| 1      | student_1  | 11      | 1     | 1    | 1       |
| 1      | student_10 | 11      | 2     | 1    | 1       |
| 1      | student_11 | 11      | 3     | 1    | 1       |
| 1      | student_12 | 11      | 4     | 1    | 1       |
| 1      | student_13 | 11      | 5     | 1    | 1       |
                        ...
| 1      | student_29 | 8       | 63    | 63   | 4       |
| 1      | student_47 | 8       | 64    | 63   | 4       |
| 2      | student_60 | 21      | 1     | 1    | 1       |
| 2      | student_15 | 19      | 2     | 2    | 2       |
                        ...
| 2      | student_56 | 9       | 23    | 22   | 7       |
| 2      | student_34 | 8       | 24    | 24   | 8       |
| 2      | student_40 | 8       | 25    | 24   | 8       |
| 2      | student_11 | 5       | 26    | 26   | 9       |
| 2      | student_48 | 5       | 27    | 26   | 9       |
| 2      | student_42 | 4       | 28    | 28   | 10      |
| 2      | student_61 | 3       | 29    | 29   | 11      |
| 2      | student_13 | 2       | 30    | 30   | 12      |
| 2      | student_26 | 2       | 31    | 30   | 12      |
+--------+------------+---------+-------+------+---------+
Affected rows: 95</code></pre>

<p>Как видно из результирующей таблицы, и нумерация, и ранжирование, и рейтинг осуществляется сначала (с 1) для каждого модуля.</p>

<p>Другой тип функций - это функции, которые используются для вычислений со значениями столбцов, входящих в окно:</p>

<pre><code class="language-sql">SUM(), MAX(), MIN(), AVG(), COUNT()</code></pre>

<p>По записи они точно соответствуют групповым функциям, при этом вычисленное значение заносится в каждую запись окна. В то время как при использовании группировки возвращается одна запись для каждой группы.</p>

<p>Как правило, эти функции используются в следующем контексте:</p>

<pre><code class="language-sql">название_функции(выражение) 
  OVER (
        PARTITION BY ...
  )</code></pre>

<p><strong>Пример</strong></p>

<p>Посчитать, сколько шагов пройдено пользователями по каждому уроку. Вывести максимальное и минимальное значение пройденных шагов по каждому модулю.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">WITH get_rate_lesson(mod_id, les, rate) 
AS
(
   SELECT module_id,CONCAT(module_id,'.', lesson_position),count(DISTINCT step_id)
   FROM step_student INNER JOIN step USING (step_id)
                     INNER JOIN lesson USING (lesson_id)
   WHERE result = "correct"
   GROUP BY module_id, 2
)
SELECT mod_id AS Модуль, les AS Урок, rate AS Пройдено_шагов, 
    MAX(rate) OVER (PARTITION BY mod_id) AS Максимум_по_модулю,
    MIN(rate) OVER (PARTITION BY mod_id) AS Минимум_по_модулю
FROM get_rate_lesson </code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------+------+----------------+--------------------+-------------------+
| Модуль | Урок | Пройдено_шагов | Максимум_по_модулю | Минимум_по_модулю |
+--------+------+----------------+--------------------+-------------------+
| 1      | 1.2  | 11             | 11                 | 11                |
| 2      | 2.2  | 8              | 13                 | 8                 |
| 2      | 2.4  | 13             | 13                 | 8                 |
+--------+------+----------------+--------------------+-------------------+
Affected rows: 3</code></pre>

<h2>Задание</h2>

<p>Вычислить рейтинг каждого студента относительно студента, прошедшего наибольшее количество шагов в модуле (вычисляется как отношение количества пройденных студентом шагов к максимальному количеству пройденных шагов, умноженное на 100). Вывести номер модуля, имя студента, количество пройденных им шагов и относительный рейтинг. Относительный рейтинг округлить до одного знака после запятой. Столбцы назвать <code><strong>Модуль</strong></code>, <code><strong>Студент</strong></code>, <code><strong>Пройдено_шагов</strong></code> и <code><strong>Относительный_рейтинг</strong></code>  соответственно. Информацию отсортировать сначала по возрастанию номера модуля, потом по убыванию относительного рейтинга и, наконец, по имени студента в алфавитном порядке.</p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/2?unit=279275" rel="noopener noreferrer nofollow">уникальные записи</a>;</u></li>
	<li>групповые функции (<u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297515/step/4?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/404275/step/8?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">оконные функции</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------+------------+----------------+-----------------------+
| Модуль | Студент    | Пройдено_шагов | Относительный_рейтинг |
+--------+------------+----------------+-----------------------+
| 1      | student_1  | 11             | 100.0                 |
| 1      | student_10 | 11             | 100.0                 |
| 1      | student_11 | 11             | 100.0                 |
                              ...
| 1      | student_47 | 8              | 72.7                  |
| 2      | student_60 | 21             | 100.0                 |
| 2      | student_15 | 19             | 90.5                  |
| 2      | student_18 | 19             | 90.5                  |
| 2      | student_27 | 19             | 90.5                  |
| 2      | student_30 | 19             | 90.5                  |
| 2      | student_31 | 19             | 90.5                  |
| 2      | student_36 | 19             | 90.5                  |
| 2      | student_39 | 19             | 90.5                  |
| 2      | student_4  | 19             | 90.5                  |
| 2      | student_43 | 19             | 90.5                  |
| 2      | student_44 | 19             | 90.5                  |
| 2      | student_46 | 19             | 90.5                  |
| 2      | student_49 | 19             | 90.5                  |
                               ...
| 2      | student_48 | 5              | 23.8                  |
| 2      | student_42 | 4              | 19.0                  |
| 2      | student_61 | 3              | 14.3                  |
| 2      | student_13 | 2              | 9.5                   |
| 2      | student_26 | 2              | 9.5                   |
+--------+------------+----------------+-----------------------+
Affected rows: 95</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">WITH get_rate(mod_id, stud_name, steps, max_step)
AS (
SELECT module_id, student_name, COUNT(DISTINCT step_id), MAX(COUNT(DISTINCT step_id)) OVER (PARTITION BY module_id)
FROM student INNER JOIN step_student USING(student_id) INNER JOIN step USING (step_id) INNER JOIN lesson USING (lesson_id)
WHERE result = "correct"
GROUP BY 1, 2)
SELECT mod_id As Модуль, stud_name AS Студент, steps AS Пройдено_шагов,
ROUND((steps/max_step) * 100, 1) AS Относительный_рейтинг
FROM get_rate
ORDER BY mod_id, ROUND(steps/max_step, 1) DESC


</code></pre><h2>Выборка данных с сортировкой</h2>

<p>При выборке можно указывать столбец или несколько столбцов, по которым необходимо отсортировать отобранные строки. Для этого используются ключевые слова <code>ORDER BY</code>, после которых задаются имена столбцов. При этом строки сортируются по первому столбцу, если указан второй столбец, сортировка осуществляется только для тех строк, у которых значения первого столбца одинаковы. По умолчанию <code>ORDER BY</code> выполняет сортировку по возрастанию. Чтобы управлять направлением сортировки вручную, после имени столбца указывается ключевое слово <code>ASC</code> (по возрастанию) или <code>DESC</code> (по убыванию). </p>

<p>Логический порядок операций для запроса SQL следующий:</p>

<ol>
	<li>FROM</li>
	<li>WHERE</li>
	<li>SELECT</li>
	<li>ORDER BY</li>
</ol>

<p>Поскольку сортировка выполняется позже <code>SELECT</code>, для указания столбцов, по которым выполняется сортировка, можно использовать имена, присвоенные им после <code>SELECT</code>, а также порядковый номер столбца в перечислении.</p>

<p><strong>Пример</strong></p>

<p>Вывести название, автора и цены книг. Информацию  отсортировать по названиям книг в алфавитном порядке.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title, author, price
FROM book
ORDER BY title;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+------------------+--------+
| title                 | author           | price  |
+-----------------------+------------------+--------+
| Белая гвардия         | Булгаков М.А.    | 540.50 |
| Братья Карамазовы     | Достоевский Ф.М. | 799.01 |
| Идиот                 | Достоевский Ф.М. | 460.00 |
| Мастер и Маргарита    | Булгаков М.А.    | 670.99 |
| Стихотворения и поэмы | Есенин С.А.      | 650.00 |
+-----------------------+------------------+--------+</code></pre>

<p>Аналогичный результат получится при использовании запроса:</p>

<pre><code class="language-sql">SELECT title, author, price
FROM book
ORDER BY 1;</code></pre>

<p><strong>Пример</strong></p>

<p>Вывести автора, название и количество книг, в отсортированном в алфавитном порядке по автору и по убыванию количества, для тех книг, цены которых меньше 750 рублей.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT author, title, amount AS Количество
FROM book
WHERE price &lt; 750
ORDER BY author, amount DESC;</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+-----------------------+------------+
| author           | title                 | Количество |
+------------------+-----------------------+------------+
| Булгаков М.А.    | Белая гвардия         | 5          |
| Булгаков М.А.    | Мастер и Маргарита    | 3          |
| Достоевский Ф.М. | Идиот                 | 10         |
| Есенин С.А.      | Стихотворения и поэмы | 15         |
+------------------+-----------------------+------------+</code></pre>

<p>Можно использовать другие варианты записи запроса:</p>

<pre><code class="language-sql">SELECT author, title, amount AS Количество
FROM book
WHERE price &lt; 750
ORDER BY author, Количество DESC;</code></pre>

<pre><code class="language-sql">SELECT author, title, amount AS Количество
FROM book
WHERE price &lt; 750
ORDER BY 1, 3 DESC;</code></pre>

<p><strong>Важно! </strong>Если названия столбцов заключены в кавычки, то при использовании их в сортировке, необходимо записывать их БЕЗ КАВЫЧЕК.</p>

<h2><strong>Задание</strong></h2>

<p>Вывести  автора и название  книг, количество которых принадлежит интервалу от 2 до 14 (включая границы). Информацию  отсортировать сначала по авторам (в обратном алфавитном порядке), а затем по названиям книг (по алфавиту).</p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+------------------+--------------------+
| author           | title              |
+------------------+--------------------+
| Достоевский Ф.М. | Братья Карамазовы  |
| Достоевский Ф.М. | Идиот              |
| Булгаков М.А.    | Белая гвардия      |
| Булгаков М.А.    | Мастер и Маргарита |
+------------------+--------------------+</code></pre>

<details><summary><strong>Структура и наполнение таблицы <code>book</code><strong>:</strong></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, title
FROM book
WHERE amount BETWEEN 2 AND 14
ORDER BY author DESC, title ASC




</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов корректировки данных к  таблицам<code><strong>book</strong></code> и  <code><strong>supply</strong></code> . Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно использовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p>В последнем модуле создан отдельный урок, в котором мы разместим запросы, набравшие наибольшее количество лайков.</p>

<p><strong>Структура и наполнение таблиц:</strong></p>

<p>Таблица <code><strong>book</strong></code></p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		
		<tr>
			<td>1</td>
			<td>Мастер и Маргарита</td>
			<td>Булгаков М.А.</td>
			<td>670.99</td>
			<td>3</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Белая гвардия</td>
			<td>Булгаков М.А.</td>
			<td>540.50</td>
			<td>5</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Идиот</td>
			<td>Достоевский Ф.М.</td>
			<td>460.00</td>
			<td>10</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Братья Карамазовы</td>
			<td>Достоевский Ф.М.</td>
			<td>799.01</td>
			<td>2</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Стихотворения и поэмы</td>
			<td>Есенин С.А.</td>
			<td>650.00</td>
			<td>15</td>
		</tr>
	</tbody>
</table>

<p>Таблица<code><strong> supply</strong></code> :</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>supply_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Лирика</td>
			<td>Пастернак Б.Л.</td>
			<td>518.99</td>
			<td>2</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Черный человек </td>
			<td>Есенин С.А.</td>
			<td>570.20</td>
			<td>6</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Белая гвардия</td>
			<td>Булгаков М.А.</td>
			<td>540.50</td>
			<td>7</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Идиот</td>
			<td>Достоевский Ф.М.</td>
			<td>360.80</td>
			<td>3</td>
		</tr>
	</tbody>
</table> <br><hr><br> <pre><code class="hljs language-sql">UPDATE book, supply
SET book.price = IF(book.price > supply.price, book.price, supply.price), book.amount = book.amount + supply.amount



</code></pre><h2>Задание</h2>

<p>Вывести фамилию с инициалами и общую сумму суточных, полученных за все командировки для тех сотрудников, которые были в командировках больше чем 3 раза, в отсортированном по убыванию сумм суточных виде. Последний столбец назвать <code><strong>Сумма</strong></code>.</p>

<p>Только для этого задания изменена строка таблицы <code><strong>trip</strong></code>:</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td>4</td>
			<td>Ильиных Г.Р.</td>
			<td>Владивосток</td>
			<td>450</td>
			<td>2020-01-12</td>
			<td><span style="color: #ff4363;">2020-03-02</span></td>
		</tr>
	</tbody>
</table>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------+----------+
| name          | Сумма    |
+---------------+----------+
| Абрамова К.А. | 29200.00 |
| Баранов П.Е.  | 21300.00 |
+---------------+----------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/5?unit=279269" rel="noopener noreferrer nofollow">вычисления в SELECT</a>;</li>
	<li><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления над сгруппированными данными</a>;</li>
	<li><a href="https://stepik.org/lesson/297515/step/7?unit=279275" rel="noopener noreferrer nofollow">условие отбора в запросах группировки</a>;</li>
	<li><a href="https://stepik.org/lesson/297514/step/4?unit=279274" rel="noopener noreferrer nofollow">вложенные запросы</a>;</li>
	<li><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a>.</li>
</ul>
</details>

<details><summary><strong>Структура и наполнение таблицы <code><strong>trip</strong></code></strong></summary>

<pre><code>+---------+---------------+-----------------+----------+------------+------------+
| trip_id | name          | city            | per_diem | date_first | date_last  |
+---------+---------------+-----------------+----------+------------+------------+
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-03-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |
+---------+---------------+-----------------+----------+------------+------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name, SUM((per_diem * (DATEDIFF(date_last, date_first) + 1))) AS Сумма
FROM trip
GROUP BY name
HAVING COUNT(name) > 3
ORDER BY Сумма DESC;


</code></pre><h2>Задание</h2>

<p>Добавьте три последние записи (с ключевыми значениями 6, 7, 8) в таблицу<code><strong> book</strong></code>, первые 5 записей уже добавлены:</p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author_id</strong></td>
			<td><strong>genre_id</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Мастер и Маргарита</td>
			<td>1</td>
			<td>1</td>
			<td>670.99</td>
			<td>3</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Белая гвардия</td>
			<td>1</td>
			<td>1</td>
			<td>540.50</td>
			<td>5</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Идиот</td>
			<td>2</td>
			<td>1</td>
			<td>460.00</td>
			<td>10</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Братья Карамазовы</td>
			<td>2</td>
			<td>1</td>
			<td>799.01</td>
			<td>3</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Игрок</td>
			<td>2</td>
			<td>1</td>
			<td>480.50</td>
			<td>10</td>
		</tr>
		<tr>
			<td>6</td>
			<td>Стихотворения и поэмы</td>
			<td>3</td>
			<td>2</td>
			<td>650.00</td>
			<td>15</td>
		</tr>
		<tr>
			<td>7</td>
			<td>Черный человек</td>
			<td>3</td>
			<td>2</td>
			<td>570.20</td>
			<td>6</td>
		</tr>
		<tr>
			<td>8</td>
			<td>Лирика</td>
			<td>4</td>
			<td>2</td>
			<td>518.99</td>
			<td>2</td>
		</tr>
	</tbody>
</table>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/"></p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">Affected rows: 1
Affected rows: 1
Affected rows: 1
Query result:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">INSERT INTO book (title, author_id, genre_id, price, amount)
VALUES ("Стихотворения и поэмы", 3, 2, 650.00, 15),
("Черный человек", 3, 2, 570.20, 6),
("Лирика", 4, 2, 518.99, 2);
</code></pre><h2>Задание</h2>

<p>В таблице <code><strong>city</strong></code> для каждого города указано количество дней, за которые заказ может быть доставлен в этот город (рассматривается только этап <strong>Транспортировка</strong>). Для тех заказов, которые прошли этап транспортировки, вывести количество дней за которое заказ реально доставлен в город. А также, если заказ доставлен с опозданием, указать количество дней задержки, в противном случае вывести 0. В результат включить номер заказа (<code><strong>buy_id</strong></code>), а также вычисляемые столбцы <code><strong>Количество_дней</strong></code> и <code><strong>Опоздание</strong></code>. Информацию вывести в отсортированном по номеру заказа виде.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/6b3c2d87-7353-48e6-adfd-26c338886f4a/"></p>

<details><summary><strong>Пояснение</strong></summary>

<ol>
	<li>Для вычисления поля «Опоздание» используйте функцию <code><a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow">if()</a></code>, а для вычисления разности дат – функцию <a href="https://stepik.org/lesson/297510/step/6?unit=279270" rel="noopener noreferrer nofollow"><code>DATEDIFF()</code></a>.</li>
	<li>Если доставка еще не осуществлена, то поле <code><strong>date_step_end</strong></code>  для этапа <strong>Транспортировка</strong> - пусто.</li>
</ol>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297510/step/6?unit=279270" rel="noopener noreferrer nofollow">вычитание дат</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/7?unit=279269" rel="noopener noreferrer nofollow">функция IF()</a></u>;</li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/305762/step/4?unit=287773" rel="noopener noreferrer nofollow">сравнение с пустым значением</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) :</p>

<blockquote>
<p>В таблице <code><strong>city</strong></code> для каждого города указано количество дней, за которые заказ может быть доставлен в этот город (рассматривается только этап "Транспортировка"). Для тех заказов, которые прошли этап транспортировки, вывести количество дней за которое заказ реально доставлен в город. А также, если заказ доставлен с опозданием, указать количество дней задержки, в противном случае вывести 0. В результат включить номер заказа (<code><strong>buy_id</strong></code>), а также вычисляемые столбцы <code><strong>Количество_дней</strong></code> и <code><strong>Опоздание</strong></code>. Информацию вывести в отсортированном по номеру заказа виде.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------+-----------------+-----------+
| buy_id | Количество_дней | Опоздание |
+--------+-----------------+-----------+
| 1      | 14              | 2         |
| 3      | 4               | 0         |
+--------+-----------------+-----------+</code></pre>
</details>
<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT buy.buy_id, (DATEDIFF(date_step_end, date_step_beg)) AS Количество_дней, (
    IF(
        DATEDIFF(date_step_end, date_step_beg) > days_delivery, DATEDIFF(date_step_end, date_step_beg) - days_delivery, 0)) AS Опоздание
FROM city INNER JOIN client USING(city_id) INNER JOIN buy ON client.client_id = buy.client_id INNER JOIN buy_step ON buy.buy_id = buy_step.buy_id INNER JOIN step ON buy_step.step_id = step.step_id
WHERE step.step_id = 3 AND date_step_end IS NOT NULL AND date_step_beg IS NOT NULL
ORDER BY buy.buy_id ASC;

</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов корректировки данных для предметной области «Интернет-магазин книг» (в таблицы занесены данные, как <a href="https://stepik.org/lesson/308891/step/4?unit=291017" rel="noopener noreferrer nofollow">на этом шаге</a>). Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно реализовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p>В последнем модуле создан отдельный урок, в котором мы разместим запросы, набравшие наибольшее количество лайков. </p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/bad26356-5e34-4945-a9d4-0748686a6b54/"></p>
<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">insert into buy(buy_id, buy_description, client_id)
values(6, 'Связаться со мной', 3)</code></pre><h2>Задание</h2>

<p>Вывести название образовательной программы и фамилию тех абитуриентов, которые подавали документы на эту образовательную программу, но не могут быть зачислены на нее. Эти абитуриенты имеют результат по одному или нескольким предметам ЕГЭ, необходимым для поступления на эту образовательную программу, меньше минимального балла. Информацию вывести в отсортированном сначала по программам, а потом по фамилиям абитуриентов виде.</p>

<p>Например, Баранов Павел по «Физике» набрал 41 балл, а  для образовательной программы «Прикладная механика» минимальный балл по этому предмету определен в 45 баллов. Следовательно, абитуриент на данную программу не может поступить.</p>

<p><strong>Логическая схемы базы данных (чтобы потренироваться выбирать таблицы для запроса):</strong></p>

<p><img alt="" src="https://ucarecdn.com/98c706e5-0118-4fa9-ae09-4a934ece5bc8/"></p>

<p>Для этого задания в базу данных добавлена строка:</p>

<pre><code class="language-sql">INSERT INTO enrollee_subject (enrollee_id, subject_id, result) VALUES (2, 3, 41);</code></pre>

<p>Добавлен человек, который сдавал <strong>Физику</strong>, но не подал документы ни на одну образовательную программу, где этот предмет нужен.</p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания </strong>(чтобы не прокручивать страницу) :</p>

<blockquote>
<p>Вывести название образовательной программы и фамилию тех абитуриентов, которые подавали документы на эту образовательную программу, но не могут быть зачислены на нее. Эти абитуриенты имеют результат по одному или нескольким предметам ЕГЭ, необходимым для поступления на эту образовательную программу, меньше минимального балла. Информацию вывести в отсортированном сначала по программам, а потом по фамилиям абитуриентов виде.</p>

<p>Например, Баранов Павел по «Физике» набрал 41 балл, а  для образовательной программы «Прикладная механика» минимальный балл по этому предмету определен в 45 баллов. Следовательно, абитуриент на данную программу не может поступить.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------------------+---------------+
| name_program                | name_enrollee |
+-----------------------------+---------------+
| Мехатроника и робототехника | Баранов Павел |
| Прикладная механика         | Баранов Павел |
+-----------------------------+---------------+</code></pre>
</details>

<details><summary><strong>Наполнение таблиц </strong></summary>

<pre><code class="language-sql">таблица department
+---------------+-------------------------+
| department_id | name_department         |
+---------------+-------------------------+
| 1             | Инженерная школа        |
| 2             | Школа естественных наук |
+---------------+-------------------------+
таблица program
+------------+-------------------------------------+---------------+------+
| program_id | name_program                        | department_id | plan |
+------------+-------------------------------------+---------------+------+
| 1          | Прикладная математика и информатика | 2             | 1    |
| 2          | Математика и компьютерные науки     | 2             | 2    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |
+------------+-------------------------------------+---------------+------+
таблица enrollee
+-------------+-----------------+
| enrollee_id | name_enrollee   |
+-------------+-----------------+
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |
+-------------+-----------------+
таблица subject
+------------+--------------+
| subject_id | name_subject |
+------------+--------------+
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |
+------------+--------------+
таблица program_subject
+--------------------+------------+------------+------------+
| program_subject_id | program_id | subject_id | min_result |
+--------------------+------------+------------+------------+
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |
+--------------------+------------+------------+------------+
таблица program_enrollee
+---------------------+------------+-------------+
| program_enrollee_id | program_id | enrollee_id |
+---------------------+------------+-------------+
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |
+---------------------+------------+-------------+
таблица enrollee_subject
+---------------------+-------------+------------+--------+
| enrollee_subject_id | enrollee_id | subject_id | result |
+---------------------+-------------+------------+--------+
| 1                   | 1           | 1          | 68     |
| 2                   | 1           | 2          | 70     |
| 3                   | 1           | 3          | 41     |
| 4                   | 1           | 4          | 75     |
| 5                   | 2           | 1          | 75     |
| 6                   | 2           | 2          | 70     |
| 7                   | 2           | 4          | 81     |
| 8                   | 3           | 1          | 85     |
| 9                   | 3           | 2          | 67     |
| 10                  | 3           | 3          | 90     |
| 11                  | 3           | 4          | 78     |
| 12                  | 4           | 1          | 82     |
| 13                  | 4           | 2          | 86     |
| 14                  | 4           | 3          | 70     |
| 15                  | 5           | 1          | 65     |
| 16                  | 5           | 2          | 67     |
| 17                  | 5           | 3          | 60     |
| 18                  | 6           | 1          | 90     |
| 19                  | 6           | 2          | 92     |
| 20                  | 6           | 3          | 88     |
| 21                  | 6           | 4          | 94     |
+---------------------+-------------+------------+--------+
таблица achievement
+----------------+-----------------------+-------+
| achievement_id | name_achievement      | bonus |
+----------------+-----------------------+-------+
| 1              | Золотая медаль        | 5     |
| 2              | Серебряная медаль     | 3     |
| 3              | Золотой значок ГТО    | 3     |
| 4              | Серебряный значок ГТО | 1     |
+----------------+-----------------------+-------+
таблица enrollee_achievement
+--------------------+-------------+----------------+
| enrollee_achiev_id | enrollee_id | achievement_id |
+--------------------+-------------+----------------+
| 1                  | 1           | 2              |
| 2                  | 1           | 3              |
| 3                  | 3           | 1              |
| 4                  | 4           | 4              |
| 5                  | 5           | 1              |
| 6                  | 5           | 3              |
+--------------------+-------------+----------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_program, name_enrollee
FROM enrollee JOIN  program_enrollee ON program_enrollee.enrollee_id = enrollee.enrollee_id
JOIN program USING(program_id)
JOIN program_subject ON program.program_id = program_subject.program_id
JOIN subject ON program_subject.subject_id = subject.subject_id
JOIN enrollee_subject ON enrollee.enrollee_id = enrollee_subject.enrollee_id AND enrollee_subject.subject_id = subject.subject_id
WHERE enrollee_subject.result < program_subject.min_result



GROUP BY name_program, name_enrollee
ORDER BY name_program</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов на выборку для предметной области «Тестирование» (в таблицы занесены данные, как на <a href="https://stepik.org/lesson/310421/step/1?unit=292727" rel="noopener noreferrer nofollow">первом шаге</a> урока). Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно реализовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/e4669333-8898-434f-b1a5-4fa88b39ae02/"></p>

<details><summary><strong>Наполнение таблиц</strong></summary>

<pre><code class="language-sql">таблица student                   таблица subject
+------------+-----------------+  +------------+-------------------+
| student_id | name_student    |  | subject_id | name_subject      |
+------------+-----------------+  +------------+-------------------+
| 1          | Баранов Павел   |  | 1          | Основы SQL        |
| 2          | Абрамова Катя   |  | 2          | Основы баз данных |
| 3          | Семенов Иван    |  | 3          | Физика            |
| 4          | Яковлева Галина |  +------------+-------------------+
+------------+-----------------+
таблица question
+-------------+------------------------------------------------------------+------------+
| question_id | name_question                                              | subject_id |
+-------------+------------------------------------------------------------+------------+
| 1           | Запрос на выборку начинается с ключевого слова:            | 1          |
| 2           | Условие, по которому отбираются записи, задается после...  | 1          |
| 3           | Для сортировки используется:                               | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:       | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:   | 1          |
| 6           | База данных - это:                                         | 2          |
| 7           | Отношение - это:                                           | 2          |
| 8           | Концептуальная модель используется для                     | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?        | 2          |
+-------------+------------------------------------------------------------+------------+
таблица answer
+-----------+--------------------------------------------------------+-------------+------------+
| answer_id | name_answer                                            | question_id | is_correct |
+-----------+--------------------------------------------------------+-------------+------------+
| 1         | UPDATE                                                 | 1           | 0          |
| 2         | SELECT                                                 | 1           | 1          |
| 3         | INSERT                                                 | 1           | 0          |
| 4         | GROUP BY                                               | 2           | 0          |
| 5         | FROM                                                   | 2           | 0          |
| 6         | WHERE                                                  | 2           | 1          |
| 7         | SELECT                                                 | 2           | 0          |
| 8         | SORT                                                   | 3           | 0          |
| 9         | ORDER BY                                               | 3           | 1          |
| 10        | RANG BY                                                | 3           | 0          |
| 11        | SELECT * FROM student                                  | 4           | 1          |
| 12        | SELECT student                                         | 4           | 0          |
| 13        | INNER JOIN                                             | 5           | 1          |
| 14        | LEFT JOIN                                              | 5           | 0          |
| 15        | RIGHT JOIN                                             | 5           | 0          |
| 16        | CROSS JOIN                                             | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным...  | 6           | 1          |
| 18        | совокупность программ для хранения иобработки ...      | 6           | 0          |
| 19        | строка                                                 | 7           | 0          |
| 20        | столбец                                                | 7           | 0          |
| 21        | таблица                                                | 7           | 1          |
| 22        | обобщенное представление пользователей о данных        | 8           | 1          |
| 23        | описание представления данных в памяти компьютера      | 8           | 0          |
| 24        | база данных                                            | 8           | 0          |
| 25        | file                                                   | 9           | 1          |
| 26        | INT                                                    | 9           | 0          |
| 27        | VARCHAR                                                | 9           | 0          |
| 28        | DATE                                                   | 9           | 0          |
+-----------+--------------------------------------------------------+-------------+------------+
таблица attempt
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
таблица testing
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
+------------+------------+-------------+-----------+
</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_subject, IF(LENGTH(name_question) > 30, CONCAT(LEFT(name_question, 30), '...'), name_question) AS Вопрос, COUNT(is_correct) AS Всего_ответов, ROUND(SUM(is_correct) / COUNT(is_correct) * 100, 2) AS Успешность
FROM answer
INNER JOIN testing ON answer.answer_id = testing.answer_id
INNER JOIN question ON answer.question_id = question.question_id
INNER JOIN subject ON question.subject_id = subject.subject_id
GROUP BY name_subject, name_question
ORDER BY name_subject, Успешность DESC, Вопрос




</code></pre><h2>Задание</h2>

<p>Проанализировать, в каком порядке и с каким интервалом пользователь отправлял последнее верно выполненное задание каждого урока. В базе занесены попытки студентов  для трех уроков курса, поэтому анализ проводить только для этих уроков.</p>

<p>Для студентов прошедших как минимум по одному шагу в каждом уроке, найти последний пройденный шаг каждого урока - крайний шаг, и указать:</p>

<ul>
	<li>имя студента;</li>
	<li>номер урока, состоящий из номера модуля и через точку позиции каждого урока в модуле;</li>
	<li>время отправки  - время подачи решения на проверку;</li>
	<li>разницу во времени отправки между текущим и предыдущим крайним шагом в днях, при этом для первого шага поставить прочерк ("-"), а количество дней округлить до целого в большую сторону.</li>
</ul>

<p>Столбцы назвать  <code><strong>Студент</strong></code>, <code><strong>Урок</strong></code>,  <code><strong>Макс_время_отправки</strong></code> и <code><strong>Интервал </strong></code> соответственно. Отсортировать результаты по имени студента в алфавитном порядке, а потом по возрастанию времени отправки.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/83dcbaba-e030-4299-9c1b-9d25a3dd5d67/"></p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------+------+---------------------+----------+
| Студент    | Урок | Макс_время_отправки | Интервал |
+------------+------+---------------------+----------+
| student_15 | 1.2  | 2020-05-20 12:35:57 | -        |
| student_15 | 2.4  | 2020-06-08 07:10:24 | 19       |
| student_15 | 2.2  | 2020-08-18 12:47:03 | 72       |
| student_18 | 1.2  | 2020-04-17 03:22:14 | -        |
| student_18 | 2.2  | 2020-06-18 07:25:44 | 63       |
| student_18 | 2.4  | 2020-06-18 07:34:14 | 1        |
| student_20 | 1.2  | 2020-05-28 12:08:53 | -        |
| student_20 | 2.2  | 2020-06-17 15:55:29 | 21       |
| student_20 | 2.4  | 2020-06-18 09:48:39 | 1        |
| student_23 | 1.2  | 2020-05-24 18:15:27 | -        |
| student_23 | 2.2  | 2020-06-01 04:37:16 | 8        |
| student_23 | 2.4  | 2020-06-01 04:42:36 | 1        |
| student_24 | 1.2  | 2020-04-14 16:16:22 | -        |
| student_24 | 2.2  | 2020-05-11 12:28:49 | 27       |
| student_24 | 2.4  | 2020-05-13 12:20:39 | 2        |
| student_27 | 1.2  | 2020-08-12 10:18:47 | -        |
| student_27 | 2.2  | 2020-08-14 17:14:51 | 3        |
| student_27 | 2.4  | 2020-08-20 12:23:34 | 6        |
| student_30 | 1.2  | 2020-08-10 08:38:49 | -        |
| student_30 | 2.2  | 2020-08-16 12:53:39 | 7        |
| student_30 | 2.4  | 2020-08-19 11:41:49 | 3        |
| student_31 | 1.2  | 2020-06-13 09:03:39 | -        |
| student_31 | 2.2  | 2020-07-02 16:43:36 | 20       |
| student_31 | 2.4  | 2020-07-05 17:18:56 | 4        |
| student_36 | 1.2  | 2020-08-04 07:25:30 | -        |
| student_36 | 2.2  | 2020-08-07 11:39:12 | 4        |
| student_36 | 2.4  | 2020-08-07 20:33:02 | 1        |
| student_39 | 1.2  | 2020-05-31 12:35:10 | -        |
| student_39 | 2.2  | 2020-06-02 09:47:15 | 2        |
| student_39 | 2.4  | 2020-06-02 17:06:41 | 1        |
| student_4  | 1.2  | 2020-05-31 17:46:27 | -        |
| student_4  | 2.2  | 2020-07-27 17:12:45 | 57       |
| student_4  | 2.4  | 2020-07-29 09:21:24 | 2        |
| student_43 | 1.2  | 2020-07-16 21:19:13 | -        |
| student_43 | 2.4  | 2020-08-06 13:02:44 | 21       |
| student_43 | 2.2  | 2020-08-08 20:11:52 | 3        |
| student_44 | 1.2  | 2020-05-26 14:23:39 | -        |
| student_44 | 2.2  | 2020-06-02 11:07:52 | 7        |
| student_44 | 2.4  | 2020-06-06 21:57:20 | 5        |
| student_46 | 1.2  | 2020-05-26 13:02:10 | -        |
| student_46 | 2.4  | 2020-06-03 20:30:01 | 9        |
| student_46 | 2.2  | 2020-06-03 20:54:34 | 1        |
| student_49 | 1.2  | 2020-07-11 16:31:12 | -        |
| student_49 | 2.2  | 2020-07-15 05:00:03 | 4        |
| student_49 | 2.4  | 2020-07-16 04:57:51 | 1        |
| student_50 | 1.2  | 2020-07-01 08:16:41 | -        |
| student_50 | 2.2  | 2020-08-10 08:26:49 | 41       |
| student_50 | 2.4  | 2020-09-09 12:44:00 | 31       |
| student_51 | 1.2  | 2020-09-03 07:24:26 | -        |
| student_51 | 2.2  | 2020-09-07 19:31:01 | 5        |
| student_51 | 2.4  | 2020-09-10 13:12:11 | 3        |
| student_52 | 1.2  | 2020-08-24 18:30:55 | -        |
| student_52 | 2.2  | 2020-09-07 13:51:02 | 14       |
| student_52 | 2.4  | 2020-09-07 22:16:19 | 1        |
| student_53 | 1.2  | 2020-07-11 09:32:33 | -        |
| student_53 | 2.2  | 2020-07-17 12:34:54 | 7        |
| student_53 | 2.4  | 2020-07-19 05:09:32 | 2        |
| student_56 | 1.2  | 2020-07-15 12:20:48 | -        |
| student_56 | 2.2  | 2020-08-06 10:22:13 | 22       |
| student_56 | 2.4  | 2020-08-20 09:18:46 | 14       |
| student_59 | 1.2  | 2020-08-17 19:29:09 | -        |
| student_59 | 2.2  | 2020-08-21 10:35:18 | 4        |
| student_59 | 2.4  | 2020-08-22 10:39:29 | 2        |
| student_60 | 1.2  | 2020-09-01 12:54:58 | -        |
| student_60 | 2.2  | 2020-09-02 15:34:45 | 2        |
| student_60 | 2.4  | 2020-09-03 10:53:13 | 1        |
| student_9  | 1.2  | 2020-05-01 05:40:11 | -        |
| student_9  | 2.2  | 2020-05-05 09:29:20 | 5        |
| student_9  | 2.4  | 2020-05-06 10:52:38 | 2        |
+------------+------+---------------------+----------+
Affected rows: 69</code></pre>

<p><strong>Важно! </strong>Чаще всего решение не совпадает для двух записей <strong>student_24, шаг 2.2</strong> и <strong>student_50, шаг 2.2</strong>. Если ответ все таки не принимается, то скопируйте таблицу результата и Ваш ответ в EXCEL в соседние столбцы (например, в <code><strong>А</strong></code> и <code><strong>B</strong></code>, начиная с первой строки), в ячейке <code><strong>C1</strong></code> напишите формуле<code><strong> = A1=B1</strong></code> и протяните ее вниз. Для всех строк, в которых данные в столбцах <code><strong>А</strong></code> и <code><strong>B</strong></code> не будут совпадать, в соответствующей ячейке столбца <code><strong>С</strong></code> будет выведено <code><strong>ЛОЖЬ</strong></code>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/404275/step/6?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">табличные выражения</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/310421/step/10?auth=login&amp;unit=292727" rel="noopener noreferrer nofollow">функция CONCAT()</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/404275/step/8?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">функции IFNULL() и FROM_UNIXTIME()</a>;</u></li>
	<li>оконные функции (<u><a href="https://stepik.org/lesson/404275/step/8?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/404275/step/10?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297515/step/7?unit=279275" rel="noopener noreferrer nofollow">условие отбора в запросах группировки</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong><em>Текст задания (чтобы не прокручивать страницу) :</em></strong></p>

<blockquote>
<p>Проанализировать, в каком порядке и с каким интервалом пользователь отправлял последнее верно выполненное задание каждого урока. Учитывать только студентов, прошедших хотя бы один шаг из всех трех уроков. В базе занесены попытки студентов  для трех уроков курса, поэтому анализ проводить только для этих уроков.</p>

<p>Для студентов прошедших как минимум по одному шагу в каждом уроке, найти последний пройденный шаг каждого урока - крайний шаг, и указать:</p>

<ul>
	<li>имя студента;</li>
	<li>номер урока, состоящий из номера модуля и через точку позиции каждого урока в модуле;</li>
	<li>время отправки  - время подачи решения на проверку;</li>
	<li>разницу во времени отправки между текущим и предыдущим крайним шагом в днях, при этом для первого шага поставить прочерк ("-"), а количество дней округлить до целого в большую сторону.</li>
</ul>

<p>Столбцы назвать  <code><strong>Студент</strong></code>, <code><strong>Урок</strong></code>,  <code><strong>Макс_время_отправки</strong></code> и <code><strong>Интервал </strong></code> соответственно. Отсортировать результаты по имени студента в алфавитном порядке, а потом по возрастанию времени отправки.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">WITH get_array(st_id, st_name, less, sub_time)
AS (
SELECT student_id, student_name, CONCAT(module_id, '.', lesson_position), MAX(submission_time)
FROM student INNER JOIN step_student Using(student_id)
INNER JOIN step USING(step_id) INNER JOIN lesson USING(lesson_id)
WHERE result = 'correct'
GROUP BY student_id, lesson_id),
requirements(st_id) AS
(SELECT st_id
 FROM get_array
 GROUP BY st_id
 HAVING COUNT(*) >= 3)
SELECT st_name AS Студент, less AS Урок, FROM_UNIXTIME(sub_time) AS Макс_время_отправки,
IFNULL(CEIL((sub_time - LAG(sub_time) OVER(PARTITION BY st_name ORDER BY sub_time))/ 86400), '-') AS Интервал
FROM get_array JOIN requirements USING(st_id)
ORDER BY 1, 3 ASC</code></pre><h2>Выборка данных, оператор LIKE</h2>

<p>Оператор <code>LIKE</code> используется для сравнения строк. В отличие от операторов отношения равно (<strong>=</strong>) и не равно (<strong>&lt;&gt;</strong>), <code>LIKE</code> позволяет сравнивать строки не на полное совпадение (не совпадение), а в соответствии с шаблоном. Шаблон может включать <strong>обычные символы</strong> и <strong>символы-шаблоны</strong>. При сравнении с шаблоном, его обычные символы должны в точности совпадать с символами, указанными в строке. Символы-шаблоны могут совпадать с произвольными элементами символьной строки.</p>

<table border="1">
	<thead>
		<tr style="background-color: #e6f8e0; background: #e6f8e0; text-align: center;">
			<th><sup>Символ-шаблон</sup></th>
			<th>Описание</th>
			<th>Пример</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><strong>%</strong></td>
			<td>Любая строка, содержащая ноль или более символов</td>
			<td><code>SELECT * FROM book WHERE author LIKE '%М.%' </code><br>
			выполняет поиск и выдает все книги, инициалы авторов которых содержат «<em>М.</em>»</td>
		</tr>
		<tr>
			<td><strong>_ </strong><sup>(подчеркивание)</sup></td>
			<td>Любой одиночный символ</td>
			<td><code>SELECT * FROM book WHERE title LIKE 'Поэм_' </code><br>
			выполняет поиск и выдает все книги, названия которых либо «<em>Поэма</em>», либо «<em>Поэмы</em>» и пр.</td>
		</tr>
	</tbody>
</table>

<p><strong>Пример 1</strong></p>

<p>Вывести названия книг, начинающихся с буквы «<em>Б</em>».</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title 
FROM book
WHERE title LIKE 'Б%';
/* эквивалентное условие 
title LIKE 'б%'
*/</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-------------------+
| title             |
+-------------------+
| Белая гвардия     |
| Братья Карамазовы |
+-------------------+</code></pre>

<details><summary><strong>Пояснение</strong></summary> Строчные и прописные буквы в строках эквивалентны.</details>

<p><strong>Пример 2</strong></p>

<p>Вывести название книг, состоящих ровно из 5 букв.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title FROM book 
WHERE title LIKE "_____"</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-------+
| title |
+-------+
| Идиот |
| Поэмы |
+-------+</code></pre>

<details><summary><strong>Пояснение</strong></summary>Для обозначения одного любого символа используется  "_", следовательно для обозначения 5 символов используется 5 подряд символов подчеркивания.</details>

<p><strong>Пример 3</strong></p>

<p>Вывести книги, название которых длиннее 5 символов:</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT title FROM book 
WHERE title LIKE "______%";
/* эквивалентные условия 
title LIKE "%______"
title LIKE "%______%"
*/
</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+
| title                 |
+-----------------------+
| Мастер и Маргарита    |
| Белая гвардия         |
| Братья Карамазовы     |
| Стихотворения и поэмы |
| Дети полуночи         |
| Лирика                |
| Капитанская дочка     |
+-----------------------+</code></pre>

<details><summary><strong>Пояснение  </strong></summary>

<p>Для того чтобы вывести названия, состоящие из любого количества символов после<code><strong>LIKE</strong></code> можно использовать шаблон <strong>"%"</strong>, с помощью которого отбираются строки, состоящие из любого количества символов, в том числе и "пустые", поскольку % заменяет любое количество символов, в том числе и нулевое.</p>

<p>Чтобы указать, что в названии должен быть хотя бы один символ, можно использовать один из эквивалентных шаблонов:</p>

<ul>
	<li> <strong>"_%"</strong> - сначала идет символ, а за ним любое количество символов;</li>
	<li><strong>"%_" </strong>- сначала идет любое количество символов, а затем обязательный символ;</li>
	<li><strong>"%_%"</strong> - сначала идет любое количество символов, потом обязательный символ, а за ним любое количество символов.</li>
</ul>
</details>

<p><strong>Пример 4</strong></p>

<p>Вывести названия книг, которые содержат букву <strong>"и"</strong> как отдельное слово, если считать, что слова в названии отделяются друг от друга пробелами и не содержат знаков препинания.</p>

<p><em> Запрос:</em></p>

<pre><code class="language-sql">SELECT title FROM book 
WHERE   title LIKE "_% и _%" /*отбирает слово И внутри названия */
    OR title LIKE "и _%" /*отбирает слово И в начале названия */
    OR title LIKE "_% и" /*отбирает слово И в конце названия */
    OR title LIKE "и" /* отбирает название, состоящее из одного слова И */

</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+
| title                 |
+-----------------------+
| Мастер и Маргарита    |
| Стихотворения и поэмы |
+-----------------------+</code></pre>

<details><summary><strong>Пояснение</strong></summary>

<p>Слово "и" может располагаться в названии в следующих позициях (при условии, что слова отделяются друг от друга пробелами):</p>

<ul>
	<li> в середине -  <strong>"_% и _%"</strong> - сначала идет любое количество символов (один обязательный), потом обязательный пробел, а за ним "и", снова обязательный пробел, и наконец любое количество символов (один обязательный);</li>
	<li>в начале -<strong> "и _%" </strong>- сначала идет "и", обязательный пробел и любое количество символов (один обязательный);</li>
	<li>в конце -<strong> "_% и" </strong>- сначала идет любое количество символов, затем обязательный пробел и буква "и":</li>
	<li>одно слово в названии - <strong>"и"</strong>.</li>
</ul>

<p>Вместо "<strong>_%"</strong> можно использовать эквивалентные шаблоны<strong> "%_"</strong> и <strong>"%_%"</strong> .</p>

<p>В качестве обязательного символа ( "_"), может быть и пробел, но, к сожалению, шаблоны для <code><strong>LIKE</strong></code> не позволяют исключить какой-то символ. Это можно сделать только с помощью регулярных выражений (будут рассмотрены в уроке 3.5)</p>
</details>

<p><strong>Пример 5</strong></p>

<p>Вывести названия книг, которые состоят ровно из одного слова, если считать, что слова в названии отделяются друг от друга пробелами .</p>

<p><em> Запрос:</em></p>

<pre><code class="language-sql">SELECT title FROM book 
WHERE title NOT LIKE "% %";    
</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------+
| title  |
+--------+
| Идиот  |
| Лирика |
| Поэмы  |
+--------+</code></pre>

<details><summary><strong>Пояснение</strong></summary> Отсутствие пробела в названии означает, что оно состоит из одного слова. Чтобы это проверить используется оператор <code><strong>NOT LIKE</strong></code>, который в данном случае отберет все названия, в которых нет пробелов.</details>

<h2>Задание</h2>

<p>Вывести название и автора тех книг, название которых состоит из двух и более слов, а инициалы автора содержат букву «С». Считать, что в названии слова отделяются друг от друга пробелами и не содержат знаков препинания, между фамилией автора и инициалами обязателен пробел, инициалы записываются без пробела в формате: буква, точка, буква, точка. Информацию отсортировать по названию книги в алфавитном порядке.</p>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------------+-------------+
| title                 | author      |
+-----------------------+-------------+
| Капитанская дочка     | Пушкин А.С. |
| Стихотворения и поэмы | Есенин С.А. |
+-----------------------+-------------+</code></pre>

<details><summary><strong>Пояснение</strong>.</summary>

<ol>
	<li>При записи условия, необходимо учесть, что слово в названии обязательно должно содержать  хотя бы один символ.</li>
	<li>Инициалы в этом задании - это первая буква имени или отчества, после которой стоит точка.</li>
	<li>Буква <strong>C </strong>должна быть написана в РУССКОЙ раскладке. Если не проходит решение - проверьте это.</li>
</ol>
</details>

<p><strong>Важно! </strong>Только для этого шага в таблицу добавлены новые записи.</p>

<details><summary><strong>Структура и наполнение таблицы <code>book</code><strong>:</strong></strong></summary>

<pre><code>+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       |                       | Иванов С.С.      | 50.00  | 10     |
| 7       | Дети полуночи         | Рушди Салман     | 950.00 | 5      |
| 8       | Лирика                | Гумилев Н.С.     | 460.00 | 10     |
| 9       | Поэмы                 | Бехтерев С.С.    | 460.00 | 10     |
| 10      | Капитанская дочка     | Пушкин А.С.      | 520.50 | 7      |
+---------+-----------------------+------------------+--------+--------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, author
FROM book
WHERE title LIKE "_% %" AND (author LIKE "% __С." OR author LIKE "% С.%");


</code></pre><h2>Задание</h2>

<p>Выбрать всех клиентов, которые заказывали книги Достоевского, информацию вывести в отсортированном по алфавиту виде. В решении используйте фамилию автора, а не его <code><strong>id</strong></code>.</p>

<p><strong>Фрагмент логической схемы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/81b4c54e-bfb0-4582-9df9-279b6be0154e/"></p>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/3?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <a href="https://stepik.org/lesson/297509/step/12?unit=279269" rel="noopener noreferrer nofollow">шаг</a>);</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Выбрать всех клиентов, которые заказывали книги Достоевского, информацию вывести в отсортированном по алфавиту виде. В решении используйте фамилию автора, а не его <code><strong>id</strong></code>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+---------------+
| name_client   |
+---------------+
| Абрамова Катя |
| Баранов Павел |
+---------------+</code></pre>
</details>
<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT DISTINCT name_client
FROM author INNER JOIN book USING(author_id) INNER JOIN buy_book ON book.book_id = buy_book.book_id INNER JOIN buy ON buy_book.buy_id = buy.buy_id INNER JOIN client ON buy.client_id = client.client_id
WHERE name_author LIKE 'Достоевск%'
ORDER BY name_client ASC;

</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов на выборку для предметной области «Абитуриент» (в таблицы занесены данные, как на <a href="https://stepik.org/lesson/310418/step/1?unit=292724" rel="noopener noreferrer nofollow">первом шаге</a> урока). Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно реализовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/98c706e5-0118-4fa9-ae09-4a934ece5bc8/"></p>
<details><summary><strong>Наполнение таблиц </strong></summary>

<pre><code class="language-sql">таблица department
+---------------+-------------------------+
| department_id | name_department         |
+---------------+-------------------------+
| 1             | Инженерная школа        |
| 2             | Школа естественных наук |
+---------------+-------------------------+
таблица program
+------------+-------------------------------------+---------------+------+
| program_id | name_program                        | department_id | plan |
+------------+-------------------------------------+---------------+------+
| 1          | Прикладная математика и информатика | 2             | 1    |
| 2          | Математика и компьютерные науки     | 2             | 2    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |
+------------+-------------------------------------+---------------+------+
таблица enrollee
+-------------+-----------------+
| enrollee_id | name_enrollee   |
+-------------+-----------------+
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |
+-------------+-----------------+
таблица subject
+------------+--------------+
| subject_id | name_subject |
+------------+--------------+
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |
+------------+--------------+
таблица program_subject
+--------------------+------------+------------+------------+
| program_subject_id | program_id | subject_id | min_result |
+--------------------+------------+------------+------------+
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |
+--------------------+------------+------------+------------+
таблица program_enrollee
+---------------------+------------+-------------+
| program_enrollee_id | program_id | enrollee_id |
+---------------------+------------+-------------+
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |
+---------------------+------------+-------------+
таблица enrollee_subject
+---------------------+-------------+------------+--------+
| enrollee_subject_id | enrollee_id | subject_id | result |
+---------------------+-------------+------------+--------+
| 1                   | 1           | 1          | 68     |
| 2                   | 1           | 2          | 70     |
| 3                   | 1           | 3          | 41     |
| 4                   | 1           | 4          | 75     |
| 5                   | 2           | 1          | 75     |
| 6                   | 2           | 2          | 70     |
| 7                   | 2           | 4          | 81     |
| 8                   | 3           | 1          | 85     |
| 9                   | 3           | 2          | 67     |
| 10                  | 3           | 3          | 90     |
| 11                  | 3           | 4          | 78     |
| 12                  | 4           | 1          | 82     |
| 13                  | 4           | 2          | 86     |
| 14                  | 4           | 3          | 70     |
| 15                  | 5           | 1          | 65     |
| 16                  | 5           | 2          | 67     |
| 17                  | 5           | 3          | 60     |
| 18                  | 6           | 1          | 90     |
| 19                  | 6           | 2          | 92     |
| 20                  | 6           | 3          | 88     |
| 21                  | 6           | 4          | 94     |
+---------------------+-------------+------------+--------+
таблица achievement
+----------------+-----------------------+-------+
| achievement_id | name_achievement      | bonus |
+----------------+-----------------------+-------+
| 1              | Золотая медаль        | 5     |
| 2              | Серебряная медаль     | 3     |
| 3              | Золотой значок ГТО    | 3     |
| 4              | Серебряный значок ГТО | 1     |
+----------------+-----------------------+-------+
таблица enrollee_achievement
+--------------------+-------------+----------------+
| enrollee_achiev_id | enrollee_id | achievement_id |
+--------------------+-------------+----------------+
| 1                  | 1           | 2              |
| 2                  | 1           | 3              |
| 3                  | 3           | 1              |
| 4                  | 4           | 4              |
| 5                  | 5           | 1              |
| 6                  | 5           | 3              |
+--------------------+-------------+----------------+</code></pre>
</details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_department, name_program, name_enrollee, SUM(result) AS TOTAL
FROM department JOIN program USING(department_id)
JOIN program_subject ON program.program_id = program_subject.program_id
JOIN subject ON program_subject.subject_id = subject.subject_id
JOIN program_enrollee ON program.program_id = program_enrollee.program_id
JOIN enrollee ON program_enrollee.enrollee_id = enrollee.enrollee_id

JOIN enrollee_subject ON enrollee.enrollee_id = enrollee_subject.enrollee_id AND enrollee_subject.subject_id = subject.subject_id
GROUP BY name_department, name_program, name_enrollee

ORDER BY TOTAL DESC
</code></pre><h2>Задание</h2>

<p>Для студента с именем <code><strong>student_59</strong></code> вывести следующую информацию по всем его попыткам:</p>

<ul>
	<li>информация о шаге: номер модуля, символ '<strong>.</strong>', позиция урока в модуле, символ '<strong>.</strong>', позиция шага в модуле;</li>
	<li>порядковый номер попытки для каждого шага - определяется по возрастанию времени отправки попытки;</li>
	<li>результат попытки;</li>
	<li>время попытки (преобразованное к формату времени) - определяется как разность между временем отправки попытки и времени ее начала, в случае если попытка длилась более 1 часа, то время попытки заменить на среднее время всех попыток пользователя по всем шагам без учета тех, которые длились больше 1 часа;</li>
	<li>относительное время попытки  - определяется как отношение времени попытки (с учетом замены времени попытки) к суммарному времени всех попыток  шага, округленное до двух знаков после запятой  .</li>
</ul>

<p>Столбцы назвать  <code><strong>Студент</strong></code>, <strong> <code>Шаг</code></strong>, <code><strong>Номер_попытки</strong></code>, <code><strong>Результат</strong></code>, <code><strong>Время_попытки</strong></code> и <code><strong>Относительное_время</strong></code>. Информацию отсортировать сначала по возрастанию <code><strong>id</strong></code> шага, а затем по возрастанию номера попытки (определяется по времени отправки попытки).</p>

<p><strong>Важно. </strong>Все вычисления производить в секундах, округлять и переводить во временной формат только для вывода результата.</p>

<p><em><strong>Фрагмент логической схемы базы данных:</strong></em></p>

<p><img alt="" src="https://ucarecdn.com/a1d75640-3d9e-4f16-9f02-2868a5a9570e/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Перед тем, как переводить <code><strong>Время_попытки</strong></code> к формату времени, округлите до целого разницу, вычисленную в секундах.</p>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------+--------+---------------+-----------+---------------+---------------------+
| Студент    | Шаг    | Номер_попытки | Результат | Время_попытки | Относительное_время |
+------------+--------+---------------+-----------+---------------+---------------------+
| student_59 | 1.2.2  | 1             | correct   | 0:00:28       | 100.00              |
| student_59 | 1.2.3  | 1             | correct   | 0:01:11       | 100.00              |
| student_59 | 1.2.4  | 1             | correct   | 0:06:09       | 100.00              |
| student_59 | 1.2.5  | 1             | correct   | 0:02:24       | 100.00              |
| student_59 | 1.2.6  | 1             | wrong     | 0:09:42       | 90.37               |
| student_59 | 1.2.6  | 2             | wrong     | 0:00:05       | 0.78                |
| student_59 | 1.2.6  | 3             | wrong     | 0:00:23       | 3.57                |
| student_59 | 1.2.6  | 4             | wrong     | 0:00:10       | 1.55                |
| student_59 | 1.2.6  | 5             | correct   | 0:00:20       | 3.11                |
                                       ...
| student_59 | 2.4.7  | 1             | correct   | 0:21:18       | 100.00              |
| student_59 | 2.4.8  | 1             | correct   | 0:33:02       | 100.00              |
| student_59 | 2.4.9  | 1             | wrong     | 0:18:12       | 71.75               |
| student_59 | 2.4.9  | 2             | correct   | 0:07:10       | 28.25               |
| student_59 | 2.4.10 | 1             | correct   | 0:05:32       | 100.00              |
| student_59 | 2.4.11 | 1             | correct   | 0:40:27       | 100.00              |
| student_59 | 2.4.12 | 1             | correct   | 0:07:10       | 100.00              |
| student_59 | 2.4.13 | 1             | correct   | 0:07:15       | 100.00              |
+------------+--------+---------------+-----------+---------------+---------------------+
Affected rows: 58</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/404275/step/6?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">табличные выражения</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/310421/step/10?auth=login&amp;unit=292727" rel="noopener noreferrer nofollow">функция CONCAT()</a>;</u></li>
	<li>оконные функции (<u><a href="https://stepik.org/lesson/404275/step/8?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/404275/step/10?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/404275/step/5?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">оператор CASE</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">вычисления для сгруппированных данных</a></u>.</li>
</ul>
</details>

<p><em><strong>Текст задания (чтобы не прокручивать страницу):</strong></em></p>

<blockquote>
<p>Для студента с именем <code><strong>student_59</strong></code> вывести следующую информацию по всем его попыткам:</p>

<ul>
	<li>информация о шаге: номер модуля, символ '<strong>.</strong>', позиция урока в модуле, символ '<strong>.</strong>', позиция шага в модуле;</li>
	<li>порядковый номер попытки для каждого шага - определяется по возрастанию времени отправки попытки;</li>
	<li>результат попытки;</li>
	<li>время попытки (преобразованное к формату времени) - определяется как разность между временем отправки попытки и времени ее начала, в случае если попытка длилась более 1 часа, то время попытки заменить на среднее время всех попыток пользователя по всем шагам без учета тех, которые длились больше 1 часа;</li>
	<li>относительное время попытки  - определяется как отношение времени попытки (с учетом замены времени попытки) к суммарному времени всех попыток  шага, округленное до двух знаков после запятой.</li>
</ul>

<p>Столбцы назвать  <code><strong>Студент</strong></code>, <strong> <code>Шаг</code></strong>, <code><strong>Номер_попытки</strong></code>, <code><strong>Результат</strong></code>, <code><strong>Время_попытки</strong></code> и <code><strong>Относительное_время</strong></code>. Информацию отсортировать сначала по возрастанию <strong>id</strong> шага, а затем по возрастанию номера попытки (определяется по времени отправки попытки).</p>

<p><strong>Важно. </strong>Все вычисления производить в секундах, округлять и переводить во временной формат только для вывода результата.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">WITH arr_a
AS (SELECT student_name AS Студент,
CONCAT(module_id, '.', lesson_position, '.', step_position) AS Шаг,
ROW_NUMBER() OVER(PARTITION BY step_id ORDER BY submission_time) AS Номер_попытки,
result AS Результат,
step_id,
(submission_time - attempt_time) AS Вр_попытки
FROM student INNER JOIN step_student USING(student_id)
INNER JOIN step USING(step_id)
INNER JOIN lesson USING(lesson_id)
WHERE student_name = 'student_59'),
arr_b AS
(SELECT Студент, CEIL(AVG(Вр_попытки)) AS att_av
FROM arr_a
WHERE Вр_попытки <= 60*60
GROUP BY Студент),
arr_c AS (
    SELECT Студент,
    step_id,
    Номер_попытки,
    (IF(Вр_попытки > 60*60, att_av, Вр_попытки)) AS Время_попытки,
    SUM(IF(Вр_попытки > 60*60, att_av, Вр_попытки)) OVER(PARTITION BY step_id) AS sum_time
    FROM arr_a INNER JOIN arr_b USING(Студент))

SELECT arr_a.Студент, Шаг, arr_a.Номер_попытки, Результат,
SEC_TO_TIME(Время_попытки) AS Время_попытки,
ROUND(Время_попытки/sum_time * 100, 2) AS Относительное_время
FROM arr_a INNER JOIN arr_c ON arr_a.step_id = arr_c.step_id AND arr_a.Номер_попытки = arr_c.Номер_попытки</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов к нашей таблице <code><strong>book</strong></code>. Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях.</p>

<p>Размещенные задания можно использовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p>В последнем модуле создан отдельный урок, в котором мы разместим запросы, набравшие наибольшее количество лайков. </p>

<p>Структура и наполнение таблицы <code><strong>book:</strong></code></p>

<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr style="background-color: #a9a9a9; background: #a9a9a9; text-align: center;">
			<td><strong>book_id</strong></td>
			<td><strong>title</strong></td>
			<td><strong>author</strong></td>
			<td><strong>price</strong></td>
			<td><strong>amount</strong></td>
		</tr>
		<tr style="background-color: #dcdcdc; background: #dcdcdc; text-align: center;">
			<td><sup><strong>INT PRIMARY KEY AUTO_INCREMENT</strong></sup></td>
			<td><sup><strong>VARCHAR(50)</strong></sup></td>
			<td><sup><strong>VARCHAR(30)</strong></sup></td>
			<td><sup><strong>DECIMAL(8,2)</strong></sup></td>
			<td><sup><strong>INT</strong></sup></td>
		</tr>
		<tr>
			<td>1</td>
			<td>Мастер и Маргарита</td>
			<td>Булгаков М.А.</td>
			<td>670.99</td>
			<td>3</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Белая гвардия</td>
			<td>Булгаков М.А.</td>
			<td>540.50</td>
			<td>5</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Идиот</td>
			<td>Достоевский Ф.М.</td>
			<td>460.00</td>
			<td>10</td>
		</tr>
		<tr>
			<td>4</td>
			<td>Братья Карамазовы</td>
			<td>Достоевский Ф.М.</td>
			<td>799.01</td>
			<td>2</td>
		</tr>
		<tr>
			<td>5</td>
			<td>Стихотворения и поэмы</td>
			<td>Есенин С.А.</td>
			<td>650.00</td>
			<td>15</td>
		</tr>
	</tbody>
</table> <br><hr><br> <pre><code class="hljs language-sql">SELECT author, amount,
ROUND(IF(amount > 5, price * 0.75, price), 2) AS new_price
FROM book
ORDER BY new_price




</code></pre><h2>Задание</h2>

<p>Вывести жанр (или жанры), в котором было заказано больше всего экземпляров книг, указать это количество. Последний столбец назвать <strong>Количество</strong>.</p>

<p><strong>Фрагмент логической схемы:</strong></p>

<p><img alt="" src="https://ucarecdn.com/710494ce-e3a3-4d4b-8f10-5ab41b474b31/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Использовать вложенный запрос для вычисления максимального значения экземпляров книг.  Рекомендуется запрос реализовывать по <a href="https://stepik.org/lesson/308886/step/7?unit=291012" rel="noopener noreferrer nofollow">шагам</a>.</p>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li>групповые функции(<u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297515/step/4?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297515/step/6?unit=279275" rel="noopener noreferrer nofollow">групповые вычисления по всей таблице</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297514/step/2?unit=279274" rel="noopener noreferrer nofollow">вложенные запросы в условии отбора</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/8?unit=291012" rel="noopener noreferrer nofollow">вложенные запросы в операторах соединения</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Вывести жанр (или жанры), в котором было заказано больше всего экземпляров книг, указать это количество . Последний столбец назвать <strong>Количество</strong>.</p>
</blockquote>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------------+------------+
| name_genre | Количество |
+------------+------------+
| Роман      | 7          |
+------------+------------+</code></pre>
</details>
<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT name_genre, SUM(buy_book.amount) AS Количество
FROM genre INNER JOIN book USING(genre_id) INNER JOIN buy_book ON book.book_id = buy_book.book_id
GROUP BY genre.genre_id, name_genre
HAVING Количество >= ALL (
    SELECT SUM(buy_book.amount) FROM genre INNER JOIN book USING(genre_id) INNER JOIN buy_book ON book.book_id = buy_book.book_id GROUP BY genre.genre_id, name_genre)

</code></pre><h2>Задание</h2>

<p>Online курс обучающиеся могут проходить по различным траекториям, проследить за которыми можно по способу решения ими заданий шагов курса. Большинство обучающихся за несколько попыток  получают правильный ответ <br>
и переходят к следующему шагу. Но есть такие, что остаются на шаге, выполняя несколько верных попыток, или переходят к следующему, оставив нерешенные шаги.</p>

<p>Выделив эти "необычные" действия обучающихся, можно проследить их траекторию работы с курсом и проанализировать задания, для которых эти действия выполнялись, а затем их как-то изменить. </p>

<p>Для этой цели необходимо выделить группы обучающихся по способу прохождения шагов:</p>

<ul>
	<li><strong>I группа</strong> - это те пользователи, которые после верной попытки решения шага делают неверную (скорее всего для того, чтобы поэкспериментировать или проверить, как работают примеры);</li>
	<li><strong>II группа</strong> - это те пользователи, которые делают больше одной верной попытки для одного шага (возможно, улучшают свое решение или пробуют другой вариант);</li>
	<li><strong>III группа</strong> - это те пользователи, которые не смогли решить задание какого-то шага (у них все попытки по этому шагу - неверные).</li>
</ul>

<p>Вывести группу (<code><strong>I, II, III</strong></code>), имя пользователя, количество шагов, которые пользователь выполнил по соответствующему способу. Столбцы назвать <code><strong>Группа, Студент, Количество_шагов</strong></code>. Отсортировать информацию по возрастанию номеров групп, потом по убыванию количества шагов и, наконец, по имени студента в алфавитном порядке.</p>

<details><summary><strong>Пояснение</strong></summary>

<p>На основе этого задания я посчитала количество различных обучающихся, относящихся к одной или нескольким группам, выделенным в задании. Получилось, что 22 человека из 64 (34%) проходят курс "нестандартно".  Причем пересечение первой и второй   группы  - 9 человек (почти все, кроме одного человека первой группы входят во вторую), первой и третьей группы - пусто, второй и третьей - один человек. </p>
</details>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/c91b0e6e-cd41-495e-857e-89c3630da9ce/"></p>

<p><strong>Рекомендация. </strong>Формирование каждой группы реализовать одним или несколькими табличными выражениями, а затем объединить их результаты.</p>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+--------+------------+------------------+
| Группа | Студент    | Количество_шагов |
+--------+------------+------------------+
| I      | student_15 | 2                |
| I      | student_53 | 2                |
| I      | student_11 | 1                |
           ...
| I      | student_9  | 1                |
| II     | student_53 | 4                |
| II     | student_62 | 4                |
| II     | student_34 | 3                |
           ...
| II     | student_59 | 1                |
| III    | student_24 | 3                |
| III    | student_33 | 1                |
| III    | student_42 | 1                |
           ...
| III    | student_64 | 1                |
+--------+------------+------------------+
Affected rows: 32</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/404275/step/6?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">табличные выражения</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">условие отбора</a>;</u></li>
	<li>оконные функции (<u><a href="https://stepik.org/lesson/404275/step/8?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/404275/step/10?auth=login&amp;unit=393473" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/297515/step/2?unit=279275" rel="noopener noreferrer nofollow">уникальные записи</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297515/step/7?unit=279275" rel="noopener noreferrer nofollow">условие отбора в запросах группировки</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/308891/step/14?auth=login&amp;unit=291017" rel="noopener noreferrer nofollow">оператор UNION</a>;</u></li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания (чтобы не прокручивать страницу):</strong></p>

<blockquote>
<p>Выделить группы обучающихся по способу прохождения шагов:</p>

<ul>
	<li><strong>I группа</strong> - это те пользователи, которые после верной попытки решения шага делают неверную (скорее всего для того, чтобы поэкспериментировать или проверить, как работают примеры);</li>
	<li><strong>II группа</strong> - это те пользователи, которые делают больше одной верной попытки для одного шага (возможно, улучшают свое решение или пробуют другой вариант);</li>
	<li><strong>III группа</strong> - это те пользователи, которые не смогли решить задание какого-то шага (у них все попытки по этому шагу - неверные).</li>
</ul>

<p>Вывести группу (<code><strong>I, II, III</strong></code>), имя пользователя, количество шагов, которые пользователь выполнил по соответствующему способу. Столбцы назвать <code><strong>Группа, Студент, Количество_шагов</strong></code>. Отсортировать информацию по возрастанию номеров групп, потом по убыванию количества шагов и, наконец, по имени студента в алфавитном порядке.</p>
</blockquote> <br><hr><br> <pre><code class="hljs language-sql">WITH preparation_arr AS (
SELECT student_name, result, step_id, submission_time, IF(result='wrong', 0, 1) AS comperance
FROM student INNER JOIN step_student USING(student_id)
ORDER BY student_name, step_id, submission_time),
grouped_arr AS (
SELECT student_name, result, step_id, comperance, submission_time,
IF(result='correct' AND LEAD(result) OVER (PARTITION BY student_name, step_id ORDER BY submission_time) = 'wrong', 'group_I', '-') AS filter_I,
IF(SUM(comperance) OVER (PARTITION BY student_name, step_id) > 1, 'group_II', '-') AS filter_II,
IF(SUM(comperance) OVER (PARTITION BY student_name, step_id) = 0, 'group_III', '-') AS filter_III
FROM preparation_arr
ORDER BY student_name, step_id, submission_time),
group_II AS (
SELECT student_name, step_id,
(ROW_NUMBER() OVER (PARTITION BY student_name)) AS step_frequency, CONCAT('II') AS Группа
FROM grouped_arr
WHERE filter_II = 'group_II'
GROUP BY student_name, step_id),
group_III AS (
SELECT student_name, step_id,
(ROW_NUMBER() OVER (PARTITION BY student_name)) AS step_frequency, CONCAT('III') AS Группа
FROM grouped_arr
WHERE filter_III = 'group_III'
GROUP BY student_name, step_id),
group_I AS (
SELECT student_name, step_id,
(ROW_NUMBER() OVER (PARTITION BY student_name)) AS step_frequency, CONCAT('I') AS Группа
FROM grouped_arr
WHERE filter_I = 'group_I')

SELECT Группа, student_name, MAX(step_frequency) AS Количество_шагов
FROM group_I
GROUP BY student_name
UNION ALL
SELECT Группа, student_name, MAX(step_frequency) AS Количество_шагов
FROM group_II
GROUP BY student_name
UNION ALL
SELECT Группа, student_name, MAX(step_frequency) AS Количество_шагов
FROM group_III
GROUP BY student_name
ORDER BY Группа, Количество_шагов DESC</code></pre><h2>Задание</h2>

<blockquote>
<p><em>Этот шаг добавлен по рекомендациям пользователей: </em><a href="https://stepik.org/users/37374841" rel="noopener noreferrer nofollow" title="Показать профиль пользователя">Тимур Timmmyyy</a>, <a href="https://stepik.org/users/33149099" rel="noopener noreferrer nofollow" title="Показать профиль пользователя">Todor Illia</a>, <a href="https://stepik.org/users/123836326" rel="noopener noreferrer nofollow">Лёха Last name</a>, <a href="https://stepik.org/users/58247085" rel="noopener noreferrer nofollow" title="Показать профиль пользователя">Игорь Владимирович Лапшин</a> и др.</p>
</blockquote>

<p>Сравнить ежемесячную выручку от продажи книг за текущий и предыдущий годы. Для этого вывести год, месяц, сумму выручки в отсортированном сначала по возрастанию месяцев, затем по возрастанию лет виде. Название столбцов: <code><strong>Год</strong></code>, <code><strong>Месяц</strong></code>, <code><strong>Сумма</strong></code>.</p>

<p><strong>Фрагмент логической схемы базы данных (в запросе НЕ ОБЯЗАТЕЛЬНО использовать все таблицы):</strong></p>

<p><img alt="" src="https://ucarecdn.com/843369b4-8065-4023-99bf-60a08aaafa34/"></p>

<p>Информация о продажах предыдущего года хранится в архивной таблице <code><strong>buy_archive</strong></code>, которая создается в конце года на основе информации из таблиц базы данных и имеет следующую структуру:</p>

<table border="1" cellpadding="1" cellspacing="1">
	<tbody>
		<tr>
			<td style="text-align: center;"><strong>Название столбца</strong></td>
			<td style="text-align: center;"><strong>Описание</strong></td>
		</tr>
		<tr>
			<td><code><strong>buy_archive_id</strong></code></td>
			<td>ключевой столбец</td>
		</tr>
		<tr>
			<td><strong><code>buy_id</code></strong></td>
			<td><code><strong>id</strong></code>заказов, выбирается из таблицы <code><strong>buy</strong></code></td>
		</tr>
		<tr>
			<td><code><strong>client_id</strong></code></td>
			<td><code><strong>id</strong></code>клиентов, выбирается из из таблицы <code><strong>client</strong></code></td>
		</tr>
		<tr>
			<td><code><strong>book_id</strong></code></td>
			<td><code><strong>id</strong></code>книги, выбирается из таблицы<code><strong> book</strong></code></td>
		</tr>
		<tr>
			<td><code><strong>date_payment</strong></code></td>
			<td>дата оплаты заказа, выбирается из столбца <code><strong>date_step_end</strong></code><br>
			таблицы <code><strong>buy_step</strong></code> этапа «Оплата» соответствующего заказа</td>
		</tr>
		<tr>
			<td><code><strong>price</strong></code></td>
			<td>цена книги в текущем заказе из таблицы <code><strong>book</strong></code><br>
			(хранится, так как цена может измениться )</td>
		</tr>
		<tr>
			<td><code><strong>amount</strong></code></td>
			<td>количество купленных книг в текущем заказе, из таблицы <code><strong>buy_book</strong></code></td>
		</tr>
	</tbody>
</table>

<p><strong>Оператор UNION</strong></p>

<p>Оператор <code><strong>UNION</strong></code> используется для объединения двух и более SQL запросов, его синтаксис:</p>

<pre><code class="language-sql">SELECT столбец_1_1, столбец_1_2, ...
FROM 
  ...
UNION
SELECT столбец_2_1, столбец_2_2, ...
FROM 
  ...</code></pre>

<p>или</p>

<pre><code class="language-sql">SELECT столбец_1_1, столбец_1_2, ...
FROM 
  ...
UNION ALL
SELECT столбец_2_1, столбец_2_2, ...
FROM 
  ...</code></pre>

<p>Важно отметить, что каждый из <code><strong>SELECT</strong></code> должен иметь в своем запросе одинаковое количество столбцов и  совместимые типы возвращаемых данных. Каждый запрос может включать разделы <code><strong>WHERE</strong></code>, <code><strong>GROUP BY</strong></code> и пр.</p>

<p>В результате выполнения этой конструкции будет выведена таблица, имена столбцов которой соответствуют именам столбцов в первом запросе. А в таблице результата сначала отображаются записи-результаты первого запроса, а затем второго. Если указано ключевое слово <code><strong>ALL</strong></code>, то в результат включаются все записи запросов, в противном случае - различные.</p>

<p><strong>Пример</strong></p>

<p>Вывести всех клиентов, которые делали заказы или в этом, или в предыдущем году.</p>

<p>На этом примере рассмотрим разницу между <code><strong>UNION</strong></code> и <code><strong>UNION ALL</strong></code>.</p>

<p>С <code><strong>UNION </strong></code>клиенты будут выведены без повторений:</p>

<pre><code>SELECT name_client
FROM 
    buy_archive
    INNER JOIN client USING(client_id)
UNION
SELECT name_client
FROM 
    buy 
    INNER JOIN client USING(client_id)
+-----------------+
| name_client     |
+-----------------+
| Баранов Павел   |
| Абрамова Катя   |
| Яковлева Галина |
| Семенонов Иван  |
+-----------------+
Affected rows: 4</code></pre>

<p>C <code><strong>UNION ALL</strong></code> будут выведены клиенты с повторением (для тех, кто заказывал книги в обоих годах, а также несколько раз в одном году)</p>

<pre><code>SELECT name_client
FROM 
    buy_archive
    INNER JOIN client USING(client_id)
UNION ALL
SELECT name_client
FROM 
    buy 
    INNER JOIN client USING(client_id)
+-----------------+
| name_client     |
+-----------------+
| Баранов Павел   |
| Баранов Павел   |
| Абрамова Катя   |
| Абрамова Катя   |
| Абрамова Катя   |
| Яковлева Галина |
| Яковлева Галина |
| Баранов Павел   |
| Абрамова Катя   |
| Абрамова Катя   |
| Баранов Павел   |
| Баранов Павел   |
| Абрамова Катя   |
| Семенонов Иван  |
+-----------------+
Affected rows: 14</code></pre>

<p><strong>Пример</strong></p>

<p>Вывести информацию об оплаченных заказах за предыдущий и текущий год, информацию отсортировать по  <code><strong>client_id</strong></code>.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT buy_id, client_id, book_id, date_payment, amount, price
FROM 
    buy_archive
UNION ALL
SELECT buy.buy_id, client_id, book_id, date_step_end, buy_book.amount, price
FROM 
    book 
    INNER JOIN buy_book USING(book_id)
    INNER JOIN buy USING(buy_id) 
    INNER JOIN buy_step USING(buy_id)
    INNER JOIN step USING(step_id)                  
WHERE  date_step_end IS NOT Null and name_step = "Оплата"  
</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------+-----------+---------+--------------+--------+--------+
| buy_id | client_id | book_id | date_payment | amount | price  |
+--------+-----------+---------+--------------+--------+--------+
| 2      | 1         | 1       | 2019-02-21   | 2      | 670.60 |
| 2      | 1         | 3       | 2019-02-21   | 1      | 450.90 |
| 1      | 2         | 2       | 2019-02-10   | 2      | 520.30 |
| 1      | 2         | 4       | 2019-02-10   | 3      | 780.90 |
| 1      | 2         | 3       | 2019-02-10   | 1      | 450.90 |
| 3      | 4         | 4       | 2019-03-05   | 4      | 780.90 |
| 3      | 4         | 5       | 2019-03-05   | 2      | 480.90 |
| 4      | 1         | 6       | 2019-03-12   | 1      | 650.00 |
| 5      | 2         | 1       | 2019-03-18   | 2      | 670.60 |
| 5      | 2         | 4       | 2019-03-18   | 1      | 780.90 |
| 1      | 1         | 3       | 2020-02-20   | 1      | 460.00 |
| 1      | 1         | 7       | 2020-02-20   | 2      | 570.20 |
| 1      | 1         | 1       | 2020-02-20   | 1      | 670.99 |
| 2      | 3         | 8       | 2020-02-28   | 2      | 518.99 |
| 3      | 2         | 1       | 2020-03-05   | 1      | 670.99 |
| 3      | 2         | 2       | 2020-03-05   | 1      | 540.50 |
| 3      | 2         | 3       | 2020-03-05   | 2      | 460.00 |
+--------+-----------+---------+--------------+--------+--------+
</code></pre>

<p>В результат включены сначала записи архивной таблицы, а затем информация об оплаченных заказах  текущего года. Для того, чтобы изменить порядок следования записей в объединенном запросе, можно использовать <strong>сортировку</strong> по всем объединенным записям. В этом случае ключевые слова <code><strong>ORDER BY</strong></code> указываются после последнего запроса: </p>

<pre><code class="language-sql">SELECT buy_id, client_id, book_id, date_payment, amount, price
FROM 
    buy_archive
UNION ALL
SELECT buy.buy_id, client_id, book_id, date_step_end, buy_book.amount, price
FROM 
    book 
    INNER JOIN buy_book USING(book_id)
    INNER JOIN buy USING(buy_id) 
    INNER JOIN buy_step USING(buy_id)
    INNER JOIN step USING(step_id)                  
WHERE  date_step_end IS NOT Null and name_step = "Оплата"
ORDER BY client_id</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+--------+-----------+---------+--------------+--------+--------+
| buy_id | client_id | book_id | date_payment | amount | price  |
+--------+-----------+---------+--------------+--------+--------+
| 2      | 1         | 3       | 2019-02-21   | 1      | 450.90 |
| 2      | 1         | 1       | 2019-02-21   | 2      | 670.60 |
| 1      | 1         | 3       | 2020-02-20   | 1      | 460.00 |
| 1      | 1         | 7       | 2020-02-20   | 2      | 570.20 |
| 4      | 1         | 6       | 2019-03-12   | 1      | 650.00 |
| 1      | 1         | 1       | 2020-02-20   | 1      | 670.99 |
| 3      | 2         | 1       | 2020-03-05   | 1      | 670.99 |
| 3      | 2         | 2       | 2020-03-05   | 1      | 540.50 |
| 3      | 2         | 3       | 2020-03-05   | 2      | 460.00 |
| 5      | 2         | 4       | 2019-03-18   | 1      | 780.90 |
| 5      | 2         | 1       | 2019-03-18   | 2      | 670.60 |
| 1      | 2         | 3       | 2019-02-10   | 1      | 450.90 |
| 1      | 2         | 4       | 2019-02-10   | 3      | 780.90 |
| 1      | 2         | 2       | 2019-02-10   | 2      | 520.30 |
| 2      | 3         | 8       | 2020-02-28   | 2      | 518.99 |
| 3      | 4         | 5       | 2019-03-05   | 2      | 480.90 |
| 3      | 4         | 4       | 2019-03-05   | 4      | 780.90 |
+--------+-----------+---------+--------------+--------+--------+</code></pre>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297510/step/8?unit=279270" rel="noopener noreferrer nofollow">выделение номера месяца из даты</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297510/step/10?unit=279270" rel="noopener noreferrer nofollow">выделение части даты</a></u>;</li>
	<li>групповые функции(<u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297515/step/5?unit=279275" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li>условие отбора (<u><a href="https://stepik.org/lesson/297509/step/8?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>, <u><a href="https://stepik.org/lesson/297509/step/9?unit=279269" rel="noopener noreferrer nofollow">шаг</a></u>);</li>
	<li><u><a href="https://stepik.org/lesson/305762/step/4?unit=287773" rel="noopener noreferrer nofollow">сравнение с пустым значением</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Сравнить ежемесячную выручку от продажи книг за текущий и предыдущий годы. Для этого вывести год, месяц, сумму выручки в отсортированном сначала по возрастанию месяцев, затем по возрастанию лет виде. Название столбцов: <code><strong>Год</strong></code>, <code><strong>Месяц</strong></code>, <code><strong>Сумма</strong></code>.</p>
</blockquote>

<details><summary><strong>Пояснение</strong></summary>

<ol>
	<li>Ежемесячная выручка рассчитывается как  сумма произведений цены книги на заказанное пользователем в этом месяце количество. </li>
	<li>Цена книги для текущего года хранится в таблице <code><strong>book</strong></code>, а для предыдущего в <code><strong>buy_archive</strong></code>.</li>
	<li>Функция для выделения месяца рассмотрена на этом <a href="https://stepik.org/lesson/297510/step/9?unit=279270" rel="noopener noreferrer nofollow">шаге</a>.</li>
</ol>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+------+----------+---------+
| Год  | Месяц    | Сумма   |
+------+----------+---------+
| 2019 | February | 5626.30 |
| 2020 | February | 3309.37 |
| 2019 | March    | 6857.50 |
| 2020 | March    | 2131.49 |
+------+----------+---------+</code></pre>
</details>
<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT YEAR(date_payment) AS Год, MONTHNAME(date_payment) AS Месяц, SUM(price * amount) AS Сумма
FROM buy_archive
GROUP BY Год, Месяц
UNION ALL
SELECT YEAR(date_step_end) AS Год, MONTHNAME(date_step_end) AS Месяц, SUM(book.price * buy_book.amount) AS Сумма
FROM book INNER JOIN buy_book USING(book_id) INNER JOIN buy_step ON buy_book.buy_id = buy_step.buy_id INNER JOIN step ON buy_step.step_id = step.step_id
WHERE date_step_end IS NOT NULL AND step.step_id = 1
GROUP BY Год, Месяц
ORDER BY Месяц</code></pre><h2>Задание</h2>

<p>Для каждой отдельной книги необходимо вывести информацию о количестве проданных экземпляров и их стоимости за текущий и предыдущий год . Вычисляемые столбцы назвать <code><strong>Количество</strong></code><strong> </strong>и <code><strong>Сумма</strong></code>. Информацию отсортировать по убыванию стоимости.</p>

<p><strong>Фрагмент логической схемы базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/d5c5d16e-32eb-4caa-8fc8-6982cda2ac32/"></p>

<p>Информация о продажах прошлого года хранится в таблице<strong> </strong><a href="https://stepik.org/lesson/308891/step/14?unit=291017" rel="noopener noreferrer nofollow"><strong><code>buy_archive</code></strong></a> следующей структуры:</p>

<p><img alt="" src="https://ucarecdn.com/bd089cc7-acb0-442e-a276-4995f7ade4b1/"></p>

<details><summary><strong>Пояснение</strong></summary>

<p>Запросы с <code><strong>UNION</strong></code> можно использовать как вложенные, это позволяет обрабатывать данные из объединенных запросов совместно.</p>

<p><strong>Пример</strong></p>

<p>Вывести клиентов, которые делали покупки в прошлом году, но не делали в этом. А также новых клиентов, которые делали заказы только в текущем году. Информацию отсортировать по возрастанию лет.</p>

<p><strong>Шаг 1. </strong>Отберем клиентов прошлого года, указав дату самого раннего заказа, а также клиентов этого года, указав для них самую раннюю дату оплаты заказа.</p>

<p><em>Запрос</em></p>

<pre><code class="language-sql">SELECT name_client, MIN(date_payment) AS first_payment
FROM 
    buy_archive 
    INNER JOIN client USING(client_id)
GROUP BY  name_client
UNION
SELECT name_client, MIN(date_step_end)
FROM 
    buy 
    INNER JOIN client USING(client_id)
    INNER JOIN buy_step USING(buy_id)
GROUP BY name_client</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------+---------------+
| name_client     | first_payment |
+-----------------+---------------+
| Абрамова Катя   | 2019-02-10    |
| Баранов Павел   | 2019-02-21    |
| Яковлева Галина | 2019-03-05    |
| Абрамова Катя   | 2020-03-05    |
| Баранов Павел   | 2020-02-20    |
| Семенонов Иван  | 2020-02-28    |
+-----------------+---------------+</code></pre>

<p>Как видно из таблицы, некоторые клиенты делали покупки как в прошлом, так и в этом году. Они встречаются в таблице 2 раза.</p>

<p><strong>Шаг 2. </strong>Оставим только тех клиентов, которые встречаются в полученной таблице один раз, для этого используем предыдущий запрос как вложенный.</p>

<p><em>Запрос:</em></p>

<pre><code class="language-sql">SELECT name_client, MIN(YEAR(first_payment)) AS Год
FROM
  (
   SELECT name_client, MIN(date_payment) AS first_payment
   FROM 
       buy_archive 
       INNER JOIN client USING(client_id)
   GROUP BY  name_client
   UNION
   SELECT name_client, MIN(date_step_end)
   FROM 
       buy 
       INNER JOIN client USING(client_id)
       INNER JOIN buy_step USING (buy_id)
   GROUP BY name_client
  ) query_in
GROUP BY name_client
HAVING COUNT(*) = 1
ORDER BY 2</code></pre>

<p><em>Результат:</em></p>

<pre><code class="language-sql">+-----------------+------+
| name_client     | Год  |
+-----------------+------+
| Яковлева Галина | 2019 |
| Семенонов Иван  | 2020 |
+-----------------+------+</code></pre>
</details>

<details><summary><strong>Связанные шаги</strong></summary>

<ul>
	<li><u><a href="https://stepik.org/lesson/297509/step/4?unit=279269" rel="noopener noreferrer nofollow">выборка столбцов и их именование</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/2?unit=291012" rel="noopener noreferrer nofollow">соединение таблиц</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297515/step/3?unit=279275" rel="noopener noreferrer nofollow">групповые функции</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/308886/step/8?unit=291012" rel="noopener noreferrer nofollow">вложенные запросы в операторах соединения</a></u>;</li>
	<li><u><a href="https://stepik.org/lesson/297509/step/11?unit=279269" rel="noopener noreferrer nofollow">сортировка</a></u>.</li>
</ul>
</details>

<p><strong>Текст задания</strong> (чтобы не прокручивать страницу) : </p>

<blockquote>
<p>Для каждой отдельной книги необходимо вывести информацию о количестве проданных экземпляров и их стоимости за текущий и предыдущий год . Вычисляемые столбцы назвать <code><strong>Количество</strong></code><strong> </strong>и <code><strong>Сумма</strong></code>. Информацию отсортировать по убыванию стоимости.</p>
</blockquote>

<details><summary><strong>Пояснение</strong></summary>

<p>При вычислении Количества и Суммы для текущего года учитывать только те книги, которые уже оплачены (указана дата оплаты для шага "Оплата" в таблице buy_step).</p>
</details>

<details><summary><strong>Результат</strong></summary>

<pre><code class="language-sql">+-----------------------+------------+---------+
| title                 | Количество | Сумма   |
+-----------------------+------------+---------+
| Братья Карамазовы     | 8          | 6247.20 |
| Мастер и Маргарита    | 6          | 4024.38 |
| Идиот                 | 5          | 2281.80 |
| Белая гвардия         | 3          | 1581.10 |
| Черный человек        | 2          | 1140.40 |
| Лирика                | 2          | 1037.98 |
| Игрок                 | 2          | 961.80  |
| Стихотворения и поэмы | 1          | 650.00  |
+-----------------------+------------+---------+</code></pre>
</details>
<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">SELECT title, SUM(Количество) AS Количество, SUM(Сумма) AS Сумма
FROM (SELECT title, SUM(buy_book.amount) AS Количество, SUM(buy_book.amount * book.price) AS Сумма
FROM book INNER JOIN buy_book USING(book_id) INNER JOIN buy USING(buy_id) INNER JOIN buy_step USING(buy_id) INNER JOIN step USING(step_id)
WHERE date_step_end IS NOT NULL AND name_step = 'Оплата'
GROUP BY book_id, title
UNION ALL
SELECT title, SUM(buy_archive.amount) AS Количество, SUM(buy_archive.amount * buy_archive.price) AS Сумма
FROM book INNER JOIN buy_archive USING(book_id)
GROUP BY book_id, title) query_in
GROUP BY title
ORDER BY Сумма DESC;

</code></pre><h2>Задание</h2>

<p>Придумайте один или несколько запросов на выборку для предметной области «Интернет-магазин книг» (в таблицы занесены данные, как на <a href="https://stepik.org/lesson/308891/step/1?unit=291017" rel="noopener noreferrer nofollow">первом шаге</a> урока). Проверьте, правильно ли они работают.</p>

<p>При желании можно формулировку запросов  разместить в комментариях. </p>

<p>Размещенные задания можно использовать для закрепления материала урока.</p>

<p>Оценивайте понравившиеся Вам запросы.</p>

<p>В последнем модуле создан отдельный урок, в котором мы разместим запросы, набравшие наибольшее количество лайков.</p>

<p><strong>Логическая схема базы данных:</strong></p>

<p><img alt="" src="https://ucarecdn.com/bad26356-5e34-4945-a9d4-0748686a6b54/"> </p>
<details><summary><strong>Наполнение таблиц</strong></summary> <img alt="" height="870" name="111.png" src="https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/" width="719"></details> <br><hr><br> <pre><code class="hljs language-sql">select buy.buy_id, name_client, sum(buy_book.amount*book.price) as Стоимость from buy
join client on buy.client_id=client.client_id
join buy_book on buy_book.buy_id=buy.buy_id
join book on book.book_id=buy_book.book_id
group by buy.buy_id
order by buy.buy_id




</code></pre>
</body>
<script>hljs.highlightAll();</script>
</html>